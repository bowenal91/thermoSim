function ExpressionInterpreter(){}
ExpressionInterpreter.prototype={html:function(a,b){$(a).html(this.addImgs(this.eval(this.addStored(b))));this.renderMath(a)},append:function(a,b){$(a).append(this.addImgs(this.eval(this.addStored(b))));this.renderMath(a)},interpInput:function(a){return this.eval(this.addStored(a))},interpImgs:function(a){return this.addImgs(a)},interp:function(a){return this.addImgs(this.eval(this.addStored(a)))},renderMath:function(a){MathJax.Hub.Queue(["Typeset",MathJax.Hub,a?$(a).attr("id"):void 0])},addStored:function(a){return a.replace(/get[\s]*\([A-Za-z0-9,\s\-\.'"]*\)/g,
function(a,d){return eval(a)})},eval:function(a){if("number"==typeof a)return a;a=a.replace(/eval[\s]*\([0-9\(\)\+\-\*\/\s,\.'"]*\)/g,function(a,d){return eval(a)});return Number(a)===a?Number(a):a},sliceArgs:function(a){var b=[];a=a.replace(/[A-Za-z0-9\s-]*\(/,"");a=a.replace(")","");a+=",";for(var d=-1<a.indexOf(",");d;)d=a.indexOf(","),b.push(a.slice(0,d).killWhiteSpace()),a=a.slice(d+1,a.length),d=-1<a.indexOf(",");return b},finishAppend:function(){this.div=void 0;this.addedMath=!1},addImgs:function(a,
b){return a.replace(/img[\s]*\([A-Za-z0-9\+\-\*\/\s,\.'"]*\)/g,function(a,b){return eval(a)})},parseImgFunc:function(a,b){var d=this.sliceArgs(a),e=d[0],f=d[1],d=d[2],e=e.replace(/['"]/g,"");if(b)return{attrs:{src:[e]}};e=templater.img({attrs:{src:[e]}});d&&(e=templater.center({innerHTML:e}));"br"==f?e=templater.br()+e+templater.br():"p"==f&&(e=templater.p({innerHTML:e}));return e}};function SceneNavigator(){}
SceneNavigator.prototype={showPrompt:function(a,b,d){timeline.show(a,b,d)},refresh:function(){timeline.refresh()},nextPrompt:function(a){timeline.curSection();var b=timeline.curPrompt();return a||this.checkWillAdvance()?(b&&(b.finished=!0),a=this.getNextIdxs(),this.showPrompt(a.newSectionIdx,a.newPromptIdx),!0):!1},getNextIdxs:function(){var a=timeline.sectionIdx,b=timeline.curSection(),d=b.promptIdx;d+1==b.sectionData.prompts.length?a+1<timeline.sections.length&&(a++,d=0):d++;return{newSectionIdx:a,
newPromptIdx:d}},getPrevIdxs:function(){var a=timeline.sectionIdx,b=a,d=timeline.curSection().promptIdx,e=d;0==d?0<a&&(b--,e=timeline.sections[b].sectionData.prompts.length-1):e--;return{newSectionIdx:b,newPromptIdx:e}},checkWillAdvance:function(){var a=this.getNextIdxs();(a=Math.min(1,this.checkWillAdvanceConditions(a.newSectionIdx,a.newPromptIdx)))&&(a=Math.min(a,this.checkWillAdvanceQuiz()));return a},checkWillAdvanceConditions:function(a,b){var d=timeline.sectionIdx!=a,e=timeline.now(),e=conditionManager.canAdvance(e.promptIdx),
f=!0;d&&e&&(f=conditionManager.canAdvance(-1));return Math.min(e,f)},checkWillAdvanceQuiz:function(){var a=curLevel.quiz;if(a){if(a.allAnswered()){if(a.allCorrect())return!0;a.fireAlertWrong();return!1}alert("You haven't answered all the questions.");return!1}return!0},prevPrompt:function(){var a=this.getPrevIdxs();this.showPrompt(a.newSectionIdx,a.newPromptIdx)}};function Templater(){}
Templater.prototype={elem:function(a){a.attrs=a.attrs||{};a.style=a.style||void 0;a.innerHTML=a.innerHTML||"";!a.attrs.class?a.attrs.class=[globalHTMLClass]:a.attrs.class.push(globalHTMLClass);a.templater=this;return this.elemTemp(a)},img:function(a){a?a.type="img":a={type:"img"};return this.elem(a)},div:function(a){a?a.type="div":a={type:"div"};return this.elem(a)},button:function(a){a?a.type="button":a={type:"button"};return this.elem(a)},textarea:function(a){a?a.type="textarea":a={type:"textarea"};
return this.elem(a)},p:function(a){a?a.type="p":a={type:"p"};return this.elem(a)},br:function(){return"<br>"},tab:function(){return"&#09;"},table:function(a){a?a.type="table":a={type:"table"};return this.elem(a)},tr:function(a){a?a.type="tr":a={type:"tr"};return this.elem(a)},td:function(a){a?a.type="td":a={type:"td"};return this.elem(a)},center:function(a){a?a.type="center":a={type:"center"};return this.elem(a)},label:function(a){a?a.type="label":a={type:"label"};return this.elem(a)},canvas:function(a){a?
a.type="canvas":a={type:"canvas"};return this.elem(a)},input:function(a){a?a.type="input":a={type:"input"};return this.elem(a)},checkbox:function(a){a=a||{};a.attrs=a.attrs||{};a.attrs.type=["checkbox"];return this.input(a)},select:function(a){a?a.type="select":a={type:"select"};return this.elem(a)},option:function(a){a?a.type="option":a={type:"option"};return this.elem(a)},ul:function(a){a?a.type="ul":a={type:"ul"};return this.elem(a)},li:function(a){a?a.type="li":a={type:"li"};return this.elem(a)},
a:function(a){a?a.type="a":a={type:"a"};return this.elem(a)},appendRadio:function(a,b,d,e){var f=templater.div({attrs:{id:[e+"TemplaterWrapper"]},style:{height:46,position:"relative",top:"15px"}});$(a).append(f);a=$("#"+e+"TemplaterWrapper");f="";d=d||0;for(var h=0;h<b.length;h++){var k,l,m;k=b[h];l=k.text;k=k.id;l=this.a({innerHTML:l,attrs:{href:["#"]}});m=[e];h==d&&m.push("on");k=this.li({innerHTML:l,attrs:{"class":m,id:[k]}});f+=k}d=this.ul({innerHTML:f,attrs:{id:[e]}});$(a).append(d);this.radioActivate(b,
e)},radioActivate:function(a,b){for(var d=0;d<a.length;d++){var e,f;e=a[d];f=$("#"+e.id);this.bindRadio(f,b,e.cb)}},bindRadio:function(a,b,d){$(a).click(function(){$("li."+b).removeClass("on");$(this).addClass("on");d&&d()})},tableFromArray:function(a,b,d){var e="";b=b||{};d=d||{};var f=b.table,h=b.tr;b=b.td;var k=d.table,l=d.tr;d=d.td;for(var m=0;m<a.length;m++){var n=a[m];rowInnerHTML="";for(var p=0;p<n.length;p++)rowInnerHTML+=templater.td({innerHTML:n[p],attrs:b?{"class":b.concat()}:void 0,style:d?
d:void 0});e+=templater.tr({innerHTML:rowInnerHTML,attrs:h?{"class":h.concat()}:void 0,style:l?l:void 0})}return templater.table({innerHTML:e,attrs:f?{"class":f.concat()}:void 0,style:k?k:void 0})},style:function(a){return this.styleTemp(a)},elemTemp:_.template("<<%= type%><% for (var attr in attrs) { %><%= ' ' + attr %>='<%= attrs[attr].join(' ') %>'<% } %><%= style ? ' ' : '' %><%= templater.style({style: style}) %>><%= innerHTML %></<%= type %>>"),styleTemp:_.template("<% if (!style) {return ''} %>style='<% for (var stylet in style) { %><%= stylet %>:<%= style[stylet] %>;<% } %>'")};function Dot(a,b,d,e,f,h,k){var l=window.spcs[e];this.x=a;this.y=b;this.v=d;this.m=l.m;this.r=l.r;this.spcName=e;this.elemId=defaultTo(-1,h);this.idNum=l.idNum;this.hF298=defaultTo(0,1E3*l.hF298/N);this.hVap298=defaultTo(0,1E3*l.hVap298/N);this.cvKinetic=1.5*R/N;this.cv=l.cv/N;this.cp=this.cv+R;this.cpLiq=defaultTo(this.cv,l.cpLiq/N);this.spcVolLiq=defaultTo(0.001,l.spcVolLiq/N);this.tag=f;this.returnTo=k;this.tConst=tConst;this.pxToE=pxToE;this.pxToMS=pxToMS;this.parentLists=[];this.internalPotential=
this.temp()*(this.cv-this.cvKinetic);this.peCur=this.tempLast=this.peLast=0;this.active=!0}function Species(a,b,d,e,f,h,k,l,m,n,p,r){this.spcName=a;this.m=b;this.r=d;this.col=e;this.idNum=f;this.cv=h;this.cp=h+R;this.hF298=k;this.hVap298=l;this.antoineCoeffs=m;this.cpLiq=n;this.spcVolLiq=p;this.dots=r.addSpcs(a)}
Species.prototype={populate:function(a,b,d,e,f,h,k,l){l=l||dotManager;var m=a.x;a=a.y;var n=b.dx;b=b.dy;for(var p=[],r=0;r<d;r++){var q=m+Math.random()*n,u=a+Math.random()*b,s=tempToV(this.m,e),t=2*Math.random()*Math.PI,v=s*Math.cos(t),s=s*Math.sin(t);p.push(D(q,u,V(v,s),this.spcName,f,h,k))}l.add(p)},depopulate:function(a){console.trace();a?dotManager.removeByInfo({name:this.def.spcName,tag:a}):dotManager.removeByInfo({name:this.def.spcName})},place:function(a){for(var b=[],d=0;d<a.length;d++){var e=
a[d];b.push(D(e.pos.x,e.pos.y,e.dir.copy().mult(tempToV(this.m,e.temp)),this.spcName,e.tag,void 0,e.returnTo))}dotManager.add(b)},placeSingle:function(a,b,d,e,f){birth=D(a.x,a.y,b.copy().mult(tempToV(this.m,d)),this.spcName,e,void 0,f);dotManager.add(birth)},enthalpy:function(a){return(1E3*this.hF298+(this.cv+R)*(a-298.15))/N},internalEnergy:function(a){return(1E3*this.hF298+this.cv*(a-298.15))/N},tBoil:function(a){a/=MMHGTOBAR;var b=this.antoineCoeffs;return b.b/(b.a-Math.log10(a))-b.c},pPure:function(a){var b=
this.antoineCoeffs;return MMHGTOBAR*Math.pow(10,b.a-b.b/(b.c+a))}};function Point(a,b){this.x=a;this.y=b}function Vector(a,b){this.dx=a;this.dy=b}function Color(a,b,d){this.r=a;this.g=b;this.b=d;this.setHex()}function D(a,b,d,e,f,h,k){return new Dot(a,b,d,e,f,h,k)}function P(a,b){return new Point(a,b)}function V(a,b){return new Vector(a,b)}function Col(a,b,d){return new Color(a,b,d)}
Vector.prototype={UV:function(){var a=Math.sqrt(this.dx*this.dx+this.dy*this.dy);return V(this.dx/a,this.dy/a)},mag:function(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)},add:function(a){this.dx+=a.dx;this.dy+=a.dy;return this},set:function(a){this.dx=a.dx;this.dy=a.dy},neg:function(){this.dx*=-1;this.dy*=-1;return this},dotProd:function(a){return this.dx*a.dx+this.dy*a.dy},magSqr:function(){return this.dx*this.dx+this.dy*this.dy},copy:function(){return new Vector(this.dx,this.dy)},mult:function(a){this.dx*=
a;this.dy*=a;return this},multVec:function(a){this.dx*=a.dx;this.dy*=a.dy;return this},setMag:function(a){this.mult(a/this.mag());return this},adjust:function(a,b){this.dx+=a;this.dy+=b;return this},rotate:function(a){var b=this.dx,d=this.dy;this.dx=b*Math.cos(a)-d*Math.sin(a);this.dy=b*Math.sin(a)+d*Math.cos(a);return this},perp:function(a){var b=this.dx,d=this.dy;a?"cw"==a?(this.dx=d,this.dy=-b):(this.dx=-d,this.dy=b):(this.dx=d,this.dy=-b);return this},angle:function(){return Math.atan2(this.dy,
this.dx)},sameAs:function(a){return this.dx==a.dx&&this.dy==a.dy},isValid:function(){return void 0!==this.dx&&!isNaN(this.dx)&&void 0!==this.dy&&!isNaN(this.dy)}};
Color.prototype={adjust:function(a,b,d){this.r=Math.round(Math.min(255,Math.max(0,this.r+a)));this.g=Math.round(Math.min(255,Math.max(0,this.g+b)));this.b=Math.round(Math.min(255,Math.max(0,this.b+d)));this.setHex();return this},set:function(a){void 0!==a.r&&(this.r=a.r);void 0!==a.g&&(this.g=a.g);void 0!==a.b&&(this.b=a.b);this.setHex();return this},setFromUnround:function(a){void 0!==a.r&&(this.r=Math.round(a.r));void 0!==a.g&&(this.g=Math.round(a.g));void 0!==a.b&&(this.b=Math.round(a.b));this.setHex();
return this},setHex:function(){var a=Number(Math.round(this.r)).toString(16),b=Number(Math.round(this.g)).toString(16),d=Number(Math.round(this.b)).toString(16);1==a.length&&(a="0"+a);1==b.length&&(b="0"+b);1==d.length&&(d="0"+d);this.hex=a+b+d},copy:function(){return new Color(this.r,this.g,this.b)},add:function(a){this.r=Math.round(Math.min(255,Math.max(0,this.r+a.r)));this.g=Math.round(Math.min(255,Math.max(0,this.g+a.g)));this.b=Math.round(Math.min(255,Math.max(0,this.b+a.b)));this.setHex();return this},
addNoBounds:function(a){this.r=Math.round(this.r+a.r);this.g=Math.round(this.g+a.g);this.b=Math.round(this.b+a.b);this.setHex();return this},mult:function(a){this.r=Math.round(Math.min(255,Math.max(0,this.r*a)));this.g=Math.round(Math.min(255,Math.max(0,this.g*a)));this.b=Math.round(Math.min(255,Math.max(0,this.b*a)));this.setHex();return this},sameAs:function(a){return this.r==a.r&&this.g==a.g&&this.b==a.b}};
Point.prototype={distTo:function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)},VTo:function(a){return V(a.x-this.x,a.y-this.y)},fracVTo:function(a,b){return this.VTo(a).mult(b)},fracMoveTo:function(a,b){this.movePt(this.fracVTo(a,b));return this},set:function(a){this.x=a.x;this.y=a.y},avg:function(a){return P((this.x+a.x)/2,(this.y+a.y)/2)},area:function(a,b){var d=V(a.x-this.x,a.y-this.y),e=d.UV(),d=d.mag(),e=V(-e.dy,e.dx),f=V(b.x-this.x,b.y-this.y),e=Math.abs(e.dotProd(f));return 0.5*
d*e},copy:function(){return new Point(this.x,this.y)},movePt:function(a){void 0!==a.dx&&(this.x+=a.dx);void 0!==a.dy&&(this.y+=a.dy);return this},moveInDir:function(a,b){this.x+=Math.cos(b)*a;this.y+=Math.sin(b)*a;return this},position:function(a){void 0!==a.x&&(this.x=a.x);void 0!==a.y&&(this.y=a.y);return this},scale:function(a,b){var d=this.y-a.y;this.x=a.x+(this.x-a.x)*b;this.y=a.y+d*b;return this},rotate:function(a,b){var d=V(a.x,a.y);this.movePt(d.copy().neg());var e=this.x,f=this.y;this.x=
e*Math.cos(b)-f*Math.sin(b);this.y=e*Math.sin(b)+f*Math.cos(b);this.movePt(d);return this},mirror:function(a,b){var d=b.UV(),e=a.VTo(this),d=d.perp("cw"),e=e.dotProd(d);0>e?this.movePt(d.mult(Math.abs(2*e))):0<e&&this.movePt(d.neg().mult(2*e));return this},rect:function(a,b){var d=Array(4);"ccw"==b?(d[0]=this.copy(),d[1]=this.copy().movePt({dy:a.dy}),d[2]=this.copy().movePt(a),d[3]=this.copy().movePt({dx:a.dx})):(d[0]=this.copy(),d[1]=this.copy().movePt({dx:a.dx}),d[2]=this.copy().movePt(a),d[3]=
this.copy().movePt({dy:a.dy}));return d},roundedRect:function(a,b,d){a=this.rect(a,d);return this.roundPts(a,b)},roundPts:function(a,b){this.sameAs(a[0])||(a=[this].concat(a));var d=Array(2*a.length);a["-1"]=a[a.length-1];a.push(a[0]);for(var e=0;e<a.length-1;e++)d[2*e]=a[e].copy().fracMoveTo(a[String(e-1)],b/2),d[2*e+1]=a[e].copy().fracMoveTo(a[String(e+1)],b/2);return d},sameAs:function(a){return this.x==a.x&&this.y==a.y},closeTo:function(a){return 1>Math.abs(this.x-a.x)&&1>Math.abs(this.y-a.y)},
isValid:function(){return void 0!==this.x&&!isNaN(this.x)&&void 0!==this.y&&!isNaN(this.y)},track:function(a){if(a instanceof Point)b=a,e=a=d=!1;else{var b=a.pt,d=a.offset,e=defaultTo("",a.noTrack);a=e.indexOf("x")+1;var e=e.indexOf("y")+1}this.trackListenerId=unique(this.x+","+this.y+"tracksWithUniqueId",curLevel.updateListeners);if(isNaN(this.x)||isNaN(this.y))console.log("Trying to track NaN!"),console.trace();if(!a&&!e)if(d)d.dx?f=function(){this.x=b.x+d.dx;this.y=b.y}:d.dy?f=function(){this.x=
b.x;this.y=b.y+d.dy}:d.dy&&d.dx&&(f=function(){this.x=b.x+d.dx;this.y=b.y+d.dy});else var f=function(){this.x=b.x;this.y=b.y};else a?d?d.dy&&(f=function(){this.y=b.y+d.dy}):f=function(){this.y=b.y}:e&&(d?d.dx&&(f=function(){this.x=b.x+d.dx}):f=function(){this.x=b.x});addListener(curLevel,"update",this.trackListenerId,f,this);f||(console.log("tried to track "+this.trackListenerId+" but input wasn't right"),console.trace());this.tracking=!0;return this},trackStop:function(){this.tracking&&(removeListener(curLevel,
"update",this.trackListenerId),this.trackListenerId=void 0,this.tracking=!1);return this}};
Dot.prototype={KE:function(){return 0.5*this.m*(this.v.dx*this.v.dx+this.v.dy*this.v.dy)},temp:function(){return 0.5*this.m*(this.v.dx*this.v.dx+this.v.dy*this.v.dy)*this.tConst},tempCondense:function(){return(this.cv*(this.temp()-298.15)+this.hVap298)/this.cpLiq+298.15},tempVaporize:function(a){return(this.cpLiq*(this.temp()-298.15)-this.hVap298)/this.cv+298.15},hVap:function(){return this.hVap298+(this.temp()-298.15)*(this.cv-this.cpLiq)},setTemp:function(a){var b=this.temp();this.v.mult(Math.sqrt(a/
b));this.internalPotential*=a/b;return this},setTempNoReference:function(a){var b=this.v.UV(),d=Math.sqrt(2*a/(this.m*this.tConst));this.v.dx=b.dx*d;this.v.dy=b.dy*d;this.internalPotential=a*(this.cv-this.cvKinetic)},addEnergy:function(a){var b=this.temp();tF=Math.max(1,b+a/this.cv);this.setTemp(tF);return(tF-b)*this.cv},setWall:function(a){this.setReturnTo(a);this.setTag(a)},setReturnTo:function(a){this.returnTo=a},setTag:function(a){this.tag=a},adjTemp:function(a){var b=this.temp();this.internalPotential+=
a*(this.cv-this.cvKinetic)/this.N;this.v.mult(Math.sqrt((b+a)/b));return this},enthalpy:function(){return this.hF298+(this.temp()-298.15)*(this.cv+R/N)},internalEnergy:function(){return this.hF298+(this.temp()-298.15)*this.cv},kineticEnergy:function(){return this.temp()*this.cvKinetic},speed:function(){return this.v.mag()*this.pxToMS},kill:function(){for(var a=0;a<this.parentLists.length;a++)this.parentLists[a].splice(this.parentLists[a].indexOf(this),1);this.parentLists.splice(0,this.parentLists.length);
this.active=!1}};toInherit={gridder:{makeGrid:function(){for(var a=this.numCols,b=this.numRows,d=Array(a),e=0;e<a;e++){for(var f=Array(b),h=0;h<b;h++)f[h]=[];d[e]=f}return d}},ArrayExtenders:{pushNumber:function(a){!isNaN(a)&&void 0!==a&&this.push(a);return this},append:function(a){for(var b=0;b<a.length;b++)this.push(a[b]);return this},average:function(){for(var a=0,b=0;b<this.length;b++)a+=this[b];return a/this.length},switchElements:function(a,b){var d=this[a];this[a]=this[b];this[b]=d;return this}},MathExtenders:{log10:function(a){return Math.log(a)/
2.302585092994046}},StringExtenders:{killWhiteSpace:function(){return this.replace(/\s+/g,"")},killNumbers:function(){return this.replace(/[0-9]/g,"")},toCamelCase:function(){return this.replace(/(?:^\w|[A-Z]|\b\w)/g,function(a,b){return 0==b?a.toLowerCase():a.toUpperCase()}).replace(/\s+/g,"")},toCapitalCamelCase:function(){return this.replace(/(?:^\w|[A-Z]|\b\w)/g,function(a,b){return a.toUpperCase()}).replace(/\s+/g,"")},sanitize:function(){return this.replace(/'/g,"&#39;").replace(/"/g,"&#34;").replace(/</g,
"&#60;").replace(/>/g,"&#62;").replace(/{/g,"&#123;").replace(/}/g,"&#125;")}},ArrowFuncs:{getPts:function(){var a=Array(3),b=this.dims.dx,d=this.dims.dy;a[0]=P(0,0.2*d);a[1]=P(0.7*b,0.2*d);a[2]=P(0.7*b,0.5*d);d=deepCopy(a).reverse();a.push(P(b,0));for(b=0;b<d.length;b++)a.push(P(d[b].x,-d[b].y));return a}}};R=8.314;function gauss(a,b){var d=Math.random()+Math.random()+Math.random()-1.5;return a+d*b}function bound(a,b,d){return Math.min(Math.max(a,b),d)}function stepTowards(a,b,d){d=Math.abs(d);return a<b?Math.min(b,a+d):Math.max(b,a-d)}function changeTemp(a,b){for(var d=dotManager.get(a),e=0;e<d.length;e++)d[e].setTemp(b)}function changeRMS(a,b){for(var d=dotManager.get(a),e=rms(dataHandler.velocities(a)),e=b/e,f=0;f<d.length;f++)d[f].v.mult(e)}
function tempToV(a,b){b=2*b/tConst;return Math.sqrt(b/a)}function VToTemp(a,b){return 0.5*a*b*b*tConst}function tempToKE(a){return a/tConst}function returnEscapist(a){returnTo=defaultTo(0,a.returnTo);var b=walls[returnTo][0],d=walls[returnTo][1],e=walls[returnTo].wallUVs[0],f=(b.x+d.x)/2-5*e.dy,b=(b.y+d.y)/2+5*e.dx;a.v.dy=Math.abs(a.v.dy);a.x=f;a.y=b}function defaultTo(a,b){return void 0===b?a:b}function validNumber(a){return isNaN(a)||void 0===a?!1:a}
function round(a,b){var d=Math.pow(10,b);return Math.round(a*d)/d}function unique(a,b){if("function"==typeof b){if(b(a)){for(var d=1;b(a+d);)d++;return a+d}}else if(b[a]){for(d=1;b[a+d];)d++;return a+d}return a}function addListener(a,b,d,e,f){a[b+"Listeners"][d]={func:e,obj:f}}function addListenerOnce(a,b,d,e,f){a[b+"Listeners"][d]={func:e,obj:f};a[b+"Listeners"][d+"Remove"]={func:function(){removeListener(a,b,d);removeListener(a,b,d+"Remove")},obj:""}}
function addInterval(a,b,d,e){extraIntervals[a]=window.setInterval(function(){b.apply(d)},e)}function removeInterval(a){extraIntervals[a]&&(window.clearInterval(extraIntervals[a]),extraIntervals[a]=void 0)}function removeListener(a,b,d){delete a[b+"Listeners"][d]}function removeListenerByName(a,b,d){for(var e=!1,f=getListenerByName(a,b,d);void 0!==f;)e=!0,delete a[b+"Listeners"][f],f=getListenerByName(a,b,d);return e}function makeListenerHolder(a,b){a[b+"Listeners"]={};return a[b+"Listeners"]}
function listenerExists(a,b,d){return void 0!==a[b+"Listeners"][d]}function emptyListener(a,b){a[b+"Listeners"]={}}function getListenerByName(a,b,d){for(thisFuncName in a[b+"Listeners"])if(-1!=thisFuncName.indexOf(d))return thisFuncName}function store(a,b){stored[a]=b}function getStore(a){return stored[a]}function eraseStore(a){a?stored[a]=void 0:stored={}}
function getAndEval(a){if("number"==typeof a)return a;if("string"==typeof a)return interpreter.interpInput(a);if("boolean"==typeof a)return a;if(a instanceof Point){var b=this.getAndEval(a.x);a=this.getAndEval(a.y);return P(b,a)}if(a instanceof Vector)return b=this.getAndEval(a.dx),a=this.getAndEval(a.dy),V(b,a);if(a instanceof Color){var b=this.getAndEval(a.r),d=this.getAndEval(a.g);a=this.getAndEval(a.b);return Col(b,d,a)}if(a instanceof Array){b=[];for(d=0;d<a.length;d++)b.push(this.getAndEval(a[d]));
return b}if("function"==typeof a)return a;if(a instanceof Object){b={};for(d in a)b[d]=this.getAndEval(a[d]);return b}}function deepCopy(a){var b=new a.constructor,d;for(d in a)b[d]="object"==typeof a[d]?deepCopy(a[d]):a[d];return b}function deepCopySafe(a){return deepCopyStep(a,[a],[])}
function deepCopyStep(a,b,d){var e;try{e=new a.constructor}catch(f){e={}}d.push(e);for(var h in a){var k=a[h];if("object"==typeof k){var l=b.indexOf(k);e[h]=-1==l?deepCopyStep(k,b.concat([k]),d.concat()):d[l]}else e[h]=k}return e}function recordData(a,b,d,e,f){f=defaultTo("record",f);store("record"+a,f);addListener(curLevel,f,a,function(){b.push(d.apply(e))},e)}function recordDataStop(a){var b=getStore("record"+a);removeListener(curLevel,b,a)}
function grabAttrs(a,b){var d={},e;for(e in a){d[e]={};for(var f=0;f<b.length;f++)d[e][b[f]]=a[e][b[f]]}return d}function execListeners(a){for(var b in a){var d=a[b];d.func.apply(d.obj)}}
function makeSlider(a,b,d,e,f,h,k){var l="";e=""+templater.center({innerHTML:e});l+=templater.div({attrs:{id:[d+"parent"]},style:{padding:"5px"},innerHTML:templater.div({attrs:{id:[d]}})});a.append(e);b.append(l);$("#"+d+"parent");l=$("#"+d);addJQueryElems($(l),"slider");l.slider("option",f);for(f=0;f<h.length;f++){var m=h[f];e=m.eventType;var n=m.obj,m=m.func;void 0===n?sliderBind(l,e,m,""):sliderBind(l,e,m,n)}if(k)div[k]();sliderList.push(d);return[a,b]}
function sliderBind(a,b,d,e){a.bind(b,function(a,b){d.apply(e,[a,b])});return a}function addJQueryElems(a,b){a=a instanceof Array?a:[a];for(var d=0;d<a.length;d++){var e=a[d];$(e)[b]();recursiveAddClass(e,globalHTMLClass)}}function getObjFromPath(a,b){if(!a||""==a)return b;var d=/[^\.]{1,}/.exec(a)[0];a=a.slice(a.indexOf(d)+d.length,a.length);if(newObj=b[d])return getObjFromPath(a,newObj);console.log("tried to get bad obj path "+a+" from object "+b);console.trace()}
function recursiveAddClass(a,b){$(a).addClass(b);for(var d=$(a).children(),e=0;e<d.length;e++){var f=$(d[e]);recursiveAddClass(f,b)}}function addButton(a,b,d){d=defaultTo("buttons",d);$("#"+d).append(templater.button({attrs:{id:[a]},innerHTML:b}));a=$("button#"+a);addJQueryElems(a,"button");return a}function hideSliders(){for(;0<sliderList.length;idIdx++)$("#"+sliderList[0]).hide()}function S(a,b,d){sceneNavigator.showPrompt(a,b,d)}function alertValid(a){void 0!==a&&""!=a&&alert(a)}
function fillEmptyGraphDivs(){for(var a=0;a<graphHolderDivs.length;a++)fillEmptyGraphDiv($("#"+graphHolderDivs[a]))}function fillEmptyGraphDiv(a){"empty"==$(a).attr("filledWith")&&new GraphBlank(a)}function rotatePts(a,b,d){for(var e=0;e<a.length;e++)a[e].rotate(b,d)}function mirrorPts(a,b,d){for(var e=0;e<a.length;e++)a[e].mirror(b,d);return a}function angleToUV(a){return V(Math.cos(a),Math.sin(a))}function UVToAngle(a){return Math.atan2(a.dy,a.dx)}
function getSign(a){var b=1;0!=a&&(b=Math.abs(a)/a);return b}function fracDiff(a,b){return Math.abs(a-b)/Math.min(Math.abs(a),Math.abs(b))}function getLen(a){for(var b=0,d=0;d<a.length-1;d++)b+=a[d].distTo(a[d+1]);return b}function inPrompt(){return/prompt/i.test(currentSetupType)}function nameVar(a){return"section"==currentSetupType?a+"S"+sectionIdx:a+"S"+sectionIdx+"P"+promptIdx}
function byAttr(a,b,d){if(a instanceof Array)for(var e=0;e<a.length;e++){if(a[e][d]==b)return a[e]}else for(e in a)if(a[e][d]==b)return a[e]}function inRect(a,b,d){d=mouseOffset(d);return d.x>=a.x&&d.x<=a.x+b.dx&&d.y>=a.y&&d.y<=a.y+b.dy}function ptInRect(a,b,d){return d.x>=a.x&&d.x<=a.x+b.dx&&d.y>=a.y&&d.y<=a.y+b.dy}function extend(a,b){return function(){return b(a())}}function countAttrs(a){var b=0,d;for(d in a)b++;return b}
function objectsEqual(a,b){return Math.min(objectsEqualInDirection(a,b),objectsEqualInDirection(b,a))}function objectsEqualInDirection(a,b){for(var d in a)if(b&&b.hasOwnProperty(d))if("object"==typeof a[d]){if(!objectsEqual(a[d],b[d]))return!1}else{if(a[d]!=b[d])return!1}else return!1;return!0}function rms(a){for(var b=0,d=0;d<a.length;d++)b+=a[d]*a[d];b/=a.length;return Math.sqrt(b)}globalMousePos=P(0,0);
function mouseOffset(a){a=$(a).offset();return P(globalMousePos.x-a.left,globalMousePos.y-a.top)}function mouseOffsetDiv(a){a=$("#"+a).offset();return P(globalMousePos.x-a.left,globalMousePos.y-a.top)}$(document).mousemove(function(a){globalMousePos.x=a.pageX;globalMousePos.y=a.pageY;for(var b in curLevel.mousemoveListeners)a=curLevel.mousemoveListeners[b],a.func.apply(a.obj)});$(document).mousedown(function(a){for(var b in curLevel.mousedownListeners)a=curLevel.mousedownListeners[b],a.func.apply(a.obj)});
$(document).mouseup(function(a){for(var b in curLevel.mouseupListeners)a=curLevel.mouseupListeners[b],a.func.apply(a.obj)});function DrawingTools(){}
DrawingTools.prototype={clear:function(a){var b=myCanvas.width,d=myCanvas.height;c.clearRect(0,0,b,d);c.fillStyle=a.hex;c.fillRect(0,0,b,d)},dots:function(){for(var a in spcs){var b=spcs[a].dots;c.fillStyle=spcs[a].col.hex;if(b[0])var d=b[0].r;for(var e=0;e<b.length;e++)c.beginPath(),c.arc(b[e].x,b[e].y,d,0,2*Math.PI,!0),c.closePath(),c.fill()}},dotsAsst:function(a){for(var b=0;b<a.length;b++)c.fillStyle=spcs[a[b].spcName].col.hex,c.beginPath(),c.arc(a[b].x,a[b].y,a[b].r,0,2*Math.PI,!0),c.closePath(),
c.fill()},walls:function(a,b){for(var d=0;d<a.length;d++){var e=a[d];if(e.show){c.beginPath();c.strokeStyle=e.col.hex;c.moveTo(e[0].x,e[0].y);for(var f=1;f<e.length-1;f++){var h=e[f];c.lineTo(h.x,h.y)}c.closePath();c.stroke()}}},circle:function(a,b,d,e,f){f.beginPath();f.arc(a.x,a.y,b,0,2*Math.PI,!0);f.closePath();e?(f.fillStyle=d.hex,f.fill()):(f.strokeStyle=d.hex,f.stroke())},fillPts:function(a,b,d){d.fillStyle=b.hex;d.beginPath();d.moveTo(a[0].x,a[0].y);for(b=1;b<a.length;b++)d.lineTo(a[b].x,a[b].y);
d.closePath();d.fill()},fillPtsAlpha:function(a,b,d,e){var f=e.globalAlpha;e.globalAlpha=d;draw.fillPts(a,b,e);e.globalAlpha=f},fillPtsStroke:function(a,b,d,e){e.fillStyle=b.hex;e.strokeStyle=d.hex;e.beginPath();e.moveTo(a[0].x,a[0].y);for(b=1;b<a.length;b++)e.lineTo(a[b].x,a[b].y);e.closePath();e.stroke();e.fill()},roundedRect:function(a,b,d,e,f){var h=a.x;a=a.y;var k=b.dx;b=b.dy;f.fillStyle=e.hex;f.beginPath();f.moveTo(h+d,a);this.curvedLine(P(h+k-d,a),P(h+k,a),P(h+k,a+d),f);this.curvedLine(P(h+
k,a+b-d),P(h+k,a+b),P(h+k-d,a+b),f);this.curvedLine(P(h+d,a+b),P(h,a+b),P(h,a+b-d),f);this.curvedLine(P(h,a+d),P(h,a),P(h+d,a),f);f.closePath();f.fill()},fillRect:function(a,b,d,e){e.fillStyle=d.hex;e.fillRect(a.x,a.y,b.dx,b.dy)},fillStrokeRect:function(a,b,d,e,f){f.strokeStyle=e.hex;f.fillStyle=d.hex;f.fillRect(a.x,a.y,b.dx,b.dy);f.strokeRect(a.x,a.y,b.dx,b.dy)},strokeRect:function(a,b,d,e){e.strokeStyle=d.hex;e.strokeRect(a.x,a.y,b.dx,b.dy)},line:function(a,b,d,e){e.strokeStyle=d.hex;e.beginPath();
e.moveTo(a.x,a.y);e.lineTo(b.x,b.y);e.closePath();e.stroke()},curvedLine:function(a,b,d,e){e.lineTo(a.x,a.y);e.quadraticCurveTo(b.x,b.y,d.x,d.y)},path:function(a,b,d){d.strokeStyle=b.hex;d.beginPath();d.moveTo(a[0].x,a[0].y);for(b=1;b<a.length;b++)d.lineTo(a[b].x,a[b].y);d.stroke()},text:function(a,b,d,e,f,h,k){k.save();k.translate(b.x,b.y);k.rotate(h);k.fillStyle=e.hex;k.font=d;k.textAlign=f;b=parseFloat(d);d=0;for(e=a.indexOf("\n");-1!=e;)f=a.slice(0,e),k.fillText(f,0,d),d+=b+2,a=a.slice(e+1,a.length),
e=a.indexOf("\n");k.fillText(a,0,d);k.restore()}};function DotManager(){this.lists={ALLDOTS:[]};this.spcLists={};this.count=0}
DotManager.prototype={add:function(a){a instanceof Array?this.count+=a.length:this.count++;this.execAllCombos(this.addFunc,a)},remove:function(a){if(a instanceof Array){this.count-=a.length;for(var b=0;b<a.length;b++)a[b].kill()}else this.count--,a.kill()},removeByAttr:function(a,b){for(var d=this.lists.ALLDOTS,e=d.length-1;0<=e;e--)d[e][a]==b&&d[e].kill()},changeDotSpc:function(a,b){a instanceof Array||(a=[a]);for(var d=spcs[b],e=0;e<a.length;e++){var f=a[e],h=(f.hF298-1E3*d.hF298/N+f.cv*(f.temp()-
298.15))/(d.cv/N)+298.15;if(0<h){for(var k=0;k<f.parentLists.length;k++)f.parentLists[k].splice(f.parentLists[k].indexOf(f),1);f.parentLists=[];f.m=d.m;f.r=d.r;f.col=d.col;f.spcName=d.spcName;f.hF298=1E3*d.hF298/N;f.hVap298=1E3*d.hVap298/N;f.idNum=d.idNum;f.cvKinetic=1.5*R/N;f.cv=d.cv/N;f.cp=f.cv+R;f.cpLiq=d.cpLiq/N;f.spcVolLiq=d.spcVolLiq/N;f.setTempNoReference(h);h=this.getRelevantLists(f);for(k=0;k<h.length;k++)f.parentLists.push(h[k]),f.parentLists[f.parentLists.length-1].push(f)}}},addSpcs:function(a){this.lists[a]||
(this.lists[a]=[],this.spcLists[a]=this.lists[a]);return this.lists[a]},removeByInfo:function(a){a.spcName&&a.tag?this.execAllCombos(this.removeByNameAndTagFunc,a):a.spcName?this.execAllCombos(this.removeByNameFunc,a):a.tag?this.execAllCombos(this.removeByTagFunc,a):(console.log("No useful info given to removeByInfo func in DotManager"),console.trace())},getWithLog:function(a){var b=this.get(a);if(b)return b;console.log("Bad species data");console.log(a)},get:function(a){if(a){if(a.spcName&&a.tag)return this.lists[a.spcName+
"-"+a.tag];if(a.spcName)return this.lists[a.spcName];if(a.tag)return this.lists[a.tag]}else return this.lists.ALLDOTS},clearAll:function(){for(var a in this.lists)this.lists[a].splice(0,this.lists[a].length)},createIfNotExists:function(a){return a.spcName&&a.tag?this.getByNameAndTag(a):a.spcName?this.getByName(a.spcName):a.tag?this.getByTag(a.tag):this.lists.ALLDOTS},addFunc:function(a,b){a.push(b);b.parentLists.push(a)},removeFunc:function(a,b){var d=a.indexOf(b);-1<d?(a.splice(d,1),b.parentLists.splice(b.parentLists.indexOf(a),
1)):(console.log("Tried to remove dot from global list of spcName "+b.spcName+" and tag "+b.tag+". Dot not present."),console.trace())},removeByNameAndTagFunc:function(a,b){for(var d=a.length-1;-1<d;d--)a[d].spcName==b.spcName&&a[d].tag==b.tag&&a[d].kill()},removeByNameFunc:function(a,b){for(var d=a.length-1;-1<d;d--)a[d].spcName==b.spcName&&(a.splice(d,1),a[d].kill())},removeByNameAndTagFunc:function(a,b){for(var d=a.length-1;-1<d;d--)a[d].tag==b.tag&&(a.splice(d,1),a[d].kill())},execAllCombos:function(a,
b){if(b instanceof Array&&b.length)var d=b,e={spcName:d[0].spcName,tag:d[0].tag};else e=b;e=this.getRelevantLists(e);if(d)for(var f=0;f<d.length;f++)this.execFuncOnLists(a,e,d[f]);else b instanceof Dot&&this.execFuncOnLists(a,e,b)},execFuncOnLists:function(a,b,d){d.active=!0;for(var e=0;e<b.length;e++)a(b[e],d)},getRelevantLists:function(a){var b=[];b.push(this.lists.ALLDOTS);a.spcName&&a.tag&&b.push(this.getByNameAndTag(a));a.spcName&&b.push(this.getByName(a.spcName));a.tag&&b.push(this.getByTag(a.tag));
return b},getByNameAndTag:function(a){this.lists[a.spcName+"-"+a.tag]||(this.lists[a.spcName+"-"+a.tag]=[]);return this.lists[a.spcName+"-"+a.tag]},getByName:function(a){if(this.lists[a])return this.lists[a];if(spcs[a])return this.lists[a]=[],this.lists[a];console.log("Tried to get bad spcName "+a);console.trace()},getByTag:function(a){this.lists[a]||(this.lists[a]=[]);return this.lists[a]}};AuxFunctions={getDims:function(){var a=$("#main").height(),a=a-$("#auxSpacer").height();return V(400,a/2)},pickParentDiv:function(a,b){if(void 0===b){for(var d=0;d<auxHolderDivs.length;d++){var e=$("#"+auxHolderDivs[d]),f=$(e).attr("filledWith");if(""==f)return $(e).attr("filledWith",a),e}console.log("Aux divs are all full!");console.trace()}else{e=$("#"+auxHolderDivs[b]);if(!e.length)return console.log("Bad div idx "+b+".  Defaulting to next empty slot"),this.pickParentDiv(a);f=$(e).attr("filledWith");
if(""==f||void 0==f)return $(e).attr("filledWith",a),e;console.log("Trying to add "+a+" in "+b+" but "+b+" is already filled with "+f+".");console.log("Defaulting to next empty slot");return this.pickParentDiv(a)}},cleanUpParent:function(){$(this.parentDiv).removeAttr("style");$(this.parentDiv).html("");$(this.parentDiv).attr("filledWith","")}};function PhaseEquilGenerator(){}
PhaseEquilGenerator.prototype={constP:function(a,b,d,e,f){var h=a.tBoil(e),k=b.tBoil(e),l=h<k?a:b;a=h>k?a:b;d=this.makeConstPEquil(e,l,a,h<k?h:k,h>k?h:k,d[l.spcName],d[a.spcName],f);return new PhaseEquilGenerator.EquilData(d,l.spcName,a.spcName)},makeConstPEquil:function(a,b,d,e,f,h,k,l){for(var m=[],n=1/(l-1),p=0,r=0;p<l;p++){var q=this.solveTAtStep(e+(f-e)*r,a,r,b,d,e,f,h,k),u=this.solvePTotal(q,r,b,d,h,k),s=this.pSpc(b,q,h,1-r);m.push(new PhaseEquilGenerator.EquilPt(1-r,r,s/u,1-s/u,q,a));r+=n}return m},
solveTAtStep:function(a,b,d,e,f,h,k,l,m){for(var n=this.solvePTotal(a,d,e,f,l,m);0.01<fracDiff(n,b);){var p=this.getDPDT(a,d,e,f,h,k,l,m);a+=(b-n)/p;a=bound(a,h,k);n=this.solvePTotal(a,d,e,f,l,m)}return a},getDPDT:function(a,b,d,e,f,h,k,l){f=0.995*a;a*=1.005;h=this.solvePTotal(f,b,d,e,k,l);return(this.solvePTotal(a,b,d,e,k,l)-h)/(a-f)},solvePTotal:function(a,b,d,e,f,h){d=this.pSpc(d,a,f,1-b);a=this.pSpc(e,a,h,b);return d+a},pSpc:function(a,b,d,e){return a.pPure(b)*d(e,b)*e}};
PhaseEquilGenerator.EquilPt=function(a,b,d,e,f,h){this.xLight=a;this.xHeavy=b;this.yLight=d;this.yHeavy=e;this.temp=f;this.pressure=h};PhaseEquilGenerator.EquilData=function(a,b,d){this.data=a;this.keyLight=b;this.keyHeavy=d};GraphBase={setStds:function(){this.hashMarkLen=10;this.checkMarkOversize=3;this.bgCol=curLevel.bgCol;this.gridCol=Col(72,72,72);this.toggleCol=Col(255,255,255);this.data={};this.legend={};this.markers={};this.textCol=Col(255,255,255);this.flashMult=1.5;this.flashRate=0.1;this.graphBoundCol=Col(255,255,255);this.integralCol=Col(150,150,150);this.integralAlpha=0.5;this.ptStroke=Col(0,0,0);this.rectSideLen=8;this.characLen=Math.sqrt(Math.pow(this.rectSideLen,2)/2);this.buttonId=this.handle+"Reset";this.graphId=
this.handle+"Graph";this.parentDiv=this.pickParentDiv("graph");this.parentDivId=$(this.parentDiv).attr("id");this.makeReset=defaultTo(!0,this.makeReset);var a=this.makeCanvas(this.dims,this.parentDiv,this.handle+"Graph",this.makeReset,this.handle+"Button");this.graphDisplayHTMLElement=a.HTMLElem;this.graphDisplay=a.canvas;this.layers=new GraphBase.Layers;this.wrapperId;addListener(curLevel,"update","drawLayers"+this.handle,this.drawLayers,this);this.hasData=!1},makeDataFunc:function(a){with(DataGetFuncs)return eval("(function() { return "+
a+"})")},setNumGridLinesAndSpacing:function(a){var b,d,e;a=a?a:{};a.x?(b=a.x,d=this.getGridSpacing(b,this.graphRangeFrac.x,this.dims.dx)):(d=40,b=Math.ceil(this.dims.dx*Math.abs(this.graphRangeFrac.x.max-this.graphRangeFrac.x.min)/d));a.y?(a=a.y,e=this.getGridSpacing(a,this.graphRangeFrac.y,this.dims.dy)):(e=40,a=Math.ceil(this.dims.dy*Math.abs(this.graphRangeFrac.y.max-this.graphRangeFrac.y.min)/e));this.numGridLines=P(b,a);this.gridSpacing=P(d,e)},makeCanvas:function(a,b,d,e,f){var h=this;b.html("");
a=templater.canvas({attrs:{id:[d],"class":["noSelect"],width:[a.dx],height:[a.dy]}});e&&(a+=templater.button({attrs:{id:[f]},style:{position:"absolute",right:".5em",bottom:".5em"},innerHTML:templater.img({attrs:{src:["img/refresh.gif"]}})}));a=$(a);$(b).append(a);e&&(addJQueryElems($("#"+f),"button"),$("#"+f).click(function(){h.reset()}));b=document.getElementById(d);d=b.getContext("2d");return{HTMLElem:b,canvas:d}},restoreHTML:function(){var a=this.makeCanvas(this.dims,this.parentDiv,this.handle+
"Graph",this.makeReset,this.handle+"Button");this.graphDisplayHTMLElement=a.HTMLElem;this.graphDisplay=a.canvas;if(this.legend)for(var b in this.legend)this.legend[b].setCheckMarkCanvas(this.graphDisplay)},clearHTML:function(){this.cleanUpParent()},remove:function(){this.disable();removeListener(curLevel,"update","drawLayers"+this.handle);removeListenerByName(curLevel,"update","flashAdvance"+this.handle);this.layers.removeAll();this.cleanUpParent();return this},enable:function(a){for(var b in this.data)this.data[b].recordStart();
this.active=!0;if(a){for(b in this.data)this.data[b].addVal();this.addLast()}return this},disable:function(){for(var a in this.data)this.data[a].recordStop();this.active=!1;return this},integrate:function(a){this.data[a].integralPts=this.getIntegralPts(a);this.drawIntegral(a);return this},getIntegralPts:function(a){var b=this.data[a].src.x,d=this.data[a].src.y;a=Array(b.length);for(var e=0;e<b.length;e++)a[e]=this.valToCoord(P(b[e],d[e]));b=this.yStart*this.dims.dy;d=a[0].x;a.push(P(a[a.length-1].x,
b));a.push(P(d,b));return a},setData:function(a,b){var d=this.data[a];d?d.setData(b):console.log("Bad set handle "+a)},save:function(a){a=defaultTo("graph"+this.handle,a);a=unique(a,stored);this.dataSave={};return a},load:function(){this.makeCanvas(this.dims);var a=[],b;for(b in this.data)this.data[b].x=[],this.data[b].y=[],this.data[b].src.x=deepCopy(this.dataSave[b].src.x),this.data[b].src.y=deepCopy(this.dataSave[b].src.y),a=a.concat(this.setsToPts(this.dataSave[b].pts.x,this.dataSave[b].pts.y,
b));this.addPts(a,!1,!0);return this},setsToPts:function(a,b,d){for(var e=Array(a.length),f=0;f<a.length;f++)e[f]={x:a[f],y:b[f],address:d};return e},drawAllBG:function(){this.drawBGRect();this.drawGrid();this.drawBounds();this.legend&&this.drawLegend();this.drawLabels()},drawBGRect:function(){draw.roundedRect(P(0,0),V(this.dims.dx,this.dims.dy),20,this.bgCol,this.graphDisplay)},drawGrid:function(){for(var a=0;a<this.numGridLines.x;a++){var b=this.graphRangeFrac.x.min*this.dims.dx+this.gridSpacing.x*
a,d=this.graphRangeFrac.y.max*this.dims.dy,e=P(b,this.graphRangeFrac.y.min*this.dims.dy+this.hashMarkLen),b=P(b,d);draw.line(e,b,this.gridCol,this.graphDisplay)}for(a=0;a<this.numGridLines.y;a++)b=this.graphRangeFrac.y.min*this.dims.dy-this.gridSpacing.y*a,d=this.graphRangeFrac.x.min*this.dims.dx,e=P(this.graphRangeFrac.x.max*this.dims.dx-this.hashMarkLen,b),b=P(d,b),draw.line(e,b,this.gridCol,this.graphDisplay)},drawBounds:function(){var a=P(this.graphRangeFrac.x.min*this.dims.dx,this.graphRangeFrac.y.max*
this.dims.dy),b=V(this.dims.dx*(this.graphRangeFrac.x.max-this.graphRangeFrac.x.min),this.dims.dy*(this.graphRangeFrac.y.min-this.graphRangeFrac.y.max));draw.strokeRect(a,b,this.graphBoundCol,this.graphDisplay)},drawLabels:function(){var a=P(this.dims.dx*(this.graphRangeFrac.x.min+this.graphRangeFrac.x.max)/2,Math.min(this.dims.dy*this.graphRangeFrac.y.min+50,this.dims.dy-20)),b=P(Math.max(this.dims.dx*this.graphRangeFrac.x.min-50,20),this.dims.dy*(this.graphRangeFrac.y.min+this.graphRangeFrac.y.max)/
2);a.y+=this.labelFontSize/2;b.y+=this.labelFontSize/2;draw.text(this.xLabel,a,this.labelFont,this.textCol,"center",0,this.graphDisplay);draw.text(this.yLabel,b,this.labelFont,this.textCol,"center",-Math.PI/2,this.graphDisplay)},drawLegend:function(){for(var a in this.legend){var b=this.legend[a],d=b.text;this.drawLegendToggle(b);draw.text(d,b.textPos,this.legendFont,this.textCol,"left",0,this.graphDisplay);this.drawPtStd(b.pos,b.col)}},drawMarkers:function(){for(var a in this.markers)this.markers[a].draw()},
clearData:function(a,b){var d=this.data[a];d&&d.clearData();b&&this.drawAllData()},enqueueData:function(a,b){var d=this.data[a];d&&d.enqueueData(b)},updateRange:function(){var a=this.valRange.copy(),b;for(b in this.data)this.data[b].updateRange(this.valRange);this.setAxisBounds(a)},flushQueues:function(a,b){b=defaultTo(!1,b);a=defaultTo(!0,a);var d=this.valRange.copy(),e;for(e in this.data){var f=this.data[e];f.visible&&f.updateRange(this.valRange)}f=this.axisRange.copy();this.setAxisBounds(d);if(!this.rangeIsSame(f.x,
this.axisRange.x)||!this.rangeIsSame(f.y,this.axisRange.y))b=!0;b?this.drawAllData():this.drawPts();a&&this.flashInit();for(e in this.data)this.data[e].flushQueue();this.drawLayers()},drawLayers:function(){if(turn%2&&this.hasData&&this.layers.count){this.drawAllData();for(var a=0;a<this.layers.layers.length;a++)for(var b=this.layers.layers[a],d=0;d<b.length;d++)b[d].draw()}},flashInit:function(){for(var a in this.data)this.data[a].flashInit()},rangeIsSame:function(a,b){return!(a.max!=b.max||a.min!=
b.min)},getGridSpacing:function(a,b,d){b=d*Math.abs(b.max-b.min);return(b-20)/(a-1)},setAxisBounds:function(a){this.setAxisBoundsX(a);this.setAxisBoundsY(a)},setAxisBoundsX:function(a){var b=this.axisInit,d=this.valRange;!(b.x.min<d.x.min&&b.x.max>d.x.max)&&!this.axesFixed.x?a?this.rangeIsSame(a.x,this.valRange.x)||this.getXBounds():this.getXBounds():this.setAxisToInit("x")},setAxisBoundsY:function(a){var b=this.axisInit,d=this.valRange;!(b.y.min<d.y.min&&b.y.max>d.y.max)&&!this.axesFixed.y?a?this.rangeIsSame(a.y,
this.valRange.y)||this.getYBounds():this.getYBounds():this.setAxisToInit("y")},setAxisToInit:function(a){var b=this.axisRange[a],d=this.axisInit[a],e=this.numGridLines[a];b.min=d.min;b.max=d.max;this.stepSize[a]=(b.max-b.min)/(e-1)},getXBounds:function(){var a=this.valRange.x.max-this.valRange.x.min,b=void 0,d=void 0;0!=a?(b=a/(this.numGridLines.x-2),d=Math.pow(10,Math.floor(Math.log10(b))),a=Math.ceil(b/d)*d,b=Math.floor(this.valRange.x.min/a)*a,d=b+(this.numGridLines.x-1)*a):(a=0.2,b=Math.floor(this.valRange.x.min),
d=b+a*this.numGridLines.x);if(b<this.axisRange.x.min||d>this.axisRange.x.max)this.axisRange.x.min=b,this.axisRange.x.max=d,this.stepSize.x=a},getYBounds:function(){var a=Math.abs(this.valRange.y.max-this.valRange.y.min),b=void 0,d=void 0;0!=a?(b=a/(this.numGridLines.y-2),d=Math.pow(10,Math.floor(Math.log10(b))),a=Math.ceil(b/d)*d,b=Math.floor(this.valRange.y.min/a)*a,d=b+(this.numGridLines.y-1)*a):(b=Math.floor(this.valRange.y.min),a=0.2,d=b+a*this.numGridLines.y);if(b<this.axisRange.y.min||d>this.axisRange.y.max)this.axisRange.y.min=
b,this.axisRange.y.max=d,this.stepSize.y=a},drawAxisVals:function(){for(var a=0;a<this.numGridLines.x;a++){var b=this.graphRangeFrac.x.min*this.dims.dx+this.gridSpacing.x*a,d=this.graphRangeFrac.y.min*this.dims.dy+this.hashMarkLen+10+this.axisValFontSize/2,e=String(round(this.axisRange.x.min+this.stepSize.x*a,1));draw.text(e,P(b,d),this.axisValFont,this.textCol,"center",0,this.graphDisplay)}for(a=0;a<this.numGridLines.y;a++)d=this.graphRangeFrac.y.min*this.dims.dy-this.gridSpacing.y*a,b=this.graphRangeFrac.x.min*
this.dims.dx-this.hashMarkLen-10,e=String(round(this.axisRange.y.min+this.stepSize.y*a,1)),draw.text(e,P(b,d),this.axisValFont,this.textCol,"center",-Math.PI/2,this.graphDisplay)},drawLegendToggle:function(a){draw.fillStrokeRect(a.boxPos,a.boxDims,this.gridCol,this.toggleCol,this.graphDisplay);a.set.visible&&a.checkMark.draw()},makeLegendEntry:function(a,b){var d=this.dims.dx-this.legendWidth+5,e=30,f;for(f in this.legend)e+=35;d=new GraphBase.LegendEntry(this,a,a.pointCol,a.label,d,e,this.legendFontSize,
this.dims,this.toggleCol);d.toggleActivate();this.legend[b]=d;this.drawAllBG()},getRange:function(a){var b=Number.MAX_VALUE,d=-Number.MAX_VALUE,e;for(e in this.data)for(var f=this.data[e].data[a],h=0;h<f.length;h++)var k=f[h],b=Math.min(b,k),d=Math.max(d,k);return{min:b,max:d}},resetStd:function(){for(var a in this.data)this.data[a].reset();removeListener(curLevel,"update","flash"+this.name);this.drawAllBG();this.resetRanges();this.hasData=!1},resetRanges:function(){this.axisRange=new GraphBase.Range(Number.MAX_VALUE,
-Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE);this.valRange=new GraphBase.Range(Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,-Number.MAX_VALUE)},makePtDataGrabFunc:function(a){return function(){return P(a.x[a.x.length-1],a.y[a.y.length-1])}},ptsExist:function(a){for(var b=0;b<a.length;b++){var d=a[b];if(void 0===d.x||void 0===d.y||isNaN(d.x)||isNaN(d.y))return!1}return!0},makeHistDataGrabFunc:function(a){return function(b){return{address:b,data:a[a.length-1]}}},valToCoord:function(a){return P(this.graphRangeFrac.x.min*
this.dims.dx+this.gridSpacing.x*(this.numGridLines.x-1)*(a.x-this.axisRange.x.min)/(this.axisRange.x.max-this.axisRange.x.min),this.dims.dy-(this.gridSpacing.y*(this.numGridLines.y-1)*(a.y-this.axisRange.y.min)/(this.axisRange.y.max-this.axisRange.y.min)+(1-this.graphRangeFrac.y.min)*this.dims.dy))},checkMark:function(a,b,d,e,f){var h=Col(0,0,0);a.x-=d;a.y-=d;b.dx+=2*d;b.dy+=2*d;return new CheckMark(a,b,e,h,f)},addMarker:function(a){a.handle?(a.graphDisplay=this.graphDisplay,a.graph=this,a.layers=
this.layers,this.markers[a.handle]=new GraphBase.Marker(a)):console.log("Tried to add a graph marker for "+this.handle+" with no handle.  Add a handle.")},LegendEntry:function(a,b,d,e,f,h,k,l){this.graph=a;this.set=b;this.pos=P(f,h);this.col=d;this.text=e;this.textPos=P(f+10,h+k/2);this.fontSize=k;this.boxPos=P(l.dx-18,h-5);this.boxDims=V(13,13);this.mouseListenerName="toggle"+this.graph.handle.toCapitalCamelCase()+this.set.handle.toCapitalCamelCase();this.checkMark=a.checkMark(this.boxPos.copy(),
this.boxDims.copy(),a.checkMarkOversize,a.toggleCol,a.graphDisplay)}};
GraphBase.LegendEntry.prototype={drawCheck:function(){this.checkMark.draw()},toggle:function(){ptInRect(this.boxPos,this.boxDims,mouseOffsetDiv(this.graph.parentDivId))&&(this.set.visible=this.set.visible?!1:!0,this.graph.drawAllBG(),this.graph.drawAllData())},toggleActivate:function(){addListener(curLevel,"mouseup",this.mouseListenerName,this.toggle,this)},toggleDeactivate:function(){removeListener(curLevel,"mouseup",this.mouseListenerName)},setCheckMarkCanvas:function(a){this.checkMark.setCanvas(a)}};
GraphBase.Range=function(a,b,d,e){this.x={min:a,max:b};this.y={min:d,max:e}};GraphBase.Range.prototype={copy:function(){return new GraphBase.Range(this.x.min,this.x.max,this.y.min,this.y.max)}};
GraphBase.Marker=function(a){this.handle=a.handle;this.dataX="function"==typeof a.x?a.x:this.wrapInDataGet(a.x);this.dataY="function"==typeof a.y?a.y:this.wrapInDataGet(a.y);this.graph=a.graph;this.graphDisplay=a.graphDisplay;validNumber(this.dataX())&&validNumber(this.dataY())?this.coordLast=this.graph.valToCoord(P(this.dataX(),this.dataY())):this.coordLast=void 0;this.markerType=a.markerType;this.col=a.col;this.layers=a.layers;if(this.drawFuncs[this.markerType])this.draw=this.drawFuncs[this.markerType];
else{console.log("Bad marker type "+this.markerType+".  Choices include ");for(var b in this.drawFuncs)console.log(b)}this.characLen=15;this.imgCharacLen=this.characLen+2;this.layers.addItem("marker",this)};
GraphBase.Marker.prototype={wrapInDataGet:function(a){with(DataGetFuncs)a=eval("(function(){return "+a+"})");return a},drawFuncs:{bullseye:function(){var a=this.characLen,b=this.coordLast=this.graph.valToCoord(P(this.dataX(),this.dataY()));window.draw.circle(b,0.15*a,this.col,!0,this.graphDisplay);window.draw.line(b.copy().movePt(V(-a/2,0)),b.copy().movePt(V(a/2,0)),this.col,this.graphDisplay);window.draw.line(b.copy().movePt(V(0,-a/2)),b.copy().movePt(V(0,a/2)),this.col,this.graphDisplay);window.draw.circle(b,
0.3*a,this.col,!1,this.graphDisplay)}},remove:function(){this.layers.removeItem("marker",this)}};GraphBase.Layers=function(){this.layers=[];this.handleIdxPairs={};this.count=0};
GraphBase.Layers.prototype={addLayer:function(a){this.layers.push([]);this.handleIdxPairs[a]=this.layers.length-1},removeLayer:function(a){var b=this.handleIdxPairs[a];for(a in this.handleIdxPairs)this.handleIdxPairs[a]>b&&this.handleIdxPairs[a]--;this.count-=this.layers[b].length;this.layers.splice(b,1);delete this.handleIdxPairs[a]},addItem:function(a,b){this.layers[this.handleIdxPairs[a]].push(b);this.count++},removeItem:function(a,b){var d=this.layers[this.handleIdxPairs[a]].indexOf(b);this.layers[this.handleIdxPairs[a]].splice(d,
1);this.count--},removeAll:function(){for(var a=0;a<this.layers.length;a++)for(var b=this.layers[a],d=0;d<b.length;d++)b[d].remove()}};function GraphPhase(a){this.spcAName=a.spcAName;this.spcBName=a.spcBName;this.spcA=spcs[this.spcAName];this.spcB=spcs[this.spcBName];this.wallGas=a.wallGas;this.liquid=a.liquid;this.constAttr=a.constAttr;this.primaryKeyType=/light/i.test(a.primaryKey)?"Light":"Heavy";this.handle=a.handle;this.actCoeffFuncs=a.actCoeffFuncs;this.pressure=a.pressure||1;this.keyNamePairs=this.getKeyNamePairs(this.spcA,this.spcB,this.pressure);(!this.spcA||!this.spcB)&&console.log("Bad species data for phase diagram "+
this.spcAName+" "+this.spcBName);a.handle+="Scatter";a.yLabel="Temp";a.xLabel="x"+this.keyNamePairs[this.primaryKeyType];a.makeReset=!1;this.graph=new GraphScatter(a);this.equilData;this.updateEquilData(this.pressure);this.equilDataHandle=this.handle+"PhaseData";this.graph.addSet({handle:this.equilDataHandle,label:"Phase\nData",pointCol:Col(255,255,255),flashCol:Col(0,0,0),trace:!0,recording:!1,showPts:!1});this.recordFracData(this.wallGas,this.keyNamePairs[this.primaryKeyType]);this.recordFracData(this.liquid.wallLiq,
this.keyNamePairs[this.primaryKeyType]);var b=this.liquid;this.liqTempFunc=function(){return b.temp};this.gasTempFunc=this.makeTempFunc(this.wallGas);this.xFunc=this.makeFracFunc(this.wallGas,this.keyNamePairs[this.primaryKeyType]);this.yFunc=this.makeFracFunc(this.liquid.wallLiq,this.keyNamePairs[this.primaryKeyType]);this.updateGraph();this.active=!1;this.graph.addMarker({handle:"liquid",col:Col(200,0,0),markerType:"bullseye",x:this.xFunc,y:this.liqTempFunc});this.graph.addMarker({handle:"gas",
col:Col(0,200,0),markerType:"bullseye",x:this.yFunc,y:this.gasTempFunc});this.graph.hasData=!0}
GraphPhase.prototype={recordFracData:function(a,b){a.recordFrac({spcName:b,tag:a.handle})},makeTempFunc:function(a){var b=a.getDataSrc("temp");return function(){return b[b.length-1]}},makeFracFunc:function(a,b){var d=a.getDataSrc("frac",{spcName:b,tag:a.handle});return function(){return d[d.length-1]}},disable:function(){this.graph.disable()},save:function(){},addLast:function(){this.graph.addLast()},remove:function(){this.graph.remove()},setPressure:function(a){this.updateEquilData(a);this.updateGraph();
this.pressure=a},getKeyNamePairs:function(a,b,d){return a.tBoil(d)<b.tBoil(d)?{Light:a.spcName,Heavy:b.spcName}:{Light:b.spcName,Heavy:a.spcName}},updateEquilData:function(a){a=phaseEquilGenerator.constP(this.spcA,this.spcB,this.actCoeffFuncs,a,20);for(var b=[],d=[],e=0;e<a.data.length;e++){var f=a.data[e],h=f.temp,k=f["y"+this.primaryKeyType];b.push(P(f["x"+this.primaryKeyType],h));d.push(P(k,h))}this.equilData=b.concat(d.reverse())},updateGraph:function(){this.graph.clearData(this.equilDataHandle,
!1);this.graph.enqueueData(this.equilDataHandle,this.equilData);this.graph.updateRange();this.graph.drawAllData()}};function GraphScatter(a){this.active=!0;this.handle=a.handle;this.dims=this.getDims();this.xLabel=a.xLabel;this.yLabel=a.yLabel;var b=a.axesInit||a.axisInit;this.labelFontSize=15;this.legendFontSize=12;this.axisValFontSize=11;this.labelFont=this.labelFontSize+"pt calibri";this.legendFont=this.legendFontSize+"pt calibri";this.axisValFont=this.axisValFontSize+"pt calibri";this.borderSpacing=70;this.legendWidth=80;a.axesFixed=a.axesFixed||{};this.axesFixed={x:defaultTo(!1,a.axesFixed.x),y:defaultTo(!1,
a.axesFixed.y)};this.graphRangeFrac=new GraphBase.Range(this.borderSpacing/this.dims.dx,(this.dims.dx-(this.legendWidth+8))/this.dims.dx,1-this.borderSpacing/this.dims.dy,0.05);this.makeReset=a.makeReset;this.setNumGridLinesAndSpacing(a.numGridLines);this.axisInit=new GraphBase.Range(b.x.min,b.x.min+b.x.step*(this.numGridLines.x-1),b.y.min,b.y.min+b.y.step*(this.numGridLines.y-1));this.resetRanges();this.stepSize=new GraphScatter.Coord(0,0);this.setStds();this.layers.addLayer("flasher");this.layers.addLayer("marker");
this.drawAllBG()}
_.extend(GraphScatter.prototype,AuxFunctions,GraphBase,{addSet:function(a){var b=new GraphScatter.Set(this,a.handle,a.label,a.data,a.pointCol,a.flashCol,a.fillInPts,a.fillInPtsMin,a.trace,a.recording,a.showPts);this.data[a.handle]=b;this.makeLegendEntry(b,a.handle);this.drawAllBG()},drawAllData:function(){this.drawAllBG();this.drawAxisVals();this.drawPts(!1)},drawPts:function(a){for(var b in this.data)this.data[b].drawPts(!1!==a)},addLast:function(){for(var a in this.data){var b=this.data[a];b.recording&&
b.enqueuePts()}this.flushQueues(!0,!1);this.hasData=!0},getAxisBounds:function(){this.getXBounds();this.getYBounds()},graphPt:function(a,b,d){a=this.valToCoord(P(a,b));this.drawPtStd(a,d)},drawPtStd:function(a,b){this.drawPt(a,b,this.characLen)},drawPt:function(a,b,d,e){e=e||this.graphDisplay;var f=a.x,h=a.y;a=P(f-d,h);var k=P(f,h-d),l=P(f+d,h);d=P(f,h+d);draw.fillPtsStroke([a,k,l,d],b,this.ptStroke,e)},reset:function(){this.resetStd()}});
GraphScatter.Set=function(a,b,d,e,f,h,k,l,m,n,p){this.graph=a;this.handle=b;this.label=d;this.data=new GraphScatter.Data;this.showPts=defaultTo(!0,p);this.graphedPts=[];this.graphedPtIdxs=[];e=e||{};this.dataFuncs=new GraphScatter.DataFuncs(a,e.x,e.y);this.pointCol=f;this.flashCol=h;this.fillInPts=defaultTo(!0,k);this.fillInPtsMin=defaultTo(5,l);this.trace=defaultTo(!1,m);this.visible=!0;this.recordListenerName=this.graph.handle+this.handle.toCapitalCamelCase()+"Record";this.traceLastIdxs=new GraphScatter.Coord(0,
0);this.flashers=[];this.queuePts=[];this.queueIdxs=[];(this.recording=defaultTo(!0,n))&&this.recordStart()};
GraphScatter.Set.prototype={reset:function(){this.graphedPts.splice(0,this.graphedPts.length);this.graphedPtIdxs.splice(0,this.graphedPtIdxs.length);this.flashers.splice(0,this.flashers.length);this.queueIdxs.splice(0,this.queueIdxs.length);this.queuePts.splice(0,this.queuePts.length)},addVal:function(){this.data.x.push(this.dataFuncs.x());this.data.y.push(this.dataFuncs.y())},clearData:function(){this.queuePts.splice(0,this.queuePts.length);this.queueIdxs.splice(0,this.queueIdxs.length);this.data.clear()},
enqueueData:function(a){var b=this.data.x.length;this.queuePts=this.queuePts.concat(a);this.addData(a);for(a=b;a<this.data.x.length;a++)this.queueIdxs.push(P(a,a))},addData:function(a){this.data.addData(a)},recordStart:function(){addListener(curLevel,"update",this.recordListenerName,function(){0==turn%2&&this.addVal()},this)},recordStop:function(){removeListener(curLevel,"update",this.recordListenerName)},enqueuePts:function(){var a=this.data.pt(),b=[],d=[];if(a.isValid()){var e=new GraphScatter.Coord(this.data.x.length-
1,this.data.y.length-1);if(this.fillInPts&&this.data.x.length&&this.data.y.length&&this.graphedPtIdxs.length)var f=this.graphedPtIdxs[this.graphedPtIdxs.length-1],h=this.data.pt(f.x,f.y),f=this.fillInPtsFunc(a,e,h,f,this.data),b=b.concat(f.newPts),d=d.concat(f.dataIdxs);b.push(a);d.push(e)}this.queuePts=this.queuePts.concat(b);this.queueIdxs=this.queueIdxs.concat(d)},fillInPtsFunc:function(a,b,d,e,f){var h=b.x-e.x;if(h!=b.y-e.y)return{newPts:[],dataIdxs:[]};var k=this.graph.valToCoord(a),l=this.graph.valToCoord(d);
b=k.x!=l.x?Math.abs(k.x-l.x)/Math.abs(a.x-d.x):1;for(var k=k.y!=l.y?Math.abs(k.y-l.y)/Math.abs(a.y-d.y):1,l=a.VTo(d).UV().perp(),m=h-1;0<m;m--){var h=e.x+m,n=e.y+m,p=V(b*(f.x[h]-a.x),k*(f.y[n]-a.y)),p=Math.abs(p.dotProd(l));if(p>this.fillInPtsMin){m=P(f.x[h],f.y[n]);b=this.getEdgePt({x:h,y:n},e,l,m,p,a,f,b,k);if(!b)break;a=b.dataIdx;b=b.pt;d=this.fillInPtsFunc(b,a,d,e,f);return{newPts:[b].concat(d.newPts),dataIdxs:[a].concat(d.dataIdxs)}}}return{newPts:[],dataIdxs:[]}},getEdgePt:function(a,b,d,e,
f,h,k,l,m){for(a=a.x-b.x-1;0<a;a--){var n=b.x+a,p=b.y+a,r=V(l*(k.x[n]-h.x),m*(k.y[p]-h.y)),r=Math.abs(r.dotProd(d));if(r<f)return{pt:e,dataIdx:{x:n+1,y:p+1}};e=P(k.x[n],k.y[p]);f=r}},updateRange:function(a){this.trace?this.updateRangeFromData(a):this.updateRangeFromPts(a)},updateRangeFromData:function(a){for(var b=this.queueIdxs[0]?this.queueIdxs[0].x:0;b<this.data.x.length;b++){var d=this.data.x[b],e=this.data.y[b];a.x.max=Math.max(a.x.max,d);a.x.min=Math.min(a.x.min,d);a.y.max=Math.max(a.y.max,
e);a.y.min=Math.min(a.y.min,e)}},updateRangeFromPts:function(a){for(var b=0;b<this.queuePts.length;b++){var d=this.queuePts[b].x,e=this.queuePts[b].y;a.x.max=Math.max(a.x.max,d);a.x.min=Math.min(a.x.min,d);a.y.max=Math.max(a.y.max,e);a.y.min=Math.min(a.y.min,e)}},drawPts:function(a){if(this.visible&&(this.showPts||this.trace)){var b,d=[];a?(b=this.queuePts,d=this.queueIdxs):(b=this.graphedPts.concat(this.queuePts),d=this.graphedPtIdxs.concat(this.queueIdxs));this.trace&&(a?this.graphedPtIdxs.length&&
this.drawTrace(this.graphedPtIdxs[this.graphedPtIdxs.length-1].x,d[d.length-1].x,this.graphedPtIdxs[this.graphedPtIdxs.length-1].y,d[d.length-1].y):this.drawTrace(d[0].x,d[d.length-1].x,d[0].y,d[d.length-1].y));if(this.showPts)for(a=0;a<b.length;a++)this.graph.graphPt(b[a].x,b[a].y,this.pointCol)}},flashInit:function(){if(this.visible&&this.showPts)for(var a=0;a<this.queuePts.length;a++){var b=this.queuePts[a],d=this.pointCol,e=this.flashCol,f=e.copy();new GraphScatter.Flasher(b,d,e,f,this.graph.characLen*
this.graph.flashMult,2*this.graph.characLen*this.graph.flashMult,this.graph.characLen,this.graph.flashMult,this.graph.flashRate,this.graph.graphDisplay,this.graph.layers,this.graph)}},flushQueue:function(){this.graphedPts=this.graphedPts.concat(this.queuePts);this.graphedPtIdxs=this.graphedPtIdxs.concat(this.queueIdxs);this.queuePts.splice(0,this.queuePts.length);this.queueIdxs.splice(0,this.queueIdxs.length)},drawTrace:function(a,b,d,e){if(b-a==e-d&&void 0!==a&&void 0!==d){b-=a;e=[this.graph.valToCoord(P(this.data.x[a],
this.data.y[d]))];for(var f=1;f<b+1;f++){var h=this.graph.valToCoord(P(this.data.x[a+f],this.data.y[d+f]));h.closeTo(e[e.length-1])||e.push(h)}draw.path(e,this.pointCol,this.graph.graphDisplay)}else console.log("Data count mismatch for tracing"),console.trace()}};GraphScatter.DataFuncs=function(a,b,d){this.x=a.makeDataFunc(b);this.y=a.makeDataFunc(d)};GraphScatter.Data=function(){this.x=[];this.y=[]};
GraphScatter.Data.prototype={pt:function(a){return void 0===a?P(this.x[this.x.length-1],this.y[this.y.length-1]):P(this.x[a],this.y[a])},addData:function(a){for(var b=0;b<a.length;b++)this.x.push(a[b].x),this.y.push(a[b].y)},toPts:function(){for(var a=[],b=0;b<this.x.length;b++)a.push(this.x[b],this.y[b]);return a},clear:function(){this.x.splice(0,this.x.length);this.y.splice(0,this.y.length)}};GraphScatter.Coord=function(a,b){this.x=a;this.y=b};
GraphScatter.Coord.prototype={copy:function(){return new GraphScatter.prototype.Coord(this.x,this.y)}};
GraphScatter.Flasher=function(a,b,d,e,f,h,k,l,m,n,p,r){this.pt=a;this.pointCol=b;this.flashCol=d;this.curCol=e;this.curCharacLen=f;this.imgCharacLen=h;this.finalCharacLen=k;this.flashMult=l;this.flashRate=m;this.graphDisplay=n;this.layers=p;this.graph=r;this.coordLast=this.graph.valToCoord(this.pt);this.advanceListenerHandle=this.addAdvanceListener();this.lifetime=1/this.flashRate;this.age=0;p.addItem("flasher",this)};
GraphScatter.Flasher.prototype={addAdvanceListener:function(){var a="flashAdvance"+this.graph.handle+this.pt.x+this.pt.y;addListener(curLevel,"update",a,function(){this.advance()},this);return a},draw:function(){this.coordLast=this.graph.valToCoord(this.pt);this.graph.drawPt(this.coordLast,this.curCol,this.curCharacLen,this.graphDisplay)},remove:function(){this.layers.removeItem("flasher",this);removeListener(curLevel,"update",this.advanceListenerHandle)},advance:function(){this.curCharacLen=stepTowards(this.curCharacLen,
this.finalCharacLen,-this.finalCharacLen*this.flashMult*this.flashRate);var a=this.curCol,b=Col(0,0,0);b.r=this.colStep("r");b.g=this.colStep("g");b.b=this.colStep("b");a.set(b);this.age>this.lifetime+1&&this.remove();this.age++},colStep:function(a){var b=this.pointCol[a];return stepTowards(this.curCol[a],b,(b-this.flashCol[a])*this.graph.flashRate)}};function GraphHist(a){this.active=!0;this.handle=a.handle;this.dims=this.getDims();this.xLabel=a.xLabel;this.yLabel=a.yLabel;this.labelFontSize=15;this.axisValFontSize=11;var b=a.axesInit;this.labelFont=this.labelFontSize+"pt calibri";this.axisValFont=this.axisValFontSize+"pt calibri";this.borderSpacing=70;this.graphRangeFrac=new GraphBase.Range(this.borderSpacing/this.dims.dx,0.95,1-this.borderSpacing/this.dims.dy,0.05);this.numBins=18;this.axesFixed={x:defaultTo(!1,a.axesFixed.x),y:defaultTo(!1,
a.axesFixed.y)};this.setNumGridLinesAndSpacing(a.numGridLines);this.axisInit=new GraphBase.Range(b.x.min,b.x.min+b.x.step*(this.numGridLines.x-1),b.y.min,b.y.min+b.y.step*(this.numGridLines.y-1));this.resetRanges();this.stepSize={x:0,y:0};Col(255,100,0);this.setStds();this.drawAllBG()}
_.extend(GraphHist.prototype,AuxFunctions,GraphBase,{addSet:function(a){a=new GraphHist.Set(this,a.handle,a.data,a.barCol);this.data[a.handle]=a;this.drawAllBG()},drawAllData:function(){this.drawAllBG();this.bins&&(this.drawAxisVals(),this.graphBins())},addLast:function(){var a="",b;for(b in this.data)a=b;a=this.data[a];a.addVal();this.makeBins(a);this.hasData=!0},plotData:function(a){var b="",d;for(d in this.data)b=d;this.data[b].data.x=a;this.makeBins(this.data[b])},makeBins:function(a){this.valRange.x=
this.getRange("x");this.setAxisBoundsX();this.bins=this.makeBinBlanks(a.data.x);this.populateBins(a.data.x);this.setYAxis();this.drawAllData()},makeBinBlanks:function(a){a=[];this.binWidth=round((this.valRange.x.max-this.valRange.x.min)/(this.numBins-1),1);for(var b=0;b<this.numBins;b++)a.push(0);return a},populateBins:function(a){for(var b=0;b<a.length;b++)this.bins[Math.floor((a[b]-this.valRange.x.min)/this.binWidth)]++},setYAxis:function(){for(var a=0,b=0;b<this.bins.length;b++)a=Math.max(this.bins[b],
a);this.valRange.y.min=0;this.valRange.y.max=a;this.setAxisBoundsY()},graphBins:function(){var a,b;for(b in this.data)a=b;a=this.data[a].barCol;for(b=0;b<this.bins.length;b++){var d=this.binWidth*(b+1),e=this.valToCoord(P(this.binWidth*b,this.bins[b])),d=this.valToCoord(P(d,0)),d=e.VTo(d);draw.fillStrokeRect(e,d,a,this.bgCol,this.graphDisplay)}},clear:function(){this.clearStd()}});
GraphHist.Set=function(a,b,d,e){this.graph=a;this.handle=b||"onlyData";this.data=new GraphHist.Data;this.dataFunc=new GraphHist.DataFunc(a,d);this.barCol=e;this.visible=!0};GraphHist.Set.prototype={addVal:function(){this.data.x=this.dataFunc.x()},recordStop:function(){}};GraphHist.Data=function(){this.x=[]};GraphHist.DataFunc=function(a,b){this.x=a.makeDataFunc(b)};function GraphBlank(a){this.dims=this.getGraphDims();this.borderSpacing=70;this.xStart=this.borderSpacing/this.dims.dx;this.yStart=1-this.borderSpacing/this.dims.dy;this.legendWidth=80;this.xEnd=(this.dims.dx-(this.legendWidth+8))/this.dims.dx;this.yEnd=0.05;this.gridSpacing=40;this.setNumGridLines();this.setStds();this.handle="blank"+Math.round(1E5*Math.random());this.parentDiv=a;this.makeCanvasNoReset(this.dims,a);this.parentDiv.attr("filledWith","blank");this.drawBGBlank()}
_.extend(GraphBlank.prototype,GraphBase,{drawBGBlank:function(){this.graph.save();this.drawBGRect();this.graph.globalAlpha=0.2;this.drawGrid();this.drawBounds();this.graph.restore()}});function DataDisplayer(){this.entries={}}
DataDisplayer.prototype={setReadouts:function(a){this.readouts=a},addEntry:function(a){var b=this,d=a.label||"",e=defaultTo(1,a.decPlaces),f=a.handle,h=a.expr||"",k=a.units||"";defaultTo(currentSetupType,a.cleanUpWith);var l=this.readouts[a.readout];l||console.log("Bad readout name "+a.readout);a="display"+d+this.entries.length;var m=l.addEntry(d+f),f=new this.Entry(f,d,e,h,k,a,this,m);this.entries[f.handle]=f;with(DataGetFuncs)eval("func = function(){return "+h+"}"),addListener(curLevel,"update",
a,function(){var a=d,f;f=(void 0)();f=isNaN(f)||void 0===f?"":b.setDecPlaces(f,e);a=a+(f+" ")+k;m.setText(a)});return f},setDecPlaces:function(a,b){var d=String(a),e=d.indexOf(".");if(-1==e)return d;var f=Number("1e"+b),e=Number(d.slice(0,e+b+2)),f=String(Math.round(f*e)/f),e=f.indexOf(".");-1==e?(f+=".",e=b):e=e+b-f.length+1;for(d=0;d<e;d++)f+="0";return f},removeEntry:function(a){this.entries[a]&&this.entries[a].remove()},Entry:function(a,b,d,e,f,h,k,l){this.handle=a;this.label=b;this.decPlaces=
d;this.expr=e;this.units=f;this.listenerStr=h;this.dataDisplayer=k;this.readoutEntry=l;this.removed=!1}};DataDisplayer.prototype.Entry.prototype={remove:function(){this.removed||(delete this.dataDisplayer.entries[this.handle],this.readoutEntry.remove(),removeListener(curLevel,"update",this.listenerStr),this.removed=!0)}};DataGetFuncs={tempSmooth:function(a){a=walls[a].getDataSrc("temp");for(var b=Math.min(15,a.length),d=a.length-b,e=0,f=0;f<b;f++)e+=a[d+f];return e/b},collisions:function(){for(var a=collide.hitsPerTurn,b=Math.min(15,a.length),d=a.length-b,e=0,f=0;f<b;f++)e+=a[d+f];return 1E3*e/b/updateInterval},temp:function(a){a=walls[a].getDataSrc("temp");return a[a.length-1]},pInt:function(a){a=walls[a].getDataSrc("pInt");return a[a.length-1]},pExt:function(a){a=walls[a].getDataSrc("pExt");return a[a.length-1]},
vol:function(a){a=walls[a].getDataSrc("vol");return a[a.length-1]},q:function(a){a=walls[a].getDataSrc("q");return a[a.length-1]},mass:function(a){a=walls[a].getDataSrc("mass");return a[a.length-1]},moles:function(a,b){var d=walls[a].getDataSrc("mass",b);return d[d.length-1]},frac:function(a,b){var d=walls[a].getDataSrc("frac",b);return d[d.length-1]},time:function(a){a=walls[a].getDataSrc("time");return a[a.length-1]},work:function(a){a=walls[a].getDataSrc("work");return a[a.length-1]},vDist:function(a,
b){var d=walls[a].getDataSrc("vDist",b);return d[d.length-1]},get:function(a,b,d,e,f){a=getStore(a);var h,k="int"==b||"float"==b;a&&("int"==b?h=Math.round(parseFloat(a)):"float"==b?h=parseFloat(a):"string"==b&&(h=a.sanitize()),k&&(f=void 0===f||isNaN(f)?h:f,e=void 0===e||isNaN(e)?h:e,h=bound(h,e,f)));if(void 0===h||k&&isNaN(h))h=d;return h},img:function(a,b,d,e){if(e)return{attrs:{src:[a]}};a=templater.img({attrs:{src:[a]}});d&&(a=templater.center({innerHTML:a}));"br"==b?a=templater.br()+a+templater.br():
"p"==b&&(a=templater.p({innerHTML:a}));return a}};ReactionHandler={addReaction:function(a){a.parent=this;a=new ReactionHandler.Reaction(a);this.initRxn(a);return a},disableRxn:function(a){this.removeRxn(a)},enableRxn:function(a){if(a=this.getRxn(this.pausedRxns,a))this.pausedRxns.splice(this.pausedRxns.indexOf(a),1),this.initRxn(a)},removeRxn:function(a){for(var b in this.rxns){for(var d=this.rxns[b],e=!1,f=0;f<d.length;f++)d[f].handle==a&&(d.splice(f,1),e=!0);e&&(0==d.length?this.setHandlerByIdStr(b,{func:this.impactStd,obj:this}):1==d.length&&
(d=d[0],this.initPair(d,!0)))}if(d=this.getRxn(this.activeRxns,a))this.activeRxns.splice(this.activeRxns.indexOf(d),1),this.pausedRxns.push(d)},getRxn:function(a,b){for(var d=0;d<a.length;d++)if(b==a[d].handle)return a[d]},initRxn:function(a){a.rctA&&a.rctB?this.initPair(a):a.rctA&&this.initDecomp(a);this.activeRxns.push(a)},removeAllReactions:function(){this.setDefaultHandler({func:this.impactStd,obj:this})},getIdStr:function(a,b){return a.idNum<b.idNum?a.idNum+"-"+b.idNum:b.idNum+"-"+a.idNum},initPair:function(a){var b=
this.getIdStr(a.rctADef,a.rctBDef);this.rxns[b]?this.rxns[b].push(a):this.rxns[b]=[a];1<this.rxns[b].length?this.setHandler(a.rctA,a.rctB,{func:this.rctHandlerMultPairs(b),obj:this}):this.setHandler(a.rctA,a.rctB,{func:this.rctHandlerSinglePair(b),obj:this})},countProds:function(a){var b=0,d;for(d in a)b+=a[d];return b},initDecomp:function(a){var b=a.rctADef.idNum,d;for(d in this.spcs){var e=a.copy(),f=this.spcs[d];e.rctB=d;e.rctBDef=f;b==f.idNum?(e.activeE*=2,e.doubleProds()):e.increaseProd(d,1);
this.initPair(e)}},hitE:function(a,b,d,e){return 0.5*(Math.abs(d)*d*a.m*a.cvKinetic+Math.abs(e)*e*b.m*b.cvKinetic)*this.tConst},probFunc:function(a,b){var d=Math.max(a/b-1,0);return 2*(d-0.5*d*d)},rctHandlerSinglePair:function(a){a=this.rxns[a][0];var b=a.activeE,d=a.prods;return function(a,f,h,k,l){var m=this.hitE(a,f,k,-l);return Math.random()<this.probFunc(m,b)?!this.react(a,f,d)?this.impactStd(a,f,h,k,l):!1:this.impactStd(a,f,h,k,l)}},rctHandlerMultPairs:function(a){var b=this.rxns[a];return function(a,
e,f,h,k){for(var l=this.hitE(a,e,h,-k),m=[],n=0,p=0;p<b.length;p++)m[p]=this.probFunc(l,b[p].activeE),n+=m[p];p=this.pickRxnIdx(m,1<n?1/n:1);return!1===p?this.impactStd(a,e,f,h,k):this.react(a,e,b[p].prods)?!1:this.impactStd(a,e,f,h,k)}},pickRxnIdx:function(a,b){for(var d=Math.random(),e=0,f=0;f<a.length;f++)if(e+=a[f]*b,e>d)return f;return!1},react:function(a,b,d){for(var e=a.enthalpy()+b.enthalpy(),f=0,h=0,k=0.5*(a.x+b.x),l=0.5*(a.y+b.y),m=[],n=0;n<d.length;n++){for(var p=d[n].name,r=d[n],q=[],
f=f+this.spcs[p].hF298*r.count,h=h+this.spcs[p].cp*r.count,u=0;u<r.count;u++){var s=2*Math.random()*Math.PI,s=V(Math.sin(s),Math.cos(s));q.push(D(k+3*s.dx,l+3*s.dy,s,p,a.tag,a.elemId,a.returnTo))}m.push(q)}f*=1E3/N;h/=N;d=(e-f)/h+298.15;if(0<d){this.dotManager.remove([a,b]);for(a=0;a<m.length;a++){q=m[a];this.dotManager.add(q);for(b=0;b<q.length;b++)q[b].setTemp(d)}return!0}return!1},Reaction:function(a){this.attrs=a;this.handle=a.handle;this.parent=a.parent;this.rctA=a.rctA||a.rctB;this.rctB=a.rctA&&
a.rctB?a.rctB:void 0;this.rctADef=this.parent.spcs[this.rctA];this.rctBDef=this.parent.spcs[this.rctB];this.activeE=1E3*a.activeE/N;if(this.rctA&&!this.rctADef)return console.log("reactant a "+this.rctA+" doesn't exist");if(this.rctB&&!this.rctBDef)return console.log("reactant b "+this.rctB+" doesn't exist");this.prods=this.reformatProds(a.prods);this.prodCount=this.countProds(this.prods)}};
ReactionHandler.Reaction.prototype={copy:function(){return new this.parent.Reaction(this.attrs)},doubleProds:function(){for(var a=0;a<this.prods.length;a++)this.prods[a].count*=2;this.prodCount*=2;return this},increaseProd:function(a,b){for(var d=!1,e=0;e<this.prods.length;e++){var f=this.prods[e];if(f.name==a){f.count+=b;d=!0;break}}d||this.prods.push({name:a,count:b});this.prodCount+=b;return this},reformatProds:function(a){var b=[],d;for(d in a)b.push({name:d,count:a[d]});return b},countProds:function(a){for(var b=
0,d=0;d<a.length;d++)b+=a[d].count;return b},remove:function(){this.parent.removeRxn(this.handle)}};function CollideHandler(a){this.tConst=tConst;this.cp=cp;this.cv=cv;this.rxns={};this.dotManager=a;this.activeRxns=[];this.pausedRxns=[];this.numHits=0;this.hitsPerTurn=[];this.checkStore=this.check;this.breakUpStore=this.breakUp;this.recordingHits=!1;this.recordCleanUpListenerName="recordCollideHits"}
_.extend(CollideHandler.prototype,ReactionHandler,toInherit.gridder,{setSpcs:function(a){this.spcs=a;this.setDefaultHandler({func:this.impactStd,obj:this},this.spcs);this.setup(this.spcs)},setDefaultHandler:function(a,b){for(var d=countAttrs(b),e=0;e<d;e++)for(var f=e;f<d;f++)this[e+"-"+f]=a,this.rxns[e+"-"+f]=[]},setHandler:function(a,b,d){var e=this.getIdStr(this.spcs[a],this.spcs[b]);this.isIdStr(e)?this[e]=d:console.log("bad spc names "+a+" "+b)},setHandlerByIdStr:function(a,b){this.isIdStr(a)?
this[a]=b:console.log("bad id string "+a)},isIdStr:function(a){return/^[0-9]+\-[0-9]+$/.test(a)},recordCollisions:function(){this.check=this.checkRecord;this.breakUp=this.breakUpRecord;this.recordingCollisions=!0;addListener(curLevel,"sectionCleanUp",this.recordCleanUpListenerName,this.recordCollisionsStop,this)},recordCollisionsStop:function(){this.check=this.checkStore;this.breakUp=this.breakUpStore;this.recordingCollisions=!1;removeListener(curLevel,"sectionCleanUp",this.recordCleanUpListenerName)},
check:function(){for(var a=this.gridSize,b=this.xSpan,d=this.ySpan,e=this.grid=this.makeGrid(),f=dotManager.lists.ALLDOTS,h=f.length-1;-1<h;h--){var k=f[h],l=Math.floor(k.x/a),m=Math.floor(k.y/a),n=!0,p=Math.max(l-1,0),r=Math.min(l+1,b)+1;a:for(;p<r;p++)for(var q=Math.max(m-1,0),u=Math.min(m+1,d)+1;q<u;q++)for(var s=e[p][q].length-1;0<=s;s--){var t=e[p][q][s],v=k.x-t.x,w=k.y-t.y;if(v*v+w*w<=(k.r+t.r)*(k.r+t.r)&&(v=this[Math.min(k.idNum,t.idNum)+"-"+Math.max(k.idNum,t.idNum)],w=V(t.x-k.x,t.y-k.y).UV(),
!1===v.func.apply(v.obj,[k,t,w,k.v.dotProd(w),t.v.dotProd(w)]))){n=!1;e[p][q].splice(s,1);break a}}0<=l&&0<=m&&l<this.numCols&&m<this.numRows?n&&e[l][m].push(k):(returnEscapist(k),console.log("ball out of bounds"))}},checkRecord:function(){var a=this.gridSize,b=this.xSpan,d=this.ySpan,e=this.grid=this.makeGrid();this.hitsPerTurn.push(this.numHits);this.numHits=0;for(var f=dotManager.lists.ALLDOTS,h=f.length-1;-1<h;h--){var k=f[h],l=Math.floor(k.x/a),m=Math.floor(k.y/a),n=!0,p=Math.max(l-1,0),r=Math.min(l+
1,b)+1;a:for(;p<r;p++)for(var q=Math.max(m-1,0),u=Math.min(m+1,d)+1;q<u;q++)for(var s=e[p][q].length-1;-1<s;s--){var t=e[p][q][s],v=k.x-t.x,w=k.y-t.y;if(v*v+w*w<=(k.r+t.r)*(k.r+t.r)&&(v=this[Math.min(k.idNum,t.idNum)+"-"+Math.max(k.idNum,t.idNum)],w=V(t.x-k.x,t.y-k.y).UV(),!1===v.func.apply(v.obj,[k,t,w,k.v.dotProd(w),t.v.dotProd(w)]))){n=!1;e[p][q].splice(s,1);break a}}0<=l&&0<=m&&l<this.numCols&&m<this.numRows?n&&e[l][m].push(k):(returnEscapist(k),console.log("ball out of bounds"))}},impactStd:function(a,
b,d,e,f){var h=(e*(a.m-b.m)+2*b.m*f)/(a.m+b.m),k=(f*(b.m-a.m)+2*a.m*e)/(a.m+b.m),l=a.temp(),m=b.temp();a.v.dx+=d.dx*(h-e);a.v.dy+=d.dy*(h-e);b.v.dx+=d.dx*(k-f);b.v.dy+=d.dy*(k-f);e=a.temp();f=b.temp();h=l+(e-l)*a.cvKinetic/a.cv;k=m+(f-m)*b.cvKinetic/b.cv;a.v.mult(Math.sqrt(h/e));a.internalPotential*=h/l;b.v.mult(Math.sqrt(k/f));b.internalPotential*=k/m;this.breakUp(a,b,d);return!0},breakUp:function(a,b,d){var e=a.r+b.r,f=b.x-d.dx*e,h=b.y-d.dy*e;b.x=a.x+d.dx*e;b.y=a.y+d.dy*e;a.x=f;a.y=h},breakUpRecord:function(a,
b,d){this.numHits++;var e=a.r+b.r,f=b.x-d.dx*e,h=b.y-d.dy*e;b.x=a.x+d.dx*e;b.y=a.y+d.dy*e;a.x=f;a.y=h},setup:function(a){this.gridSize=2*this.getMaxR(a);this.numCols=Math.ceil(myCanvas.width/this.gridSize+1);this.numRows=Math.ceil(myCanvas.height/this.gridSize+1);this.xSpan=Math.floor(myCanvas.width/this.gridSize);this.ySpan=Math.floor(myCanvas.height/this.gridSize)},getMaxR:function(a){var b=0,d;for(d in a)b=Math.max(b,a[d].r);return b}});function Attractor(){this.eDebt=0;this.k1=0.5;this.k2=0.07}
_.extend(Attractor.prototype,toInherit.gridder,{setup:function(){this.gridSize=30;this.numCols=Math.ceil(myCanvas.width/this.gridSize+1);this.numRows=Math.ceil(myCanvas.height/this.gridSize+1);this.xSpan=Math.floor(myCanvas.width/this.gridSize);this.ySpan=Math.floor(myCanvas.height/this.gridSize);this.dotManager=dotManager;return this},attract:function(){for(var a=this.makeGrid(),b=this.gridSize,d=this.xSpan,e=this.ySpan,f=dotMagnager.lists.ALLDOTS,h=0;h<f.length;h++){var k=f[h];if(0<k.attractStr){k.tempLast=
k.temp();for(var l=Math.floor(k.x/b),m=Math.floor(k.y/b),n=Math.max(l-1,0);n<=Math.min(l+1,d);n++)for(var p=Math.max(m-1,0);p<=Math.min(m+1,e);p++)for(var r=a[n][p].length-1;-1<r;r-=1){var q=a[n][p][r],u=k.x-q.x,s=k.y-q.y,t=Math.sqrt(u*u+s*s),v=V(u,s);v.dx/=t;v.dy/=t;var t=Math.max(0,t-k.r-q.r)*pxToE,u=k.attractStrs[q.idNum],s=(k.attractRad+q.attractRad)/2,w=s*s*s*s*s,y=(0.97*s+t)*(0.97*s+t)*(0.97*s+t)*(0.97*s+t)*(0.97*s+t),x=-u*(5*w/(y*(0.97*s+t))-8*w*s*s*s/(y*(0.97*s+t)*(0.97*s+t)*(0.97*s+t)*(0.97*
s+t))),A=v.copy().mult(x/k.m),v=v.mult(-x/q.m);k.v.add(A);q.v.add(v);t=-u*(w*s*s*s/(y*(0.97*s+t)*(0.97*s+t)*(0.97*s+t))-w/y);k.peCur+=t;q.peCur+=t}a[l][m].push(k)}}this.adjustE()},adjustE:function(){for(var a=dotManager.lists.ALLDOTS,b=0;b<a.length;b++){var d=a[b];if(0<d.attractStr){var e=d.tempLast+d.peCur-d.peLast;0>e&&(this.eDebt+=10-e,e=10);d.setTemp(e);d.peLast=d.peCur;d.peCur=0}}0<this.eDebt&&this.exactDebt()},exactDebt:function(){for(var a=0.3*dataHandler.avgTemp(),b=dotManager.lists.ALLDOTS,
d=0;d<b.length;d++){var e=b[d],f=e.temp();if(f>a){var h=Math.min(Math.min(f-a,5),this.eDebt);this.eDebt-=h;e.setTemp(f-h);if(0>=this.eDebt)break}}},zeroAllEnergies:function(){for(var a=dotManager.lists.ALLDOTS,b=0;b<a.length;b++)a[b].peLast=0,a[b].keLast=0,a[b].tempLast=0},assignELastAll:function(){for(var a=this.makeGrid(),b=this.gridSize,d=this.xSpan,e=this.ySpan,f=dotManager.lists.ALLDOTS,h=0;h<f.length;h++){var k=f[h];if(0<k.attrStr){k.tempLast=k.temp();for(var l=Math.floor(k.x/b),m=Math.floor(k.y/
b),n=Math.max(l-1,0);n<=Math.min(l+1,d);n++)for(var p=Math.max(m-1,0);p<=Math.min(m+1,e);p++)for(var r=a[n][p].length-1;-1<r;r-=1){var q=a[n][p][r],u=pxToE*V(k.x-q.x,k.y-q.y).mag(),u=Math.max(0,u-k.r-q.r)*pxToE,s=(k.attractRad+q.attractRad)/2,t=s*s*s*s*s,v=(0.97*s+u)*(0.97*s+u)*(0.97*s+u)*(0.97*s+u)*(0.97*s+u),u=-k.attractStrs[q.idNum]*(t*s*s*s/(v*(0.97*s+u)*(0.97*s+u)*(0.97*s+u))-t/v);k.peLast+=u;q.peLast+=u}a[l][m].push(k)}}}});function DataHandler(){this.tConst=tConst}
DataHandler.prototype={temp:function(a){return this.KEAvg(a)*this.tConst},tempFunc:function(a){var b=this;return function(){return b.KEAvg(a)*b.tConst}},avgTemp:function(){for(var a=0,b=0;b<walls.length;b++)a+=walls[b].data.t[walls[b].data.t.length-1];return a/walls.length},countFunc:function(a){var b=this;return function(){return b.count(a)}},count:function(a){return dotManager.get(a).length},RMS:function(a){var b=0;a=dotManager.get(a);for(var d=0;d<a.length;d++)b+=a[d].v.magSqr();return pxToMS*
Math.sqrt(b/a.length)},velocities:function(a){a=dotManager.get(a);for(var b=Array(a.length),d=0;d<a.length;d++)b[d]=a[d].v.mag();return b},velocityAvg:function(a){vList=this.velocities(a);for(var b=a=0;b<vList.length;b++)a+=vList[b];return a/vList.length},KEAvg:function(a){var b=0;a=dotManager.get(a);for(var d=0;d<a.length;d++)b+=a[d].KE();return b/a.length},volume:function(a){return void 0===a?walls.totalVolume():walls.wallVolume(a)},volumeFunc:function(a){var b=this;return function(){return b.volume(a)}}};function WallHandler(a){var b=a?Array(a.pts.length):[];_.extend(b,WallMethods.main,WallMethods.collideMethods);b.defaultCol=Col(255,255,255);a&&(b.assemble(a),a.handles.length!=a.pts.length&&console.log("NAME YOUR WALLS"),a.handlers&&b.doInitHandlers(a.handlers));b.setup();return b}
WallMethods={main:{assemble:function(a){this.removed=!1;var b=a.pts,d=a.handles;this.numWalls=b.length;this.qArrowFill=Col(200,0,0);this.qArrowFillFinal=Col(100,0,0);this.qArrowStroke=Col(255,255,255);var e=defaultTo([],a.includes),f=defaultTo([],a.bounds),h=defaultTo([],a.vols),k=defaultTo([],a.shows),l=defaultTo([],a.records);a=defaultTo([],a.temps);for(var m=0;m<b.length;m++)this.setWallVals(m,b[m],d[m],f[m],e[m],h[m],k[m],l[m],a[m])},setDefaultReadout:function(a){this.defaultReadout=a;return this},
unsetDefaultReadout:function(){this.defaultReadout=void 0;return this},setBounds:function(a,b){var d=this[this.idxByInfo(a)].bounds,e;for(e in b)d[e]=b[e];return this},setup:function(){this.gridDim=20;this.xSpan=Math.floor(myCanvas.width/this.gridDim);this.ySpan=Math.floor(myCanvas.height/this.gridDim);this.numCols=Math.ceil(myCanvas.width/this.gridDim);this.numRows=Math.ceil(myCanvas.height/this.gridDim);for(var a=0;a<this.length;a++)this.setupWall(a)},setAllHandler:function(a){for(var b=0;b<this.length;b++)this.setWallHandler(b,
a)},setWallHandler:function(a,b){var d=this.idxByInfo(a);/isothermal/i.test(b)&&this[d].isothermalInit();for(var e=0;e<this[d].length;e++)"string"==typeof b?this[d+"-"+e]={obj:this,func:this[b]}:"object"==typeof b&&(this[d+"-"+e]=b)},setSubWallHandler:function(a,b,d){a=this.idxByInfo(a);"string"==typeof d?(this[a][b].isothermal=/isothermal/i.test(d),this[a+"-"+b]={obj:this,func:this[d]}):"object"==typeof d&&(this[a+"-"+b]=d)},getSubWallHandler:function(a,b){return this[this.idxByInfo(a)+"-"+b]},setupWall:function(a){this[a].wallUVs=
this.getWallUV(a);this[a].wallPerpUVs=this.getPerpUVs(a);this[a].wallGrids=this.scatterPts(a)},scatterPts:function(a){var b=this.makeBlankGrid(),d=this[a];d.scatter=Array(d.length-1);var e=d.wallUVs,f=this.gridDim;for(a=0;a<d.scatter.length;a++)for(var h=e[a],k=d[a].distTo(d[a+1]),k=Math.ceil(k/f),l=d[a],m=0;m<k;m++){var n=Math.floor((l.x+h.dx*f*m)/f),p=Math.floor((l.y+h.dy*f*m)/f);(-1!=n||-1!=p)&&b[n][p].push(a)}return b},makeBlankGrid:function(){for(var a=Array(this.numCols+1),b=0;b<this.numCols+
1;b++){for(var d=Array(this.numRows+1),e=0;e<this.numRows+1;e++)d[e]=[];a[b]=d}return a},setWallVals:function(a,b,d,e,f,h,k,l,m,n,p,r){e=defaultTo({yMin:30,yMax:435},e);f=defaultTo(1,f);this[a]=b;_.extend(this[a],WallMethods.wall,WallMethods.wallDataHandler);this[a].handle=d;this[a].include=f;this[a].hitMode="Std";this[a].v=0;this[a].bounds=e;this[a].dotManager=p||dotManager;h&&this[a].setVol(h);this[a].col=defaultTo(this.defaultCol,n);this[a].show=defaultTo(!0,k);!1!==r&&this.closeWall(this[a]);
this[a].ptsInit=this.copyWallPts(this[a]);this[a].g=g;this[a].pConst=pConst;this[a].liquids={};this[a].data={};this[a].q=0;this[a].pIntLen=35;this[a].surfAreaAdj={};this[a].eToAdd=0;this[a].isothermal=!1;this[a].removed=!1;this[a].tSet=m;this[a].massChunks={};this[a].forceInternal=0;this[a].pLastRecord=turn;this[a].mass=0;this[a].parent=this;makeListenerHolder(this[a],"cleanUp");this[d]=this[a];(l=defaultTo(!0,l))&&this[a].recordDefaults()},addWall:function(a){this.numWalls++;var b=this.length;this.setWallVals(b,
a.pts,a.handle,a.bounds,a.include,a.vol,a.show,a.record,a.temp,a.col,a.dotManager,a.close);this.setupWall(b);this.setWallHandler(b,a.handler);a.border&&this[b].addBorder(a.border);a.hitMode&&this[b].setHitMode(a.hitMode);return this[b]},setPtsInit:function(){for(var a=0;a<this.length;a++)this[a].ptsInit=this.copyWallPts(this[a])},copyWallPts:function(a){for(var b=a.length,d=Array(b),e=0;e<b;e++)d[e]=a[e].copy();return d},idxByHandle:function(a){for(var b=0;b<this.length;b++)if(a==this[b].handle)return b;
console.log("Failed to get wall idx by handle\nHandle:"+a)},idxByInfo:function(a){return parseFloat(a)!=a?this.idxByHandle(a):a},remove:function(){for(var a=this.length-1;0<=a;a-=1)this.removeWall(a);this.removed=!0;emptyListener(curLevel,"wallMove")},removeWall:function(a){this[a]&&(this.numWalls-=1,this[a].recordAllStop(),this[a].cleanUp(),this[a].removeBorder(),this[a].removed=!0,a=this.idxByInfo(a),this[this[a].handle]=void 0,this.splice(a,1),this.removeHandlers(a))},removeHandlers:function(a){for(var b in this)-1!=
b.indexOf(a+"-")&&(this[b]=void 0)},closeWall:function(a){a.push(P(a[0].x,a[0].y))},getPerpUVs:function(a){a=this[a].wallUVs;for(var b=Array(a.length),d=0;d<a.length;d++){var e=a[d];b[d]=V(-e.dy,e.dx)}return b},getWallUV:function(a){for(var b=this[a].length-1,d=Array(b),e=0;e<b;e++){var f=this[a][e],h=this[a][e+1];d[e]=V(h.x-f.x,h.y-f.y).UV()}return d},check:function(){for(var a=this.gridDim,b=this.xSpan,d=this.ySpan,e=dotManager.lists.ALLDOTS,f=0;f<e.length;f++)for(var h=e[f],k=[],l=Math.floor(h.x/
a),m=Math.floor(h.y/a),n=Math.max(l-1,0),l=Math.min(l+1,b)+1;n<l;n++)for(var p=Math.max(m-1,0),r=Math.min(m+1,d)+1;p<r;p++)for(var q=0;q<this.length;q++)for(var u=this[q].wallGrids[n][p],s=0;s<u.length;s++){var t=u[s];!1===this.haveChecked([q,t],k)&&(this.checkWallHit(h,[q,t]),k.push([q,t]))}},checkWallHit:function(a,b){var d=b[0],e=b[1],f=this[d][e],h=this[d].wallUVs[e],k=this[d].wallPerpUVs[e],f=V(a.x+a.v.dx-k.dx*a.r-f.x,a.y+a.v.dy-k.dy*a.r-f.y),f=k.dotProd(f),l=-k.dotProd(a.v),m=this[b[0]].hitMode;
if(0>f&&-30<f&&this.isBetween(a,d,e,h))this["didHit"+m](a,d,e,h,l,k)},isBetween:function(a,b,d,e){var f=a.v.dotProd(e),h=f*e.dx,k=f*e.dy,f=P(walls[b][d].x+h,walls[b][d].y+k);d=P(walls[b][d+1].x+h,walls[b][d+1].y+k);b=V(-e.dx,-e.dy);f=V(a.x-f.x,a.y-f.y);a=V(a.x-d.x,a.y-d.y);return 0<=f.dotProd(e)&&0<=a.dotProd(b)},didHitStd:function(a,b,d,e,f,h){var k=this[b+"-"+d];k.func.apply(k.obj,[a,b,d,e,f,h])},didHitArrowDV:function(a,b,d,e,f,h){var k=a.v.copy(),l=this[b+"-"+d];l.func.apply(l.obj,[a,b,d,e,f,
h]);b=P(a.x,a.y);d=a.v.copy();a=-h.dotProd(a.v);this.drawArrowV(b,k,d,f,a)},didHitArrowSpd:function(a,b,d,e,f,h){var k=a.v.copy(),l=this[b+"-"+d];l.func.apply(l.obj,[a,b,d,e,f,h]);b=P(a.x,a.y);d=a.v.copy();a=-h.dotProd(a.v);this.drawArrowSpd(b,k,d,f,a)},didHitGravity:function(a,b,d,e,f,h){var k=this[b+"-"+d];if(0!=e.dx)var l=a.y,m=a.v.dy;k.func.apply(k.obj,[a,b,d,e,f,h]);0!=e.dx&&(b=a.v.dy*a.v.dy+2*gInternal*(a.y-l),0<=b?a.v.dy=0<a.v.dy?Math.sqrt(b):-Math.sqrt(b):(a.v.dy=-1E-7,a.y=(a.v.dy*a.v.dy-
m*m)/(2*gInternal)+l))},assignRecording:function(a){for(var b in a)a.recording=!1},assignDisplaying:function(a){for(var b in a)a.displaying=!1},haveChecked:function(a,b){for(var d=0;d<b.length;d++)if(b[d][0]==a[0]&&b[d][1]==a[1])return!0;return!1},totalVolume:function(){for(var a=0,b=0;b<this.length;b++)a+=this[b].include*this.wallArea(b);return a*vConst},wallVolume:function(a){return this.area(this[a].slice(0,this[a].length-1))*vConst},area:function(a){var b=0,d=this.isConvex(a),e=d.multiplier;if(d.isConvex)return this.areaConvex(a);
a=this.splitConcave(a,e);b+=this.area(a[0]);return b+=this.area(a[1])},isConvex:function(a){for(var b=this.getMult(a),d=1;d<a.length-1;d++){var e=this.abcs(a,d),e=this.angleBetweenPts(e.a,e.b,e.c,b);if(e>Math.PI)return{isConvex:!1,multiplier:b}}this.angleBetweenPts(a[a.length-2],a[a.length-1],a[0],b);e=this.angleBetweenPts(a[a.length-1],a[0],a[1],b);return e>Math.PI?{isConvex:!1,multiplier:b}:{isConvex:!0,multiplier:b}},getMult:function(a){var b=Math.PI*(a.length-2),d=this.getAreaUVs(a),e=this.getIntAngles(a,
d,1);a=this.getIntAngles(a,d,-1);if(round(e,2)==round(b,2))return 1;if(round(a,2)==round(b,2))return-1},getAreaUVs:function(a){for(var b=Array(a.length),d=0;d<a.length-1;d++){var e=a[d],f=a[d+1];b[d]=e.VTo(f).UV()}e=a[a.length-1];f=a[0];b[b.length]=e.VTo(f).UV();return b},getIntAngles:function(a,b,d){b=0;for(var e=1;e<a.length-1;e++)b+=this.angleBetweenPts(a[e-1],a[e],a[e+1],d);b+=this.angleBetweenPts(a[a.length-2],a[a.length-1],a[0],d);return b+=this.angleBetweenPts(a[a.length-1],a[0],a[1],d)},splitConcave:function(a,
b){for(var d=Array(a.length+2),e=0;e<a.length;e++)d[e]=a[e];d[d.length-2]=a[0];d[d.length-1]=a[1];for(e=1;e<d.length-1;e++){var f=this.abcs(d,e);if(this.angleBetweenPts(f.a,f.b,f.c,b)>Math.PI)return e==a.length&&(e=0),this.splitAt(d.slice(0,d.length-2),e,b)}},splitAt:function(a,b,d){a=a.slice(b,a.length).concat(a.slice(0,b));d=a[0];for(b=2;b<a.length-1;b++)if(!this.crossesWall(d,a[b],a))return d=a.slice(0,b+1),a=a.slice(0,1).concat(a.slice(b,a.length)),[d,a]},abcs:function(a,b){return{a:a[b-1],b:a[b],
c:a[b+1]}},crossesWall:function(a,b,d){a.VTo(b);for(var e=1;e<d.length;e++){var f,h;e==d.length-1?(f=d[e],h=d[0]):(f=d[e],h=d[e+1]);if(this.linesCross({p1:a,p2:b},{p1:f,p2:h}))return!0}return!1},linesCross:function(a,b){var d=a.p1.VTo(a.p2),e=b.p1.VTo(b.p2),f=d.mag(),h=e.mag(),d=d.UV(),k=e.UV(),e=this.getDist(a,b,d,k,"p1"),d=this.getDist(a,b,d.neg(),k.neg(),"p2");e.da=round(e.da,5);e.db=round(e.db,5);d.da=round(d.da,5);d.db=round(d.db,5);f=round(f,5);h=round(h,5);return e.da>=f||e.db>=h||d.da>=f||
d.db>=h?!1:!0},getDist:function(a,b,d,e,f){"p1"==f?(a=a.p1,b=b.p1):(a=a.p2,b=b.p2);if(0==d.dx&&0==e.dx)return{da:Infinity,db:Infinity};if(0==d.dx)return f=a.x-b.x,f=Math.abs(f/e.dx),d=b.copy().movePt(e.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==e.dx)return f=b.x-a.x,f=Math.abs(f/d.dx),d=a.copy().movePt(d.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==d.dy&&0==e.dy)return{da:Infinity,db:Infinity};if(0==d.dy)return f=a.y-b.y,f=Math.abs(f/e.dy),d=b.copy().movePt(e.copy().mult(f)),{da:a.distTo(d),
db:b.distTo(d)};if(0==e.dy)return f=b.y-a.y,f=Math.abs(f/d.dy),d=a.copy().movePt(d.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};f=e.dx*d.dy/d.dx-e.dy;if(0==f)return{da:Infinity,db:Infinity};f=(b.y-a.y-d.dy*b.x/d.dx+a.x*d.dy/d.dx)/f;return{da:(b.x+e.dx*f-a.x)/d.dx,db:f}},angleBetweenPts:function(a,b,d,e){var f=a.VTo(b).UV();a=f.copy().neg();b=b.VTo(d).UV();e=f.copy().add(b).rotate(Math.PI/2*e);a=Math.atan2(a.dy,a.dx);b=Math.atan2(b.dy,b.dx);e=Math.atan2(e.dy,e.dx);return this.distBetweenAngles(a,
e)+this.distBetweenAngles(e,b)},distBetweenAngles:function(a,b){0>a&&(a+=2*Math.PI);0>b&&(b+=2*Math.PI);var d=Math.max(a,b),e=Math.min(a,b),d=d-e;return d>Math.PI?2*Math.PI-d:d},areaConvex:function(a){for(var b=0,d=a[0],e=2;e<a.length;e++)b+=d.area(a[e-1],a[e]);return b},drawArrowV:function(a,b,d,e,f){var h=Array(3);h[0]=a.copy().movePt(b.copy().mult(10).neg());h[1]=a.copy();h[2]=a.copy().movePt(d.copy().mult(10));b="drawArrow"+round(a.x,0)+round(a.y,0);new ArrowLine(b,h,Col(255,0,0),50,c);a=a.copy().movePt(d.mult(15));
e=(Math.abs(e)+Math.abs(f))*pxToMS;animText.newAnim({pos:a},{pos:a.copy().movePt({dy:-20}),col:curLevel.bgCol},{text:"deltaV = "+round(e,1)+"m/s",time:3E3})},drawArrowSpd:function(a,b,d,e,f){e=Array(3);e[0]=a.copy().movePt(b.copy().mult(10).neg());e[1]=a.copy();e[2]=a.copy().movePt(d.copy().mult(10));b="drawArrow"+round(a.x,0)+round(a.y,0);new ArrowLine(b,e,Col(255,0,0),50,c);a=a.copy().movePt(d.mult(15));d=0.1*d.mag()*pxToMS;animText.newAnim({pos:a},{pos:a.copy().movePt({dy:-20}),col:curLevel.bgCol},
{text:"Speed = "+round(d,1)+"m/s",time:3E3})}}};WallMethods.DataObj=function(){this.srcVal=[];this.idVal;this.typeVal;this.idArgsVal;this.wallHandleVal;this.recordingVal=!1;this.recordStopVal=void 0;this.readoutVal};
WallMethods.DataObj.prototype={id:function(a){a&&(this.idVal=a);return this.idVal},type:function(a){a&&(this.typeVal=a);return this.typeVal},idArgs:function(a){a&&(this.idArgsVal=a);return this.idArgsVal},argsMatch:function(a){return objectsEqual(this.idArgsVal,a)},readout:function(a){a&&(this.readoutVal=a);return this.readoutVal},wallHandle:function(a){a&&(this.wallHandleVal=a);return this.wallHandleVal},src:function(a){a&&(this.srcVal=a);return this.srcVal},recording:function(a){void 0!==a&&(this.recordingVal=
a);return this.recordingVal},recordStop:function(a){a?this.recordStopVal=a:this.recordStopVal&&this.recordingVal&&this.recordStopVal()}};WallMethods.wall={reset:function(){for(var a=this.ptsInit,b=0;b<a.length;b++)this[b].x=a[b].x,this[b].y=a[b].y;this.v=this.forceInternal=0;this.parent.setupWall(this.parent.indexOf(this))},setVol:function(a){a=this.volToY(a);this[0].position({y:a});this[1].position({y:a})},volToY:function(a){var b=this[2].distTo(this[3]);a/=vConst*b;this[2].VTo(this[3]).UV().perp("cw");return this[2].y-a},changeSetPt:function(a,b,d){if(-1!=b.indexOf("isothermal"))var e="cVIsothermal";else-1!=b.indexOf("adiabatic")&&
(e="cVAdiabatic");removeListener(curLevel,"wallMove","cV"+this.handle);var f=function(a){this[0].y=a;this[1].y=a;this[this.length-1].y=a};b=a-this[0].y;0!=b&&(b=getSign(b),this.v=d*b,this.parent.setSubWallHandler(this.handle,0,e),addListener(curLevel,"wallMove","cV"+this.handle,function(){var b=this[0].y;f.apply(this,[stepTowards(b,a,this.v)]);this.parent.setupWall(this.handle);round(b,2)==round(a,2)&&(removeListener(curLevel,"wallMove","cV"+this.handle),this.parent.setSubWallHandler(this.handle,
0,"staticAdiabatic"),this.v=0)},this))},releaseWithBounds:function(a,b,d,e){this.moveStop();removeListener(curLevel,"wallMove","releaseWithBounds"+this.handle);removeListener(curLevel,"wallMove","cP"+this.handle);this.parent.setSubWallHandler(this.handle,0,d);a=defaultTo(0,a);b=defaultTo(Number.MAX_VALUE,b);var f=g,h=this.bounds;addListener(curLevel,"wallMove","releaseWithBounds"+this.handle,function(){var d=this[0].y,l=d+this.v+0.5*f;l<a||l>b?(this.moveStop(),this.parent.setSubWallHandler(this.handle,
0,"staticAdiabatic"),l<a?(e(a),d=a):(e(b),d=b)):l>h.yMax||l<h.yMin?d=this.hitBounds(d,f,h.yMin,h.yMax):(d=l,this.v+=f);this[0].y=d;this[1].y=d;this[this.length-1].y=d;this.parent.setupWall(this.handle)},this)},moveInit:function(){var a=g,b=this.bounds;addListener(curLevel,"wallMove","cP"+this.handle,function(){var d=this[0].y,e=d+this.v+0.5*a;e>b.yMax||e<b.yMin?d=this.hitBounds(d,a,b.yMin,b.yMax):(d=e,this.v+=a);this[0].y=d;this[1].y=d;this[this.length-1].y=d;this.parent.setupWall(this.handle)},this)},
moveStop:function(){this.v=0;removeListener(curLevel,"wallMove","cP"+this.handle);removeListener(curLevel,"wallMove","releaseWithBounds"+this.handle)},hitBounds:function(a,b,d,e){var f=1,h=Math.max(d,Math.min(e,a+this.v*f+0.5*b*f*f));a=this.v*this.v+2*b*(h-a);if(h==e)var k=(-this.v+Math.sqrt(a))/b;else h==d&&(k=(-this.v-Math.sqrt(a))/b);this.v+=b*k;this.v*=-1;f-=k;-2*this.v<f*b&&0>this.v&&(d=Math.abs(2*this.v/b),f-=Math.floor(f/d)*d);h=h+this.v*f+0.5*b*f*f;this.v+=b*f;return h},setHitMode:function(a){/^[sS]td$/.test(a)||
/^[aA]rrowDV$/.test(a)||/^[aA]rrowSpd$/.test(a)||/^[gG]ravity$$/.test(a)?this.hitMode=a.toCapitalCamelCase():console.log("bad hitMode "+a)},setDefaultReadout:function(a){this.defaultReadout=a;return this},unsetDefaultReadout:function(){this.defaultReadout=void 0;return this},setTemp:function(a){this.tSet=a},getCv:function(){var a=0,b;for(b in window.spcs)var d=dotManager.get({tag:this.handle,spcName:b}),a=a+(d?d.length:0)*spcs[b].cv/N;return a},isothermalInit:function(a){a&&(this.tSet=a);this.eToAdd=
0;dotManager.get({tag:this.handle});var b=this.data.temp.src();this.isothermal||(addListener(curLevel,"data","recordEnergyForIsothermal"+this.handle,function(){var a;a=this.tSet-(b[b.length-1]||this.tSet);this.eToAdd=this.getCv()*a;for(var e in this.liquids){var f=this.liquids[e],h="setT"+f.handle;removeListener(curLevel,"update",h);var k=this.tSet;a=k-f.temp;if(1<Math.abs(a)){var l=a/15;addListener(curLevel,"update",h,function(){var a=stepTowards(f.temp,k,l);this.q+=(a-f.temp)*f.Cp*JtoKJ;f.temp=
a;a==k&&removeListener(curLevel,"update",h)},this)}}},this),this.recordQ());for(a=0;a<this.length;a++)this[a].isothermal=!0;this.isothermal=!0},isothermalStop:function(){this.isothermal=!1;removeListener(curLevel,"data","recordEnergyForIsothermal"+this.handle)},surfArea:function(){var a=0;for(ptIdx=0;ptIdx<this.length-1;ptIdx++)a+=this[ptIdx].distTo(this[ptIdx+1]);return a},updateMass:function(){var a=0,b;for(b in this.massChunks)a+=this.massChunks[b];this.mass=a},setMass:function(a,b){this.massChunks[a]=
b;this.updateMass();return this},unsetMass:function(a){if(a)delete this.massChunks[a];else for(a in this.massChunks)delete this.massChunk[a];this.updateMass();return this},addLiquid:function(a){this.liquids[a.handle]=a},removeLiquid:function(a){"string"==typeof a&&(a=this.liquids[a]);a&&a.handle&&delete this.liquids[a.handle]},addBorder:function(a){a.wall=this;this.border=new WallMethods.Border(a)},removeBorder:function(){this.border&&this.border.remove()},addPts:function(a,b){for(var d=[],e=this.parent.idxByInfo(this.handle),
f=a;f<this.length;f++)d.push(this.parent.getSubWallHandler(e,a));e=this.concat();e=e.slice(0,a).concat(b,e.slice(a,e.length));for(f=0;f<e.length;f++)this[f]=e[f];for(e=a+b.length;e<this.length;e++)this.parent.setSubWallHandler(this.handle,e,d[e-b.length-a]);d=d[0]||this.parent[id+"-"+(a-1)];for(e=a;e<a+b.length;e++)this.parent.setSubWallHandler(this.handle,e,d);this.parent.setupWall(this.handle);this.border&&!this.border.removed&&this.border.update()},removePts:function(a,b){for(var d=[],e=this.parent.idxByInfo(this.handle),
f=a+b;f<this.length;f++)d.push(this.parent.getSubWallHandler(e,f));this.splice(a,b);for(f=a;f<this.length;f++)this.parent.setSubWallHandler(e,f,d[f-a]);this.parent.setupWall(this.handle);this.border&&!this.border.removed&&this.border.update()},getPt:function(a){return this[a]},getUV:function(a){return this.wallUVs[a]},getPerpUV:function(a){return this.wallPerpUVs[a]},populateArrows:function(a){var b=this.parent.qArrowFill,d=this.parent.qArrowFillFinal,e=this.parent.qArrowStroke,f=getSign(a),h={"-1":"cw",
1:"ccw"}[f];this.turnLastArrow=this.data.q.src().length-1;a=V(110*Math.abs(a),170*Math.abs(a));var k=a.copy();k.dx*=1.4;k.dy*=0.85;var l={"-1":0,1:-k.dx-30};if(7<a.dx||7<a.dy)for(var m=0;m<this.length-1;m++)if(this[m].isothermal)for(var n=this[m].distTo(this[m+1]),p=Math.round(n/150),r=n/=p+1,q=0;q<p;q++){var u=this[m].copy().movePt(this.wallUVs[m].copy().mult(r)).movePt(this.wallPerpUVs[m].copy().mult(l[f]));new ArrowFly({pos:u,dist:30,UV:this.wallUVs[m].copy().perp(h),fill:b,fillFinal:d,stroke:e,
dims:a,dimsFinal:k,lifespan:3500});r+=n}},cleanUp:function(){var a=this.cleanUpListeners,b;for(b in a){var d=a[b];d.func.apply(d.obj)}}};WallMethods.wallDataHandler={pExt:function(){return this.pConst*this.mass*this.g/(this[1].x-this[0].x)},pInt:function(){var a=this.surfArea(),b;for(b in this.surfAreaAdj)a+=this.surfAreaAdj[b].val;a=this.pConst*this.forceInternal/((turn-this.pLastRecord)*a);this.forceInternal=0;this.pLastRecord=turn;this.pIntList[this.pIntIdx]=a;this.pIntIdx++;this.pIntIdx==this.pIntLen&&(this.pIntIdx=0);return this.pIntList.average()},addSurfAreaAdjust:function(a){this.surfAreaAdj[a]={val:0};return this.surfAreaAdj[a]},
removeSurfAreaAdjust:function(a){delete this.surfAreaAdj[a]},getDataObj:function(a,b,d){if(this.data[a])if(this.data[a]instanceof Array)for(d=0;d<this.data[a].length;d++){if(this.data[a][d].argsMatch(b))return this.data[a][d]}else return this.data[a];else!0!==d&&(console.log('Tried to get bad data type "'+a+'" with args'),console.log(b));return!1},getDataSrc:function(a,b,d){if(this.data[a])if(this.data[a]instanceof Array)for(d=0;d<this.data[a].length;d++){if(this.data[a][d].argsMatch(b))return this.data[a][d].srcVal}else return this.data[a].srcVal;
else d||(console.log('Tried to get bad data type "'+a+'" with args'),console.log(b));return!1},removeDataObj:function(a,b){if(this.data[a])if(this.data[a]instanceof Array){for(var d=0;d<this.data[a].length;d++)if(this.data[a][d].argsMatch(b))return this.data[a].splice(d,1);console.log("Couldn't find data "+a+" with args "+b)}else return delete this.data[a]},createSingleValDataObj:function(a,b,d){var e=new WallMethods.DataObj;d?this.data[a]?this.data[a].push(e):this.data[a]=[e]:this.data[a]=e;this.setupStdDataObj(e,
a);e.recordStop(function(){});e.srcVal=[b()];return e},recordDefaults:function(){this.recordTime();this.recordTemp();this.recordPInt();this.recordVol()},recordTime:function(){this.data.time=new WallMethods.DataObj;var a=this.data.time;this.setupStdDataObj(a,"time");var b=Date.now();recordData(a.id()+a.wallHandle(),a.src(),function(){return(Date.now()-b)/1E3},this,"update")},recordTemp:function(a){if(!this.data.temp||!this.data.temp.recording()){this.data.temp=new WallMethods.DataObj;var b=this.data.temp;
this.setupStdDataObj(b,"temp");var d=this.dotManager.getWithLog({tag:this.handle});a||(a=function(){for(var a=0,b=0;b<d.length;b++)a+=d[b].KE();return d.length?tConst*a/d.length:0});recordData(b.id()+b.wallHandle(),b.src(),a,this,"update")}return this},recordRMS:function(){},getRMSMass:function(a){if(a)for(var b in spcs)for(var d=spcs[b].dots,e=0;e<d.length;e++)if(a){if(d[e].tag==a)return d[e].m}else return d[e].m},recordPInt:function(){if(!this.data.pInt||!this.data.pInt.recording()){this.data.pInt=
new WallMethods.DataObj;var a=this.data.pInt;this.setupStdDataObj(a,"pInt");this.pIntList=[];this.pIntIdx=0;recordData(a.id()+a.wallHandle(),a.src(),this.pInt,this,"update")}return a},recordPExt:function(){if(!this.data.pExt||!this.data.pExt.recording()){this.data.pExt=new WallMethods.DataObj;var a=this.data.pExt;this.setupStdDataObj(a,"pExt");recordData(a.id()+a.wallHandle(),a.src(),this.pExt,this,"update")}return a},recordVol:function(){if(!this.data.vol||!this.data.vol.recording()){this.data.vol=
new WallMethods.DataObj;var a=this.data.vol;this.setupStdDataObj(a,"vol");recordData(a.id()+a.wallHandle(),a.src(),function(){return this.parent.wallVolume(this.handle)},this,"update")}return a},recordWork:function(){if(!this.data.work||!this.data.work.recording()){this.data.work=new WallMethods.DataObj;var a=this.data.work;this.setupStdDataObj(a,"work");this.work=0;var b=LtoM3,d=PUNITTOPA,e=JtoKJ,f=this,h=this.getDataObj("vol").src();recordData(a.id()+a.wallHandle(),a.src(),function(){var a=h.length,
a=b*(h[a-1]-h[a-2]);if(isNaN(a))return f.work=0;var l=f.pExt()*d;f.work-=e*l*a;return f.work},this,"update")}return a},recordMass:function(){if(!this.data.mass||!this.data.mass.recording()){this.data.mass=new WallMethods.DataObj;var a=this.data.mass;this.setupStdDataObj(a,"mass");recordData(a.id()+a.wallHandle(),a.src(),function(){return this.mass},this,"update")}return a},recordQ:function(){if(!this.data.q||!this.data.q.recording()){this.data.q=new WallMethods.DataObj;var a=this.data.q;this.setupStdDataObj(a,
"q");recordData(a.id()+a.wallHandle(),a.src(),function(){return this.q},this,"update")}return a},recordVDist:function(a){var b=this.dotManager.createIfNotExists(a);this.data.vDist||(this.data.vDist=[]);if(!this.getDataObj("vDist",a)){this.data.vDist.push(new WallMethods.DataObj);var d=this.data.vDist[this.data.vDist.length-1];this.setupInfoDataObj(d,"vDist",a);recordData(d.id()+d.wallHandle(),d.src(),function(){for(var a=[],d=0;d<b.length;d++)a.push(b[d].speed());return a},this,"update")}},recordMoles:function(a){var b,
d=this.dotManager.createIfNotExists(a);this.data.moles||(this.data.moles=[]);this.getDataObj("moles",a)?b=this.getDataObj("moles",a):(this.data.moles.push(new WallMethods.DataObj),b=this.data.moles[this.data.moles.length-1],this.setupInfoDataObj(b,"moles",a),recordData(b.id()+b.wallHandle(),b.src(),function(){return d.length/N},this,"update"));return b},recordFrac:function(a){var b,d=this.dotManager.createIfNotExists(a),e=this.dotManager.createIfNotExists(a.tag?{tag:a.tag}:void 0);this.data.frac||
(this.data.frac=[]);this.getDataObj("frac",a)?b=this.getDataObj("frac",a):(this.data.frac.push(new WallMethods.DataObj),b=this.data.frac[this.data.frac.length-1],this.setupInfoDataObj(b,"frac",a),recordData(b.id()+b.wallHandle(),b.src(),function(){return d.length/e.length},this,"update"));return b},setupStdDataObj:function(a,b){a.recording(!0);a.recordStop(this.recordStop);a.id(b);a.type(b);a.wallHandle(this.handle);inPrompt()&&this.setupPromptRecordStop(a,a.id())},setupInfoDataObj:function(a,b,d){a.recording(!0);
a.recordStop(this.recordStopDestroy);a.id(b+(d.spcName||"").toCapitalCamelCase()+(d.tag||"").toCapitalCamelCase());a.wallHandle(this.handle);a.type(b);a.idArgs(d);inPrompt()&&this.setupPromptRecordStop(a)},setupPromptRecordStop:function(a){var b="recordStop"+a.id().toCapitalCamelCase();addListener(curLevel,currentSetupType+"CleanUp",b,function(){a.recordStop();removeListener(curLevel,currentSetupType+"CleanUp",b)})},setupPromptDisplayStop:function(a){var b="displayStop"+a.id().toCapitalCamelCase();
addListener(curLevel,currentSetupType+"CleanUp",b,function(){a.displayStop();removeListener(curLevel,currentSetupType+"CleanUp",b)})},recordStopDestroy:function(){this.recording(!1);walls[this.wallHandle()].removeDataObj(this.type(),this.idArgs());recordDataStop(this.id()+this.wallHandle())},recordStop:function(){this.recording(!1);recordDataStop(this.id()+this.wallHandle())},recordAllStop:function(){for(var a in this.data){var b=this.data[a];if(b instanceof Array)for(var d=0;d<b.length;d++)b[d].recordStop();
else b.recordStop()}return this},resetWork:function(){this.work=0;return this},resetQ:function(){this.q=0;return this},displayQArrowsRate:function(a){a=a.threshold;if(this.data.q.recording()&&(!this.data.qArrowsRate||!this.data.qArrowsRate.recording())&&(!this.data.qArrowsAmmt||!this.data.qArrowsAmmt.recording())){this.data.qArrowsRate=new WallMethods.DataObj;var b=this.data.qArrowsRate;b.displaying(!0);b.wallHandle(this.handle);b.id("qArrowsRate");this.turnLastArrow=Math.max(0,this.data.q.length-
1);this.qArrowThreshold=defaultTo(a,0.3);var d="checkForDisplayArrows"+b.wallHandle(),e=this;qSrc=this.data.q.src();addListener(curLevel,"update",d,function(){e.checkDisplayArrows(qSrc)},this);this.turnLastArrow=turn;addListener(this,"cleanUp","qArrowsRate",function(){removeListener(curLevel,"update",d);removeListenerByName(curLevel,"update","ArrowFly")})}else console.log("Tried to display q arrowsRate for wall "+this.handle+" while not recording or already displaying.  Will not display."),console.trace()},
makeDataList:function(){var a=[];a.displaying=!1;a.recording=!1;return a},resetQ:function(){this.q=0;this.displayingQArrowsAmmt&&(this.displayQArrowsAmmtStop(),this.displayQArrowsAmmt(this.qArrowAmmtMax))},resetWork:function(){this.work=0},checkDisplayArrows:function(a){a=a[a.length-1]-a[this.turnLastArrow];Math.abs(a)>this.qArrowThreshold&&(this.populateArrows(a),this.turnLastArrow=turn)}};WallMethods.collideMethods={cPAdiabaticDamped:function(a,b,d,e,f,h,k){e=a.temp();h=this[b];a.v.copy();k=a.v.dy;var l=h.v,m=a.m,n=h.mass,p=Math.abs(l);if(1<p){b=k*k;d=l*l;var p=0.0017*p*p*p-0.0281*p*p+0.205*p+0.8466,r=p*p,q=m*(1+m/(r*n)),u=-2*m*(k*m/n+l)/r;b=(-u+Math.sqrt(u*u-4*q*((m*(m*b/n+2*l*k)+n*d)/r-m*b-n*d)))/(2*q);a.y+=a.r;h.v=(m*k+n*l-m*b)/(n*p)}else d=walls[b][d],b=(k*(m-n)+2*n*l)/(a.m+n),h.v=(l*(n-m)+2*m*k)/(n+m),a.y=d.y+a.r;a.setTemp(e+(0.5*tConst*a.m*(a.v.dx*a.v.dx+b*b)-e)*a.cvKinetic/
a.cv);0>a.v.dy*b&&(a.v.dy*=-1);h.forceInternal+=a.m*(Math.abs(f)+Math.abs(a.v.dy))},cPAdiabatic:function(a,b,d,e,f,h,k){e=a.temp();b=this[b];a.v.copy();h=a.v.dy;k=b.v;var l=a.m,m=b.mass,n=b[d];d=(h*(l-m)+2*m*k)/(a.m+m);b.v=(k*(m-l)+2*l*h)/(m+l);a.y=n.y+a.r;a.setTemp(e+(0.5*tConst*a.m*(a.v.dx*a.v.dx+d*d)-e)*a.cvKinetic/a.cv);0>a.v.dy*d&&(a.v.dy*=-1);b.forceInternal+=a.m*(Math.abs(f)+Math.abs(a.v.dy))},staticAdiabatic:function(a,b,d,e,f,h,k){this.reflect(a,e,f);this[b].forceInternal+=2*a.m*Math.abs(f)},
cVIsothermal:function(a,b,d,e,f,h,k){if(this[b].eToAdd){h=getSign(this[b].eToAdd);d=a.temp();h*=Math.min(Math.abs(this[b].eToAdd),20*a.cv);0>h&&20>=d&&(h=(d-20)*a.cv);this[b].eToAdd-=h;k=d+h/a.cv;var l=Math.sqrt(k/d),m=f*l;this.reflect(a,e,f);a.v.dx*=l;a.v.dy*=l;a.internalPotential*=k/d;this[b].forceInternal+=a.m*(Math.abs(f)+Math.abs(m));this[b].q+=h*JtoKJ}else this[b].forceInternal+=2*a.m*Math.abs(f),this.reflect(a,e,f)},cVAdiabatic:function(a,b,d,e,f,h,k){d=a.temp();e=-a.v.dy+2*walls[b].v;this[b].forceInternal+=
2*a.m*f;a.setTemp(d+(0.5*tConst*a.m*(a.v.dx*a.v.dx+e*e)-d)*a.cvKinetic/a.cv);0>a.v.dy*e&&(a.v.dy*=-1)},reflect:function(a,b,d){a.v.dx-=2*b.dy*d;a.v.dy+=2*b.dx*d;a.x-=b.dy;a.y+=b.dx},outlet:function(a){dotManager.remove(a)}};WallMethods.Border=function(a){this.wall=a.wall;this.type=a.type;this.yMin=void 0!==a.yMin?a.yMin:this.wall[0].y;this.col=a.col||this.wall.col.copy().adjust(-100,-100,-100);this.thick=a.thickness||5;this.update=this.pickGenerator(this.type);this.update();this.removed=!1};
WallMethods.Border.prototype={remove:function(){this.removed=!0;removeListener(curLevel,"update",this.listenerName)},pickGenerator:function(a){if("open"==a)return this.genOpen();if("wrap"==a)return this.genWrap()},genOpen:function(){return this.genBorder(this.thick,this.col,1,"end",!0)},genWrap:function(){return this.genBorder(this.thick,this.col,0,"end",!1)},genBorder:function(a,b,d,e,f){var h=this,k=c;this.listenerName="drawBorder"+this.wall.handle.toCapitalCamelCase();return function(){h.remove();
var l=h.genSegs(d,e,a,f);addListener(curLevel,"update",h.listenerName,function(){for(var a=0;a<l.length;a++)draw.fillPts(l[a],b,k)});h.removed=!1}},genSegs:function(a,b,d,e){var f=[];b="end"==b?this.wall.length-1:b;for(var h=a;h<b;h++){var k=this.wall.wallPerpUVs[h].copy().neg(),l=this.wall[h].copy(),m=this.wall[h+1].copy(),n=h+1==b?0:h+1,p;p=this.getExtendV(k,this.wall[h-1]?h-1:this.wall.length-2,a-1,d,e);k=this.getExtendV(k,n,0,d,e);k=m.copy().movePt(k);p=l.copy().movePt(p);"open"==this.type&&(h==
a?(l.y=this.yMin,p.y=this.yMin):h==b-1&&(m.y=this.yMin,k.y=this.yMin));f.push([l,m,k,p])}return f},getExtendV:function(a,b,d,e,f){var h=this.wall.wallPerpUVs[b].copy().neg();b=f&&b==d?a.copy():h.add(a).UV();a=a.dotProd(b);return b.mult(e/a)}};function ButtonManager(a){this.wrapperDivId=a;this.groups=[]}
ButtonManager.prototype={addGroup:function(a,b,d,e,f,h){var k=$("#"+this.wrapperDivId),l="group"+a,m=l+"Wrapper",n=l+"Padder",p=templater.div({attrs:{id:[l],"class":["buttonGroup"]}}),p=b+templater.br()+p,m=templater.div({attrs:{id:[m],handle:[a],"class":["buttonManagerElem","displayText","buttonGroupWrapper"]},innerHTML:p}),n=templater.div({attrs:{id:[n],handle:[a],"class":["buttonManagerElem","buttonGroupPadder"]},innerHTML:m});k.append(n);this.groups.push(new ButtonManager.Group(k,l,a,b,d,e,f,
h))},removeGroup:function(a){var b=this.getGroup(a);b?(a=this.groups.indexOf(b),b=this.getGroupDiv(b),this.groups.splice(a,1),b.remove()):console.log("Bad group handle "+a)},removeButton:function(a,b){var d=this.getGroup(a);d?d.removeButton(b):console.log("Bad group handle "+a)},getGroupDiv:function(a){for(var b=$("#"+this.wrapperDivId).children(),d=0;d<b.length;d++)if($(b[d]).attr("handle")==a.handle)return $(b[d])},arrangeGroupWrappers:function(){var a=this.arrangeObjs(this.groups);this.arrangeHTML($("#"+
this.wrapperDivId),a)},arrangeAllGroups:function(){for(var a=0;a<this.groups.length;a++)this.arrangeGroup(this.groups[a].handle)},arrangeGroup:function(a){var b=this.getGroup(a);b?(a=this.arrangeObjs(b.buttons),this.arrangeHTML($("#"+b.groupId),a)):console.log("Bad group name "+a)},setButtonWidth:function(){for(var a=$("button.buttonManagerElem"),b=100,d=0;d<a.length;d++)var e=a[d],b=Math.max(b,$(e).outerWidth());for(d=0;d<a.length;d++)e=a[d],$(e).css("width",b)},arrangeHTML:function(a,b){for(var d=
a.children(),e=!1,f=0;f<d.length;f++){var h=d[f],k=b[f],h=$(h).attr("handle");if(e=Math.max(e,h!=k.handle))break}if(e){e={};for(f=0;f<d.length;f++)h=d[f],e[$(h).attr("handle")]=$(h).clone(!0);a.html("");for(d=0;d<b.length;d++)a.append(e[b[d].handle])}},addButton:function(a,b,d,e,f,h){var k=this.getGroup(a);k?k.addButton(b,d,e,f,h):console.log("Bad group handle "+a)},getGroup:function(a){for(var b=0;b<this.groups.length;b++)if(this.groups[b].handle==a)return this.groups[b]},arrangeObjs:function(a){var b=
[];a=this.sortObjs(a.concat());var d=this.slicePrefs(a);a=this.sliceNoPrefs(a);for(var e=0;e<d.length;e++){var f=d[e].prefIdx;b[f]?b.push(d[e]):b[f]=d[e]}for(e=d=0;d<a.length;)void 0==b[e]&&(b[e]=a[d],d++),e++;for(e=b.length-1;0<=e;e--)void 0==b[e]&&b.splice(e,1);return b},sortObjs:function(a){for(var b=0;b<a.length;b++)for(var d=0;d<a.length-1;d++)if(a[d].prefIdx>a[d+1].prefIdx||void 0==a[d].prefIdx){var e=a[d];a[d]=a[d+1];a[d+1]=e}return a},slicePrefs:function(a){for(var b=0;b<a.length;b++)if(void 0==
a[b].prefIdx)return a.slice(0,b);return a.slice(0,a.length)},sliceNoPrefs:function(a){for(var b=0;b<a.length;b++)if(void 0==a[b].prefIdx)return a.slice(b,a.length);return[]}};ButtonManager.Group=function(a,b,d,e,f,h,k){this.mgrDiv=a;this.groupId=b;this.handle=d;this.label=e;this.prefIdx=f;this.buttons=[];this.isRadio=h;this.isToggle=k&&!h};
ButtonManager.Group.prototype={addButton:function(a,b,d,e,f,h){var k=a+"Button",l=a+"Wrapper";this.buttons.push(new ButtonManager.Button(a,k,l,b,d,e,h));b=templater.button({innerHTML:b,attrs:{id:[k],"class":["buttonManagerElem","buttonManagerButton"],handle:[a]}});a=templater.div({innerHTML:b,attrs:{id:[l],"class":["buttonManagerElem","buttonWrapper"],handle:[a]}});$("#"+this.groupId).append(a);k=$("button#"+k);addJQueryElems(k,"button");a=this.buttons[this.buttons.length-1];l=a.cb;this.isRadio?l=
this.wrapInRadio(a,l):this.isToggle&&(l=this.wrapInToggle(a,l));f&&this.isRadio?this.pushRadio(a):f&&this.isToggle&&this.toggleButton(a);$(k).click(l)},removeButton:function(a){a=this.getButton(a);this.getButtonDiv(a).remove();this.buttons.splice(this.buttons.indexOf(a),1)},wrapInRadio:function(a,b){var d=b,e=this;return function(){e.pushRadio(a);d()}},wrapInToggle:function(a,b){var d=b,e=this;return function(){e.toggleButton(a);d()}},pushRadio:function(a){for(var b=0;b<this.buttons.length;b++)$("#"+
this.buttons[b].buttonId).removeClass("ui-button-as-radio-selected");$("#"+a.buttonId).addClass("ui-button-as-radio-selected")},toggleButton:function(a){a=$("#"+a.buttonId);a.hasClass("ui-button-as-radio-selected")?a.removeClass("ui-button-as-radio-selected"):a.addClass("ui-button-as-radio-selected")},getButton:function(a){for(var b=0;b<this.buttons.length;b++)if(this.buttons[b].handle==a)return this.buttons[b];console.log("Bad button handle "+a)},getButtonDiv:function(a){for(var b=$("#"+this.groupId).children(),
d=0;d<b.length;d++)if($(b[d]).attr("handle")==a.handle)return $(b[d])}};ButtonManager.Button=function(a,b,d,e,f,h,k){this.handle=a;this.buttonId=b;this.wrapperId=d;this.label=e;this.cb="function"==typeof f?f:this.wrapExprs(f);this.prefIdx=h;this.cleanUpWith=k||currentSetupType};ButtonManager.Button.prototype={wrapExprs:function(a){exprStr=a.join(";")+";";with(DataGetFuncs)a=eval("(function() {return "+exprStr+"})");return a}};function QuizRenderer(){this.hoverCol=Col(0,81,117);this.selectedCol=Col(40,121,147)}
QuizRenderer.prototype={render:function(a,b){var d=new QuizRenderer.Quiz(a);if(this.checkQuizTyping(d)){$(b).append(templater.br());var e=templater.div({attrs:{id:["quizWrapper"]},style:{display:"inline-block"}}),f=templater.div({attrs:{id:["quizContent"],"class":["niceFont","whiteFont"]}}),h=templater.div({attrs:{id:["quizFooter"]}});$(b).append(e);$("#quizWrapper");$(quizWrapper).append(f);$(quizWrapper).append(h);e=$("#quizContent");f=$("#quizFooter");for(h=0;h<d.questions.length;h++)this.renderQuestion(d.questions[h],
e);a[0]&&"setVals"==a[0].type?this.appendButtons(f,function(){sceneNavigator.prevPrompt()},function(){sceneNavigator.refresh()},"Back","Set values"):this.appendButtons(f,function(){sceneNavigator.prevPrompt()},function(){sceneNavigator.nextPrompt()},"Back","Submit");return d}},checkQuizTyping:function(a){a=a.questions;for(var b=!1,d=!1,e=0;e<a.length;e++)"setVals"==a.type?b=!0:d=!0;return b&&d?(console.log("Bad quiz typing.  Can't mix setVals with others"),!1):!0},renderQuestion:function(a,b){"multChoice"==
a.type?this.renderMultChoice(a,b):"text"==a.type?this.renderTextBox(a,b,3,50):"textSmall"==a.type?this.renderTextBox(a,b,1,10):"setVals"==a.type&&this.renderTextBox(a,b,1,10)},renderMultChoice:function(a,b){for(var d=a.options,e="<br><table width=100%<tr><td width=10%></td><td>",f=0;f<d.length;f++)var h=d[f],e=e+templater.div({attrs:{id:[a.storeAs+String(f)],"class":["multChoiceBlock"]},innerHTML:h.text});b.append(e);for(f=0;f<d.length;f++)h=d[f],h.div=$("#"+a.storeAs+String(f));this.bindMultChoiceQuestion(a)},
bindMultChoiceQuestion:function(a){var b=this,d=a.options,e=function(e){var f=d[e];a.answered=!0;if(!f.selected){for(var l=0;l<d.length;l++)d[l]!=f&&(d[l].div.css("background-color","transparent"),d[l].selected=!1);f.selected=!0;store(a.storeAs,e);a.hasCorrectAnswer()?a.correct=f.correct?!0:!1:a.correct=!0;$(f.div).css("background-color",b.selectedCol.hex)}};void 0!==getStore(a.storeAs)&&e(getStore(a.storeAs));for(var f=0;f<a.options.length;f++)this.bindMultChoiceOption(a,e,a.options,a.options[f])},
bindMultChoiceOption:function(a,b,d,e){var f=this;e.div.click(function(){b(d.indexOf(e))});e.div.hover(function(){e.selected||$(this).css("background-color",f.hoverCol.hex)},function(){e.selected||$(this).css("background-color","transparent")})},renderTextBox:function(a,b,d,e){var f=a.storeAs,h=defaultTo("Type your answer here.",a.text);textareaHTML=templater.textarea({attrs:{id:[f],rows:[d],cols:[e],placeholder:[h]}});d=(void 0===a.preText?"":interpreter.interp(a.preText)+templater.br())+templater.table({attrs:{"class":["niceFont",
"whiteFont"]},innerHTML:templater.tr({innerHTML:templater.td({innerHTML:a.label})+templater.td({innerHTML:"&#32;&#32;"})+templater.td({innerHTML:textareaHTML})+templater.td({innerHTML:a.units||""})})});b.append(d);a.div=$("#"+f);var k=function(b){b=void 0!==b?b:a.div.val();""!=b&&(store(a.storeAs,b),a.answered=!0,a.hasCorrectAnswer()?0.05>fracDiff(parseFloat(a.answer),parseFloat(val))?a.correct=!0:a.correct=!1:a.correct=!0)};getStore(a.storeAs)&&(k(getStore(a.storeAs)),a.div.html(getStore(a.storeAs)));
a.div.change(function(){k()})},appendButtons:function(a,b,d,e,f){e=templater.button({attrs:{id:["quizButtonLeft"]},innerHTML:e})+templater.button({attrs:{id:["quizButtonRight"]},innerHTML:f});e=templater.div({attrs:{id:["quizSubmitWrapper"]},style:{"float":"right"},innerHTML:e});$(a).append(e);$("#quizButtonLeft").click(b);$("#quizButtonRight").click(d);addJQueryElems($("#quizButtonLeft"),"button");addJQueryElems($("#quizButtonRight"),"button")}};
QuizRenderer.Quiz=function(a){this.questions=[];for(var b=0;b<a.length;b++)this.questions.push(new QuizRenderer.Question(a[b]))};
QuizRenderer.Quiz.prototype={allAnswered:function(){for(var a=0;a<this.questions.length;a++)if(!this.questions[a].answered)return!1;return!0},allCorrect:function(){for(var a=0;a<this.questions.length;a++)if(!this.questions[a].correct)return!1;return!0},fireAlertWrong:function(){for(var a=0;a<this.questions.length;a++){var b=this.questions[a];if(b.hasCorrectAnswer()&&!b.correct)if("multChoice"==b.type)for(var d=0;d<b.options.length;d++){if(b.options[d].selected&&b.options[d].message){alert(b.options[d].message);
return}}else if(b.message){alert(b.message);break}}}};QuizRenderer.Question=function(a){this.type=a.type;this.label=a.label;this.text=a.text;this.preText=a.preText;this.units=a.units;this.message=a.message;this.storeAs=a.storeAs;this.options=this.makeOptions(a.options);this.answered=!1;this.answer=a.answer;this.correct=!1;this.div=void 0};
QuizRenderer.Question.prototype={makeOptions:function(a){if(a){for(var b=[],d=0;d<a.length;d++)b.push(new QuizRenderer.MultChoiceOption(a[d]));return b}},hasCorrectAnswer:function(){if(("text"==this.type||"textSmall"==this.type||"setVals"==this.type)&&void 0!==this.answer)return!0;if("multChoice"==this.type)for(var a=0;a<this.options.length;a++)if(this.options[a].correct)return!0;return!1}};
QuizRenderer.MultChoiceOption=function(a){this.correct=a.correct||!1;this.text=a.text;this.selected=!1;this.message=a.message;this.div=void 0};function ActivationEnergySpcChanger(a){this.collideHandler=a;this.pairs={};this.active=!1;this.standardBreakUp=this.collideHandler.breakUp;this.breakUpFunc=this.makeBreakUpFunc()}
ActivationEnergySpcChanger.prototype={addPair:function(a){var b=a.spcNameLow,d=a.spcNameHigh;this.pairs[b]||this.pairs[d]?console.log("Trying to add another energy threshold to either "+b+" or "+d):(this.pairs[a.spcNameLow]=a,this.pairs[a.spcNameHigh]=a,this.active||this.addThresholdBreakUp())},removePair:function(a){delete this.pairs[a.spcNameLow];delete this.pairs[a.spcNameHigh];countAttrs(this.pairs)||(this.active=!1,this.restoreBreakUp())},addThresholdBreakUp:function(){this.collideHandler.breakUp=
this.breakUpFunc},restoreBreakUp:function(){this.collideHandler.breakUp=this.standardBreakUp},makeBreakUpFunc:function(){var a=this;return function(b,d,e){var f,h=a.pairs[b.spcName],k=a.pairs[d.spcName];h&&(f=b.kineticEnergy(),h.thresholdEnergy>=f&&b.spcName==h.spcNameHigh?dotManager.changeDotSpc([b],h.spcNameLow):h.thresholdEnergy<f&&b.spcName==h.spcNameLow&&dotManager.changeDotSpc([b],h.spcNameHigh));k&&(f=d.kineticEnergy(),k.thresholdEnergy>=f&&d.spcName==k.spcNameHigh?dotManager.changeDotSpc([d],
k.spcNameLow):k.thresholdEnergy<f&&d.spcName==k.spcNameLow&&dotManager.changeDotSpc([d],k.spcNameHigh));a.standardBreakUp(b,d,e)}}};function ConditionManager(){this.conditionSets={}}
ConditionManager.prototype={add:function(a){var b=this.timeStrToStamp(a.requiredFor);this.conditionSets[b]||(this.conditionSets[b]=[]);var b=this.conditionSets[b],d=this.getIfExists(a,b);a=new ConditionManager.TriggerEntry(a);d&&(a.satisfied=d.satisfied,b.splice(b.indexOf(d,1)));b.push(a)},canAdvance:function(a){var b;"number"==typeof a?b=a:/prompt/i.test(a)?b=/[0-9]+/.exec(a):/section/i.test(a)&&(b=-1);return this.checkConditions(this.conditionSets[b]||[])},checkConditions:function(a,b){b=defaultTo(!0,
b);for(var d,e=-1,f=!0,h=0;h<a.length;h++){var k=a[h],l=k.trigger;k.satisfied||(k=!0,"conditions"==l.checkOn&&!l.conditionFunc()?k=!1:!l.isSatisfied()&&!l.conditionFunc()&&(k=!1),!k&&(l.priority>e&&l.message)&&(d=l.message,e=l.priority),k||(f=!1))}b&&d&&alert(d);f&&a.map(function(a){a.satisfied=!0;/conditions/i.test(a.checkOn)&&a.recordVals()});return f},stripForInheritance:function(){for(var a in this.conditionSets)for(var b=this.conditionSets[a],d=b.length-1;0<=d;d--)b[d].satisfied&&b.splice(d,
1);return this},getIfExists:function(a,b){for(var d=0;d<b.length;d++)if(a.handle==b[d].trigger.handle)return b[d]},timeStrToStamp:function(a){if(/now/i.test(a))return timeline.now().promptIdx;if(/section/i.test(a))return-1;if(/prompt/i.test(a))return Number(/[0-9]+/.exec(a));if(!isNaN(Number(a)))return Number(a)}};ConditionManager.TriggerEntry=function(a){this.trigger=a;this.satisfied=!1};compressorFuncs={getBinPts:function(a,b,d,e){var f=[];e=defaultTo(5,e);f.push(P(a.x-b*d.dx/2,a.y-d.dy));f.push(P(a.x-d.dx/2,a.y));f.push(P(a.x+d.dx/2,a.y));f.push(P(a.x+b*d.dx/2,a.y-d.dy));f.push(P(a.x+b*d.dx/2+e,a.y-d.dy));f.push(P(a.x+d.dx/2+e,a.y+e));f.push(P(a.x-d.dx/2-e,a.y+e));f.push(P(a.x-b*d.dx/2-e,a.y-d.dy));f.push(P(a.x-b*d.dx/2,a.y-d.dy));return f}};
objectFuncs={setupStd:function(){this.enabled=!0;this.removed=!1;this.handle&&this.addToCurLevel();this.wrapRemove()},wrapRemove:function(){var a=this.remove;this.remove=function(){this.removed=!0;this.handle&&this.removeFromCurLevel();a.apply(this)}},addToCurLevel:function(){curLevel[curLevel.key(this.type,this.handle)]=this},removeFromCurLevel:function(){var a=curLevel.key(this.type,this.handle);delete curLevel[a]},pickSliderPos:function(){var a;this.wall?a=(this.wall[0].x+this.wall[1].x)/2:this.pos&&
this.dims?a=this.pos.x+this.dims.dx/2:this.pos&&(a=this.pos.x);if(a){var b=$("#main").width()/3;a=Math.floor(a/b);if(0==a)return"left";if(1!=a&&2==a)return"right"}return this.checkForMigrateCenter()},addSlider:function(a,b,d,e,f,h){if(!f||!h){e||(e=this.pickSliderPos());switch(e){case "left":f=$("#sliderHolderLeft");$("#sliderHolderSingle").hide();$("#sliderHolderDouble").show();break;case "center":f=$("#sliderHolderCenter");$("#sliderHolderSingle").show();$("#sliderHolderDouble").hide();break;case "right":f=
$("#sliderHolderRight"),$("#sliderHolderSingle").hide(),$("#sliderHolderDouble").show()}h=f}e="slider"+this.handle.toCapitalCamelCase();this.sliderWrappers=makeSlider(h,f,e,a,b,d);return e},checkForMigrateCenter:function(){return""!=$("#sliderHolderCenter").html().killWhiteSpace()?(this.migrateCenterSlider(),"right"):"center"},migrateCenterSlider:function(){var a=$("#sliderHolderCenter").html();$("#sliderHolderCenter").html("");$("#sliderHolderLeft").html(a)},removeSlider:function(){for(var a=0;a<
this.sliderWrappers.length;a++)this.sliderWrappers[a].html("")},hideSliderDivs:function(){$("#sliderHolderSingle").hide();$("#sliderHolderDouble").hide()},valToPercent:function(a){return 100*(a-this.min)/(this.max-this.min)},percentToVal:function(a){return a*(this.max-this.min)/100+this.min},pressureToMass:function(a){return a*(this.wall[1].x-this.wall[0].x)/(pConst*g)},massToPressure:function(a){return a*pConst*g/(this.wall[1].x-this.wall[0].x)},toggle:function(){this.enabled?this.disable():this.enable()}};
function DragWeights(a){this.type="DragWeights";this.handle=a.handle;this.tempWeightDefs=a.weightDefs;this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.zeroY=defaultTo(this.wall[2].y,a.min);this.pistonPt=defaultTo(this.wall[0],a.pistonPt);this.pistonOffset=defaultTo(void 0,a.pistonOffset);this.wallHandler=defaultTo("cPAdiabaticDamped",a.compMode);this.binY=defaultTo(myCanvas.height-15,a.binY);this.blockCol=defaultTo(Col(224,165,75),a.blockCol);this.binCol=defaultTo(Col(150,
150,150),a.binCol);void 0!==a.pInit?this.massInit=this.pressureToMass(a.pInit):this.massInit=this.pressureToMass(1);this.binHeight=defaultTo(45,a.binHeight);this.weightDimRatio=defaultTo(0.5,a.weightDimRatio);this.moveSpeed=defaultTo(20,a.moveSpeed);this.weightScalar=defaultTo(70,a.weightScalar);this.displayText=defaultTo(!0,a.displayText);this.binSlant=1.3;this.storeBinWidth=110;this.storeBinSpacing=60;this.pistonBinWidth=150;this.pistonBinSpacing=15;this.blockSpacing=2;this.mass=this.massInit;this.massChunkName=
"dragWeights";this.weightsOnPiston=[];this.font="12pt Calibri";this.fontCol=Col(255,255,255);this.binThickness=5;this.trackingPts=[];this.wall.setMass(this.massChunkName,this.massInit);this.wall.recordPExt();this.wall.recordWork();this.wall.recordMass();this.setupStd();return this.init()}
_.extend(DragWeights.prototype,objectFuncs,compressorFuncs,{init:function(){this.weightGroups=this.makeWeights(this.tempWeightDefs);this.bins={};this.bins.store=this.makeStoreBins();this.bins.piston=this.makePistonBins();walls.setSubWallHandler(this.wallInfo,0,this.wallHandler);this.displayText||(this.draw=this.drawNoText);addListener(curLevel,"update","drawDragWeights"+this.wallInfo,this.draw,this);this.enable();this.wall.moveInit();this.dropAllIntoBins("instant");delete this.tempWeightDefs;return this},
remove:function(){this.wall.moveStop();this.trackingPts.map(function(a){a.trackStop()});this.trackingPts.splice(0,this.trackingPts.length);removeListener(curLevel,"update","drawDragWeights"+this.wallInfo);removeListener(curLevel,"mousedown","weights"+this.wallInfo)},getWeightDims:function(a){for(var b={},d=this.storeBinWidth-this.blockSpacing,e=0,f=0,h=0;h<a.length;h++){var k=a[h],l=Math.sqrt(k.mass*this.weightScalar/this.weightDimRatio);Math.max(l,e)>e&&(f=k.mass,e=l);b[k.name]=V(l,l*this.weightDimRatio)}return e>
d?(this.weightScalar=0.99*d*d*this.weightDimRatio/f,this.getWeightDims(a)):b},nameWeights:function(a){for(var b=0;b<a.length;b++)a[b].name="grp"+b},assignMasses:function(a){for(var b=0;b<a.length;b++)weightDef=a[b],weightDef.mass=this.pressureToMass(weightDef.pressure)},makeWeights:function(a){this.nameWeights(a);var b={};this.assignMasses(a);for(var d=this.getWeightDims(a),e=0,f=0;f<a.length;f++){var h=a[f],k={};k.name=h.name;k.dims=d[k.name];k.pressure=h.pressure;k.mass=h.mass;k.weights=[];for(var l=
0;l<h.count;l++){var m={};m.pos=P(300,500);m.name=h.name;m.status="";m.id=e;k.weights.push(m);e++}b[k.name]=k}return b},makeStoreBins:function(){var a=(this.wall[0].x+this.wall[1].x)/2,b={},d=this.getNumGroups(),a=a-this.storeBinWidth*(d-1)/2-this.storeBinSpacing*(d-1)/2,e;for(e in this.weightGroups)b[e]=this.makeStoreBin(a,this.weightGroups[e]),a+=this.storeBinWidth+this.storeBinSpacing;return b},makeStoreBin:function(a,b){var d={};d.pts=this.getBinPts(P(a,this.binY),this.binSlant,V(this.storeBinWidth,
this.binHeight),this.binThickness);d.x=a-this.storeBinWidth/2;d.y=this.binY;d.slots=this.getBinSlots(P(d.x,d.y),b);d.visible=!0;return d},makePistonBins:function(){var a=(this.wall[0].x+this.wall[1].x)/2,b={},d=this.getNumGroups(),a=a-this.pistonBinWidth*(d-1)/2-this.pistonBinSpacing*(d-1)/2,e;for(e in this.weightGroups)b[e]=this.makePistonBin(a,this.weightGroups[e]),a+=this.pistonBinWidth+this.pistonBinSpacing;return b},makePistonBin:function(a,b){var d={};if(this.pistonOffset){var e=this.pistonOffset.dx;
d.pos=P(a-this.pistonBinWidth/2,0).movePt({dx:e}).track({pt:this.pistonPt,noTrack:"x",offset:{dy:this.pistonOffset.dy}})}else d.pos=P(a-this.pistonBinWidth/2,0).track({pt:this.pistonPt,noTrack:"x"});this.trackingPts.push(d.pos);d.slots=this.getPistonBinSlots(d.pos,b);d.visible=!1;return d},getBinSlots:function(a,b){var d=b.weights.length,e=b.dims,f=Math.floor(this.storeBinWidth/(e.dx+this.blockSpacing));a.x+=(this.storeBinWidth-f*(e.dx+this.blockSpacing))/2;for(var d=Math.ceil(d/f),h=[],k=a.y-this.blockSpacing-
e.dy,l=0;l<d;l++){for(var m=[],n=a.x+this.blockSpacing,p=0;p<f;p++){var r=P(n,k),q=new Boolean,q=!1;m.push(this.newSlot(q,r,b.name,"store",l,p));n+=e.dx+this.blockSpacing}h.push(m);k-=e.dy+this.blockSpacing}return h},getPistonBinSlots:function(a,b){var d=b.weights.length,e=b.dims,f=Math.floor(this.pistonBinWidth/(e.dx+this.blockSpacing));startX=a.x+(this.pistonBinWidth-f*(e.dx+this.blockSpacing))/2;for(var d=Math.ceil(d/f),h=[],k=this.blockSpacing,l=0;l<d;l++){for(var m=[],n=startX+this.blockSpacing,
p=0;p<f;p++){var r=P(n,0).track({pt:a,offset:{dy:-(k+e.dy)},noTrack:"x"});this.trackingPts.push(r);var q=new Boolean,q=!1;m.push(this.newSlot(q,r,b.name,"piston",l,p));n+=e.dx+this.blockSpacing}h.push(m);k+=e.dy+this.blockSpacing}return h},newSlot:function(a,b,d,e,f,h){return{isFull:a,pos:b,name:d,type:e,row:f,col:h}},binIsFull:function(a,b){var d=this.bins[a][b].slots;for(rowIdx=0;rowIdx<d.length;rowIdx++)for(var e=d[rowIdx],f=0;f<e.length;f++)if(!e[f].isFull)return!1;return!0},binIsEmpty:function(a,
b){var d=this.bins[a][b].slots;for(rowIdx=0;rowIdx<d.length;rowIdx++)for(var e=d[rowIdx],f=0;f<e.length;f++)if(e[f].isFull)return!1;return!0},allEmpty:function(a){var b=new Boolean,b=!0,d;for(d in this.bins[a])b=Math.min(b,this.binIsEmpty(a,d));return b},weightCount:function(a,b){var d=this.bins[a][b].slots,e=0;for(rowIdx=0;rowIdx<d.length;rowIdx++)for(var f=d[rowIdx],h=0;h<f.length;h++)e+=f[h].isFull;return e},getPistonMass:function(){var a=0,b;for(b in this.weightGroups)for(var d=this.weightGroups[b],
e=d.weights,d=d.mass,f=0;f<e.length;f++)"piston"==e[f].status&&(a+=d);return a+this.massInit},dropAllIntoBins:function(a){for(var b in this.weightGroups)for(var d=this.weightGroups[b],e=0;e<d.weights.length;e++){var f=d.weights[e];"piston"==f.status?(f.status="inTransit",f.slot.isFull=!1,this.takeOffPiston(f),this.dropIntoBin(f,"store",a)):"store"!=f.status&&(f.status="inTransit",this.dropIntoBin(f,"store",a))}return this},dropAllOntoPiston:function(a){for(var b in this.weightGroups)for(var d=this.weightGroups[b],
e=0;e<d.weights.length;e++){var f=d.weights[e];"store"==f.status?(f.status="inTransit",f.slot.isFull=!1,this.takeOffPiston(f),this.dropIntoBin(f,"piston",a)):"piston"!=f.status&&(f.status="inTransit",this.dropIntoBin(f,"piston",a))}return this},dropIntoBin:function(a,b,d){var e=this;a.status="inTransit";var f=this.getDropSlot(a.name,b),h=f.slot;h.isFull=!0;a.slot=h;f=f.id;if("instant"==d)this.dropInstant(a,h);else{d=a.name+a.id+"endId"+this.wallInfo;var k="moveWeight"+d+b+f;removeListenerByName(curLevel,
"update",d)&&(a.slot.isFull=!1,a.slot=void 0);addListener(curLevel,"update",k,function(){var b=h.pos,d=V(b.x-a.pos.x,b.y-a.pos.y).UV();d.dx&&d.dy&&(a.pos.x=stepTowards(a.pos.x,b.x,d.dx*this.moveSpeed),a.pos.y=stepTowards(a.pos.y,b.y,d.dy*this.moveSpeed));this.weightArrived(a,h)&&(removeListener(curLevel,"update",k),e.placeWeight(a,h))},this)}},placeWeight:function(a,b){a.status=b.type;"piston"==a.status&&this.putOnPiston(a,b)},dropInstant:function(a,b){a.pos=b.pos.copy();this.placeWeight(a,b)},weightArrived:function(a,
b){return a.pos.sameAs(b.pos)},getDropSlot:function(a,b){for(var d=this.bins[b][a],e=0;e<d.slots.length;e++)for(var f=d.slots[e],h=0;h<f.length;h++){var k=d.slots[e][h];if(!k.isFull)return{slot:k,id:String(e)+String(h)}}alert("BOX IS FULL!  WHY IS THIS HAPPENING?")},getNumGroups:function(){var a=0;for(idx in this.weightGroups)a++;return a},draw:function(){this.drawWeights();this.drawBins();this.drawBinLabels()},drawNoText:function(){this.drawWeights();this.drawBins()},drawWeights:function(){var a=
c,b;for(b in this.weightGroups)for(var d=this.weightGroups[b],e=d.weights,d=d.dims,f=0;f<e.length;f++)draw.fillRect(e[f].pos,d,this.blockCol,a)},drawBins:function(){var a=c,b;for(b in this.bins){var d=this.bins[b],e;for(e in d){var f=d[e];f.visible&&draw.fillPts(f.pts,this.binCol,a)}}},drawBinLabels:function(){for(var a in this.bins.store){var b=this.bins.store[a];b.visible&&draw.text(this.weightGroups[a].pressure+" bar each",P(b.x+this.storeBinWidth/2,b.y-this.binHeight+10),this.font,this.fontCol,
"center",0,c)}},putOnPiston:function(a,b){this.weightsOnPiston.push(a);a.pos.track({pt:b.pos,noTrack:"x"});this.trackingPts.push(a.pos);a.status="piston";this.mass=this.getPistonMass();this.wall.setMass(this.massChunkName,this.mass)},takeOffPiston:function(a){for(var b=0;b<this.weightsOnPiston.length;b++)a==this.weightsOnPiston[b]&&this.weightsOnPiston.splice([b],1);a.pos.trackStop();this.trackingPts.splice(this.trackingPts.indexOf(a.pos),1);this.mass=this.getPistonMass();this.wall.setMass(this.massChunkName,
this.mass)},mousedown:function(){var a=this.getClicked();a&&(this.pickup(a),"piston"==this.selected.cameFrom&&this.takeOffPiston(this.selected),addListener(curLevel,"mousemove","weights",this.mousemove,this),addListener(curLevel,"mouseup","weights",this.mouseup,this))},mousemove:function(){var a=mouseOffset(myCanvas),b=this.selected.origPos,d=b.weight,b=b.mouse,e=d.y+(a.y-b.y);this.selected.pos.x=d.x+(a.x-b.x);this.selected.pos.y=e},mouseup:function(){removeListener(curLevel,"mousemove","weights");
removeListener(curLevel,"mouseup","weights");var a=this.getDest();new Boolean;this.dropIntoBin(this.selected,a);delete this.origPos;this.selected=void 0},getDest:function(){var a=this.selected,b=this.weightGroups[a.name].dims.dy;return"piston"==a.cameFrom||a.pos.y+b>this.zeroY?"store":"piston"},pickup:function(a){a.cameFrom=a.status;a.status="holding";var b=mouseOffset(myCanvas);void 0!==a.slot&&(a.slot.isFull=!1);"piston"==a.status&&this.takeOffPiston(a);delete a.slot;this.selected=a;this.selected.origPos=
{mouse:b.copy(),weight:a.pos.copy()}},getClicked:function(){for(var a in this.weightGroups){a=this.weightGroups[a];for(var b=0;b<a.weights.length;b++){var d=a.weights[b];if(inRect(d.pos,a.dims,myCanvas)&&("inTransit"==d.status||this.isOnTop(d)))return d}}return!1},mouseOnWeight:function(a,b){var d=mouseOffset(myCanvas);return d.x>=b.x&&d.x<=b.x+a.dx&&d.y<=b.y&&d.y>=b.y-a.dy},isOnTop:function(a){var b=a.slot;a=this.bins[b.type][a.name];for(var d=b.col,b=b.row+1;b<a.slots.length;b++)if(!0==a.slots[b][d].isFull)return!1;
return!0},mass:function(){return this.mass},disable:function(){removeListener(curLevel,"mousedown","weights"+this.wallInfo);this.enabled=!1},enable:function(){addListener(curLevel,"mousedown","weights"+this.wallInfo,this.mousedown,this);this.enabled=!0}});
function DragArrow(a,b,d,e,f,h,k,l,m){this.type="DragArrow";this.pos=a;this.rotation=b;this.posInit=this.pos.copy();this.cols=d;this.dims=e;this.name=f;this.listeners=l;this.drawCanvas=h;this.canvasElement=k;this.bounds=m;this.bounds.x?(this.bounds.x.max||(this.bounds.x.max=k.width-e.dx),this.bounds.x.min||(this.bounds.x.min=0)):this.bounds.x={min:0,max:k.width-e.dx};this.bounds.y?(this.bounds.y.max||(this.bounds.y.max=k.height-e.dy),this.bounds.y.min||(this.bounds.y.min=0)):this.bounds.y={min:0,
max:k.height-e.dy};this.pts={};this.pts.outer=[];this.pts.inner=[];a=this.dims.dx;b=this.dims.dy;this.pts.outer.push(P(0,0));this.pts.outer.push(P(0.9*a,-b/2));this.pts.outer.push(P(a,0));this.pts.outer.push(P(0.9*a,b/2));this.pts.outer.push(P(0,0));this.makeDrawFunc();this.clickListeners=this.makeListenerFuncs();return this}
DragArrow.prototype={makeDrawFunc:function(){this.dirUV=V(Math.cos(this.rotation+Math.PI/2),Math.sin(this.rotation+Math.PI/2));this.draw=function(){};var a=this;this.draw=extend(this.draw,function(){a.drawCanvas.save();a.drawCanvas.translate(a.pos.x,a.pos.y);a.drawCanvas.rotate(a.rotation)});this.draw=this.cols.stroke?extend(this.draw,function(){draw.fillPtsStroke(a.pts.outer,a.cols.outer,a.cols.stroke,a.drawCanvas)}):extend(this.draw,function(){draw.fillPts(a.pts.outer,a.cols.outer,a.drawCanvas)});
if(this.cols.inner||this.cols.onClick){for(var b=0;b<this.pts.outer.length;b++){var d=this.pts.outer[b].copy().movePt({dx:-this.dims.dx/2}).scale(P(0,0),0.6).movePt({dx:this.dims.dx/2});this.pts.inner.push(d)}this.cols.curInner=this.cols.inner?this.cols.inner:this.cols.outer;this.draw=extend(this.draw,function(){draw.fillPts(a.pts.inner,a.cols.curInner,a.drawCanvas)})}this.draw=extend(this.draw,function(){a.drawCanvas.restore()})},makeListenerFuncs:function(){var a=this.listeners,b=this;b.amSelected=
new Boolean;if(a.onDown||a.onMove||a.onUp){var d=function(){};b.cols.onClick&&(d=extend(d,function(){b.cols.curInner=b.cols.onClick}));var d=extend(d,function(){a.onDown.apply(b)}),e=this.makeMoveListenerFunc(b),d=extend(d,e);a.onUp&&(e=this.makeUpListenerFunc(b),d=extend(d,e));return function(){b.amSelected=b.checkSelected();b.amSelected&&(b.posInit=b.pos.copy(),b.mouseInit=mouseOffset(b.canvasElement),d())}}},makeMoveListenerFunc:function(a){var b=a.listeners,d=function(){var b=mouseOffset(a.canvasElement),
d=V(b.x-a.mouseInit.x,b.y-a.mouseInit.y).dotProd(a.dirUV),b=a.posInit.x+d*Math.cos(a.rotation+Math.PI/2),d=a.posInit.y+d*Math.sin(a.rotation+Math.PI/2);a.pos.x=Math.max(a.bounds.x.min,Math.min(b,a.bounds.x.max));a.pos.y=Math.max(a.bounds.y.min,Math.min(d,a.bounds.y.max))};b.onMove&&(d=extend(d,function(){b.onMove.apply(a)}));var e=function(){addListener(curLevel,"mouseup","dragArrow"+a.name+"RemoveMove",function(){removeListener(curLevel,"mousemove","dragArrow"+a.name);removeListener(curLevel,"mouseup",
"dragArrow"+a.name+"RemoveMove")},"")};return function(){addListener(curLevel,"mousemove","dragArrow"+a.name,d,"");e()}},makeUpListenerFunc:function(a){var b=function(){addListener(curLevel,"mouseup","mouseup"+a.name,function(){a.listeners.onUp.apply(a)},"");addListener(curLevel,"mouseup","mouseup"+a.name+"remove",function(){removeListener(curLevel,"mouseup","mouseup"+a.name);removeListener(curLevel,"mouseup","mouseup"+a.name+"remove")},"")};if(a.cols.onClick)var d=function(){},d=a.cols.inner?extend(d,
function(){a.cols.curInner=a.cols.inner}):extend(d,function(){a.cols.curInner=a.cols.outer}),b=extend(b,function(){addListener(curLevel,"mouseup","revertCols"+a.name,function(){d();removeListener(curLevel,"mouseup","revertCols"+a.name)},"")});return b},setPos:function(a){"number"==typeof a.x&&(this.pos.x=a.x);"number"==typeof a.y&&(this.pos.y=a.y)},show:function(){addListener(curLevel,"mousedown","dragArrow"+this.name,this.clickListeners,"");addListener(curLevel,"update","drawDragArrow"+this.name,
this.draw,"");return this},hide:function(){removeListener(curLevel,"mousedown","dragArrow"+this.name);removeListener(curLevel,"update","drawDragArrow"+this.name);return this},reset:function(){this.pos=this.posInit.copy();removeListener(curLevel,"update","moveWall");return this},remove:function(){removeListener(curLevel,"mousedown","dragArrow"+this.name);removeListener(curLevel,"update","drawDragArrow"+this.name)},checkSelected:function(){var a=mouseOffset(this.canvasElement).rotate(this.pos,-this.rotation),
b=this.pos.copy().movePt({dy:-this.dims.dy/2});return ptInRect(b,this.dims,a)}};
function CompArrow(a){this.type="CompArrow";var b=defaultTo(0,a.wallInfo),d=defaultTo(1.5,a.speed),e=defaultTo("adiabatic",a.compMode),f=defaultTo(!0,a.stops),h=defaultTo({y:{min:30,max:350}},a.bounds);this.wall=walls[b];var k={};k.outer=Col(44,118,172);k.onClick=Col(44,118,172);k.inner=curLevel.bgCol.copy();var l=V(25,15);a="volDragger"+defaultTo("",a.handle);var m=c,n=canvas,p={};f&&(this.stops=new Stops({stopPt:{height:h.y.max},wallInfo:b}));var r=this.wall;p.onDown=function(){};p.onMove=function(){r.changeSetPt(this.pos.y,
e,d)};p.onUp=function(){};this.dragArrowFunc=this.makeDragArrowFunc(this.wall,0,k,l,a,m,n,p,h);this.dragArrow=this.dragArrowFunc();this.setupStd();return this}
_.extend(CompArrow.prototype,objectFuncs,{remove:function(){this.dragArrow.remove();this.stop&&this.stops.remove()},makeDragArrowFunc:function(a,b,d,e,f,h,k,l,m){return function(){var n=a[1].copy();return(new DragArrow(n,b,d,e,f,h,k,l,m)).show()}},enable:function(){this.dragArrow.setPos(this.wall[1].copy());this.dragArrow.show();this.enabled=!0},disable:function(){this.dragArrow.hide();this.enabled=!1}});
function Piston(a){this.type="Piston";this.handle=a.handle;this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.min=defaultTo(2,a.min);this.max=defaultTo(15,a.max);this.makeSlider=defaultTo(!0,a.makeSlider);this.drawCanvas=defaultTo(c,a.drawCanvas);this.slant=0.07;this.sliderWrapper=a.sliderWrapper;this.sliderTitleWrapper=a.sliderTitleWrapper;this.left=this.wall[0].x;this.width=this.wall[1].x-this.left;this.pistonPt=this.wall[0];var b=defaultTo(2,a.init);this.setPressure(b);this.height=
500;this.draw=this.makeDrawFunc(this.height,this.left,this.width);this.dataSlotFont="12pt Calibri";this.dataSlotFontCol=Col(255,255,255);this.pStep=0.05;var d=this.left+this.width*this.slant,e=this.left+this.width-this.width*this.slant,f=this.pistonBottom.pos.y-2+this.pistonPt.y,h=Col(255,255,255);this.readout=new Readout("pistonReadout"+this.handle.toCapitalCamelCase(),d,e,f,"12pt calibri",h,"center",curLevel);this.wall.moveInit();this.wall.recordPExt();this.wall.recordWork();this.wallHandler=defaultTo("cPAdiabaticDamped",
a.compMode);walls.setSubWallHandler(this.wallInfo,0,this.wallHandler);this.makeSlider&&(this.sliderId=this.addSlider("Pressure",{value:this.pToPercent(b)},[{eventType:"slide",obj:this,func:this.parseSlider}],this.sliderWrapper,this.sliderTitleWrapper),this.slider=$("#"+this.sliderId));this.setupStd();return this.show()}
_.extend(Piston.prototype,objectFuncs,compressorFuncs,{makeDrawFunc:function(a,b,d){var e=a-45;this.pistonTop=this.makeTop(b,d,30,e,a,35,10);this.pistonBottom=this.makePlateBottom(P(b,-a+e+35),V(d,10));var f=this;return function(){f.readout&&f.setReadoutY();f.drawCanvas.save();f.drawCanvas.translate(0,f.pistonPt.y);draw.fillPts(f.pistonTop.pts,f.pistonTop.col,f.drawCanvas);draw.fillRect(f.pistonBottom.pos,f.pistonBottom.dims,f.pistonBottom.col,f.drawCanvas);f.drawCanvas.restore()}},makeTop:function(a,
b,d,e,f,h,k){var l=this.slant,m=1-l,n=Array(14);f=P(a+b/2-d/2,-f);var p=Col(150,150,150);b=V(b,h);a=f.copy().movePt({dy:e}).position({x:a});n[0]=P(a.x,a.y+b.dy+1);n[1]=P(a.x+b.dx*l,a.y);n[2]=P(f.x-b.dx*l,a.y);n[3]=P(f.x,a.y-5*b.dy*l);n[4]=P(f.x,f.y);n[5]=P(f.x+d,f.y);n[6]=P(f.x+d,a.y-5*b.dy*l);n[7]=P(f.x+d+b.dx*l,a.y);n[8]=P(a.x+b.dx*m,a.y);n[9]=P(a.x+b.dx,a.y+b.dy+1);n[10]=P(a.x+b.dx-k,a.y+b.dy+1);n[11]=P(a.x+b.dx*m-k,a.y+k);n[12]=P(a.x+b.dx*l+k,a.y+k);n[13]=P(a.x+k,a.y+b.dy+1);p=Col(150,150,150);
return{pts:n,col:p}},makePlateBottom:function(a,b){var d=Col(100,100,100);b.adjust(0,1);return{pos:a,dims:b,col:d}},enable:function(){this.slider&&this.slider.slider("option","disabled",!1);this.setMass(this.massStore);delete this.massStore;this.enabled=!0},disable:function(){this.slider&&this.slider.slider("option","disabled",!0);this.massStore=this.mass;this.setMass(0);this.enabled=!1},show:function(){addListener(curLevel,"update","drawPiston"+this.handle,this.draw,"");this.readout.show();return this},
pToPercent:function(a){return 100*(a-this.min)/(this.max-this.min)},hide:function(){removeListener(curLevel,"update","drawPiston"+this.handle);this.readout.hide()},parseSlider:function(a,b){this.setPressure(this.percentToVal(b.value))},setPressure:function(a){this.setMass(this.pressureToMass(a))},setMass:function(a){this.mass=a;this.wall.setMass("piston"+this.handle,this.mass)},setReadoutY:function(){this.readout.position({y:this.pistonBottom.pos.y-2+this.pistonPt.y})},remove:function(){this.wall.moveStop();
this.wall.unsetMass("piston"+this.handle);this.hide();this.sliderId&&this.removeSlider();this.hideSliderDivs();removeListener(curLevel,"update","moveWalls")}});
function Heater(a){this.type="Heater";this.dims=defaultTo(V(100,40),a.dims);this.sliderWrapper=a.sliderWrapper;this.sliderTitleWrapper=a.sliderTitleWrapper;this.wall=walls[a.wallInfo];this.pos=a.pos?a.pos:this.centerOnWall(a.wallInfo,this.dims);a.offset&&this.pos.movePt(a.offset);this.wall.recordQ();this.makeSlider=defaultTo(!0,a.makeSlider);this.handle=a.handle;this.drawCanvas=defaultTo(c,a.drawCanvas);this.cornerRound=0.2;this.qRate=defaultTo(0,a.init);this.qRateMax=defaultTo(1,a.max);this.qRateMin=
-this.qRateMax;this.rot=defaultTo(0,a.rotation);this.center=this.pos.copy().movePt(this.dims.copy().mult(0.5));var b=defaultTo(Col(200,0,0),a.colMax),d=defaultTo(Col(0,0,200),a.colMin),e=defaultTo(Col(100,100,100),a.colDefault);this.draw=this.makeDrawFunc(d,e,b);this.wallPts=this.pos.roundedRect(this.dims,0.3,"ccw");this.eAdded=0;a.liquid&&this.setupLiquidHeat(a.liquid);this.wallHandleHeater="heater"+this.handle.toCapitalCamelCase();this.setupStd();this.makeSlider&&(this.sliderId=this.addSlider("Heater",
{value:50},[{eventType:"slide",obj:this,func:this.parseSlider},{eventType:"slidestop",obj:this,func:function(a,b){$("#"+this.sliderId).slider("option",{value:50});b.value=50;this.parseSlider(a,b)}}],this.sliderWrapper,this.sliderTitleWrapper));this.init(this.wallHandleHeater)}
_.extend(Heater.prototype,objectFuncs,{parseSlider:function(a,b){this.setQRate(b.value)},setQRate:function(a){this.qRate=0.02*(a-50)*this.qRateMax;this.liquid&&(50!=a?addListener(curLevel,"update","heatLiquid"+this.handle,this.heatLiq,this):removeListener(curLevel,"update","heatLiquid"+this.handle))},heatLiq:function(){this.liquid.addQ(0.1*this.qRate*updateInterval)},disable:function(){var a=$("#"+this.sliderId);a.length&&$(a).slider("disable");this.enabled=!1},enable:function(){var a=$("#"+this.sliderId);
a.length&&$(a).slider("enable");this.enabled=!0},makeDrawFunc:function(a,b,d){this.pts=this.getPts(this.pos,this.dims);rotatePts(this.pts,this.center,this.rot);var e=this.getColorSteps(a,b,d),f=this,h=this.pts;return function(){var a=getSign(f.qRate),d=e[String(a)],a=a*f.qRate/f.qRateMax,d=b.copy().adjust(d[0]*a,d[1]*a,d[2]*a);draw.path(h,d,f.drawCanvas)}},centerOnWall:function(a,b){var d=walls[a];return P((d[3].x+d[2].x)/2-b.dx/2,d[2].y-30-b.dy)},getPts:function(a,b,d){d=[];a=a.copy().movePt({dy:b.dy/
2});var e=b.dy/2+2.5,f=b.dy/2-2.5,h=Math.floor((b.dx-2*e)/(2*(e-f)));d.push(a.copy().movePt({dy:200}));d.push(a.copy());d=d.concat(this.halfElipse(a,e,b.dy/2,0,5));a.movePt({dx:2*e});for(var k=0;k<h;k++)d=d.concat(this.halfElipse(a,f,b.dy/2,Math.PI,5)),a.movePt({dx:-2*f}),d=d.concat(this.halfElipse(a,e,b.dy/2,0,5)),a.movePt({dx:2*e});d.push(a.copy());d.push(a.copy().movePt({dy:200}));this.endX=d[d.length-1].x;this.dims=V(this.endX-this.pos.x,b.dy);this.center=this.pos.copy().movePt(this.dims.copy().mult(0.5));
return d},halfElipse:function(a,b,d,e,f){f=defaultTo(5,f);for(var h=Array(f),k=Math.PI/f,l=a.x+b,m=Math.PI,n=0;n<f;n++){var p=l+b*Math.cos(m),r=a.y+d*Math.sin(m);h[n]=P(p,r);m+=k}rotatePts(h,a,e);return h},getColorSteps:function(a,b,d){var e={};d=[d.r-b.r,d.g-b.g,d.b-b.b];e["-1"]=[a.r-b.r,a.g-b.g,a.b-b.b];e["1"]=d;return e},init:function(a){addListener(curLevel,"update","drawHeater"+this.handle,this.draw,"");this.setupWalls(a);this.eAdded=0},setupWalls:function(a){walls.addWall({pts:this.wallPts,
handler:this.wall?{func:this.hitAddQToWall,obj:this}:{func:this.hit,obj:this},handle:a,record:!1,show:!1});walls[a].createSingleValDataObj("vol",function(){return walls.wallVolume(a)})},hit:function(a,b,d,e,f,h){walls.reflect(a,e,f);this.qRate&&(a=0.001*a.addEnergy(this.qRate),this.eAdded+=a)},hitAddQToWall:function(a,b,d,e,f,h){walls.reflect(a,e,f);this.qRate&&(a=0.001*a.addEnergy(this.qRate),this.eAdded+=a,this.wall.q+=a)},setupLiquidHeat:function(a){var b=this;timeline.addEvent("now","now","setup",
"cmmds",function(){var d=a.handle,e=curLevel.selectObj("Liquid",d);e||console.log("Bad liquid data for heater "+this.handle+".  Handle "+d);e.getWallLiq().recordQ();b.liquid=e})},remove:function(){this.removeSlider();removeListener(curLevel,"update","drawHeater"+this.handle);window.walls&&!walls.removed&&walls.removeWall(this.wallHandleHeater)}});
function Stops(a){this.type="Stops";this.handle=a.handle;this.stopWidth=20;this.stopHeight=5;this.boundToSet=void 0;var b=a.stopPt;this.wallInfo=defaultTo(0,a.wallInfo);this.pts=this.wall=walls[this.wallInfo];if(b.vol){var d=this.pts[0].distTo(this.pts[1]);this.height=this.pts[2].y-b.vol/(vConst*d)}else b.y&&(this.height=b.height);if(this.willDraw=defaultTo(!0,a.draw))this.draw=this.makeDrawFunc(this.height);this.setupStd();return this.init()}
_.extend(Stops.prototype,objectFuncs,{makeDrawFunc:function(a){var b=this.pts[3].copy().position({y:a}),d=this.pts[2].copy().position({y:a}).movePt({dx:-this.stopWidth}),e=V(this.stopWidth,this.stopHeight),f=borderCol;return function(){draw.fillRect(b,e,f,c);draw.fillRect(d,e,f,c)}},init:function(){this.boundToSet=this.height>this.wall[0].y?"yMax":"yMin";this.yBoundSave=this.wall.bounds[this.boundToSet];var a={};a[this.boundToSet]=this.height;walls.setBounds(this.wallInfo,a);this.willDraw&&addListener(curLevel,
"update","drawStops"+this.wallInfo,this.draw,"");return this},remove:function(){if(window.walls&&!walls.removed){var a={};a[this.boundToSet]=this.yBoundSave;walls.setBounds(this.wallInfo,a)}this.willDraw&&removeListener(curLevel,"update","drawStops"+this.wallInfo);return this}});
function Trigger(a){this.type="Trigger";this.handle=a.handle;this.conditionFunc=this.wrapExpr(a.expr);this.checkOn=a.checkOn;this.requiredFor=!1===a.requiredFor?void 0:a.requiredFor||"now";this.message=a.message;this.priority=defaultTo(0,a.priorityUnsatisfied||a.priority);this.satisfyStore=defaultTo(void 0,a.satisfyStore);this.satisfyCmmds=defaultTo(void 0,a.satisfyCmmds);this.amSatisfied=!1;this.setupStd();this.init()}
_.extend(Trigger.prototype,objectFuncs,{init:function(){"conditions"==this.checkOn?this.initCheckOnConditions():this.initCheckOnInterval()},wrapExpr:function(a){with(DataGetFuncs)a=eval("(function() {return "+a+"})");return a},initCheckOnConditions:function(){this.requiredFor&&conditionManager.add(this)},initCheckOnInterval:function(){addListener(curLevel,"update",this.handle,function(){if(this.conditionFunc()){this.amSatisfied=!0;this.recordVals();if(this.satisfyCmmds)for(var a=0;a<this.satisfyCmmds.length;a++)eval(this.satisfyCmmds[a]);
removeListener(curLevel,"update",this.handle)}},this);this.requiredFor&&conditionManager.add(this)},recordVals:function(){with(DataGetFuncs)if(this.satisfyStore)for(var a=0;a<this.satisfyStore.length;a++){var b=this.satisfyStore[a],d=b.storeAs,b=eval(b.expr);store(d,b)}},isSatisfied:function(){return this.amSatisfied},remove:function(){removeListener(curLevel,"update",this.handle)}});function Sandbox(a){this.type="Sandbox";this.handle=a.handle;this.emitterNum=0;a=defaultTo({},a);this.bin={};this.sand={};this.drawCanvas=defaultTo(c,a.drawCanvas);this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.mass=this.pressureToMass(defaultTo(2,a.init));this.massMin=this.pressureToMass(defaultTo(0.5,a.min));this.massMax=this.pressureToMass(defaultTo(15,a.max));this.particleMass=defaultTo(0.01,a.partMass);this.buttonAddId="sandAdd"+this.handle;this.buttonRemoveId="sandRemove"+
this.handle;this.makeButtons();this.massChunkName="sandMass"+defaultTo("",this.handle);this.wall.setMass(this.massChunkName,this.mass);this.wall.recordPExt();this.wall.recordWork();this.wallHandler=defaultTo("cPAdiabaticDamped",a.compMode);walls.setSubWallHandler(this.wallInfo,0,this.wallHandler);this.trackingPts=[];this.wallPt=this.wall[0];this.emitters=[];this.binX=(this.wall[1].x+this.wall[0].x)/2;this.spcVol=70;this.sand.col=defaultTo(Col(224,165,75),a.sandCol);this.sand.pts=this.getSandPts();
this.sand.pos=P(this.binX,this.wall[0].y).track({pt:this.wallPt,noTrack:"x"});this.trackingPts.push(this.sand.pos);this.pistonPt=this.wall[0].y;this.setupStd();return this.init()}
_.extend(Sandbox.prototype,compressorFuncs,objectFuncs,{init:function(){this.drawListenerName=unique("drawSand"+this.handle,curLevel.updateListeners);addListener(curLevel,"update",this.drawListenerName,this.draw,this);this.wall.moveInit();this.wall.recordMass();this.wall.recordPExt();return this},makeButtons:function(){addButton(this.buttonAddId,"Add mass");addButton(this.buttonRemoveId,"Remove mass");var a=this;$("#"+this.buttonAddId).mousedown(function(){a.buttonAddDown()});$("#"+this.buttonRemoveId).mousedown(function(){a.buttonRemoveDown()})},
removeButtons:function(){$("#"+this.buttonAddId).remove();$("#"+this.buttonRemoveId).remove()},draw:function(){this.drawCanvas.save();this.drawCanvas.translate(this.sand.pos.x,this.sand.pos.y);var a=Math.sqrt(0.4*this.mass);this.drawCanvas.scale(a,a);draw.fillPts(this.sand.pts,this.sand.col,this.drawCanvas);this.width=a*(this.sand.pts[this.sand.pts.length-1].x-this.sand.pts[0].x);this.drawCanvas.restore()},getSandPts:function(){var a=Array(4);a[0]=P(-10,0);a[1]=P(-7,-2);a[2]=P(-3,-6);a[3]=P(0,-7);
ptsRight=deepCopy(a).splice(0,a.length-1).reverse();mirrorPts(ptsRight,P(0,0),V(0,-10));return a=a.concat(ptsRight)},buttonAddDown:function(){this.mass<this.massMax&&(this.boundUpper(),this.addMass(),addListener(curLevel,"mouseup","mouseUpSandbox",this.buttonAddUp,this))},buttonAddUp:function(){this.boundUpperStop();this.addMassStop();removeListener(curLevel,"mouseup","mouseUpSandbox")},buttonRemoveDown:function(){this.mass>this.massMin&&(this.boundLower(),this.removeMass(),addListener(curLevel,"mouseup",
"mouseUpSandbox",this.buttonRemoveUp,this))},buttonRemoveUp:function(){this.boundLowerStop();this.removeMassStop();removeListener(curLevel,"mouseup","mouseUpSandbox")},boundUpper:function(){var a=this.handle+"BoundUpper";curLevel.updateListeners[a]||addListener(curLevel,"update",a,function(){this.mass>this.massMax&&(this.stopAllEmitters(),removeListener(curLevel,"update",a))},this)},boundLower:function(){var a=this.handle+"BoundLower";curLevel.updateListeners[a]||addListener(curLevel,"update",a,function(){this.mass<
this.massMin&&(this.stopAllEmitters(),removeListener(curLevel,"update",a))},this)},boundUpperStop:function(){removeListener(curLevel,"update",this.handle+"BoundUpper")},boundLowerStop:function(){removeListener(curLevel,"update",this.handle+"BoundLower")},stopAllEmitters:function(){for(var a=0;a<this.emitters.length;a++)this.emitters[a].stopFlow()},addMass:function(){this.emitters.push(this.makeAddEmitter())},addMassStop:function(){this.emitters[this.emitters.length-1].stopFlow()},removeMass:function(){this.emitters.push(this.makeRemoveEmitter())},
removeMassStop:function(){this.emitters[this.emitters.length-1].stopFlow()},makeAddEmitter:function(){var a=this.handle+this.emitterNum;this.emitterNum++;var b={func:this.onArriveAdd,obj:this},d=this.emitters.length,e=Math.PI/2,f=this.sand.col,h=this.wall[0].y,k=new ParticleEmitter({pos:P((this.wall[0].x+this.wall[1].x)/2,0),width:this.width,dist:h,dir:e,col:f,onRemove:l,parentList:this.emitters,onArrive:b,handle:a});k.adding=!0;moveListenerName=unique("adjustEmitter"+d,curLevel.updateListeners);
addListener(curLevel,"update",moveListenerName,function(){k.adjust({dist:this.wallPt.y,width:this.width})},this);var l={func:function(){removeListener(curLevel,"update",moveListenerName)},obj:this};return k},makeRemoveEmitter:function(){var a=this.handle+this.emitterNum;this.emitterNum++;var b={func:this.onGenerateRemove,obj:this},d=this.emitters.length,e=-Math.PI/2,f=this.sand.col,h=(this.wall[0].x+this.wall[1].x)/2,k=this.wall[0].y,l=new ParticleEmitter({pos:P(h,0),width:this.width,dist:k,dir:e,
col:f,onRemove:n,parentList:this.emitters,onGenerate:b,handle:a});l.removing=!0;moveListenerName=unique("adjustEmitter"+d,curLevel.updateListeners);var m=this.wall[0];addListener(curLevel,"update",moveListenerName,function(){l.adjust({pos:P(h,m.y),dist:m.y,width:this.width})},this);var n={func:function(){removeListener(curLevel,"update",moveListenerName)},obj:this};return l},onGenerateRemove:function(){this.mass-=this.particleMass;this.wall.setMass(this.massChunkName,this.mass)},onArriveAdd:function(){this.mass+=
this.particleMass;this.wall.setMass(this.massChunkName,this.mass)},remove:function(){for(var a=0;a<this.emitters.length;a++)this.emitters[a].remove();this.emitters=[];this.trackingPts.map(function(a){a.trackStop()});this.trackingPts.splice(0,this.trackingPts.length);this.removeButtons();removeListener(curLevel,"update",this.drawListenerName);removeListener(curLevel,"data",this.cleanUpEmittersListenerName);this.wall.moveStop()}});
function ParticleEmitter(a){this.type="ParticleEmitter";this.pos=a.pos;this.handle=a.handle;this.dir=a.dir;this.parentList=a.parentList;this.width=a.width;this.col=a.col;this.dist=a.dist;this.onGenerate=a.onGenerate;this.onArrive=a.onArrive;this.onRemove=a.onRemove;this.rate=defaultTo(Math.round(0.1*this.width),a.rate);this.speed=defaultTo(5,a.speed);this.speedSpread=defaultTo(1,a.speedSpread);2*this.speedSpread>this.speed&&console.log("Uh-oh.  Making particle emitter with handle "+this.handle+" with speed spread such that particles will hit ~0 speed");
this.accel=defaultTo(0.5,a.accel);this.accelSpread=defaultTo(1,a.accelSpread);this.dirSpread=defaultTo(0,a.dirSpread);this.drawCanvas=defaultTo(c,a.drawCanvas);this.makeBounds();this.setupStd();this.particles=[];return this.init()}
_.extend(ParticleEmitter.prototype,objectFuncs,{init:function(){this.runListenerName=unique("particle"+this.handle,curLevel.updateListeners);addListener(curLevel,"update",this.runListenerName,this.run,this);return this},adjust:function(a){for(var b in a)this[b]=a[b];this.makeBounds()},makeBounds:function(){this.UV=angleToUV(this.dir);var a=this.pos.copy().movePt(this.UV.copy().rotate(-Math.PI/2).mult(this.width/2)),b=this.pos.copy().movePt(this.UV.copy().rotate(Math.PI/2).mult(this.width/2));this.prodPt=
a;this.prodV=a.VTo(b);this.finishPt=a.copy().movePt(this.UV.copy().mult(this.dist));this.finishV=this.finishPt.VTo(this.prodPt)},run:function(){this.generateNew();this.updateParticles();this.draw()},trickleOut:function(){this.updateParticles();this.draw();0==this.particles.length&&this.remove()},generateNew:function(){for(var a=Math.round(Math.random()*this.rate),b=0;b<a;b++)this.particles.push(this.newParticle()),this.onGenerate&&this.onGenerate.func.apply(this.onGenerate.obj)},newParticle:function(){var a=
this.prodPt.copy().movePt(this.prodV.copy().mult(Math.random())),b=Math.max(0.01,this.speed+this.speedSpread*(Math.random()-0.5)),d=Math.max(0,this.accel+this.accelSpread*(Math.random()-0.5)),e=angleToUV(this.dir+this.dirSpread*(Math.random()-0.5)),f=this.getlifespan(a,b,d,e);return{pos:a,V:e.copy().mult(b),accelV:e.copy().mult(d),age:0,lifespan:f}},getlifespan:function(a,b,d,e){a=e.dotProd(this.UV);d=0.5*d*a;b*=a;return(-b+Math.sqrt(b*b-4*d*-this.dist))/(2*d)},updateParticles:function(){for(var a=
this.particles.length-1;0<=a;a-=1){var b=this.particles[a];b.pos.movePt(b.V);b.V.add(b.accelV);b.age++;b.age>b.lifespan&&(this.particles.splice(a,1),this.onArrive&&this.onArrive.func.apply(this.onArrive.obj))}},draw:function(){this.drawCanvas.strokeStyle=this.col.hex;for(var a=0;a<this.particles.length;a++){var b=this.particles[a];c.beginPath();c.moveTo(b.pos.x,b.pos.y);c.lineTo(b.pos.x+2,b.pos.y+2);c.stroke()}},stopFlow:function(){removeListener(curLevel,"update",this.runListenerName);addListener(curLevel,
"update",this.runListenerName,this.trickleOut,this)},remove:function(){this.onRemove&&this.onRemove.func.apply(this.onRemove.obj);this.parentList&&this.parentList.splice(_.indexOf(this.parentList,this),1);removeListener(curLevel,"update",this.runListenerName);this.removed=!0}});
function ArrowFly(a){this.type="ArrowFly";this.pos=a.pos.copy();if(a.posFinal)this.posFinal=a.posFinal,this.UV=this.pos.VTo(this.posFinal).UV(),this.dir=this.UV.angle(),this.dist=this.pos.distTo(this.posFinal);else if(a.V)this.posFinal=this.pos.copy().movePt(a.V),this.UV=a.V.UV(),this.dir=this.UV.angle();else if((a.dir||a.UV)&&a.dist)a.dir?(this.dir=a.dir,this.UV=angleToUV(a.dir)):(this.UV=a.UV,this.dir=this.UV.angle(),this.UV=a.UV),this.posFinal=this.pos.copy().movePt(this.UV.copy().mult(a.dist)),
this.dist=a.dist;this.drawCanvas=defaultTo(c,a.drawCanvas);this.dims=a.dims.copy();this.dimsFinal=defaultTo(this.dims,a.dimsFinal);this.fill=a.fill.copy();this.fillUnround={r:this.fill.r,g:this.fill.g,b:this.fill.b};this.fillFinal=defaultTo(this.fill,a.fillFinal);this.stroke=defaultTo(this.fill,a.stroke.copy());this.fade=defaultTo(!0,a.fade);this.fadeTurns=defaultTo(4,a.fadeTurns);this.strokeUnround={r:this.stroke.r,g:this.stroke.g,b:this.stroke.b};this.strokeFinal=defaultTo(this.fillFinal,a.strokeFinal);
this.alpha=defaultTo(1,a.alpha);this.alphaFinal=defaultTo(this.alpha,a.alphaFinal);this.age=0;this.lifespan=Math.round(a.lifespan/updateInterval);this.getSteps();this.pts=this.getPts();this.onFinish=a.onFinish;return this.init()}
_.extend(ArrowFly.prototype,objectFuncs,toInherit.ArrowFuncs,{getSteps:function(){var a=1/this.lifespan;this.posStep=this.pos.VTo(this.posFinal).mult(a);this.dimsStep=V(this.dimsFinal.dx-this.dims.dx,this.dimsFinal.dy-this.dims.dy).mult(a);this.fillStep={r:a*(this.fillFinal.r-this.fill.r),g:a*(this.fillFinal.g-this.fill.g),b:a*(this.fillFinal.b-this.fill.b)};this.strokeStep={r:a*(this.strokeFinal.r-this.stroke.r),g:a*(this.strokeFinal.g-this.stroke.g),b:a*(this.strokeFinal.b-this.stroke.b)};this.alphaStep=
(this.alphaFinal-this.alpha)*a},init:function(){this.updateListenerName=unique(this.type+defaultTo("",this.handle),curLevel.updateListeners);addListener(curLevel,"update",this.updateListenerName,this.run,this);this.setupStd();return this},run:function(){this.drawCanvas.save();this.drawCanvas.globalAlpha=this.alpha;this.drawCanvas.translate(this.pos.x,this.pos.y);this.drawCanvas.rotate(this.dir);draw.fillPtsStroke(this.pts,this.fill,this.stroke,this.drawCanvas);this.drawCanvas.restore();this.takeStep();
this.age++;this.age==this.lifespan&&(this.onFinish&&this.onFinish.func.apply(this.onFinish.obj),this.fade?(this.alphaStep=-this.alpha/this.fadeTurns,this.remove(),this.updateListenerName=unique(this.type+defaultTo("",this.handle)+"fade",curLevel.updateListeners),addListener(curLevel,"update",this.updateListenerName,this.runFade,this),this.addCleanUp()):this.remove())},runFade:function(){this.drawCanvas.save();this.drawCanvas.globalAlpha=this.alpha;this.drawCanvas.translate(this.pos.x,this.pos.y);
this.drawCanvas.rotate(this.dir);draw.fillPtsStroke(this.pts,this.fill,this.stroke,this.drawCanvas);this.drawCanvas.restore();this.takeStepFade();this.age++;this.age==this.lifespan+this.fadeTurns&&this.remove()},scale:function(){for(var a=(this.dims.dx+this.dimsStep.dx)/this.dims.dx,b=(this.dims.dy+this.dimsStep.dy)/this.dims.dy,d=0;d<this.pts.length;d++)this.pts[d].x*=a,this.pts[d].y*=b},takeStep:function(){this.pos.movePt(this.posStep);this.dims.add(this.dimsStep);this.scale();this.alpha+=this.alphaStep;
this.fillUnround.r+=this.fillStep.r;this.fillUnround.g+=this.fillStep.g;this.fillUnround.b+=this.fillStep.b;this.strokeUnround.r+=this.strokeStep.r;this.strokeUnround.g+=this.strokeStep.g;this.strokeUnround.b+=this.strokeStep.b;this.fill.setFromUnround(this.fillUnround);this.stroke.setFromUnround(this.strokeUnround)},takeStepFade:function(){this.pos.movePt(this.posStep);this.dims.add(this.dimsStep);this.scale();this.alpha+=this.alphaStep},remove:function(){removeListener(curLevel,"update",this.updateListenerName);
this.removeCleanUp()}});function CheckMark(a,b,d,e,f){var h=P(a.x,a.y+0.6*b.dy),k=P(a.x+0.4*b.dx,a.y+b.dy),l=P(a.x+b.dx,a.y);a=P(a.x+0.35*b.dx,a.y+0.75*b.dy);this.pts=[h,k,l,a];this.col=d;this.stroke=e;this.drawCanvas=f}CheckMark.prototype={draw:function(){draw.fillPtsStroke(this.pts,this.col,this.stroke,this.drawCanvas)},setCanvas:function(a){this.drawCanvas=a}};
function ArrowLine(a,b,d,e,f){this.handle=a;this.pts={line:b,arrow:Array(3)};this.col=d;this.drawCanvas=defaultTo(c,f);a=this.pts.line[this.pts.line.length-1];d=a.VTo(this.pts.line[this.pts.line.length-2]).UV();b=d.copy().rotate(0.5);d=d.copy().rotate(-0.5);this.pts.arrow[0]=a.copy().movePt(b.mult(10));this.pts.arrow[1]=a;this.pts.arrow[2]=a.copy().movePt(d.mult(10));return this.show(e)}
ArrowLine.prototype={draw:function(){for(var a=this.pts.line,b=0;b<a.length-1;b++)draw.line(a[b],a[b+1],this.col,this.drawCanvas);a=this.pts.arrow;draw.line(a[0],a[1],this.col,this.drawCanvas);draw.line(a[1],a[2],this.col,this.drawCanvas)},show:function(a){addListener(curLevel,"update","drawArrow"+this.handle,this.makeDrawFunc(a),this);return this},makeDrawFunc:function(a){var b=0,d=this,e=function(){d.draw()};a&&(e=extend(e,function(){b++;b==a&&removeListener(curLevel,"update","drawArrow"+d.handle)}));
return e},hide:function(){removeListener(curLevel,"update","drawArrow"+this.handle)}};function TempChanger(a){this.type="tempChanger";this.info=a.info;this.min=defaultTo(100,a.min);this.val=dataHandler.temp(this.info);this.max=defaultTo(1500,a.max);this.sliderPos=a.sliderPos;this.handle=a.handle;this.totalDots=dataHandler.count(this.info);this.setupStd();return this.init()}
_.extend(TempChanger.prototype,objectFuncs,{init:function(){this.sliderId=this.addSlider(1<this.totalDots?"System temperature":"Molecule's kinetic energy",{value:this.valToPercent(this.val)},[{eventType:"slide",obj:this,func:this.parseSlider}],this.sliderPos)},parseSlider:function(a,b){changeTemp(this.info,this.percentToVal(b.value))},remove:function(){this.removeSlider()}});
function RMSChanger(a){this.type="RMSChanger";this.info=a.info;this.min=defaultTo(1,a.min);this.val=dataHandler.RMS(this.info);this.max=defaultTo(15,a.max);this.handle=a.handle;this.totalDots=dataHandler.count(this.info);this.sliderPos=a.sliderPos;this.setupStd();return this.init()}
_.extend(RMSChanger.prototype,objectFuncs,{init:function(){this.sliderId=this.addSlider(1<this.totalDots?"Molecules' RMS":"Molecule's RMS",{value:this.valToPercent(this.val)},[{eventType:"slide",obj:this,func:this.parseSlider}],this.sliderPos)},parseSlider:function(a,b){changeRMS(this.info,this.percentToVal(b.value))},remove:function(){this.removeSlider()}});function Clamps(a){this.type="Clamps";this.handle=a.handle;this.draw=defaultTo(!1,a.draw);this.releaseWith=defaultTo("button",a.releaseWith);this.currentClamper=void 0;this.clamps=a.clamps;this.wall=walls[a.wallInfo];this.buttonId="clampRelease"+this.wall.handle;this.wallHandler=this.wall.parent.getSubWallHandler(this.wall.handle,0);this.init()}
_.extend(Clamps.prototype,objectFuncs,{init:function(){this.setupStd();this.wall.moveStop();this.assembleClamps();"button"==this.releaseWith?this.makeReleaseButton():this.setupClampClicking();this.draw&&this.drawClamps();this.freezeWall()},assembleClamps:function(){for(var a=0;a<this.clamps.length;a++){var b=this.clamps[a];b.vol&&(b.y=this.wall.volToY(b.vol),delete b.vol);b.clamping=!1}this.sortClamps();this.addInitClamp()},sortClamps:function(){for(var a=0;a<this.clamps.length;a++){for(var b=!1,
d=0;d<this.clamps.length-1;d++)this.clamps[d].y>this.clamps[d+1].y&&(this.clamps.switchElements(d,d+1),b=!0);if(!b)break}},addInitClamp:function(){for(var a=this.wall[0].y,b=0;b<this.clamps.length;b++)if(this.clamps[b].y>a){this.clamps.splice(b,0,{y:a,clamping:!0});this.currentClamper=this.clamps[b];break}},makeReleaseButton:function(){var a=this;addButton(this.buttonId,"Release");$("#"+this.buttonId).click(function(){a.release()})},removeReleaseButton:function(){removeButton(this.buttonId)},release:function(){var a=
void 0,b=void 0;this.currentClamper.clamping=!1;var d=this.clamps.indexOf(this.currentClamper),e=this.clamps[d+1],d=this.clamps[d-1];e&&(a=e.y);d&&(b=d.y);var f=this;this.wall.releaseWithBounds(b,a,this.wallHandler,function(a){f.activateClamp(a)})},activateClamp:function(a){var b=this.clamps.indexOf(this.currentClamper);this.currentClamper.clamping=!1;this.currentClamper=a<this.currentClamper.y?this.clamps[b-1]:this.clamps[b+1];this.currentClamper.clamping=!0;this.freezeWall()},freezeWall:function(){walls.setSubWallHandler(this.wall.handle,
0,"staticAdiabatic")},remove:function(){this.wall.removed||(this.wall.moveInit(),this.wall.parent.setSubWallHandler(walls.indexOf(this.wall),0,this.wallHandler));"button"==this.releaseWith&&this.removeReleaseButton()}});function sillyArrow(){new ArrowFly({pos:P(100,100),dist:100,V:V(300,30),fill:Col(200,0,0),fillFinal:Col(0,200,0),stroke:Col(0,0,200),dims:V(100,50),dimsFinal:V(50,100),lifespan:5E3})}
function sillierArrow(){return new ArrowStatic({pos:P(0,0),dims:V(100,50),angle:0,fill:Col(150,0,0),stroke:Col(0,255,255),label:void 0})}
function ArrowStatic(a){this.type="ArrowStatic";this.pos=a.pos.copy();this.dims=a.dims.copy();this.handle=a.handle;this.pts=this.getPts();this.drawCanvas=defaultTo(c,a.drawCanvas);this.label=a.label?a.label:!1;a.angle?this.angle=a.angle:a.UV&&(this.angle=UVToAngle(a.UV));this.setTextOffset();this.fill=a.fill.copy();this.textCol=defaultTo(Col(255,255,255),a.textCol);this.stroke=defaultTo(a.stroke,Col(0,0,0));this.init()}
_.extend(ArrowStatic.prototype,objectFuncs,toInherit.ArrowFuncs,{init:function(){this.updateListenerName=unique(this.type+defaultTo("",this.handle),curLevel.updateListeners);this.label?addListener(curLevel,"update",this.updateListenerName,this.runLabel,this):addListener(curLevel,"update",this.updateListenerName,this.runNoLabel,this);this.setupStd()},runLabel:function(){this.drawCanvas.save();this.drawCanvas.translate(this.pos.x,this.pos.y);this.drawCanvas.rotate(this.angle);draw.fillPtsStroke(this.pts,
this.fill,this.stroke,this.drawCanvas);this.drawCanvas.translate(this.textOffset.dx,this.textOffset.dy);this.drawCanvas.rotate(-this.angle);draw.text(this.label,P(0,0),"13pt calibri",this.textCol,"center",0,this.drawCanvas);this.drawCanvas.restore()},runNoLabel:function(){this.drawCanvas.save();this.drawCanvas.translate(this.pos.x,this.pos.y);this.drawCanvas.rotate(this.angle);draw.fillPtsStroke(this.pts,this.fill,this.stroke,this.drawCanvas);this.drawCanvas.restore()},setTextOffset:function(){this.textOffset=
V(7+5*Math.sin(Math.abs(-this.angle)),5*Math.cos(this.angle))},getDims:function(){return this.dims},move:function(a){this.pos.movePt(a);return this},scale:function(a){this.dims.multVec(a);this.pts=this.getPts();return this},size:function(a){this.dims=a.copy();this.pts=this.getPts();return this},rotate:function(a){this.angle+=a;this.setTextOffset();return this},getAngle:function(){return this.angle},setFill:function(a){this.fill=a.copy()},setStroke:function(a){this.stroke=a.copy()},remove:function(){removeListener(curLevel,
"update",this.updateListenerName);this.removeCleanUp()}});
var flowFuncs={getPts:function(a,b,d,e,f){d=a.VTo(b).mag();var h=this.width/d;this.fracOffset=Math.max(Math.min(this.fracOffset,1-h/2),h/2);d=f+h;f=a.copy().fracMoveTo(b,f-h);a=a.copy().fracMoveTo(b,d);b=f.copy().movePt(e.copy().neg().mult(this.depth));e=a.copy().movePt(e.copy().neg().mult(this.depth));return[f,b,e,a]},addPts:function(){var a=Math.min(this.ptIdxs[0],this.ptIdxs[1]),b=Math.max(this.ptIdxs[0],this.ptIdxs[1]),d=this.wall.getPt(a).copy(),b=this.wall.getPt(b).copy();this.perp=this.wall.getPerpUV(a);
a=this.wall.getUV(a);this.pts=this.getPts(d,b,a,this.perp,this.fracOffset)},addArrows:function(a,b){var d=[],e=30<this.width?2:1,f=this.pts[1].copy();f.movePt(a.copy().neg().mult(this.arrowDims.dy/3));for(var h=this.pts[1].VTo(this.pts[2]),h=h.copy().UV().copy().mult(h.mag()/(e+1)),k=0;k<e;k++)f.movePt(h),d.push(new ArrowStatic({pos:f,dims:this.arrowDims,UV:a.copy(),fill:this.arrowFill,stroke:this.arrowStroke,cleanUpWith:this.cleanUpWith}));return d}};
function Inlet(a){this.arrowDims=V(15,20);this.arrowFill=Col(200,0,0);this.arrowStroke=Col(100,100,100);this.type="Inlet";this.handle=a.handle;this.width=defaultTo(30,a.width);this.depth=defaultTo(20,a.depth);this.fracOpen=defaultTo(1,a.fracOpen);this.makePts=this.depth;this.wallInfo=a.wallInfo;this.wall=walls[this.wallInfo];this.ptIdxs=a.ptIdxs;this.fracOffset=defaultTo(0.5,a.fracOffset);this.flows=this.processFlows(a.flows);if(this.makeSlider=a.makeSlider)this.sliderId=this.addSlider("Flow rate",
{value:100*this.fracOpen},[{eventType:"slide",obj:this,func:this.parseSlider}]);this.setupStd();this.arrows=[];this.init()}
_.extend(Inlet.prototype,flowFuncs,objectFuncs,{init:function(){this.addPts();this.makePts&&this.wall.addPts(this.ptIdxs[1],this.pts);var a={pos:this.pts[1].copy(),vec:this.pts[1].VTo(this.pts[2]),dir:this.perp.copy()};this.arrows=this.addArrows(this.pts[1].VTo(this.pts[2]).UV().perp("ccw"));this.makeInlet(a,this.flows)},processFlows:function(a){for(var b=[],d=0;d<a.length;d++){var e=a[d];b.push({spc:spcs[e.spcName],temp:e.temp,nDotMax:e.nDotMax,returnTo:this.wallInfo,tag:e.tag});b[b.length-1].nDotMax*=
1E3/updateInterval}return b},parseSlider:function(a,b){this.fracOpen=b.value/100},makeInlet:function(a,b){for(var d=a.pos,e=a.vec,f=a.dir,h=Array(b.length),k=b.length,l=0;l<h.length;l++)h[l]=0;addListener(curLevel,"update",this.type+this.handle,function(){for(var a=0;a<k;a++){var l=b[a];h[a]+=this.fracOpen*l.nDotMax;var p=Math.floor(h[a]);if(p){for(var r=[],q=0;q<p;q++){var u=Math.random(),u=P(d.x+e.dx*u,d.y+e.dy*u);r.push({pos:u,dir:f,temp:l.temp,returnTo:l.returnTo,tag:l.tag})}l.spc.place(r);h[a]-=
p}}},this)},remove:function(){this.sliderId&&this.removeSlider();this.arrows.map(function(a){a.remove()});removeListener(curLevel,"update",this.type+this.handle)}});
function Outlet(a){this.arrowDims=V(15,20);this.arrowFill=Col(200,0,0);this.arrowStroke=Col(100,100,100);this.type="Outlet";this.handle=a.handle;this.width=defaultTo(30,a.height);this.depth=defaultTo(20,a.depth)||20;this.fracOpen=defaultTo(1,a.fracOpen);this.makePts=this.depth;this.wallInfo=a.wallInfo;this.wall=walls[this.wallInfo];this.ptIdxs=a.ptIdxs;this.fracOffset=defaultTo(0.5,a.fracOffset);this.arrows=[];this.init()}
_.extend(Outlet.prototype,flowFuncs,objectFuncs,{init:function(){this.addPts();this.makePts&&this.wall.addPts(this.ptIdxs[1],this.pts);var a=Math.min(this.ptIdxs[0],this.ptIdxs[1])+2;this.arrows=this.addArrows(this.pts[1].VTo(this.pts[2]).UV().perp("cw"));walls.setSubWallHandler(this.wallInfo,a,"outlet")},remove:function(){this.arrows.map(function(a){a.remove()})}});
function Tracer(a){this.handle=a.handle;this.type="Tracer";this.info=a.info;this.col=defaultTo(Col(175,175,175),a.col);this.lifespan=Math.round(1E3/updateInterval*defaultTo(5,a.lifespan));this.listenerHandle=this.type+this.handle+"Draw";this.listenerHandleSearch=this.type+this.handle+"Search";this.setupStd();this.drawCanvas=c;this.drawingTools=draw;this.init()}
_.extend(Tracer.prototype,objectFuncs,{init:function(){this.dot=this.getDot();this.pts=[];this.dot?(removeListener(curLevel,"update",this.listenerHandleSearch),addListener(curLevel,"update",this.listenerHandle,this.draw,this)):addListener(curLevel,"update",this.listenerHandleSearch,this.init,this)},getDot:function(){var a=dotManager.get(this.info);if(0<a.length)return this.info.idx&&this.info.idx<a.length?a[this.info.idx]:a[Math.floor(Math.random()*a.length)]},draw:function(){this.dot.active?(this.pts.push(P(this.dot.x,
this.dot.y)),this.pts.length>this.lifespan&&this.pts.splice(0,1),this.drawingTools.path(this.pts,this.col,this.drawCanvas)):this.init()},remove:function(){removeListener(curLevel,"update",this.listenerHandleSearch);removeListener(curLevel,"update",this.listenerHandle)}});function Liquid(a){this.type="Liquid";this.wallInfo=a.wallInfo;this.wallGas=walls[this.wallInfo];this.wallPtIdxs=a.wallPts||[this.wallGas.length-2,this.wallGas.length-3];this.handle=a.handle;this.actCoeffType=a.actCoeffType;this.actCoeffInfo=a.actCoeffInfo;var b=a.makePhaseDiagram;this.Cp=0;var d=a.tempInit;this.temp=d;var e=a.spcCounts;this.spcDefs=this.getSpcDefs(e);this.drivingForce=this.makeDrivingForce(this.spcDefs);this.dotMgrLiq=this.makeDotManager(this.spcDefs);this.wallLiq=this.makeWallLiq(this.spcDefs,
e,this.wallGas,this.wallPtIdxs,this.dotMgrLiq);this.surfAreaObj=this.wallGas.addSurfAreaAdjust(this.handle);this.numAbs=deepCopy(this.drivingForce);this.numEjt=deepCopy(this.numAbs);this.makeDots(this.wallLiq,this.wallGas,this.wallPtIdxs,e,d,this.dotMgrLiq)&&this.deleteCount(this.spcDefs);this.dataGas=this.initData(this.wallGas,this.spcDefs,["pInt","temp"]);this.dataLiq=this.initData(this.wallLiq,this.spcDefs);this.recordTempLiq(this.wallLiq);this.drawList=this.makeDrawList(this.dotMgrLiq);this.actCoeffFuncs=
this.makeActCoeffFuncs(this.actCoeffType,this.actCoeffInfo,this.spcDefs);this.chanceZeroDf=0.4;this.drivingForceSensitivity=10;this.updateListenerName=this.type+this.handle;this.setupUpdate(this.spcDefs,this.dataGas,this.dataLiq,this.actCoeffFuncs,this.drivingForce,this.updateListenerName,this.drawList,this.dotMgrLiq,this.wallLiq,this.numAbs,this.drivingForceSensitivity,this.numEjt,this.wallGas,this.wallPtIdxs,this.surfAreaObj);this.wallGas.addLiquid(this);b&&(this.phaseDiagram=this.makePhaseDiagram(this,
this.spcDefs,this.actCoeffFuncs,this.handle,a.primaryKey),curLevel.graphs[this.phaseDiagram.handle]=this.phaseDiagram,(this.phasePressure=a.phasePressure)&&this.phaseDiagram.setPressure(this.phasePressure));this.setupStd()}
_.extend(Liquid.prototype,objectFuncs,{getSpcDefs:function(a){var b={},d;for(d in a)b[d]=window.spcs[d];return b},makeActCoeffFuncs:function(a,b,d){if("twoSfxMrg"==a)return this.makeTwoSfxMrgFuncs(d,b.a)},makeTwoSfxMrgFuncs:function(a,b){var d={},e=R,f;for(f in a)d[f]=function(a,d){return Math.exp(b*a*a/(e*d))};return d},makeWallLiq:function(a,b,d,e,f,h){a=this.getLiqWallVol(a,b);d=this.getWallLiqPts(d,e,a);return window.walls.addWall({pts:d,handler:{func:this.hit,obj:this},handle:"liquid"+this.handle.toCapitalCamelCase(),
record:!1,show:!0,dotManager:f,close:!1})},makeNumAbsorbed:function(a){var b={},d;for(d in a)b[d]=0;return b},getLiqWallVol:function(a,b,d){var e=0;if(d)for(f in a)e+=a[f].spcVolLiq*d.get({spcName:f}).length/N;else for(var f in a)e+=a[f].spcVolLiq*b[f]/N;return e},getWallLiqPts:function(a,b,d){var e=a[b[0]];b=a[b[1]];a=e.x<b.x?e:b;e=a==e?b:e;d=this.getWallHeight(e.x-a.x,d);a=a.copy().movePt(V(0,-d));return[e.copy().movePt(V(0,-d)),a]},getWallHeight:function(a,b){return b/(vConst*a)+2},makeDotManager:function(a){var b=
new DotManager,d;for(d in a)b.addSpcs(d);return b},makeDots:function(a,b,d,e,f,h){var k=a[1].copy();b=P(Math.max(b[d[0]].x,b[d[1]].x),b[d[0]].y);b=k.VTo(b);for(var l in e)spcs[l].populate(k,b,e[l],f,a.handle,a.handle,h)},recordTempLiq:function(a){var b=this;a.recordTemp(function(){return b.temp})},initData:function(a,b,d){var e={};if(d)for(var f=0;f<d.length;f++){var h=d[f],k=a.getDataObj(h,void 0,!0);!1===k?(k="record"+h.toCapitalCamelCase(),a[k](),e[h]=a.getDataObj(h).src()):e[h]=k.src()}for(var l in b)b=
{spcName:l,tag:a.handle},a.recordFrac(b),e[l]=a.getDataObj("frac",b).src();return e},makeDrivingForce:function(a){var b={},d;for(d in a)b[d]=0;return b},setupUpdate:function(a,b,d,e,f,h,k,l,m,n,p,r,q,u,s){this.calcCp=this.setupCalcCp(a,l);this.calcEquil=this.setupUpdateEquil(a,b,d,e,f);this.drawDots=this.setupDrawDots(k);this.moveDots=this.setupMoveDots(l,a,m,q,u);this.ejectDots=this.setupEjectDots(l,a,f,n,p,k,m,r);var t=this.setupSizeWall(m,q,a,l,u,s);this.phasePressure&&(this.checkUpdatePhase=function(){});
var v=this.calcCp,w=this.calcEquil,y=this.drawDots,x=this.moveDots,A=this.ejectDots;v();var B=0,z=this;addListener(curLevel,"update",h,function(){if(5==B){z.checkUpdatePhase||(z.checkUpdatePhase=z.setupCheckUpdatePhase(z.phaseDiagram,z.wallGas.getDataSrc("pExt"),z.wallGas.getDataSrc("pInt")));var a=z.checkUpdatePhase;removeListener(curLevel,"update",h);addListener(curLevel,"update",h,function(){v();w();y();x();A();t();a()})}else v(),w(),y(),x(),t(),B++})},setupCalcCp:function(a,b){var d=this,e={},
f;for(f in a)e[f]=b.get({spcName:f});return function(){var b=0,f;for(f in a)b+=a[f].cpLiq*e[f].length/N;d.Cp=b}},setupUpdateEquil:function(a,b,d,e,f){var h=this;return function(){for(var k in a){var l=b[k][b[k].length-1],m=d[k][d[k].length-1],n=h.temp,p=e[k](m,n),r=a[k].antoineCoeffs,m=h.getPPure(r.a,r.b,r.c,n)*p*m;f[k]=l*b.pInt[b.pInt.length-1]-m}}},setupDrawDots:function(a){return function(){window.draw.dotsAsst(a)}},setupMoveDots:function(a,b,d,e,f){var h=this,k=[],l;for(l in b)k.push(a.get({spcName:l}));
return function(){for(var a,b,l,r,q=d[0].x,u=d[1].x,s=e[f[0]].y,t=d[0].y,v=0;v<k.length;v++){var w=k[v];if(b=w.length){r=w[0].m;a=15+Math.ceil(15*Math.random());for(var y=0;y<a;y++){l=0.5*tempToV(r,h.temp);var x=2*Math.PI*Math.random();l=V(Math.cos(x)*l,Math.sin(x)*l);for(x=y;x<b;x+=a)w[x].x=Math.max(u,Math.min(q,w[x].x+l.dx)),w[x].y=Math.max(t,Math.min(s,w[x].y+l.dy))}}}}},setupEjectDots:function(a,b,d,e,f,h,k,l){var m=this,n=this.wallGas,p={},r;for(r in b)p[r]=a.get({spcName:r});return function(){for(var q in b){var r=
d[q],s=e[q];e[q]=0;0<r?l[q]+=s/(r*f+1):(l[q]+=1+Math.sqrt(s*(-r*f+1)),l[q]+=(k[0].x-k[1].x)*-r*f/2E3);l[q]=Math.min(l[q],p[q].length);if(r=Math.floor(l[q]))m.eject(a,window.dotManager,b,q,r,n,h,k),l[q]=0}}},setupSizeWall:function(a,b,d,e,f,h){var k=this;return function(){var l=k.getLiqWallVol(d,void 0,e),l=k.getWallHeight(Math.abs(b[f[0]].x-b[f[1]].x),l);a[0].y=b[f[0]].y-l;a[1].y=b[f[0]].y-l;a.parent.setupWall(a.parent.indexOf(a));h.val=2*l+a[1].x-a[0].x}},setupCheckUpdatePhase:function(a,b,d){var e=
b?b:d,f=0;return function(){e[e.length-1]!=a.pressure&&f++;15<f&&(a.setPressure(e[e.length-1]),f=0)}},eject:function(a,b,d,e,f,h,k,l){d=a.get({spcName:e});f=Math.min(d.length,f);f=d.slice(0,f);a.remove(f);for(a=0;a<f.length;a++)d=f[a],d.setTemp(this.temp),e=d.hVap(),d.v.dy=-Math.abs(f[a].v.dy),d.y=l[0].y-1,d.setWall(h.handle),k.splice(k.indexOf(d),1),this.calcCp(),this.temp-=e/this.Cp;b.add(f)},getPPure:function(a,b,d,e){return Math.pow(10,a-b/(e+d))*MMHGTOBAR},makeDrawList:function(a){for(var b=
a.lists.ALLDOTS.concat(),d=[],e=0;e<a.lists.ALLDOTS.length;e++){var f=Math.floor(Math.random()*b.length);d.push(b[f]);b.splice(f,1)}return d},hit:function(a,b,d,e,f,h,k){b=this.drivingForce;if(void 0!==b[a.spcName]&&(d=this.chanceZeroDf,d/=1-d,d/(d+Math.exp(-b[a.spcName]*this.drivingForceSensitivity))>Math.random()))return this.absorbDot(a,this.drawList,this.dotMgrLiq,this.wallLiq,this.spcDefs);this.adjTemps(a,e,f,this.dataGas,this.dataLiq,this.temp,window.dotManager.spcLists,this.spcDefs)},absorbDot:function(a,
b,d,e,f){window.dotManager.remove(a);b.splice(Math.floor(Math.random()*b.length),0,a);a.setWall(e.handle);d.add(a);b=a.tempCondense();d=this.Cp;this.calcCp();this.temp=(this.temp*d+b*a.cpLiq)/this.Cp;this.numAbs[a.spcName]++;return!1},adjTemps:function(a,b,d,e,f,h,k,l){var m=e.temp[e.temp.length-1];e=a.temp();f=a.cv;var n=0,p;for(p in l)n+=k[p].length*l[p].cv/N;k=getSign(h-m);h=Math.abs((h-(this.Cp*h+n*m)/(this.Cp+n))*this.Cp);h=Math.max(k*Math.min(h,100*f),(5-e)*f);f=e+h/f;k=1;0<this.temp-h/this.Cp&&
(this.temp-=h/this.Cp,k=Math.sqrt(f/e),a.v.mult(k),a.internalPotential*=f/e);WallMethods.collideMethods.reflect(a,b,d*k)},getWallLiq:function(){return this.wallLiq},getWallGas:function(){return this.wallGas},addQ:function(a){var b=this.Cp,d=this.temp;a=Math.min(b*(3E3-d),Math.max((-d+10)*b,a));this.temp+=a/b;console.log(a/b);this.wallLiq.q+=a},makePhaseDiagram:function(a,b,d,e,f){var h,k,l;for(l in b)h?k=l:h=l;return new GraphPhase({spcAName:h,spcBName:k,axisInit:{x:{min:0,max:1},y:{min:200,max:400}},
actCoeffFuncs:d,handle:e,primaryKey:f,liquid:this,wallGas:this.wallGas})},remove:function(){removeListener(curLevel,"update",this.updateListenerName);this.wallGas.removeLiquid(this);this.wallLiq.removed||walls.removeWall(this.wallLiq.handle);this.wallGas.removed||this.wallGas.removeSurfAreaAdjust(this.handle)}});function QArrowsAmmt(a){this.type="QArrowsAmmt";this.wallHandle=a.wallInfo;this.wall=walls[this.wallHandle];this.handle=a.handle;var b=this.wall;b.recordQ();var d=3*(1/a.scale);this.qArrowAmmtMax=isNaN(d)?3:d;this.qArrowAmmtMax=defaultTo(3,3*(1/a.scale));addListener(b,"cleanUp","qArrowsAmmt",function(){for(var a=0;a<this.qArrowsAmmt.length;a++)this.qArrowsAmmt[a].remove();removeListener(curLevel,"update",this.listenerName)},this);this.init(this.wall,this.qArrowAmmtMax);this.setupStd()}
_.extend(QArrowsAmmt.prototype,objectFuncs,{init:function(a,b){Col(175,0,0);var d=V(30,10),e=a[3].copy().fracMoveTo(a[2],0.25),f=a[3].copy().fracMoveTo(a[2],0.75),h=f.VTo(e).perp("cw").UV();e.movePt(h.copy().mult(5));f.movePt(h.copy().mult(5));var e=new ArrowStatic({pos:e,dims:d,fill:Col(175,0,0),stroke:Col(0,0,0),label:"Q",UV:h}),d=new ArrowStatic({pos:f,dims:d,fill:Col(175,0,0),stroke:Col(0,0,0),label:"Q",UV:h}),k=b/65;this.qArrowsAmmt=[e,d];var l="out";qLast=a.q;this.setAmmtArrowDims(this.qArrowsAmmt,
15,80,70,90,a.q,b);0<=a.q&&(l="in",this.flipAmmtArrows(this.qArrowsAmmt));this.listenerName=this.handle+"updateQAmmtArrows";addListener(curLevel,"update",this.listenerName,function(){Math.abs(a.q-qLast)>k&&(dir=0>a.q?"out":"in",this.setAmmtArrowDims(this.qArrowsAmmt,15,80,70,90,a.q,b),l!=dir&&(this.flipAmmtArrows(this.qArrowsAmmt),l=dir),qLast=a.q)},this)},flipAmmtArrows:function(a){for(var b=0;b<a.length;b++){var d=a[b],e=angleToUV(d.getAngle()).mult(1);d.move(e.mult(d.getDims().dx));d.rotate(Math.PI)}},
setAmmtArrowDims:function(a,b,d,e,f,h,k){for(var l=0;l<a.length;l++){var m=a[l],n=m.getDims(),p=Math.abs(h)/k,r=b+(d-b)*p;m.size(V(r,e+(f-e)*p));0<h&&m.move(V(0,r-n.dx))}},remove:function(){removeListener(curLevel,"update",this.listenerName)}});
function ThresholdEnergyPair(a){this.type="ThresholdEnergyPair";spcs[a.spcNameLow]&&spcs[a.spcNameHigh]?(this.spcNameLow=a.spcNameLow,this.spcNameHigh=a.spcNameHigh,this.spcDefLow=spcs[this.spcNameLow],this.spcDefHigh=spcs[this.spcNameHigh],this.thresholdEnergy=a.thresholdEnergy,this.addToChanger(),this.setupStd()):(console.log("One of the species names in threshold energy pair is bad"),console.log("The names are "+a.spcNameLow+" and "+a.spcNameHigh))}
_.extend(ThresholdEnergyPair.prototype,objectFuncs,{addToChanger:function(){ActivationEnergySpcChanger.addPair(this)},remove:function(){ActivationEnergySpcChanger.removePair(this)}});function AuxImage(a){this.type="AuxImage";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.handle=a.handle;this.imgFunc=a.imgFunc;this.slotNum=a.slotNum;this.dims=this.getDims();this.bgCol=curLevel.bgCol;this.makeDiv(this.slotNum);this.addImage(this.imgFunc);curLevel.auxs[this.handle]=this;this.setupStd()}
_.extend(AuxImage.prototype,AuxFunctions,objectFuncs,{makeDiv:function(a){this.parentDiv=this.pickParentDiv("picture",a);this.parentDiv.html("");$(this.parentDiv).css({width:this.dims.dx,height:this.dims.dy,"background-color":this.bgCol.hex,"border-radius":20,padding:0})},addImage:function(a){var b=this;a=interpreter.parseImgFunc(a,!0);a.attrs||(a.attrs={});a.attrs.id=[this.type+this.handle];$(this.parentDiv).append(templater.img(a));var d=$("#"+a.attrs.id[0]);$(d).load(function(){var a=V(b.parentDiv.width(),
b.parentDiv.height()),f=V(d.width(),d.height()),h=Math.min(f.dx,a.dx)/f.dx,k=Math.min(f.dy,a.dy)/f.dy,h=Math.min(h,k),f=f.copy().mult(h),a=P(a.dx/2-f.dx/2,a.dy/2-f.dy/2);$(d).css({position:"absolute",left:a.x,top:a.y,width:f.dx,height:f.dy})})},clearHTML:function(){this.cleanUpParent()},restoreHTML:function(){$(this.parentDiv).css({width:this.dims.dx,height:this.dims.dy,"background-color":this.bgCol.hex,"border-radius":20,padding:0});this.addImage(this.imgFunc)},remove:function(){this.cleanUpParent();
delete curLevel.auxs[this.handle]}});function AnimText(a){this.drawCanvas=a}
AnimText.prototype={newAnim:function(a,b,d){var e=unique("animText",curLevel.updateListeners),f=d.text,h=new Boolean,k=new Boolean,l=new Boolean,m=new Boolean,h=void 0!==b.pos,k=void 0!==b.col,l=void 0!==b.rotation,m=void 0!==b.size,n;n=Col(255,255,255);var p=defaultTo("calibri",d.font),r=defaultTo("center",d.align);d=defaultTo(300,d.time);var q,u,s,t;a.size=defaultTo(13,a.size);a.rot=defaultTo(0,a.rot);a.col=defaultTo(n,a.col);q=a.size;u=a.rot;s=a.col;t=a.pos.copy();var v=Math.floor(d/updateInterval),
w=function(){},y=function(){},x=function(){},A=function(){},B,z,C,E,F,G;h&&(h=V(b.pos.x-a.pos.x,b.pos.y-a.pos.y),B=h.UV().mult(h.mag()/v),w=function(){t.x+=B.dx;t.y+=B.dy});k&&(z=Math.ceil((b.col.r-a.col.r)/v),C=Math.ceil((b.col.g-a.col.g)/v),E=Math.ceil((b.col.b-a.col.b)/v),y=function(){s.adjust(z,C,E)});l&&(k=b.rotation-a.rotation,F=k<=Math.PI?k/v:-k/v,x=function(){u+=F});m&&(G=(b.size-a.size)/v,A=function(){q+=G});var H=0,I=this.drawCanvas;addListener(curLevel,"update",e,function(){draw.text(f,
t,Math.floor(q)+"pt "+p,s,r,u,I);w();y();x();A();H==v&&removeListener(curLevel,"update",e);H++},"")}};function Readout(a,b,d,e,f,h,k,l){this.handle=a;this.align=defaultTo("left",k);this.drawCanvas=c;this.font=defaultTo("13pt calibri",f);this.fontCol=defaultTo(Col(255,255,255),h);this.leftBound=b;this.width=d-b;this.y=e;this.entries=[];l.readouts[a]=this}
Readout.prototype={draw:function(){this.drawCanvas.save();this.drawCanvas.translate(this.leftBound,this.y);for(var a=0;a<this.entries.length;a++){var b=this.entries[a];window.draw.text(b.text,b.pos,this.font,this.fontCol,this.align,0,this.drawCanvas)}this.drawCanvas.restore()},update:function(a,b){var d=byAttr(this.entries,a,"name");d.val=round(b,d.decPlaces)},addEntry:function(a,b){var d=new this.Entry(a,"",this);b?this.entries.splice(b,0,d):this.entries.push(d);this.positionEntries();this.hide().show();
return d},removeEntry:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].handle==a)return this.entries.splice(b,1),this.positionEntries(),this;console.log("Tried to remove entry that does not exist: "+a)},entryExists:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].name==a)return!0;return!1},removeAllEntries:function(){this.entries=[]},positionEntries:function(){var a=this.entries.length,b;b=1<a?Math.floor(this.width/(a-1)):this.width;if("center"==this.align){b=
this.width/(a+1);for(var d=0;d<a;d++){var e=this.entries[d],f=b*(d+1),h=0;e.pos=P(f,h)}}else if("left"==this.align)for(d=0;d<a;d++)e=this.entries[d],f=b*d,h=0,e.pos=P(f,h)},getNumEntries:function(){var a=0,b;for(b in this.entries)a++;return a},reset:function(a){var b=byName(this.entries,a);this.tickReadout(b.curVal,b.setPt,a)},resetAll:function(){for(var a=0;a<this.entries.length;a++){var b=this.entries[a];this.hardUpdate(b.initVal,b.name)}},position:function(a){void 0!==a.x&&(this.leftBound=a.x);
void 0!==a.y&&(this.y=a.y)},show:function(){curLevel.readouts[this.handle]=this;addListener(curLevel,"update","drawReadout"+this.handle,this.draw,this);return this},hide:function(){delete curLevel.readouts[this.handle];removeListener(curLevel,"update","drawReadout"+this.handle);return this},Entry:function(a,b,d){this.handle=a;this.text=b;this.pos=void 0;this.readout=d}};Readout.prototype.Entry.prototype={setText:function(a){this.text=a},remove:function(){this.readout.removeEntry(this.handle)}};LevelTools={setStds:function(){this.graphs={};this.bgCol=Col(5,17,26);this.wallCol=Col(255,255,255);this.numUpdates=0;this.wallSpeed=defaultTo(1,this.wallSpeed);this.makeListenerHolders();this.auxs={};this.gravitying=this.attracting=!1;this.setUpdateRunListener();addListener(this,"data","run",this.dataRun,this)},addStoreAs:function(a){for(var b=0,d=0;d<a.mainSequence.length;d++)for(var e=a.mainSequence[d],f=0;f<e.prompts.length;f++){var h=e.prompts[f];if(h.quiz)for(var k=0;k<h.quiz.length;k++){var l=
h.quiz[k];void 0===l.storeAs&&(l.storeAs="questionAnswer"+String(b));b++}}},addImgs:function(a){for(var b=0,d=0;d<a.mainSequence.length;d++){var e=a.mainSequence[d];e.prompts||console.log("Section "+d+" has no prompts!  Sections must have at least one prompt.");for(var f=0;f<e.prompts.length;f++){var h=prompt.title,k=prompt.text,l=prompt.quiz;h&&(prompt.title=interpreter.interpImgs(h));k&&(prompt.text=interpreter.interpImgs(h));if(l)for(h=0;h<l.length;h++)if(k=l[h],k.storeAs||(k.storeAs="storeAs"+
b),b++,k.options)for(optionIdx=0;optionIdx<k.options.length;optionIdx++){var m=k.options[optionIdx];for(optionElement in m){var n=m[optionElement];"string"==typeof n&&(m[optionElement]=interpreter.interpImgs(n))}}}}},transferObjCleanUp:function(a){for(var b=0;b<a.mainSequence.length;b++){var d=a.mainSequence[b];d.sceneData&&this.transferObjDataCleanUp(d.sceneData.objs);for(var e=0;e<d.prompts.length;e++){var f=d.prompts[e];f.sceneData&&this.transferObjDataCleanUp(f.sceneData.objs)}}},transferObjDataCleanUp:function(a){if(a)for(var b=
0;b<a.length;b++){var d=a[b];d.attrs.cleanUpWith&&!d.cleanUpWith&&(d.cleanUpWith=d.attrs.cleanUpWith)}},addTriggerCleanUp:function(a){for(var b=0;b<a.mainSequence.length;b++){var d=a.mainSequence[b];d.sceneData&&this.addTriggerDataCleanUp(d.sceneData.triggers);for(var e=0;e<d.prompts.length;e++){var f=d.prompts[e];f.sceneData&&this.addTriggerDataCleanUp(f.sceneData.triggers)}}},addTriggerDataCleanUp:function(a){a=a||[];for(var b=0;b<a.length;b++){var d=a[b];!d.cleanUpWith&&(d.requiredFor&&"now"!=
d.requiredFor)&&(d.cleanUpWith=d.requiredFor)}},setDefaultPromptVals:function(a){for(var b=0;b<a.mainSequence.length;b++)for(var d=a.mainSequence[b],e=0;e<d.prompts.length;e++){var f=d.prompts[e];f.finished=!1;f.title=defaultTo("",f.title);f.text=defaultTo("",f.text)}},addSpcs:function(a,b,d){for(var e=0;e<a.length;e++){var f=a[e],h=new Species(f.spcName,f.m,f.r,f.col,e,f.cv,f.hF298,f.hVap298,f.antoineCoeffs,f.cpLiq,f.spcVolLiq,d);b[f.spcName]=h}},move:function(){var a=this.spcs,b;for(b in a)for(var d=
a[b].dots,e=0;e<d.length;e++)d[e].x+=d[e].v.dx,d[e].y+=d[e].v.dy},cutSceneStart:function(a,b,d){this.inCutScene=!0;$("#intText").html("");a=defaultTo("",a);this.pause();$("#dashRunWrapper").hide();$("#buttonManager").hide();!0===b?($("#dashCutScene").show(),this.cutSceneText(a),$("#prompt").html("")):"intro"==b?($("#dashIntro").show(),$("#base").hide(),this.cutSceneText(a)):"outro"==b&&($("#dashOutro").show(),$("#base").hide(),this.cutSceneText(a));$("#canvasDiv").hide();$("#display").show();this.cutSceneDivShow()},
cutSceneDivShow:function(){$("#intText").show()},cutSceneText:function(a){$("#intText").html(a)},showRunDivs:function(){$("#intText").html("");$("#dashRunWrapper").show();$("#buttonManager").show();$("#dashRun").show();$("#dashOutro").hide();$("#dashIntro").hide();$("#dashCutScene").hide();$("#nextPrevDiv").show();$("#base").show();$("#canvasDiv").show();$("#display").hide();$("#intText").hide()},cutSceneEnd:function(){this.inCutScene=!1;this.resume();this.showRunDivs();$("#intText").html("")},pause:function(){this.updateStore=
this.update;this.updateDataStore=this.updateData;this.update=function(){};this.updateData=function(){}},resume:function(){this.updateStore&&(this.update=this.updateStore);this.updateDataStore&&(this.updateData=this.updateDataStore)},hideDash:function(){$("#dashIntro").hide();$("#dashRunWrapper").hide();$("#dashOutro").hide();$("#dashCutScene").hide()},update:function(){this.numUpdates++;turn++;this.updateRun();for(var a in this.updateListeners){var b=this.updateListeners[a];b.func.apply(b.obj)}for(var d in this.wallMoveListeners)b=
this.wallMoveListeners[d],b.func.apply(b.obj)},updateData:function(){for(var a in this.dataListeners){var b=this.dataListeners[a];b.func.apply(b.obj)}this.numUpdates=0},delayGraphs:function(){var a=this;window.setTimeout(function(){a.dataRunNoGraphs();addListener(curLevel,"data","run",a.dataRun,a)},250)},dataRunNoGraphs:function(){for(var a in this.recordListeners){var b=this.recordListeners[a];b.func.apply(b.obj)}},dataRun:function(){for(var a in this.recordListeners){var b=this.recordListeners[a];
b.func.apply(b.obj)}for(var d in this.graphs)this.graphs[d].active&&this.graphs[d].addLast()},setUpdateRunListener:function(){this.updateRun=this.attracting&&this.gravitying?this.updateRunAttractAndGravity:this.attracting?this.updateRunAttract:this.gravitying?this.updateRunGravity:this.updateRunBasic},gravity:function(a){this.gravitying=!0;for(a=0;a<walls.length;a++)walls[a].setHitMode("Gravity");this.setUpdateRunListener()},gravityStop:function(){this.gravitying=!1;this.setUpdateRunListener()},doGravity:function(){for(var a in spcs)for(var b=
spcs[a].dots,d=0;d<b.length;d++)b[d].v.dy+=gInternal,b[d].y+=0.5*gInternal},attract:function(a){this.attracting=!0;attractor.setup();attractor.assignELastAll();this.setUpdateRunListener()},attractStop:function(){this.attracting=!1;attractor.zeroAllEnergies();this.setUpdateRunListener()},updateRunBasic:function(){this.move();collide.check();walls.check();this.drawRun()},updateRunGravity:function(){this.move();collide.check();this.doGravity();walls.check();this.drawRun()},updateRunAttract:function(){this.move();
collide.check();attractor.attract();walls.check();this.drawRun()},updateRunAttractAndGravity:function(){this.move();collide.check();attractor.attract();this.doGravity();walls.check();this.drawRun()},drawRun:function(){draw.clear(this.bgCol);draw.dots();draw.walls(walls)},resetGraphs:function(){for(var a in this.graphs)this.graphs[a].reset()},removeGraph:function(a){this.graphs[a].remove();this.graphs[a]=void 0},removeAllGraphs:function(){for(var a in this.graphs)this.removeGraph(a),delete this.graphs[a]},
saveAllGraphs:function(){for(var a in this.graphs)this.graphs[a].save(a+"section"+sectionIdx+"prompt"+promptIdx)},disableAllGraphs:function(){for(var a in this.graphs)this.graphs[a].disable()},selectObj:function(a,b){return/^wall$/i.test(a)?walls[b]||console.log("Bad command wall handle "+b):this[this.key(a,b)]||console.log("Bad command data: Type "+a+" and handle "+b)},key:function(a,b){return a.toCamelCase()+b.toCapitalCamelCase()},makeListenerHolders:function(){makeListenerHolder(this,"update");
makeListenerHolder(this,"wallMove");makeListenerHolder(this,"data");makeListenerHolder(this,"mousedown");makeListenerHolder(this,"mouseup");makeListenerHolder(this,"mousemove");makeListenerHolder(this,"init");makeListenerHolder(this,"record");makeListenerHolder(this,"sectionCondition");makeListenerHolder(this,"promptCondition");makeListenerHolder(this,"setup")}};function LevelInstance(){this.readouts={};this.setStds()}_.extend(LevelInstance.prototype,LevelTools);function Timeline(){this.buttonManagerBlank=document.getElementById("buttonManager").outerHTML;this.dashRunBlank=document.getElementById("dashRun").outerHTML;this.sections=[];this.sectionIdx=void 0;this.curId=0;this.elems=[]}
Timeline.prototype={curSection:function(){return this.sections[this.sectionIdx]},curPrompt:function(){return this.sections[this.sectionIdx].curPrompt()},pushSection:function(a){this.sections.push(new Timeline.Section(this,a,this.buttonManagerBlank,this.dashRunBlank))},clearCurrentSection:function(){void 0!==this.sectionIdx&&this.sections[this.sectionIdx].clear()},now:function(){return{sectionIdx:this.sectionIdx,promptIdx:this.sections[this.sectionIdx].promptIdx}},findElemBoundsByHandle:function(a){var b=
[],d,e,f,h,k,l;e=0;a:for(;e<this.sections.length;e++){h=this.sections[e].moments;for(f=0;f<h.length;f++){k=h[f].events;for(l=0;l<k.walls.length;l++)if(a==k.walls[l].elemDatum.handle&&(b.push(h[f].timestamp),d=e,2==b.length))break a;for(l=0;l<k.objs.length;l++)if(k.objs[l].elemDatum.handle){if(k.objs[l].elemDatum.handle==a&&(b.push(h[f].timestamp),d=e,2==b.length))break a}else if(k.objs[l].elemDatum.attrs&&k.objs[l].elemDatum.attrs.handle==a&&(b.push(h[f].timestamp),d=e,2==b.length))break a;for(l=
0;l<k.cmmds.length;l++)if(a==k.cmmds[l].elemDatum.handle&&(b.push(h[f].timestamp),d=e,2==b.length))break a}}b.push(d);return b},show:function(a,b,d){var e=this.sectionIdx!=a,f=e||b!=this.sections[a].promptIdx;e&&void 0!==this.sectionIdx&&this.sections[this.sectionIdx].stepToBound(a>this.sectionIdx);if(e||d)this.clearCurrentSection(),this.sectionIdx=a,this.sections[a].showSection(this.sectionIdx);(f||d)&&this.sections[a].showPrompt(b)},addOnce:function(a,b,d,e,f){a="now"==a?this.sectionIdx:a;this.sections[a].addOnce(b,
d,e,f)},refresh:function(){var a=this.sections[this.sectionIdx].promptIdx,b=this.sections[this.sectionIdx],d=new Timeline.Section(this,b.sectionData,this.buttonManagerBlank,this.dashRunBlank,b.conditionManager);b.clear();this.sections.splice(this.sectionIdx,1,d);this.show(this.sectionIdx,a,!0)},takeNumber:function(){return this.curId++}};
Timeline.Section=function(a,b,d,e,f){this.timeline=a;this.inited=!1;this.promptIdx=-1;this.time=-2;this.sectionData=b;this.moments=[];this.populateMoments(a,a.elems,this.moments,this.sectionData);this.moments=_.sortBy(this.moments,function(a){return a.timestamp});this.level=new LevelInstance;this.mainReadout=new Readout("mainReadout",30,myCanvas.width-125,25,"13pt calibri",Col(255,255,255),"left",this.level);this.dotManager=new DotManager;this.collide=new CollideHandler(this.dotManager);this.walls=
WallHandler();this.dataHandler=new DataHandler;this.dataDisplayer=new DataDisplayer;this.conditionManager=f?f.stripForInheritance():new ConditionManager;this.ActivationEnergySpcChanger=new ActivationEnergySpcChanger(this.collide);this.buttonManager=new ButtonManager("buttonManager");this.spcs={};LevelTools.addSpcs(LevelData.spcDefs,this.spcs,this.dotManager);this.sliderList=[];this.dataDisplayer.setReadouts(this.level.readouts);this.collide.setSpcs(this.spcs);this.level.spcs=this.spcs;this.level.dataHandler=
this.dataHandler;this.buttonMangerClone;this.buttonManagerBlank=d;this.dashRunClone;this.dashRunBlank=e};
Timeline.Section.prototype={showSection:function(a){this.replaceDiv($("#dashRunWrapper"),$("#dashRun"),this.dashRunClone||this.dashRunBlank);this.replaceDiv($("#buttonManagerWrapper"),$("#buttonManager"),this.buttonManagerClone||this.buttonManagerBlank);this.pushToGlobal();this.aux1Clone&&(this.replaceDiv($("#aux1Wrapper"),$("aux1"),this.aux1Clone),this.aux1Clone=void 0);this.aux2Clone&&(this.replaceDiv($("#aux2Wrapper"),$("aux2"),this.aux2Clone),this.aux2Clone=void 0);this.inited?(this.restoreAuxs(),
this.restoreGraphs()):(this.promptIdx=-1,this.stepTo(-1),this.inited=!0)},showPrompt:function(a){var b=this.getTimestamp(a,"headHTML");this.promptIdx=a;this.stepTo(b)},stepTo:function(a){if(a>this.time||Math.floor(this.time)==Math.floor(a)){var b=this.momentAt(this.time);for(b&&b.fire(this.time,a);a!=this.time;){b=this.nextTowardsDest(this.time,a);if(!b)break;b.fire(this.time,b.timestamp);this.time=b.timestamp}}else if(a<this.time){(b=this.momentAt(this.time))&&b.fire(this.time,a);for(var d=this.getTimestamp(Math.floor(a),
"tail");d!=this.time;){b=this.nextTowardsDest(this.time,d);if(!b)break;b.fire(this.time,b.timestamp);this.time=b.timestamp}for(this.time=this.getTimestamp(Math.floor(a),"setup")-1E-4;a!=this.time;){b=this.nextMoment(this.time);if(!b)break;b.fire(this.time,b.timestamp);this.time=b.timestamp}}},stepToBound:function(a){a?(this.stepTo(this.sectionData.prompts.length),this.time=this.sectionData.prompts.length):(this.stepTo(0),this.time=0)},nextTowardsDest:function(a,b){var d=this.momentAt(a);if(d){d=this.moments.indexOf(d);
b<a?d--:d++;var e=this.moments[d];if(e&&Math.abs(e.timestamp-a)<=Math.abs(b-a))return this.moments[d]}else if(a<b)for(d=0;d<this.moments.length;d++){if(e=this.moments[d],e.timestamp>a){if(e.timestamp<=b)return e;break}}else if(b<a)for(d=this.moments.length-1;0<=d;d--)if(e=this.moments[d],e.timestamp<a){if(e.timestamp>=b)return e;break}},nextMoment:function(a){for(var b=0;b<this.moments.length;b++)if(this.moments[b].timestamp>a)return this.moments[b]},momentAt:function(a){for(var b=0;b<this.moments.length;b++)if(this.moments[b].timestamp==
a)return this.moments[b]},cleanUpPrompt:function(){var a=this.getTimestamp(this.sectionData.prompts.length-1,"tail");this.stepTo(a);this.time=a},curPrompt:function(){return this.sectionData.prompts[this.promptIdx]},replaceDiv:function(a,b,d){b.length&&b.remove();a.append(d)},pushToGlobal:function(){window.curLevel=this.level;window.collide=this.collide;window.walls=this.walls;window.dotManager=this.dotManager;window.spcs=this.spcs;window.dataDisplayer=this.dataDisplayer;window.sliderList=this.sliderList;
window.buttonManager=this.buttonManager;window.dataHandler=this.dataHandler;window.ActivationEnergySpcChanger=this.ActivationEnergySpcChanger;window.conditionManager=this.conditionManager},restoreAuxs:function(){for(var a in this.level.auxs)this.level.auxs[a].restoreHTML()},restoreGraphs:function(){for(var a in this.level.graphs){var b=this.level.graphs[a];b.restoreHTML();b.drawAllData()}},clear:function(){if(this.inited){$("#prompt").html("");this.buttonManagerClone=$("#buttonManager").clone(!0);$("#buttonManager").html("");
$("#baseHeader").html("");this.dashRunClone=$("#dashRun").clone(!0);$("#dashRun").remove();for(var a in this.level.graphs)this.level.graphs[a].clearHTML();for(var b in this.level.auxs)this.level.auxs[b].clearHTML()}},addCmmdSpan:function(a,b){promptIdx="now"==a?this.promptIdx:a;var d=this.getTimestamp(promptIdx,"setup"),e=this.timeline.takeNumber();cmmd="string"==typeof b||"function"==typeof b?new Timeline.Command("span",b,void 0,!0,!1):new Timeline.Command("span",b.spawn,b.remove,!1,b.once,b.cleanUpWith);
this.timeline.elems[e]=cmmd;this.applyCmmdSpan(this.timeline,this.moments,this.timeline.elems,cmmd,"cmmds",cmmd.once,d,e)},addCmmdPoint:function(a,b,d,e,f){promptIdx="now"==a?this.promptIdx:a;a=this.timeline.takeNumber();b=this.getTimestamp(promptIdx,b||"setup");d=new Timeline.Command("point",d,void 0,e,f);this.timeline.elems[a]=d;this.applyCmmdPoint(this.timeline,this.moments,this.timeline.elems,d,"cmmds",f,b,a)},populateMoments:function(a,b,d,e){d.push(new Timeline.Moment(-2));this.addSceneDataToMoments(a,
b,d,e.sceneData,-1,void 0);for(var f=e.prompts,h=0;h<f.length;h++)f[h].sceneData&&this.addSceneDataToMoments(a,b,d,f[h].sceneData,h);this.populateHTMLMoments(a,b,d,e)},populateHTMLMoments:function(a,b,d,e){e=e.prompts;for(var f=0;f<e.length;f++){var h=e[f],k=this.getTimestamp(f,"headHTML");this.populatePromptHTML(h,k,a,b,d,f)}},populatePromptHTML:function(a,b,d,e,f,h){var k=this,l,m,n;a.cutScene?(m=d.takeNumber(),l=function(){var b=interpreter.interp(a.text);k.level.cutSceneStart(b,a.cutScene)},n=
function(){k.level.cutSceneEnd()},a.quiz&&(l=extend(l,function(){$("#base").hide();k.level.quiz=quizRenderer.render(a.quiz,$("#intText"))}),n=extend(n,function(){$("#base").show();k.level.quiz=void 0}))):(m=d.takeNumber(),l=function(){var b=interpreter.interp(a.text);$("#prompt").html(defaultTo("",templater.div({innerHTML:b})));a.quiz&&(k.level.quiz=quizRenderer.render(a.quiz,$("#prompt")))},n=function(){$("#prompt").html("");k.level.quiz=void 0});n=new Timeline.Command("span",l,n);l=this.getTimestamp(h,
"tailHTML");this.pushSpan(e,n,Timeline.stateFuncs.cmmds.spawn,Timeline.stateFuncs.cmmds.remove,m,f,b,l,!1,"cmmds");a.quiz&&(m=d.takeNumber(),n=new Timeline.Command("span",function(){$("#nextPrevDiv").hide()},function(){$("#nextPrevDiv").show()}),l=this.getTimestamp(h,"tailHTML"),this.pushSpan(e,n,Timeline.stateFuncs.cmmds.spawn,Timeline.stateFuncs.cmmds.remove,m,f,b,l,!1,"cmmds"));a.title&&(m=d.takeNumber(),n=new Timeline.Command("span",function(){$("#baseHeader").html(a.title)},function(){$("#baseHeader").html("")}),
l=this.getTimestamp(h,"tailHTML"),this.pushSpan(e,n,Timeline.stateFuncs.cmmds.spawn,Timeline.stateFuncs.cmmds.remove,m,f,b,l,!1,"cmmds"));h=new Timeline.Command("point",function(){interpreter.renderMath();k.buttonManager.arrangeGroupWrappers();k.buttonManager.arrangeAllGroups();k.buttonManager.setButtonWidth()},void 0,!0);this.pushPoint(f,e,d.takeNumber(),h,Timeline.stateFuncs.cmmds.spawn,!0,"cmmds",!1,b)},addSceneDataToMoments:function(a,b,d,e,f){this.getOrCreateMoment(d,f);e&&(this.applySpanToMoments(a,
d,b,e.walls,"walls",f,Timeline.stateFuncs.walls.spawn,Timeline.stateFuncs.walls.remove),this.applySpanToMoments(a,d,b,e.dots,"dots",f,Timeline.stateFuncs.dots.spawn,Timeline.stateFuncs.dots.remove),this.applySpanToMoments(a,d,b,e.objs,"objs",f,Timeline.stateFuncs.objs.spawn,Timeline.stateFuncs.objs.remove),this.applySpanToMoments(a,d,b,e.dataRecord,"objs",f,Timeline.stateFuncs.dataRecord.spawn,Timeline.stateFuncs.dataRecord.remove),this.applySpanToMoments(a,d,b,e.dataReadouts,"objs",f,Timeline.stateFuncs.dataReadouts.spawn,
Timeline.stateFuncs.dataReadouts.remove),this.applySpanToMoments(a,d,b,e.triggers,"objs",f,Timeline.stateFuncs.triggers.spawn,Timeline.stateFuncs.triggers.remove),this.applySpanToMoments(a,d,b,e.graphs,"objs",f,Timeline.stateFuncs.graphs.spawn,Timeline.stateFuncs.graphs.remove),this.applySpanToMoments(a,d,b,e.rxns,"objs",f,Timeline.stateFuncs.rxns.spawn,Timeline.stateFuncs.rxns.remove),this.applySpanToMoments(a,d,b,e.buttonGroups,"objs",f,Timeline.stateFuncs.buttonGrps.spawn,Timeline.stateFuncs.buttonGrps.remove),
this.applyCmmdsToMoments(a,d,b,e.cmmds,"cmmds",f))},applySpanToMoments:function(a,b,d,e,f,h,k,l){e=e?e:[];for(var m=0;m<e.length;m++){var n=a.takeNumber(),p=e[m],r=this.getTimestamp(p.cleanUpWith||h,"tail");this.pushSpan(d,p,k,l,n,b,h,r,!1,f)}},applyCmmdsToMoments:function(a,b,d,e,f,h){var k;e=e?e:[];for(var l=0;l<e.length;l++)k=e[l],k="string"==typeof k||"function"==typeof k?new Timeline.Command("point",k,void 0,!0,!1):new Timeline.Command(k.type,k.spawn,k.remove,defaultTo(!0,k.oneWay),k.once),/span/i.test(k.type)?
this.applyCmmdSpan(a,b,d,k,f,k.once,h):/point/i.test(k.type)?this.applyCmmdPoint(a,b,d,k,f,k.once,h):(console.log("Bad command"),console.log(k),console.log('Must be string or have type of "span" or "point"'))},applyCmmdSpan:function(a,b,d,e,f,h,k,l){l=void 0===l?a.takeNumber():l;a=Timeline.stateFuncs.cmmds.spawn;f=Timeline.stateFuncs.cmmds.remove;var m=this.getTimestamp(e.cleanUpWith||k,"tail");this.pushSpan(d,e,a,f,l,b,k,m,h,"cmmds")},applyCmmdPoint:function(a,b,d,e,f,h,k,l){l=void 0===l?a.takeNumber():
l;a=Timeline.stateFuncs.cmmds.spawn;var m=defaultTo(!0,e.oneWay);this.pushPoint(b,d,l,e,a,m,f,h,k)},pushSpan:function(a,b,d,e,f,h,k,l,m,n){k=this.getOrCreateMoment(h,k);h=this.getOrCreateMoment(h,l);l=new Timeline.Event.Span(this,a,b,d,e,f,"head",m,k);a=new Timeline.Event.Span(this,a,b,d,e,f,"tail",m,h);l.partner=a;a.partner=l;k.events[n].push(l);h.events[n].push(a)},pushPoint:function(a,b,d,e,f,h,k,l,m){a=this.getOrCreateMoment(a,m);b=new Timeline.Event.Point(this,b,e,f,d,h,l,a);a.events[k].push(b)},
getTimestamp:function(a,b){var d;/tailhtml/i.test(b)?d=0.8:/tail/i.test(b)?d=0.9:/setup/i.test(b)?d=0.1:/headhtml/i.test(b)?d=0.2:/head/.test(b)&&(d=0);var e=this.parseIntegerTimeIdx(a);return-1==e&&"tail"==b?Infinity:e+d},parseIntegerTimeIdx:function(a){if("string"==typeof a){if(/section/i.test(a))return-1;var b=/[0-9]+/.exec(a);if(""!==b)return Number(b);console.log("Bad time code: "+a)}else return a},getOrCreateMoment:function(a,b){for(var d=0;d<a.length;d++)if(a[d].timestamp==b)return a[d];a.push(new Timeline.Moment(b));
return a[a.length-1]}};
Timeline.stateFuncs={walls:{spawn:function(a,b,d,e){b[d]=a.walls.addWall(e)},remove:function(a,b,d){var e=b[d];e&&a.walls.removeWall(e.handle);b[d]=void 0}},dots:{spawn:function(a,b,d,e){a.spcs[e.spcName].populate(e.pos,e.dims,e.count,e.temp,e.tag,d,e.returnTo);b[d]="dots"},remove:function(a,b,d){a.dotManager.removeByAttr("elemId",d);b[d]=void 0}},objs:{spawn:function(a,b,d,e){(a=window[e.type])||console.log("Bad object type "+e.type);b[d]=new a(e.attrs)},remove:function(a,b,d){(a=b[d])&&a.remove();
b[d]=void 0}},dataRecord:{spawn:function(a,b,d,e){if(/collisions/i.test(e.data))a.collide.recordCollisions();else a.walls[e.wallInfo]["record"+e.data.toCapitalCamelCase()](e.attrs);b[d]=e},remove:function(a,b,d){var e=b[d];if(/collisions/i.test(e.data))a.collide.recordCollisionsStop();else a.walls[e.wallInfo]["record"+e.data.toCapitalCamelCase()+"Stop"](e.attrs);b[d]=void 0}},dataReadouts:{spawn:function(a,b,d,e){a=a.dataDisplayer.addEntry(e);b[d]=a},remove:function(a,b,d){b[d].remove();b[d]=void 0}},
triggers:{spawn:function(a,b,d,e){b[d]=new window.Trigger(e)},remove:function(a,b,d){b[d].remove();b[d]=void 0}},graphs:{spawn:function(a,b,d,e){for(var f=new window.Graphs[e.type](e),h=0;h<e.sets.length;h++)f.addSet(e.sets[h]);a.level.graphs[e.handle]=f;b[d]=f},remove:function(a,b,d){b[d].remove();b[d]=void 0}},rxns:{spawn:function(a,b,d,e){a=a.collide.addReaction(e);b[d]=a},remove:function(a,b,d){b[d].remove();b[d]=void 0}},buttonGrps:{spawn:function(a,b,d,e){a.buttonManager.addGroup(e.handle,e.label,
e.prefIdx,e.isRadio,e.isToggle);for(var f=0;f<e.buttons.length;f++){var h=e.buttons[f];a.buttonManager.addButton(e.handle,h.handle,h.label,h.exprs,h.prefIdx,h.isDown)}b[d]=e},remove:function(a,b,d){a.buttonManager.removeGroup(b[d].handle);b[d]=void 0}},cmmds:{spawn:function(a,b,d,e){a=e.spawn;b[d]=e;if(a)with(DataGetFuncs)"function"==typeof a?a():"string"==typeof a?eval("("+a+")"):a instanceof Array&&(b=a.join(";")+";",eval("("+b+")"))},remove:function(a,b,d){a=b[d];b[d]=void 0;if(b=a.remove)with(DataGetFuncs)"function"==
typeof b?b():"string"==typeof b?eval("("+b+")"):b instanceof Array&&(b=b.join(";")+";",eval("("+b+")"))}}};Timeline.Moment=function(a){this.timestamp=a;this.events=new Timeline.EventClassHolder};
Timeline.Moment.prototype={fire:function(a,b){this.fireSpans(this.events.dots,a,b);this.fireSpans(this.events.walls,a,b);this.fireSpans(this.events.objs,a,b);this.fireCmmds(this.events.cmmds,a,b)},fireSpans:function(a,b,d){for(var e=0;e<a.length;e++)this.fireSpan(a[e],b,d)},fireSpan:function(a,b,d){if(a.active){var e=getAndEval(a.elemDatum);"head"==a.boundType?d==this.timestamp&&b<d?a.spawn(a.section,a.timelineElems,a.id,e):b==this.timestamp&&d<b&&(a.remove(a.section,a.timelineElems,a.id),a.once&&
(a.active=!1,a.partner.active=!1)):"tail"==a.boundType&&(d>b?(a.remove(a.section,a.timelineElems,a.id),a.once&&(a.active=!1)):b>d&&a.spawn(a.section,a.timelineElems,a.id,e))}},fireCmmds:function(a,b,d){for(var e,f=0;f<a.length;f++){var h=a[f];if(h instanceof Timeline.Event.Span)this.fireSpans([h],b,d);else if(h instanceof Timeline.Event.Point&&d==this.timestamp&&(h.elemDatum.oneWay?b<d:1)&&h.active)e=getAndEval(h.elemDatum),h.spawn(h.section,h.timelineElems,h.id,e),h.once&&(h.active=!1)}}};
Timeline.Command=function(a,b,d,e,f,h){this.type=a;this.spawn=b;this.remove=d;this.oneWay=e;this.once=f;this.cleanUpWith=h};Timeline.EventClassHolder=function(){this.walls=[];this.dots=[];this.objs=[];this.cmmds=[]};
Timeline.Event={Span:function(a,b,d,e,f,h,k,l,m){this.section=a;this.timelineElems=b;this.elemDatum=d;this.spawn=e;this.remove=f;this.id=h;this.boundType=k;this.moment=m;this.once=l;this.active=!0;this.parnter},Point:function(a,b,d,e,f,h,k,l){this.section=a;this.timelineElems=b;this.elemDatum=d;this.spawn=e;this.id=f;this.oneWay=h;this.moment=l;this.once=k;this.active=!0}};$(function(){MathJax.Hub.Config({tex2jax:{inlineMath:[["##","##"],["\\(","\\)"]],displayMath:[["$$","$$"]]}});_.extend(Array.prototype,toInherit.ArrayExtenders);_.extend(Math,toInherit.MathExtenders);_.extend(String.prototype,toInherit.StringExtenders);templater=new Templater;globalHTMLClass="sim";dotManager=new DotManager;turn=0;window.Graphs={Scatter:GraphScatter,Hist:GraphHist,Phase:GraphPhase};$("#mainHeader").html(LevelData.levelTitle);$("#canvasDiv").hide();$("#base").hide();$("#dashIntro").hide();
$("#dashOutro").hide();$("#dashCutScene").hide();$("#display").hide();$("#intText").hide();canvas=document.getElementById("myCanvas");c=canvas.getContext("2d");N=1E3;R=8.314;KB=R/N;cv=1.5*R;cp=2.5*R;extraIntervals={};vConst=1E-4;pConst=16.3562;tConst=20;LtoM3=0.001;ATMtoPA=101325;PUNITTOPA=BARTOPA=1E5;MMHGTOBAR=0.0013332237;JtoKJ=0.001;pxToE=Math.sqrt(tConst);ACTUALN=6.022E23;g=1.75;gInternal=0.01;workConst=1.58E-4;updateInterval=30;dataInterval=1250;borderCol=Col(155,155,155);pxToMS=19.33821;auxHolderDivs=
["aux1","aux2"];a=promptIdx=0;stored={};addJQueryElems($("button"),"button");draw=new DrawingTools;turnUpdater=setInterval("curLevel.update()",updateInterval);dataUpdater=setInterval("curLevel.updateData()",dataInterval);attractor=new Attractor;animText=new AnimText(c);phaseEquilGenerator=new PhaseEquilGenerator;quizRenderer=new QuizRenderer;sceneNavigator=new SceneNavigator;interpreter=new ExpressionInterpreter;$("#resetExp").click(function(){sceneNavigator.refresh()});$("#toSim").click(function(){sceneNavigator.nextPrompt()});
$("#toLastStep").click(function(){sceneNavigator.prevPrompt()});$("#previous").click(function(){sceneNavigator.prevPrompt()});$("#next").click(function(){sceneNavigator.nextPrompt()});timeline=new Timeline;canvasHeight=450;myCanvas.width=$("#main").width();myCanvas.height=canvasHeight;LevelTools.addImgs(LevelData);LevelTools.setDefaultPromptVals(LevelData);LevelTools.addTriggerCleanUp(LevelData);LevelTools.addStoreAs(LevelData);LevelTools.transferObjCleanUp(LevelData);LevelTools.showRunDivs();for(var a=
0;a<LevelData.mainSequence.length;a++)timeline.pushSection(LevelData.mainSequence[a]);window.currentSetupType="section";timeline.show(0,0)});

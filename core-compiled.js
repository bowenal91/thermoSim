function Dot(a,b,d,e,f,h,j,k,l){this.x=a;this.y=b;this.v=d;this.m=e;this.r=f;this.spcName=h;this.idNum=j;this.tag=k;this.returnTo=l;this.tConst=tConst;this.pxToE=pxToE;this.parentLists=[];this.peCur=this.tempLast=this.peLast=0;a=speciesDefs[h];this.attractStr=a.attractStr;this.attractStrs=a.attractStrs;this.attractRad=a.attractRad;return this}function Species(a,b,d,e){this.m=a;this.r=b;this.cols=d;this.def=e;this.idNum=e.idNum;this.dots=dotManager.addSpcs(e.spcName)}
Species.prototype={populate:function(a,b,d,e,f,h){var j=a.x;a=a.y;var k=b.dx;b=b.dy;for(var l=[],m=0;m<d;m++){var n=j+Math.random()*k,q=a+Math.random()*b,r=tempToV(this.m,e),s=2*Math.random()*Math.PI,u=r*Math.cos(s),r=r*Math.sin(s);l.push(D(n,q,V(u,r),this.m,this.r,this.def.spcName,this.def.idNum,f,h))}dotManager.add(l)},depopulate:function(a){console.trace();a?dotManager.removeByInfo({name:this.def.spcName,tag:a}):dotManager.removeByInfo({name:this.def.spcName})}};
function Point(a,b){this.x=a;this.y=b;return this}function Vector(a,b){this.dx=a;this.dy=b;return this}function Color(a,b,d){this.r=a;this.g=b;this.b=d;this.setHex();return this}function D(a,b,d,e,f,h,j,k,l){return new Dot(a,b,d,e,f,h,j,k,l)}function P(a,b){return new Point(a,b)}function V(a,b){return new Vector(a,b)}function Col(a,b,d){return new Color(a,b,d)}
Vector.prototype={UV:function(){var a=Math.sqrt(this.dx*this.dx+this.dy*this.dy);return V(this.dx/a,this.dy/a)},mag:function(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)},add:function(a){this.dx+=a.dx;this.dy+=a.dy;return this},neg:function(){this.dx*=-1;this.dy*=-1;return this},dotProd:function(a){return this.dx*a.dx+this.dy*a.dy},magSqr:function(){return this.dx*this.dx+this.dy*this.dy},copy:function(){return new Vector(this.dx,this.dy)},mult:function(a){this.dx*=a;this.dy*=a;return this},
multVec:function(a){this.dx*=a.dx;this.dy*=a.dy;return this},setMag:function(a){this.mult(a/this.mag());return this},adjust:function(a,b){this.dx+=a;this.dy+=b;return this},rotate:function(a){var b=this.dx,d=this.dy;this.dx=b*Math.cos(a)-d*Math.sin(a);this.dy=b*Math.sin(a)+d*Math.cos(a);return this},perp:function(a){var b=this.dx,d=this.dy;a?"cw"==a?(this.dx=d,this.dy=-b):(this.dx=-d,this.dy=b):(this.dx=d,this.dy=-b);return this},angle:function(){return Math.atan2(this.dy,this.dx)},sameAs:function(a){return this.dx==
a.dx&&this.dy==a.dy},isValid:function(){return void 0!==this.dx&&!isNaN(this.dx)&&void 0!==this.dy&&!isNaN(this.dy)}};
Color.prototype={adjust:function(a,b,d){this.r=Math.round(Math.min(255,Math.max(0,this.r+a)));this.g=Math.round(Math.min(255,Math.max(0,this.g+b)));this.b=Math.round(Math.min(255,Math.max(0,this.b+d)));this.setHex();return this},set:function(a){void 0!==a.r&&(this.r=a.r);void 0!==a.g&&(this.g=a.g);void 0!==a.b&&(this.b=a.b);this.setHex();return this},setFromUnround:function(a){void 0!==a.r&&(this.r=Math.round(a.r));void 0!==a.g&&(this.g=Math.round(a.g));void 0!==a.b&&(this.b=Math.round(a.b));this.setHex();
return this},setHex:function(){var a=Number(Math.round(this.r)).toString(16),b=Number(Math.round(this.g)).toString(16),d=Number(Math.round(this.b)).toString(16);1==a.length&&(a="0"+a);1==b.length&&(b="0"+b);1==d.length&&(d="0"+d);this.hex=a+b+d},copy:function(){return new Color(this.r,this.g,this.b)},add:function(a){this.r=Math.round(Math.min(255,Math.max(0,this.r+a.r)));this.g=Math.round(Math.min(255,Math.max(0,this.g+a.g)));this.b=Math.round(Math.min(255,Math.max(0,this.b+a.b)));this.setHex();return this},
addNoBounds:function(a){this.r=Math.round(this.r+a.r);this.g=Math.round(this.g+a.g);this.b=Math.round(this.b+a.b);this.setHex();return this},mult:function(a){this.r=Math.round(Math.min(255,Math.max(0,this.r*a)));this.g=Math.round(Math.min(255,Math.max(0,this.g*a)));this.b=Math.round(Math.min(255,Math.max(0,this.b*a)));this.setHex();return this},sameAs:function(a){return this.r==a.r&&this.g==a.g&&this.b==a.b}};
Point.prototype={distTo:function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)},VTo:function(a){return V(a.x-this.x,a.y-this.y)},fracVTo:function(a,b){return this.VTo(a).mult(b)},fracMoveTo:function(a,b){this.movePt(this.fracVTo(a,b));return this},set:function(a){this.x=a.x;this.y=a.y},avg:function(a){return P((this.x+a.x)/2,(this.y+a.y)/2)},area:function(a,b){var d=V(a.x-this.x,a.y-this.y),e=d.UV(),d=d.mag(),e=V(-e.dy,e.dx),f=V(b.x-this.x,b.y-this.y),e=Math.abs(e.dotProd(f));return 0.5*
d*e},copy:function(){return new Point(this.x,this.y)},movePt:function(a){void 0!==a.dx&&(this.x+=a.dx);void 0!==a.dy&&(this.y+=a.dy);return this},position:function(a){void 0!==a.x&&(this.x=a.x);void 0!==a.y&&(this.y=a.y);return this},scale:function(a,b){var d=this.y-a.y;this.x=a.x+(this.x-a.x)*b;this.y=a.y+d*b;return this},rotate:function(a,b){var d=V(a.x,a.y);this.movePt(d.copy().neg());var e=this.x,f=this.y;this.x=e*Math.cos(b)-f*Math.sin(b);this.y=e*Math.sin(b)+f*Math.cos(b);this.movePt(d);return this},
mirror:function(a,b){var d=b.UV(),e=a.VTo(this),d=d.perp("cw"),e=e.dotProd(d);0>e?this.movePt(d.mult(Math.abs(2*e))):0<e&&this.movePt(d.neg().mult(2*e));return this},rect:function(a,b){var d=Array(4);"ccw"==b?(d[0]=this.copy(),d[1]=this.copy().movePt({dy:a.dy}),d[2]=this.copy().movePt(a),d[3]=this.copy().movePt({dx:a.dx})):(d[0]=this.copy(),d[1]=this.copy().movePt({dx:a.dx}),d[2]=this.copy().movePt(a),d[3]=this.copy().movePt({dy:a.dy}));return d},roundedRect:function(a,b,d){a=this.rect(a,d);return this.roundPts(a,
b)},roundPts:function(a,b){this.sameAs(a[0])||(a=[this].concat(a));var d=Array(2*a.length);a["-1"]=a[a.length-1];a.push(a[0]);for(var e=0;e<a.length-1;e++)d[2*e]=a[e].copy().fracMoveTo(a[String(e-1)],b/2),d[2*e+1]=a[e].copy().fracMoveTo(a[String(e+1)],b/2);return d},sameAs:function(a){return this.x==a.x&&this.y==a.y},closeTo:function(a){return 1>Math.abs(this.x-a.x)&&1>Math.abs(this.y-a.y)},isValid:function(){return void 0!==this.x&&!isNaN(this.x)&&void 0!==this.y&&!isNaN(this.y)},track:function(a){if(a instanceof
Point)b=a,e=f=d=!1;else var b=a.pt,d=a.offset,e=defaultTo("",a.noTrack),f=e.indexOf("x")+1,e=e.indexOf("y")+1;this.trackListenerId=unique(this.x+","+this.y+"tracksWithUniqueId",curLevel.updateListeners.listeners);-1!=this.trackListenerId.indexOf("NaN")&&(console.log("Trying to track NaN!"),console.trace());if(!f&&!e)if(d)d.dx?h=function(){this.x=b.x+d.dx;this.y=b.y}:d.dy?h=function(){this.x=b.x;this.y=b.y+d.dy}:d.dy&&d.dx&&(h=function(){this.x=b.x+d.dx;this.y=b.y+d.dy});else var h=function(){this.x=
b.x;this.y=b.y};else f?d?d.dy&&(h=function(){this.y=b.y+d.dy}):h=function(){this.y=b.y}:e&&(d?d.dx&&(h=function(){this.x=b.x+d.dx}):h=function(){this.x=b.x});h?(addListener(curLevel,"update",this.trackListenerId,h,this),this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith),addListener(curLevel,this.cleanUpWith+"CleanUp",this.trackListenerId,this.trackStop,this)):(console.log("tried to track "+this.trackListenerId+" but input wasn't right"),console.trace());return this},trackStop:function(){removeListener(curLevel,
"update",this.trackListenerId);removeListener(curLevel,this.cleanUpWith+"CleanUp",this.trackListenerId);this.cleanUpWith=this.trackListenerId=void 0;return this}};
Dot.prototype={KE:function(){return 0.5*this.m*(this.v.dx*this.v.dx+this.v.dy*this.v.dy)},temp:function(){return 0.5*this.m*(this.v.dx*this.v.dx+this.v.dy*this.v.dy)*this.tConst},setTemp:function(a){var b=this.temp();this.v.mult(Math.sqrt(a/b));return this},adjTemp:function(a){var b=this.temp();this.v.mult(Math.sqrt((b+a)/b));return this},speed:function(){return this.v.mag()*this.pxToMS},kill:function(){for(var a=0;a<this.parentLists.length;a++)this.parentLists[a].splice(this.parentLists[a].indexOf(this),
1)}};toInherit={gridder:{makeGrid:function(){for(var a=this.numCols,b=this.numRows,d=Array(a),e=0;e<a;e++){for(var f=Array(b),h=0;h<b;h++)f[h]=[];d[e]=f}return d}},ArrayExtenders:{pushNumber:function(a){!isNaN(a)&&void 0!==a&&this.push(a);return this},append:function(a){for(var b=0;b<a.length;b++)this.push(a[b]);return this},average:function(){for(var a=0,b=0;b<this.length;b++)a+=this[b];return a/this.length},switchElements:function(a,b){var d=this[a];this[a]=this[b];this[b]=d;return this},applyFunc:function(a){for(var b=
0;b<this.length;b++)a(this[b])}},MathExtenders:{log10:function(a){return Math.log(a)/Math.log(10)}},StringExtenders:{killWhiteSpace:function(){return this.replace(/\s/g,"")},killNumbers:function(){return this.replace(/[0-9]/g,"")}},ArrowFuncs:{getPts:function(){var a=Array(3),b=this.dims.dx,d=this.dims.dy;a[0]=P(0,0.2*d);a[1]=P(0.7*b,0.2*d);a[2]=P(0.7*b,0.5*d);d=deepCopy(a).reverse();a.push(P(b,0));for(b=0;b<d.length;b++)a.push(P(d[b].x,-d[b].y));return a}}};function DrawingTools(){}
DrawingTools.prototype={clear:function(a){var b=myCanvas.width,d=myCanvas.height;c.clearRect(0,0,b,d);c.fillStyle=a.hex;c.fillRect(0,0,b,d)},dots:function(){for(var a in spcs){var b=spcs[a].dots;c.fillStyle=spcs[a].cols.hex;if(b[0])var d=b[0].r;for(var e=0;e<b.length;e++)c.beginPath(),c.arc(b[e].x,b[e].y,d,0,2*Math.PI,!0),c.closePath(),c.fill()}},walls:function(a,b){c.beginPath();c.strokeStyle=b.hex;for(var d=0;d<a.length;d++){var e=a[d];if(e.show){c.moveTo(e[0].x,e[0].y);for(var f=1;f<e.length-1;f++){var h=
e[f];c.lineTo(h.x,h.y)}c.closePath();c.stroke()}}},fillPts:function(a,b,d){d.fillStyle=b.hex;d.beginPath();d.moveTo(a[0].x,a[0].y);for(b=1;b<a.length;b++)d.lineTo(a[b].x,a[b].y);d.closePath();d.fill()},fillPtsAlpha:function(a,b,d,e){var f=e.globalAlpha;e.globalAlpha=d;draw.fillPts(a,b,e);e.globalAlpha=f},fillPtsStroke:function(a,b,d,e){e.fillStyle=b.hex;e.strokeStyle=d.hex;e.beginPath();e.moveTo(a[0].x,a[0].y);for(b=1;b<a.length;b++)e.lineTo(a[b].x,a[b].y);e.closePath();e.stroke();e.fill()},roundedRect:function(a,
b,d,e,f){var h=a.x;a=a.y;var j=b.dx;b=b.dy;f.fillStyle=e.hex;f.beginPath();f.moveTo(h+d,a);this.curvedLine(P(h+j-d,a),P(h+j,a),P(h+j,a+d),f);this.curvedLine(P(h+j,a+b-d),P(h+j,a+b),P(h+j-d,a+b),f);this.curvedLine(P(h+d,a+b),P(h,a+b),P(h,a+b-d),f);this.curvedLine(P(h,a+d),P(h,a),P(h+d,a),f);f.closePath();f.fill()},fillRect:function(a,b,d,e){e.fillStyle=d.hex;e.fillRect(a.x,a.y,b.dx,b.dy)},fillStrokeRect:function(a,b,d,e,f){f.strokeStyle=e.hex;f.fillStyle=d.hex;f.fillRect(a.x,a.y,b.dx,b.dy);f.strokeRect(a.x,
a.y,b.dx,b.dy)},strokeRect:function(a,b,d,e){e.strokeStyle=d.hex;e.strokeRect(a.x,a.y,b.dx,b.dy)},line:function(a,b,d,e){e.strokeStyle=d.hex;e.beginPath();e.moveTo(a.x,a.y);e.lineTo(b.x,b.y);e.closePath();e.stroke()},curvedLine:function(a,b,d,e){e.lineTo(a.x,a.y);e.quadraticCurveTo(b.x,b.y,d.x,d.y)},path:function(a,b,d){d.strokeStyle=b.hex;d.beginPath();d.moveTo(a[0].x,a[0].y);for(b=1;b<a.length;b++)d.lineTo(a[b].x,a[b].y);d.stroke()},text:function(a,b,d,e,f,h,j){j.save();j.translate(b.x,b.y);j.rotate(h);
j.fillStyle=e.hex;j.font=d;j.textAlign=f;b=parseFloat(d);d=0;for(e=a.indexOf("\n");-1!=e;)f=a.slice(0,e),j.fillText(f,0,d),d+=b+2,a=a.slice(e+1,a.length),e=a.indexOf("\n");j.fillText(a,0,d);j.restore()}};function DotManager(){this.lists={ALLDOTS:[]};this.count=0}
DotManager.prototype={add:function(a){a instanceof Array?this.count+=a.length:this.count++;this.execAllCombos(this.addFunc,a)},remove:function(a){if(a instanceof Array){this.count-=a.length;for(var b=0;b<a.length;b++)a[b].kill()}else this.count--,a.kill()},addSpcs:function(a){this.lists[a]=[];return this.lists[a]},removeByInfo:function(a){a.spcName&&a.tag?this.execAllCombos(this.removeByNameAndTagFunc,a):a.spcName?this.execAllCombos(this.removeByNameFunc,a):a.tag?this.execAllCombos(this.removeByTagFunc,
a):(console.log("No useful info given to removeByInfo func in DotManager"),console.trace())},get:function(a){if(a){if(a.spcName&&a.tag)return this.lists[a.spcName+"-"+a.tag];if(a.spcName)return this.lists[a.spcName];if(a.tag)return this.lists[a.tag]}else return this.lists.ALLDOTS},clearAll:function(){for(var a in this.lists)this.lists[a].splice(0,this.lists[a].length)},addFunc:function(a,b){a.push(b);b.parentLists.push(a)},removeFunc:function(a,b){var d=a.indexOf(b);-1<d?(a.splice(d,1),b.parentLists.splice(b.parentLists.indexOf(a),
1)):(console.log("Tried to remove dot from global list of spcName "+b.spcName+" and tag "+b.tag+". Dot not present."),console.trace())},removeByNameAndTagFunc:function(a,b){for(var d=a.length-1;-1<d;d--)a[d].spcName==b.spcName&&a[d].tag==b.tag&&a[d].kill()},removeByNameFunc:function(a,b){for(var d=a.length-1;-1<d;d--)a[d].spcName==b.spcName&&(a.splice(d,1),a[d].kill())},removeByNameAndTagFunc:function(a,b){for(var d=a.length-1;-1<d;d--)a[d].tag==b.tag&&(a.splice(d,1),a[d].kill())},execAllCombos:function(a,
b){if(b instanceof Array)var d=b,e={spcName:d[0].spcName,tag:d[0].tag};else e=b;e=this.getRelevantLists(e);if(d)for(var f=0;f<d.length;f++)this.execFuncOnLists(a,e,d[f]);else this.execFuncOnLists(a,e,b)},execFuncOnLists:function(a,b,d){for(var e=0;e<b.length;e++)a(b[e],d)},getRelevantLists:function(a){var b=[];b.push(this.lists.ALLDOTS);a.spcName&&a.tag&&b.push(this.getByNameAndTag(a));a.spcName&&b.push(this.getByName(a.spcName));a.tag&&b.push(this.getByTag(a.tag));return b},getByNameAndTag:function(a){this.lists[a.spcName+
"-"+a.tag]||(this.lists[a.spcName+"-"+a.tag]=[]);return this.lists[a.spcName+"-"+a.tag]},getByName:function(a){if(this.lists[a])return this.lists[a];console.log("Tried to get bad spcName "+a);console.trace()},getByTag:function(a){this.lists[a]||(this.lists[a]=[]);return this.lists[a]}};AuxFunctions={getDims:function(){var a=$("#main").height(),a=a-$("#auxSpacer").height();return V(400,a/2)},pickParentDiv:function(a){for(var b=0;b<auxHolderDivs.length;b++){var d=$("#"+auxHolderDivs[b]);if(""==$(d).attr("filledWith"))return $(d).attr("filledWith",a),d}console.log("Aux divs are all full!");console.trace()},cleanUpParent:function(){$(this.parentDiv).removeAttr("style");this.parentDiv.html("");$(this.parentDiv).attr("filledWith","")}};GraphBase={setStds:function(){this.hashMarkLen=10;this.checkMarkOversize=3;this.bgCol=curLevel.bgCol;this.gridCol=Col(72,72,72);this.toggleCol=Col(255,255,255);this.textCol=Col(255,255,255);this.flashMult=1.5;this.flashRate=0.1;this.graphBoundCol=Col(255,255,255);this.integralCol=Col(150,150,150);this.integralAlpha=0.5;this.ptStroke=Col(0,0,0);this.rectSideLen=8;this.characLen=Math.sqrt(Math.pow(this.rectSideLen,2)/2)},setNumGridLines:function(){var a=Math.ceil(this.dims.dx*Math.abs(this.xEnd-this.xStart)/
this.gridSpacing),b=Math.ceil(this.dims.dy*Math.abs(this.yEnd-this.yStart)/this.gridSpacing);this.numGridLines={x:a,y:b}},makeCanvas:function(a,b){var d=this;this.buttonId=this.handle+"reset";this.parentDiv=b?b:this.pickParentDiv("graph");this.parentDiv.html("");this.parentDivId=$(this.parentDiv).attr("id");var e=$("<canvas id ='"+this.handle+"Graph' width="+a.dx+" height="+a.dy+" class='noSelect'></canvas><button id='"+this.buttonId+"' style='position:absolute;right:.5em;bottom:.5em'><img src='img/refresh.gif'></img></button>");
$(this.parentDiv).append(e);$("#"+this.buttonId).button();$("#"+this.buttonId).click(function(){d.reset()});this.graphHTMLElement=document.getElementById(this.handle+"Graph");this.graph=this.graphHTMLElement.getContext("2d")},makeCanvasNoReset:function(a,b){this.buttonId=this.handle+"reset";this.parentDiv=b?b:this.pickParentDiv("graph");this.parentDiv.html("");this.parentDivId=$(this.parentDiv).attr("id");var d=$("<canvas id ='"+this.handle+"Graph' width="+a.dx+" height="+a.dy+" class='noSelect'></canvas>");
$(this.parentDiv).append(d);this.graphHTMLElement=document.getElementById(this.handle+"Graph");this.graph=this.graphHTMLElement.getContext("2d")},remove:function(){this.freeze();removeListener(curLevel,"update","flash"+this.handle);removeSave(curLevel,"update","flash"+this.handle);this.cleanUpParent();return this},unfreeze:function(){this.active=!0;return this},freeze:function(){this.active=!1;return this},trace:function(a,b){0<b&&this.getPtsToTrace(a,b)},getPtsToTrace:function(a,b){var d=a.ptDataIdxs[b-
1].x,e=a.ptDataIdxs[b].x,f=a.ptDataIdxs[b-1].y;if(e-d==a.ptDataIdxs[b].y-f){var e=e-d,h=[this.valToCoord(P(a.src.x[d],a.src.y[f]))];for(b=1;b<e+1;b++){var j=this.valToCoord(P(a.src.x[d+b],a.src.y[f+b]));j.closeTo(h[h.length-1])||h.push(j)}this.drawTrace(a,h)}else console.log("Data count mismatch for tracing"),console.trace()},drawTrace:function(a,b){draw.path(b,a.pointCol,this.graph)},integrate:function(a){this.data[a].integralPts=this.getIntegralPts(a);this.drawIntegral(a);return this},getIntegralPts:function(a){var b=
this.data[a].src.x,d=this.data[a].src.y;a=Array(b.length);for(var e=0;e<b.length;e++)a[e]=this.valToCoord(P(b[e],d[e]));b=this.yStart*this.dims.dy;d=a[0].x;a.push(P(a[a.length-1].x,b));a.push(P(d,b));return a},drawIntegral:function(a){draw.fillPtsAlpha(this.data[a].integralPts,this.integralCol,this.integralAlpha,this.graph);this.graphPts()},save:function(a){a=defaultTo("graph"+this.handle,a);a=unique(a,stored);this.dataSave={};for(var b in this.data)this.dataSave[b]={pts:{},src:{}},this.dataSave[b].pts.x=
deepCopy(this.data[b].x),this.dataSave[b].pts.y=deepCopy(this.data[b].y),this.data[b].xInitDataIdx&&(this.dataSave[b].src.x=deepCopy(this.data[b].src.x)),this.data[b].yInitDataIdx&&(this.dataSave[b].src.y=deepCopy(this.data[b].src.y));store(a,this);return a},load:function(){this.makeCanvas(this.dims);var a=[],b;for(b in this.data)this.data[b].x=[],this.data[b].y=[],this.data[b].src.x=deepCopy(this.dataSave[b].src.x),this.data[b].src.y=deepCopy(this.dataSave[b].src.y),a=a.concat(this.setsToPts(this.dataSave[b].pts.x,
this.dataSave[b].pts.y,b));this.addPts(a,!1,!0);return this},setsToPts:function(a,b,d){for(var e=Array(a.length),f=0;f<a.length;f++)e[f]={x:a[f],y:b[f],address:d};return e},makeCheck:function(a,b,d){var e=b[a];a=this.checkMarkOversize;b=e.togglePos.copy();e=e.toggleDims.copy();b.x-=a;b.y-=a;e.dx+=2*a;e.dy+=2*a;return new CheckMark(b,e,d,Col(0,0,0),this.graph)},drawAllBG:function(){this.drawBGRect();this.drawGrid();this.drawBounds();this.legend&&this.drawLegend();this.drawLabels();this.bg=this.graph.getImageData(0,
0,this.dims.dx,this.dims.dy)},drawBGRect:function(){draw.roundedRect(P(0,0),V(this.dims.dx,this.dims.dy),20,this.bgCol,this.graph)},drawGrid:function(){for(var a=0;a<this.numGridLines.x;a++){var b=this.xStart*this.dims.dx+this.gridSpacing*a,d=this.yEnd*this.dims.dy,e=P(b,this.yStart*this.dims.dy+this.hashMarkLen),b=P(b,d);draw.line(e,b,this.gridCol,this.graph)}for(a=0;a<this.numGridLines.y;a++)b=this.yStart*this.dims.dy-this.gridSpacing*a,d=this.xEnd*this.dims.dx,e=P(this.xStart*this.dims.dx-this.hashMarkLen,
b),b=P(d,b),draw.line(e,b,this.gridCol,this.graph)},drawBounds:function(){var a=P(this.xStart*this.dims.dx,this.yStart*this.dims.dy),b=V(this.dims.dx*(this.xEnd-this.xStart),this.dims.dy*(this.yEnd-this.yStart));draw.strokeRect(a,b,this.graphBoundCol,this.graph)},drawLabels:function(){var a=P(this.dims.dx*(this.xStart+this.xEnd)/2,Math.min(this.dims.dy*this.yStart+50,this.dims.dy-20)),b=P(Math.max(this.dims.dx*this.xStart-50,20),this.dims.dy*(this.yStart+this.yEnd)/2);a.y+=this.labelFontSize/2;b.y+=
this.labelFontSize/2;draw.text(this.xLabel,a,this.labelFont,this.textCol,"center",0,this.graph);draw.text(this.yLabel,b,this.labelFont,this.textCol,"center",-Math.PI/2,this.graph)},drawLegend:function(){for(var a in this.legend){var b=this.legend[a],d=b.text,b=b.pt;this.drawLegendToggle(a);draw.text(d.text,P(d.x,d.y),this.legendFont,this.textCol,"left",0,this.graph);this.drawPtStd(b,b.col)}},addPts:function(a,b,d){d=defaultTo(!1,d);b=defaultTo(!0,b);for(var e=this.valRange,e={x:{min:e.x.min,max:e.x.max},
y:{min:e.y.min,max:e.y.max}},f={},h=0;h<a.length;h++){var j=a[h].address,k=a[h].x,l=a[h].y,m=this.data[j];f[j]||(f[j]=[]);m.show&&f[j].push(m.x.length);m.x.push(k);m.y.push(l);this.valRange.x.max=Math.max(this.valRange.x.max,k);this.valRange.x.min=Math.min(this.valRange.x.min,k);this.valRange.y.max=Math.max(this.valRange.y.max,l);this.valRange.y.min=Math.min(this.valRange.y.min,l)}h=this.axisRange;a={min:h.x.min,max:h.x.max};h={min:h.y.min,max:h.y.max};this.setAxisBounds(e);if(!this.rangeIsSame(a,
this.axisRange.x)||!this.rangeIsSame(h,this.axisRange.y))d=!0;d?this.drawAllData():this.drawLastData(f);b&&this.flashInit(f)},rangeIsSame:function(a,b){return!(a.max!=b.max||a.min!=b.min)},setAxisBounds:function(a){this.setAxisBoundsX(a);this.setAxisBoundsY(a)},setAxisBoundsX:function(a){var b=this.axisInit,d=this.valRange;b.x.min<d.x.min&&b.x.max>d.x.max?this.setAxisToInit("x"):a?this.rangeIsSame(a.x,this.valRange.x)||this.getXBounds():this.getXBounds()},setAxisBoundsY:function(a){var b=this.axisInit,
d=this.valRange;b.y.min<d.y.min&&b.y.max>d.y.max?this.setAxisToInit("y"):a?this.rangeIsSame(a.y,this.valRange.y)||this.getYBounds():this.getYBounds()},setAxisToInit:function(a){var b=this.axisRange[a],d=this.axisInit[a],e=this.numGridLines[a];b.min=d.min;b.max=d.max;this.stepSize[a]=(b.max-b.min)/(e-1)},getXBounds:function(){var a=this.valRange.x.max-this.valRange.x.min;if(0!=a){var a=a/(this.numGridLines.x-2),b=Math.pow(10,Math.floor(Math.log10(a)));this.stepSize.x=Math.ceil(a/b)*b;this.axisRange.x.min=
Math.floor(this.valRange.x.min/this.stepSize.x)*this.stepSize.x;this.axisRange.x.max=this.axisRange.x.min+(this.numGridLines.x-1)*this.stepSize.x}else this.axisRange.x.min=Math.floor(this.valRange.x.min),this.stepSize.x=0.2,this.axisRange.x.max=this.axisRange.x.min+this.stepSize.x*this.numGridLines.x},getYBounds:function(){var a=Math.abs(this.valRange.y.max-this.valRange.y.min);if(0!=a){var a=a/(this.numGridLines.y-2),b=Math.pow(10,Math.floor(Math.log10(a)));this.stepSize.y=Math.ceil(a/b)*b;this.axisRange.y.min=
Math.floor(this.valRange.y.min/this.stepSize.y)*this.stepSize.y;this.axisRange.y.max=this.axisRange.y.min+(this.numGridLines.y-1)*this.stepSize.y}else this.axisRange.y.min=Math.floor(this.valRange.y.min),this.stepSize.y=0.2,this.axisRange.y.max=this.axisRange.y.min+this.stepSize.y*this.numGridLines.y},drawAxisVals:function(){for(var a=0;a<this.numGridLines.x;a++){var b=this.xStart*this.dims.dx+this.gridSpacing*a,d=this.yStart*this.dims.dy+this.hashMarkLen+10+this.axisValFontSize/2,e=String(round(this.axisRange.x.min+
this.stepSize.x*a,1));draw.text(e,P(b,d),this.axisValFont,this.textCol,"center",0,this.graph)}for(a=0;a<this.numGridLines.y;a++)d=this.yStart*this.dims.dy-this.gridSpacing*a,b=this.xStart*this.dims.dx-this.hashMarkLen-10,e=String(round(this.axisRange.y.min+this.stepSize.y*a,1)),draw.text(e,P(b,d),this.axisValFont,this.textCol,"center",-Math.PI/2,this.graph)},drawLegendToggle:function(a){var b=this.legend[a];draw.fillStrokeRect(b.togglePos,b.toggleDims,this.gridCol,this.toggleCol,this.graph);this.data[a].show&&
this.legend[a].check.draw()},makeLegendEntry:function(a,b){var d=this.dims.dx-this.legendWidth+5,e=30,f;for(f in this.legend)e+=35;f={};f.text={text:a.label,x:d+10,y:e+this.legendFontSize/2};f.pt={x:d,y:e,col:a.pointCol};var h=P(this.dims.dx-18,e-5),j=V(13,13);f.togglePos=h;f.toggleDims=j;var k=this;f.toggle=function(){ptInRect(h,j,mouseOffsetDiv(k.parentDivId))&&(a.show=a.show?!1:!0,k.flashers=[],removeListener(curLevel,"update","flash"+k.handle),k.drawAllBG(),k.drawAllData())};addListener(curLevel,
"mouseup","toggle"+b,f.toggle,"");this.legend[b]=f;this.legend[b].check=this.makeCheck(b,this.legend,this.toggleCol);this.drawAllBG()},getRange:function(a){var b=Number.MAX_VALUE,d=-Number.MAX_VALUE,e;for(e in this.data)for(var f=this.data[e][a],h=0;h<f.length;h++)var j=f[h],b=Math.min(b,j),d=Math.max(d,j);return{min:b,max:d}},resetStd:function(){for(var a in this.data){a=this.data[a];for(var b in a)a[b]instanceof Array&&(a[b]=[]);a.trace&&(a.traceStartX=a.src.x.length,a.traceStartY=a.src.y.length,
a.traceLastX=a.traceStartX,a.traceLastY=a.traceStartY,a.ptDataIdxs=[])}this.flashers=[];removeListener(curLevel,"update","flash"+this.name);this.graph.putImageData(this.bg,0,0);this.resetRanges()},resetRanges:function(){this.axisRange={x:{min:Number.MAX_VALUE,max:-Number.MAX_VALUE},y:{min:Number.MAX_VALUE,max:-Number.MAX_VALUE}};this.valRange={x:{min:Number.MAX_VALUE,max:-Number.MAX_VALUE},y:{min:Number.MAX_VALUE,max:-Number.MAX_VALUE}}},makePtDataGrabFunc:function(a){return function(){return P(a.x[a.x.length-
1],a.y[a.y.length-1])}},ptsExist:function(a){for(var b=0;b<a.length;b++){var d=a[b];if(void 0===d.x||void 0===d.y||isNaN(d.x)||isNaN(d.y))return!1}return!0},makeHistDataGrabFunc:function(a){return function(b){return{address:b,data:a[a.length-1]}}},valToCoord:function(a){return P(this.gridSpacing*(this.numGridLines.x-1)*(a.x-this.axisRange.x.min)/(this.axisRange.x.max-this.axisRange.x.min)+this.xStart*this.dims.dx,this.dims.dy-(this.gridSpacing*(this.numGridLines.y-1)*(a.y-this.axisRange.y.min)/(this.axisRange.y.max-
this.axisRange.y.min)+(1-this.yStart)*this.dims.dy))},flashInit:function(a){this.flashers=[];for(var b in a){for(var d=a[b],e=this.data[b],f=0;f<d.length;f++){var h=d[f],h=P(e.x[h],e.y[h]),h=this.valToCoord(h),j=h.x,k=h.y,l=e.pointCol,m=e.flashCol,n=Col(m.r,m.g,m.b),j=P(j-this.characLen*this.flashMult-1,k-this.characLen*this.flashMult-1),q=2*this.characLen*this.flashMult+2,k=this.characLen*this.flashMult,q=this.graph.getImageData(j.x,j.y,q,q);this.flashers.push({pos:h,pointCol:l,flashCol:m,curCol:n,
curCharacLen:k,imagePos:j,imageData:q})}0<this.flashers.length&&addListener(curLevel,"update","flash"+this.handle,this.flashRun,this)}},flashRun:function(){this.eraseFlashers();for(var a=0;a<this.flashers.length;a++){var b=this.flashers[a];this.drawPt(b.pos,b.curCol,b.curCharacLen);this.flasherNextStep(b)}this.doneFlashing()&&(removeListener(curLevel,"update","flash"+this.handle),this.eraseFlashers(),this.flashers=void 0)},eraseFlashers:function(){for(var a=0;a<this.flashers.length;a++){var b=this.flashers[a];
this.graph.putImageData(b.imageData,b.imagePos.x,b.imagePos.y)}},flasherNextStep:function(a){a.curCharacLen=boundedStep(a.curCharacLen,this.characLen,-this.characLen*this.flashMult*this.flashRate);var b=a.curCol,d=Col(0,0,0);d.r=this.flashColStep(a,"r");d.g=this.flashColStep(a,"g");d.b=this.flashColStep(a,"b");b.set(d)},flashColStep:function(a,b){var d=a.pointCol[b];return boundedStep(a.curCol[b],d,(d-a.flashCol[b])*this.flashRate)},doneFlashing:function(){for(var a=new Boolean,a=!0,b=0;b<this.flashers.length;b++){var d=
this.flashers[b],e=d.curCol.r,f=d.pointCol.r,h=d.curCol.g,j=d.pointCol.g,k=d.curCol.b,l=d.pointCol.b;if(d.curCharacLen!=this.characLen||e!=f||h!=j||k!=l)a=!1}return a}};function GraphScatter(a){this.active=!0;this.handle=a.handle;this.dims=this.getDims();this.xLabel=a.xLabel;this.yLabel=a.yLabel;a=a.axesInit;this.labelFontSize=15;this.legendFontSize=12;this.axisValFontSize=11;this.labelFont=this.labelFontSize+"pt calibri";this.legendFont=this.legendFontSize+"pt calibri";this.axisValFont=this.axisValFontSize+"pt calibri";this.borderSpacing=70;this.xStart=this.borderSpacing/this.dims.dx;this.yStart=1-this.borderSpacing/this.dims.dy;this.legendWidth=80;this.xEnd=(this.dims.dx-
(this.legendWidth+8))/this.dims.dx;this.yEnd=0.05;this.gridSpacing=40;this.addPtThreshold=5;this.setNumGridLines();this.axisInit={x:{min:a.x.min,max:a.x.min+a.x.step*(this.numGridLines.x-1)},y:{min:a.y.min,max:a.y.min+a.y.step*(this.numGridLines.y-1)}};this.axisRange={x:{min:0,max:0},y:{min:0,max:0}};this.data={};this.legend={};this.resetRanges();this.stepSize={x:0,y:0};this.setStds();this.makeCanvas(this.dims);this.drawAllBG()}
_.extend(GraphScatter.prototype,AuxFunctions,GraphBase,{addSet:function(a){var b={};b.label=a.label;b.x=[];b.y=[];b.xInitDataIdx=a.data.x.length-1;b.yInitDataIdx=a.data.y.length-1;b.pointCol=a.pointCol;b.flashCol=a.flashCol;b.trace=defaultTo(!1,a.trace);b.getLast=this.makePtDataGrabFunc(a.data);b.show=!0;b.src=a.data;this.data[a.address]=b;b.trace&&(b.traceStartX=b.src.x.length,b.traceStartY=b.src.y.length,b.traceLastX=b.traceStartX,b.traceLastY=b.traceStartY);b.ptDataIdxs=[];this.makeLegendEntry(b,
a.address);this.drawAllBG()},drawAllData:function(){this.graph.putImageData(this.bg,0,0);this.drawAxisVals();this.graphPts()},drawLastData:function(a){for(var b in a)for(var d=a[b],e=this.data[b],f=0;f<d.length;f++){var h=d[f],j=e.x[h],k=e.y[h],l=e.pointCol;e.trace&&this.trace(e,h);this.graphPt(j,k,l)}},addLast:function(){var a=[],b;for(b in this.data){var d=this.data[b],e=d.getLast();e.address=b;if(e.isValid()){var f={x:d.src.x.length-1,y:d.src.y.length-1};if(0<d.x.length){var h=P(d.x[d.x.length-
1],d.y[d.y.length-1]),h=this.addPtsAtTurns(e,f,h,d.ptDataIdxs[d.ptDataIdxs.length-1],d,b),a=a.concat(h.newPts);d.ptDataIdxs=d.ptDataIdxs.concat(h.dataIdxs)}a.push(e);d.ptDataIdxs.push(f)}}this.addPts(a)},addPtsAtTurns:function(a,b,d,e,f,h){var j=b.x-e.x;if(j!=b.y-e.y)return{newPts:[],dataIdxs:[]};var k=this.valToCoord(a),l=this.valToCoord(d);b=k.x!=l.x?Math.abs(k.x-l.x)/Math.abs(a.x-d.x):1;for(var k=k.y!=l.y?Math.abs(k.y-l.y)/Math.abs(a.y-d.y):1,l=f.src,m=a.VTo(d).UV().perp(),n=j-1;0<n;n--){var j=
e.x+n,q=e.y+n,r=V(b*(l.x[j]-a.x),k*(l.y[q]-a.y)),r=Math.abs(r.dotProd(m));if(r>this.addPtThreshold){n=P(l.x[j],l.y[q]);b=this.getEdgePt({x:j,y:q},e,m,n,r,a,l,b,k);if(!b)break;a=b.dataIdx;b=b.pt;b.address=h;d=this.addPtsAtTurns(b,a,d,e,f,h);return{newPts:[b].concat(d.newPts),dataIdxs:[a].concat(d.dataIdxs)}}}return{newPts:[],dataIdxs:[]}},getEdgePt:function(a,b,d,e,f,h,j,k,l){for(a=a.x-b.x-1;0<a;a--){var m=b.x+a,n=b.y+a,q=V(k*(j.x[m]-h.x),l*(j.y[n]-h.y)),q=Math.abs(q.dotProd(d));if(q<f)return{pt:e,
dataIdx:{x:m+1,y:n+1}};e=P(j.x[m],j.y[n]);f=q}},plotData:function(a,b,d){a.length==b.length&&1<a.length?(this.data[d].x=a,this.data[d].y=b,this.valRange.x=this.getRange("x"),this.valRange.y=this.getRange("y"),this.getAxisBounds(),this.drawAllData()):a.length!=b.length&&(console.log("xVals has ",a.length,"entries"),console.log("yVals has ",b.length,"entries"),console.log("UH-OH"))},getAxisBounds:function(){this.getXBounds();this.getYBounds()},graphPts:function(){for(var a in this.data){var b=this.data[a];
if(b.show)for(var d=b.pointCol,e=0;e<b.x.length;e++)this.graphPt(b.x[e],b.y[e],d),b.trace&&this.trace(b,e)}},graphPt:function(a,b,d){a=this.valToCoord(P(a,b));this.drawPtStd(a,d)},drawPtStd:function(a,b){this.drawPt(a,b,this.characLen)},drawPt:function(a,b,d){var e=a.x,f=a.y;a=P(e-d,f);var h=P(e,f-d),j=P(e+d,f);d=P(e,f+d);draw.fillPtsStroke([a,h,j,d],b,this.ptStroke,this.graph)},reset:function(){this.resetStd()}});function GraphHist(a,b,d,e,f,h,j){this.active=!0;this.handle=a;this.dims=V(b,d);this.xLabel=e;this.yLabel=f;this.labelFontSize=15;this.axisValFontSize=11;this.labelFont=this.labelFontSize+"pt calibri";this.axisValFont=this.axisValFontSize+"pt calibri";this.borderSpacing=70;this.xStart=this.borderSpacing/b;this.yStart=1-this.borderSpacing/d;this.legendWidth=80;this.xEnd=0.95;this.yEnd=0.05;this.gridSpacing=40;this.numBins=18;this.setNumGridLines();this.axisInit={x:{min:h.x.min,max:h.x.min+h.x.step*
(this.numGridLines.x-1)},y:{min:h.y.min,max:h.y.min+h.y.step*(this.numGridLines.y-1)}};this.axisRange={x:{min:0,max:0},y:{min:0,max:0}};this.data={};this.legend={};this.resetRanges();this.stepSize={x:0,y:0};a=Col(255,100,0);this.setStds();this.makeCanvas(this.dims);this.drawAllBG();this.addSet("only",a,j)}
_.extend(GraphHist.prototype,GraphBase,{addSet:function(a,b,d){var e={x:[],y:[]};e.barCol=b;e.getLast=this.makeHistDataGrabFunc(d);this.data[a]=e;this.drawAllBG()},drawAllData:function(){this.graph.putImageData(this.bg,0,0);this.drawAxisVals();this.graphBins()},drawLastData:function(a){for(var b=0;b<a.length;b++){var d=this.data[a[b].address];d.show&&this.graphPt(d.x[d.x.length-1],d.y[d.y.length-1],d.pointCol)}},addLast:function(){var a="",b,d;for(d in this.data)a=d,b=this.data[a].getLast();this.data[a].x=
this.data[a].x.concat(b.data);this.makeBins(a)},plotData:function(a){var b="",d;for(d in this.data)b=d;this.data[b].x=a;this.makeBins(b)},getAxisBounds:function(){this.getXBounds();this.getYBounds()},makeBins:function(a){this.valRange.x=this.getRange("x");this.setAxisBoundsX();this.bins=this.makeBinBlanks(this.data[a].x);this.populateBins(this.data[a].x);this.setYAxis();this.drawAllData()},makeBinBlanks:function(){var a={};this.binWidth=round((this.valRange.x.max-this.valRange.x.min)/(this.numBins-
1),1);for(var b=0;b<this.numBins;b++)min=this.valRange.x.min+this.binWidth*b,a[String(min)]=0;return a},populateBins:function(a){for(var b=0;b<a.length;b++){var d=this.valRange.x.min;this.bins[String(Math.floor((a[b]-d)/this.binWidth)*this.binWidth+d)]++}},setYAxis:function(){var a=0,b;for(b in this.bins)a=Math.max(this.bins[b],a);this.valRange.y.min=0;this.valRange.y.max=a;this.setAxisBoundsY()},graphBins:function(){var a="",b;for(b in this.data)a=b;var a=this.data[a].barCol,d;for(d in this.bins){var e=
parseFloat(d),f=this.bins[d];b=parseFloat(d)+this.binWidth;e=this.valToCoord(P(e,f));b=this.valToCoord(P(b,0));b=e.VTo(b);draw.fillStrokeRect(e,b,a,this.bgCol,this.graph)}},clear:function(){this.clearStd()}});function GraphBlank(a){this.dims=this.getGraphDims();this.borderSpacing=70;this.xStart=this.borderSpacing/this.dims.dx;this.yStart=1-this.borderSpacing/this.dims.dy;this.legendWidth=80;this.xEnd=(this.dims.dx-(this.legendWidth+8))/this.dims.dx;this.yEnd=0.05;this.gridSpacing=40;this.setNumGridLines();this.setStds();this.handle="blank"+Math.round(1E5*Math.random());this.parentDiv=a;this.makeCanvasNoReset(this.dims,a);this.parentDiv.attr("filledWith","blank");this.drawBGBlank()}
_.extend(GraphBlank.prototype,GraphBase,{drawBGBlank:function(){this.graph.save();this.drawBGRect();this.graph.globalAlpha=0.2;this.drawGrid();this.drawBounds();this.graph.restore()}});speciesDefs={spc1:{m:3,r:2,cols:Col(200,0,0),attractRad:60,attractStr:200,attractStrs:[],idNum:0,spcName:""},spc2:{m:5,r:6,cols:Col(0,200,200),attractRad:50,attractStr:100,attractStrs:[],idNum:0,spcName:""},spc3:{m:1,r:1,cols:Col(225,0,225),attractRad:50,attractStr:0,attractStrs:[],idNum:0,spcName:""},spc4:{m:4,r:4,cols:Col(0,200,200),attractRad:50,attractStr:20,attractStrs:[],idNum:0,spcName:""},spc5:{m:8,r:6,cols:Col(255,255,0),attractRad:50,attractStr:100,attractStrs:[],idNum:0,spcName:""},spc6:{m:2,
r:2,cols:Col(111,111,253),attractRad:50,attractStr:20,attractStrs:[],idNum:0,spcName:""}};$(function(){var a=0,b;for(b in speciesDefs)speciesDefs[b].idNum=a,speciesDefs[b].spcName=b,a++});$(function(){for(var a in speciesDefs){var b=speciesDefs[a],d=b.attractStrs,e;for(e in speciesDefs){var f=speciesDefs[e];d[f.idNum]=Math.sqrt(b.attractStr*f.attractStr)}}});ReactionHandler={addReaction:function(a,b,d,e,f){b?this.addRxnPair(a,b,d,e,f):this.addRxnDecomp(a,d,e,f)},removeAllReactions:function(){this.setDefaultHandler({func:this.impactStd,obj:this})},addRxnPair:function(a,b,d,e,f){var h=this.defs[a].idNum,j=this.defs[b].idNum,k=Math.min(h,j),h=Math.max(h,j),k=k+"-"+h;this.rxns[k].push({hRxn:d,activE:e,prods:this.reformatProds(f),prodCount:this.countProds(f)});1==this.rxns[k].length?this.setHandler(a,b,{func:this.setupReactSinglePair(this.rxns[k]),obj:this}):
this.setHandler(a,b,{func:this.setupReactMultPairs(this.rxns[k]),obj:this})},reformatProds:function(a){var b=[],d;for(d in a)b.push({name:d,count:a[d]});return b},countProds:function(a){var b=0,d;for(d in a)b+=a[d];return b},addRxnDecomp:function(a,b,d,e){var f=this.doubleProds(deepCopy(e));this.addRxnPair(a,a,2*b,2*d,f);for(var h in speciesDefs)f=this.plusOne(deepCopy(e),h),this.addRxnPair(a,h,b,d,f)},doubleProds:function(a){for(var b in a)a[b]*=2;return a},plusOne:function(a,b){void 0===a[b]?a[b]=
1:a[b]++;return a},hitTemp:function(a,b,d,e){return 0.5*(Math.abs(d)*d*a.m+Math.abs(e)*e*b.m)*this.tConst},probFunc:function(a,b){var d=Math.max(a/b-1,0);return 2*(d-0.5*d*d)},setupReactSinglePair:function(a){var b=a[0].activE,d=a[0].hRxn,e=a[0].prods,f=a[0].prodCount;return function(a,j,k,l,m){var n=this.hitTemp(a,j,l,-m);return Math.random()>this.probFunc(n,b)?(this.react(a,j,d,e,f),!1):this.impactStd(a,j,k,l,m)}},setupReactMultPairs:function(a){return function(b,d,e,f,h){for(var j=this.hitTemp(b,
d,f,-h),k=Array(a.length),l=0,m=0;m<a.length;m++)k[m]=this.probFunc(j,a[m].activE),l+=k[m];if(1<l){j=1/l;for(l=0;l<k.length;l++)k[l]*=j}k=this.pickRxnIdx(k);if(!1===k)return this.impactStd(b,d,e,f,h);this.react(b,d,a[k].hRxn,a[k].prods,a[k].prodCount);return!1}},pickRxnIdx:function(a){for(var b=Math.random(),d=0,e=0;e<a.length;e++)if(d+=a[e],d>=b)return e;return!1},react:function(a,b,d,e,f){d=(a.temp()+b.temp()-d)/f;this.dotManager.remove([a,b]);f=0.5*(a.x+b.x);b=0.5*(a.y+b.y);for(var h=0;h<e.length;h++){for(var j=
e[h].name,k=Array(e[h].count),l=0;l<e[h].count;l++){var m=2*Math.random()*Math.PI,m=V(Math.sin(m),Math.cos(m));k[l]=D(f+3*m.dx,b+3*m.dy,m,this.defs[j].m,this.defs[j].r,j,this.defs[j].idNum,a.tag,a.returnTo);k[l].setTemp(d)}this.dotManager.add(k)}return!1},checkMassConserve:function(a,b,d){for(var e=a.m+b.m,f=0,h=0;h<d.length;h++)f+=spcs[d[h].spc].m*d[h].count;e!=f&&console.log("YOUR ATTENTION PLEASE: MASS IS NOT CONSERVED IN THE REACTION BETWEEN "+a.name+" AND "+b.name)}};function CollideHandler(){this.spcs=spcs;this.defs=speciesDefs;this.tConst=tConst;this.cp=cp;this.cv=cv;this.rxns={};this.setDefaultHandler({func:this.impactStd,obj:this});this.dotManager=dotManager;console.log("Made supercollider")}
_.extend(CollideHandler.prototype,ReactionHandler,toInherit.gridder,{setDefaultHandler:function(a){for(var b=this.getNumSpcs(),d=0;d<b;d++)for(var e=d;e<b;e++)this[d+"-"+e]=a,this.rxns[d+"-"+e]=[]},setHandler:function(a,b,d){a=speciesDefs[a].idNum;var e=speciesDefs[b].idNum;b=Math.min(a,e);a=Math.max(a,e);this[b+"-"+a]=d},getNumSpcs:function(){var a=0,b;for(b in speciesDefs)a++;return a},check:function(){var a=this.gridSize,b=this.xSpan,d=this.ySpan,e=this.grid=this.makeGrid(),f={},h;for(h in this.spcs)f[h]=
this.spcs[h].dots.length;for(h in this.spcs)for(var j=this.spcs[h].dots,k=f[h]-1;0<=k;k--){var l=j[k],m=Math.floor(l.x/a),n=Math.floor(l.y/a),q=!0,r=Math.max(m-1,0);a:for(;r<=Math.min(m+1,b);r++)for(var s=Math.max(n-1,0);s<=Math.min(n+1,d);s++)for(var u=e[r][s].length-1;-1<u;u--){var p=e[r][s][u],t=l.x-p.x,v=l.y-p.y;if(t*t+v*v<=(l.r+p.r)*(l.r+p.r)&&(t=this[Math.min(l.idNum,p.idNum)+"-"+Math.max(l.idNum,p.idNum)],v=V(p.x-l.x,p.y-l.y).UV(),!1===t.func.apply(t.obj,[l,p,v,l.v.dotProd(v),p.v.dotProd(v)]))){q=
!1;e[r][s].splice(u,1);break a}}0<=m&&0<=n&&m<this.numCols&&n<this.numRows?q&&e[m][n].push(l):(returnEscapist(l),console.log("ball out of bounds"))}},impactStd:function(a,b,d,e,f){var h=(e*(a.m-b.m)+2*b.m*f)/(a.m+b.m),j=(f*(b.m-a.m)+2*a.m*e)/(a.m+b.m);a.v.dx+=d.dx*(h-e);a.v.dy+=d.dy*(h-e);b.v.dx+=d.dx*(j-f);b.v.dy+=d.dy*(j-f);this.breakUp(a,b,d);return!0},breakUp:function(a,b,d){var e=a.r+b.r,f=b.y-d.dy*e,h=a.x+d.dx*e,j=a.y+d.dy*e;a.x=b.x-d.dx*e;a.y=f;b.x=h;b.y=j},setup:function(){this.gridSize=2*
this.getMaxR();this.numCols=Math.ceil(myCanvas.width/this.gridSize+1);this.numRows=Math.ceil(myCanvas.height/this.gridSize+1);this.xSpan=Math.floor(myCanvas.width/this.gridSize);this.ySpan=Math.floor(myCanvas.height/this.gridSize)},getMaxR:function(){var a=0,b;for(b in spcs)a=Math.max(a,spcs[b].r);return a}});function Attractor(){this.eDebt=0;this.k1=0.5;this.k2=0.07}
_.extend(Attractor.prototype,toInherit.gridder,{setup:function(){this.gridSize=30;this.numCols=Math.ceil(myCanvas.width/this.gridSize+1);this.numRows=Math.ceil(myCanvas.height/this.gridSize+1);this.xSpan=Math.floor(myCanvas.width/this.gridSize);this.ySpan=Math.floor(myCanvas.height/this.gridSize);this.dotManager=dotManager},attract:function(){var a=this.makeGrid(),b=this.gridSize,d=this.xSpan,e=this.ySpan,f;for(f in spcs)for(var h=spcs[f].dots,j=0;j<h.length;j++){var k=h[j];if(0<k.attractStr){k.tempLast=
k.temp();for(var l=Math.floor(k.x/b),m=Math.floor(k.y/b),n=Math.max(l-1,0);n<=Math.min(l+1,d);n++)for(var q=Math.max(m-1,0);q<=Math.min(m+1,e);q++)for(var r=a[n][q].length-1;-1<r;r-=1){var s=a[n][q][r],u=k.x-s.x,p=k.y-s.y,t=Math.sqrt(u*u+p*p),v=V(u,p);v.dx/=t;v.dy/=t;var t=Math.max(0,t-k.r-s.r)*pxToE,u=k.attractStrs[s.idNum],p=(k.attractRad+s.attractRad)/2,w=p*p*p*p*p,x=(0.97*p+t)*(0.97*p+t)*(0.97*p+t)*(0.97*p+t)*(0.97*p+t),y=-u*(5*w/(x*(0.97*p+t))-8*w*p*p*p/(x*(0.97*p+t)*(0.97*p+t)*(0.97*p+t)*(0.97*
p+t))),z=v.copy().mult(y/k.m),v=v.mult(-y/s.m);k.v.add(z);s.v.add(v);t=-u*(w*p*p*p/(x*(0.97*p+t)*(0.97*p+t)*(0.97*p+t))-w/x);k.peCur+=t;s.peCur+=t}a[l][m].push(k)}}this.adjustE()},adjustE:function(){for(var a in spcs)for(var b=spcs[a].dots,d=0;d<b.length;d++){var e=b[d];if(0<e.attractStr){var f=e.tempLast+e.peCur-e.peLast;0>f&&(this.eDebt+=10-f,f=10);e.setTemp(f);e.peLast=e.peCur;e.peCur=0}}0<this.eDebt&&this.exactDebt()},exactDebt:function(){var a=0.3*dataHandler.avgTemp(),b;for(b in spcs)for(var d=
spcs[b].dots,e=0;e<d.length;e++){var f=d[e],h=f.temp();if(h>a){var j=Math.min(Math.min(h-a,5),this.eDebt);this.eDebt-=j;f.setTemp(h-j);if(0>=this.eDebt)return}}},zeroAllEnergies:function(){for(var a in spcs)for(var b=spcs[a].dots,d=0;d<b.length;d++)b[d].peLast=0,b[d].keLast=0,b[d].tempLast=0},assignELastAll:function(){var a=this.makeGrid(),b=this.gridSize,d=this.xSpan,e=this.ySpan,f;for(f in spcs)for(var h=spcs[f].dots,j=0;j<h.length;j++){var k=h[j];if(0<k.attrStr){k.tempLast=k.temp();for(var l=Math.floor(k.x/
b),m=Math.floor(k.y/b),n=Math.max(l-1,0);n<=Math.min(l+1,d);n++)for(var q=Math.max(m-1,0);q<=Math.min(m+1,e);q++)for(var r=a[n][q].length-1;-1<r;r-=1){var s=a[n][q][r],u=pxToE*V(k.x-s.x,k.y-s.y).mag(),u=Math.max(0,u-k.r-s.r)*pxToE,p=(k.attractRad+s.attractRad)/2,t=p*p*p*p*p,v=(0.97*p+u)*(0.97*p+u)*(0.97*p+u)*(0.97*p+u)*(0.97*p+u),u=-k.attractStrs[s.idNum]*(t*p*p*p/(v*(0.97*p+u)*(0.97*p+u)*(0.97*p+u))-t/v);k.peLast+=u;s.peLast+=u}a[l][m].push(k)}}}});function DataHandler(){this.tConst=tConst}
DataHandler.prototype={temp:function(a){return this.KEAvg(a)*this.tConst},tempFunc:function(a){var b=this;return function(){return b.KEAvg(a)*b.tConst}},avgTemp:function(){for(var a=0,b=0;b<walls.length;b++)a+=walls[b].data.t[walls[b].data.t.length-1];return a/walls.length},countFunc:function(a){var b=this;return function(){return b.count(a)}},count:function(a){return dotManager.get(a).length},RMS:function(a){var b=0;a=dotManager.get(a);for(var d=0;d<a.length;d++)b+=a[d].v.magSqr();return pxToMS*
Math.sqrt(b/a.length)},velocities:function(a){a=dotManager.get(a);for(var b=Array(a.length),d=0;d<a.length;d++)b[d]=a[d].v.mag();return b},velocityAvg:function(a){vList=this.velocities(a);for(var b=a=0;b<vList.length;b++)a+=vList[b];return a/vList.length},KEAvg:function(a){var b=0;a=dotManager.get(a);for(var d=0;d<a.length;d++)b+=a[d].KE();return b/a.length},volume:function(a){return void 0===a?walls.totalVolume():walls.wallVolume(a)},volumeFunc:function(a){var b=this;return function(){return b.volume(a)}}};function WallHandler(a){var b=a?Array(a.pts.length):[];_.extend(b,WallMethods.main,WallMethods.collideMethods);addListener(curLevel,"sectionCleanUp","walls",b.remove,b);b.cVIsothermal32=b.cVIsothermal;a&&(b.assemble(a),a.handles.length!=a.pts.length&&console.log("NAME YOUR WALLS"),a.handlers&&b.doInitHandlers(a.handlers));b.setup();return b}
WallMethods={main:{assemble:function(a){this.removed=!1;var b=a.pts,d=a.handles;this.numWalls=b.length;this.qArrowFill=Col(200,0,0);this.qArrowFillFinal=Col(100,0,0);this.qArrowStroke=Col(255,255,255);var e=defaultTo([],a.includes),f=defaultTo([],a.bounds),h=defaultTo([],a.vols),j=defaultTo([],a.shows),k=defaultTo([],a.records);a=defaultTo([],a.temps);for(var l=0;l<b.length;l++)this.setWallVals(l,b[l],d[l],f[l],e[l],h[l],j[l],k[l],a[l])},setDefaultReadout:function(a){this.defaultReadout=a;return this},
unsetDefaultReadout:function(){this.defaultReadout=void 0;return this},setBounds:function(a,b){var d=this[this.idxByInfo(a)].bounds,e;for(e in b)d[e]=b[e];return this},setup:function(){this.gridDim=20;this.xSpan=Math.floor(myCanvas.width/this.gridDim);this.ySpan=Math.floor(myCanvas.height/this.gridDim);this.numCols=Math.ceil(myCanvas.width/this.gridDim);this.numRows=Math.ceil(myCanvas.height/this.gridDim);for(var a=0;a<this.length;a++)this.setupWall(a)},doInitHandlers:function(a){if(a instanceof Array)for(var b=
0;b<a.length;b++)if(a[b]instanceof Array)for(var d=a[b],e=0;e<d.length;e++)this.setSubWallHandler(b,e,d[e]);else"string"==typeof a[b]&&this.setWallHandler(b,a[b]);else"string"==typeof a||"object"==typeof a?this.setAllHandler(a):console.log("YOU SEND POOR WALL HANDLERS.  THEY ARE NEITHER STRING NOR ARRAY NOR OBJECT")},setAllHandler:function(a){for(var b=0;b<this.length;b++)this.setWallHandler(b,a)},setWallHandler:function(a,b){for(var d=this.idxByInfo(a),e=0;e<this[d].length;e++)this.setSubWallHandler(d,
e,b)},setSubWallHandler:function(a,b,d){a=this.idxByInfo(a);"string"==typeof d?(this[a+"-"+b]={obj:this,func:this[d]},-1!=d.toLowerCase().indexOf("isothermal")?this[a].isothermalInit():this[a][b].isothermal=!1):"object"==typeof d&&(this[a+"-"+b]=d,d.isothermal?this[a].isothermalInit():this[a][b].isothermal=!1)},getSubWallHandler:function(a,b){return this[this.idxByInfo(a)+"-"+b]},setupWall:function(a){this[a].wallUVs=this.getWallUV(a);this[a].wallPerpUVs=this.getPerpUVs(a);this[a].wallGrids=this.scatterPts(a)},
scatterPts:function(a){var b=this.makeBlankGrid(),d=this[a];d.scatter=Array(d.length-1);var e=d.wallUVs,f=this.gridDim;for(a=0;a<d.scatter.length;a++)for(var h=e[a],j=d[a].distTo(d[a+1]),j=Math.ceil(j/f),k=d[a],l=0;l<j;l++){var m=Math.floor((k.x+h.dx*f*l)/f),n=Math.floor((k.y+h.dy*f*l)/f);(-1!=m||-1!=n)&&b[m][n].push(a)}return b},makeBlankGrid:function(){for(var a=Array(this.numCols+1),b=0;b<this.numCols+1;b++){for(var d=Array(this.numRows+1),e=0;e<this.numRows+1;e++)d[e]=[];a[b]=d}return a},setWallVals:function(a,
b,d,e,f,h,j,k,l){e=defaultTo({yMin:30,yMax:435},e);f=defaultTo(1,f);this[a]=b;_.extend(this[a],WallMethods.wall);this[a].handle=d;this[a].include=f;this[a].hitMode="Std";this[a].v=0;this[a].bounds=e;h&&this[a].setVol(h);this[a].show=defaultTo(!0,j);this.closeWall(this[a]);this[a].ptsInit=this.copyWallPts(this[a]);this[a].g=g;this[a].pConst=pConst;this[a].data={};this[a].data.pInt=[];this[a].data.pExt=[];this[a].data.t=[];this[a].data.RMS=[];this[a].data.v=[];this[a].data.m=[];this[a].data.work=[];
this[a].data.q=[];this[a].recordingTemp={val:!1};this[a].recordingPInt={val:!1};this[a].recordingPExt={val:!1};this[a].recordingVol={val:!1};this[a].recordingWork={val:!1};this[a].recordingMass={val:!1};this[a].recordingQ={val:!1};this[a].recordingRMS={val:!1};this[a].displayingTemp={val:!1};this[a].displayingPInt={val:!1};this[a].displayingPExt={val:!1};this[a].displayingVol={val:!1};this[a].displayingWork={val:!1};this[a].displayingMass={val:!1};this[a].displayingQ={val:!1};this[a].displayingRMS=
{val:!1};this[a].q=0;this[a].pIntLen=35;this[a].eToAdd=0;this[a].isothermal=!1;this[a].tSet=l;this[a].massChunks={};this[a].forceInternal=0;this[a].pLastRecord=turn;this[a].mass=0;this[a].parent=this;this[d]=this[a];(k=defaultTo(!0,k))&&this[a].recordDefaults()},addWall:function(a){this.numWalls++;var b=this.length;this.setWallVals(b,a.pts,a.handle,a.bounds,a.include,a.vol,a.show,a.record,a.temp);this.setupWall(b);this.setWallHandler(b,a.handler)},setPtsInit:function(){for(var a=0;a<this.length;a++)this[a].ptsInit=
this.copyWallPts(this[a])},copyWallPts:function(a){for(var b=a.length,d=Array(b),e=0;e<b;e++)d[e]=a[e].copy();return d},idxByHandle:function(a){for(var b=0;b<this.length;b++)if(a==this[b].handle)return b;console.log("Failed to get wall idx by handle\nHandle:"+a)},idxByInfo:function(a){return parseFloat(a)!=a?this.idxByHandle(a):a},remove:function(){for(var a=this.length-1;0<=a;a-=1)this.removeWall(a);this.removed=!0;emptyListener(curLevel,"wallMove")},removeWall:function(a){this.numWalls-=1;this[a].recordAllStop();
this[a].displayAllStop();this[a].bordered&&this[a].removeBorder();a=this.idxByInfo(a);this[this[a].handle]=void 0;this.splice(a,1);this.removeHandlers(a)},removeHandlers:function(a){for(var b in this)-1!=b.indexOf(a+"-")&&(this[b]=void 0)},closeWall:function(a){a.push(P(a[0].x,a[0].y))},getPerpUVs:function(a){a=this[a].wallUVs;for(var b=Array(a.length),d=0;d<a.length;d++){var e=a[d];b[d]=V(-e.dy,e.dx)}return b},getWallUV:function(a){for(var b=this[a].length-1,d=Array(b),e=0;e<b;e++){var f=this[a][e],
h=this[a][e+1];d[e]=V(h.x-f.x,h.y-f.y).UV()}return d},check:function(){var a=this.gridDim,b=this.xSpan,d=this.ySpan,e=spcs,f;for(f in e)for(var h=e[f].dots,j=0;j<h.length;j++)for(var k=h[j],l=[],m=Math.floor(k.x/a),n=Math.floor(k.y/a),q=Math.max(m-1,0);q<=Math.min(m+1,b);q++)for(var r=Math.max(n-1,0);r<=Math.min(n+1,d);r++)for(var s=0;s<this.length;s++)for(var u=this[s].wallGrids[q][r],p=0;p<u.length;p++){var t=u[p];!1===this.haveChecked([s,t],l)&&(this.checkWallHit(k,[s,t]),l.push([s,t]))}},checkWallHit:function(a,
b){var d=b[0],e=b[1],f=this[d][e],h=this[d].wallUVs[e],j=this[d].wallPerpUVs[e],f=V(a.x+a.v.dx-j.dx*a.r-f.x,a.y+a.v.dy-j.dy*a.r-f.y),f=j.dotProd(f),k=-j.dotProd(a.v),l=this[b[0]].hitMode;if(0>f&&-30<f&&this.isBetween(a,d,e,h))this["didHit"+l](a,d,e,h,k,j)},isBetween:function(a,b,d,e){var f=a.v.dotProd(e),h=f*e.dx,j=f*e.dy,f=P(walls[b][d].x+h,walls[b][d].y+j);d=P(walls[b][d+1].x+h,walls[b][d+1].y+j);b=V(-e.dx,-e.dy);f=V(a.x-f.x,a.y-f.y);a=V(a.x-d.x,a.y-d.y);return 0<=f.dotProd(e)&&0<=a.dotProd(b)},
didHitStd:function(a,b,d,e,f,h){var j=this[b+"-"+d];j.func.apply(j.obj,[a,b,d,e,f,h])},didHitArrow:function(a,b,d,e,f,h){var j=a.v.copy(),k=this[b+"-"+d];k.func.apply(k.obj,[a,b,d,e,f,h]);b=P(a.x,a.y);d=a.v.copy();a=-h.dotProd(a.v);this.drawArrowV(b,j,d,f,a)},didHitArrowSpd:function(a,b,d,e,f,h){var j=a.v.copy(),k=this[b+"-"+d];k.func.apply(k.obj,[a,b,d,e,f,h]);b=P(a.x,a.y);d=a.v.copy();a=-h.dotProd(a.v);this.drawArrowSpd(b,j,d,f,a)},didHitGravity:function(a,b,d,e,f,h){var j=this[b+"-"+d];if(0!=e.dx)var k=
a.y,l=a.v.dy;j.func.apply(j.obj,[a,b,d,e,f,h]);0!=e.dx&&(b=a.v.dy*a.v.dy+2*gInternal*(a.y-k),0<=b?a.v.dy=0<a.v.dy?Math.sqrt(b):-Math.sqrt(b):(a.v.dy=-1E-7,a.y=(a.v.dy*a.v.dy-l*l)/(2*gInternal)+k))},haveChecked:function(a,b){for(var d=0;d<b.length;d++)if(b[d][0]==a[0]&&b[d][1]==a[1])return!0;return!1},totalVolume:function(){for(var a=0,b=0;b<this.length;b++)a+=this[b].include*this.wallArea(b);return a*vConst},wallVolume:function(a){return this.area(this[a].slice(0,this[a].length-1))*vConst},area:function(a){var b=
0,d=this.isConvex(a),e=d.multiplier;if(d.isConvex)return this.areaConvex(a);a=this.splitConcave(a,e);b+=this.area(a[0]);return b+=this.area(a[1])},isConvex:function(a){for(var b=this.getMult(a),d=1;d<a.length-1;d++){var e=this.abcs(a,d),e=this.angleBetweenPts(e.a,e.b,e.c,b);if(e>Math.PI)return{isConvex:!1,multiplier:b}}this.angleBetweenPts(a[a.length-2],a[a.length-1],a[0],b);e=this.angleBetweenPts(a[a.length-1],a[0],a[1],b);return e>Math.PI?{isConvex:!1,multiplier:b}:{isConvex:!0,multiplier:b}},getMult:function(a){var b=
Math.PI*(a.length-2),d=this.getAreaUVs(a),e=this.getIntAngles(a,d,1);a=this.getIntAngles(a,d,-1);if(round(e,2)==round(b,2))return 1;if(round(a,2)==round(b,2))return-1},getAreaUVs:function(a){for(var b=Array(a.length),d=0;d<a.length-1;d++){var e=a[d],f=a[d+1];b[d]=e.VTo(f).UV()}e=a[a.length-1];f=a[0];b[b.length]=e.VTo(f).UV();return b},getIntAngles:function(a,b,d){b=0;for(var e=1;e<a.length-1;e++)b+=this.angleBetweenPts(a[e-1],a[e],a[e+1],d);b+=this.angleBetweenPts(a[a.length-2],a[a.length-1],a[0],
d);return b+=this.angleBetweenPts(a[a.length-1],a[0],a[1],d)},splitConcave:function(a,b){for(var d=Array(a.length+2),e=0;e<a.length;e++)d[e]=a[e];d[d.length-2]=a[0];d[d.length-1]=a[1];for(e=1;e<d.length-1;e++){var f=this.abcs(d,e);if(this.angleBetweenPts(f.a,f.b,f.c,b)>Math.PI)return e==a.length&&(e=0),this.splitAt(d.slice(0,d.length-2),e,b)}},splitAt:function(a,b){a=a.slice(b,a.length).concat(a.slice(0,b));var d=a[0];for(b=2;b<a.length-1;b++)if(!this.crossesWall(d,a[b],a)){var d=a.slice(0,b+1),e=
a.slice(0,1).concat(a.slice(b,a.length));return[d,e]}},abcs:function(a,b){return{a:a[b-1],b:a[b],c:a[b+1]}},crossesWall:function(a,b,d){a.VTo(b);for(var e=1;e<d.length;e++){var f,h;e==d.length-1?(f=d[e],h=d[0]):(f=d[e],h=d[e+1]);if(this.linesCross({p1:a,p2:b},{p1:f,p2:h}))return!0}return!1},linesCross:function(a,b){var d=a.p1.VTo(a.p2),e=b.p1.VTo(b.p2),f=d.mag(),h=e.mag(),d=d.UV(),j=e.UV(),e=this.getDist(a,b,d,j,"p1"),d=this.getDist(a,b,d.neg(),j.neg(),"p2");e.da=round(e.da,5);e.db=round(e.db,5);
d.da=round(d.da,5);d.db=round(d.db,5);f=round(f,5);h=round(h,5);return e.da>=f||e.db>=h||d.da>=f||d.db>=h?!1:!0},getDist:function(a,b,d,e,f){"p1"==f?(a=a.p1,b=b.p1):(a=a.p2,b=b.p2);if(0==d.dx&&0==e.dx)return{da:Infinity,db:Infinity};if(0==d.dx)return f=a.x-b.x,f=Math.abs(f/e.dx),d=b.copy().movePt(e.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==e.dx)return f=b.x-a.x,f=Math.abs(f/d.dx),d=a.copy().movePt(d.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==d.dy&&0==e.dy)return{da:Infinity,
db:Infinity};if(0==d.dy)return f=a.y-b.y,f=Math.abs(f/e.dy),d=b.copy().movePt(e.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==e.dy)return f=b.y-a.y,f=Math.abs(f/d.dy),d=a.copy().movePt(d.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};f=e.dx*d.dy/d.dx-e.dy;if(0==f)return{da:Infinity,db:Infinity};f=(b.y-a.y-d.dy*b.x/d.dx+a.x*d.dy/d.dx)/f;return{da:(b.x+e.dx*f-a.x)/d.dx,db:f}},angleBetweenPts:function(a,b,d,e){var f=a.VTo(b).UV();a=f.copy().neg();b=b.VTo(d).UV();e=f.copy().add(b).rotate(Math.PI/
2*e);a=Math.atan2(a.dy,a.dx);b=Math.atan2(b.dy,b.dx);e=Math.atan2(e.dy,e.dx);return this.distBetweenAngles(a,e)+this.distBetweenAngles(e,b)},distBetweenAngles:function(a,b){0>a&&(a+=2*Math.PI);0>b&&(b+=2*Math.PI);var d=Math.max(a,b),e=Math.min(a,b),d=d-e;return d>Math.PI?2*Math.PI-d:d},areaConvex:function(a){for(var b=0,d=a[0],e=2;e<a.length;e++)b+=d.area(a[e-1],a[e]);return b},drawArrowV:function(a,b,d,e,f){var h=Array(3);h[0]=a.copy().movePt(b.copy().mult(10).neg());h[1]=a.copy();h[2]=a.copy().movePt(d.copy().mult(10));
b="drawArrow"+round(a.x,0)+round(a.y,0);new ArrowLine(b,h,Col(255,0,0),50,c);a=a.copy().movePt(d.mult(15));e=(Math.abs(e)+Math.abs(f))*pxToMS;animText.newAnim({pos:a},{pos:a.copy().movePt({dy:-20}),col:curLevel.bgCol},{text:"deltaV = "+round(e,1)+"m/s",time:3E3})},drawArrowSpd:function(a,b,d){var e=Array(3);e[0]=a.copy().movePt(b.copy().mult(10).neg());e[1]=a.copy();e[2]=a.copy().movePt(d.copy().mult(10));b="drawArrow"+round(a.x,0)+round(a.y,0);new ArrowLine(b,e,Col(255,0,0),50,c);a=a.copy().movePt(d.mult(15));
d=0.1*d.mag()*pxToMS;animText.newAnim({pos:a},{pos:a.copy().movePt({dy:-20}),col:curLevel.bgCol},{text:"Speed = "+round(d,1)+"m/s",time:3E3})}},wall:{reset:function(){for(var a=this.ptsInit,b=0;b<a.length;b++)this[b].x=a[b].x,this[b].y=a[b].y;this.v=this.forceInternal=0;this.parent.setupWall(this.parent.indexOf(this))},setVol:function(a){a=this.volToY(a);this[0].position({y:a});this[1].position({y:a})},volToY:function(a){var b=this[2].distTo(this[3]);a/=vConst*b;this[2].VTo(this[3]).UV().perp("cw");
return this[2].y-a},changeSetPt:function(a,b,d){if(-1!=b.indexOf("isothermal"))var e="cVIsothermal";else-1!=b.indexOf("adiabatic")&&(e="cVAdiabatic");removeListener(curLevel,"wallMove","cV"+this.handle);var f=function(a){this[0].y=a;this[1].y=a;this[this.length-1].y=a};b=a-this[0].y;0!=b&&(b=getSign(b),this.v=d*b,this.parent.setSubWallHandler(this.handle,0,e+compAdj),addListener(curLevel,"wallMove","cV"+this.handle,function(){var b=this[0].y;f.apply(this,[boundedStep(b,a,this.v)]);this.parent.setupWall(this.handle);
round(b,2)==round(a,2)&&(removeListener(curLevel,"wallMove","cV"+this.handle),this.parent.setSubWallHandler(this.handle,0,"staticAdiabatic"),this.v=0)},this))},releaseWithBounds:function(a,b,d,e){this.moveStop();removeListener(curLevel,"wallMove","releaseWithBounds"+this.handle);removeListener(curLevel,"wallMove","cP"+this.handle);this.parent.setSubWallHandler(this.handle,0,d);a=defaultTo(0,a);b=defaultTo(Number.MAX_VALUE,b);var f=g,h=this.bounds;addListener(curLevel,"wallMove","releaseWithBounds"+
this.handle,function(){var d=this[0].y,k=d+this.v+0.5*f;k<a||k>b?(this.moveStop(),this.parent.setSubWallHandler(this.handle,0,"staticAdiabatic"),k<a?(e(a),d=a):(e(b),d=b)):k>h.yMax||k<h.yMin?d=this.hitBounds(d,f,h.yMin,h.yMax):(d=k,this.v+=f);this[0].y=d;this[1].y=d;this[this.length-1].y=d;this.parent.setupWall(this.handle)},this)},moveInit:function(){var a=g,b=this.bounds;addListener(curLevel,"wallMove","cP"+this.handle,function(){var d=this[0].y,e=d+this.v+0.5*a;e>b.yMax||e<b.yMin?d=this.hitBounds(d,
a,b.yMin,b.yMax):(d=e,this.v+=a);this[0].y=d;this[1].y=d;this[this.length-1].y=d;this.parent.setupWall(this.handle)},this)},moveStop:function(){this.v=0;removeListener(curLevel,"wallMove","cP"+this.handle);removeListener(curLevel,"wallMove","releaseWithBounds"+this.handle)},hitBounds:function(a,b,d,e){var f=1,h=Math.max(d,Math.min(e,a+this.v*f+0.5*b*f*f));a=this.v*this.v+2*b*(h-a);if(h==e)var j=(-this.v+Math.sqrt(a))/b;else h==d&&(j=(-this.v-Math.sqrt(a))/b);this.v+=b*j;this.v*=-1;f-=j;-2*this.v<
f*b&&0>this.v&&(d=Math.abs(2*this.v/b),f-=Math.floor(f/d)*d);h=h+this.v*f+0.5*b*f*f;this.v+=b*f;return h},setHitMode:function(a){this.hitMode=a},setDefaultReadout:function(a){this.defaultReadout=a;return this},unsetDefaultReadout:function(){this.defaultReadout=void 0;return this},setTemp:function(a){this.tSet=a},isothermalInit:function(){this.eToAdd=0;var a=1<this.parent.numWalls?dataHandler.countFunc({tag:this.handle}):dataHandler.countFunc();this.isothermal||addListener(curLevel,"data","recordEnergyForIsothermal"+
this.handle,function(){var b=defaultTo(this.tSet,this.data.t[this.data.t.length-1]),b=this.tSet-b;this.eToAdd=cv*a()*b/N},this);for(var b=0;b<this.length;b++)this[b].isothermal=!0;this.isothermal=!0},isothermalStop:function(){this.isothermal=!1;removeListener(curLevel,"data","recordEnergyForIsothermal"+this.handle)},pExt:function(){return this.pConst*this.mass*this.g/(this[1].x-this[0].x)},pInt:function(){var a=this.surfArea(),a=this.pConst*this.forceInternal/((turn-this.pLastRecord)*a);this.forceInternal=
0;this.pLastRecord=turn;this.pIntList[this.pIntIdx]=a;this.pIntIdx++;this.pIntIdx==this.pIntLen&&(this.pIntIdx=0);return this.pIntList.average()},surfArea:function(){var a=0;for(ptIdx=0;ptIdx<this.length-1;ptIdx++)a+=this[ptIdx].distTo(this[ptIdx+1]);return a},updateMass:function(){var a=0,b;for(b in this.massChunks)a+=this.massChunks[b];this.mass=a},setMass:function(a,b){this.massChunks[a]=b;this.updateMass();return this},unsetMass:function(a){if(a)this.massChunks[a]=void 0;else for(a in this.massChunks)this.massChunks[a]=
void 0;this.updateMass();return this},border:function(a,b,d,e){this.bordered=!0;for(var f=c,h=Array(a.length),j=Array(a.length-1),k=[],l=this.wallPerpUVs,m=0;m<a.length;m++)h[m]=this[a[m]].copy();for(m=0;m<a.length-1;m++)j[m]=l[a[m]].copy().neg();for(a=0;a<h.length;a++)l=h[a],l.movePt(e[a]),l.position(e[a]),k.push(l);e=j[j.length-1].copy().mult(b);k.push(h[h.length-1].copy().movePt(e));for(a=h.length-2;0<a;a-=1)e=[j[a],j[a-1]],l=h[a],k.push(this.spacedPt(l,e,b));b=j[0].mult(b);k.push(h[0].copy().movePt(b));
k.push(h[0]);addListener(curLevel,"update","drawBorder"+this.handle,function(){draw.fillPts(k,d,f)},"")},spacedPt:function(a,b,d){b=b[0].add(b[1]);return a.copy().movePt(b.mult(d))},removeBorder:function(){this.bordered=!1;removeListener(curLevel,"update","drawBorder"+this.handle)},recordDefaults:function(){this.recordTemp();this.recordPInt();this.recordVol();this.recordQ()},recordTemp:function(){this.recordingTemp.val=!0;var a=dataHandler.tempFunc({tag:this.handle});recordData("t"+this.handle,this.data.t,
a,this,"update");return this},recordRMS:function(){if(this.recordingTemp.val){this.recordingRMS.val=!0;var a=this.getRMSMass(1<this.parent.numWalls?this.handle:void 0);recordData("RMS"+this.handle,this.data.RMS,function(){return Math.sqrt(3E3*KB*this.data.t[this.data.t.length-1]*ACTUALN/a)},this,"update")}else console.log("Tried to record RMS of wall "+this.handle+" while not recording temp.  Will not record.");return this},getRMSMass:function(a){if(a)for(var b in spcs)for(var d=spcs[b].dots,e=0;e<
d.length;e++)if(a){if(d[e].tag==a)return d[e].m}else return d[e].m},recordPInt:function(){this.recordingPInt.val=!0;this.pIntList=[];this.pIntIdx=0;recordData("pInt"+this.handle,this.data.pInt,this.pInt,this,"update");return this},recordPExt:function(){this.recordingPExt.val=!0;recordData("pExt"+this.handle,this.data.pExt,this.pExt,this,"update");return this},recordVol:function(){this.recordingVol.val=!0;recordData("v"+this.handle,this.data.v,function(){return this.parent.wallVolume(this.handle)},
this,"update");return this},recordWork:function(){if(!this.recordingWork.val){this.recordingWork.val=!0;this.work=0;var a=LtoM3,b=PUNITTOPA,d=JtoKJ,e=this;recordData("work"+this.handle,this.data.work,function(){var f=e.data.v.length,f=a*(e.data.v[f-1]-e.data.v[f-2]);if(void 0!=f){var h=e.pExt()*b;e.work-=d*h*f;return e.work}return e.work=0},this,"update")}return this},recordMass:function(){this.recordingMass.val||(this.recordingMass.val=!0,recordData("mass"+this.handle,this.data.m,function(){return this.mass},
this,"update"));return this},recordQ:function(){this.recordingQ.val||(this.recordingQ.val=!0,recordData("q"+this.handle,this.data.q,function(){return this.q},this,"update"));return this},recordStop:function(a,b){a.val=!1;recordDataStop(b+this.handle)},recordAllStop:function(){this.recordingTemp.val&&this.recordStop(this.recordingTemp,"t");this.recordingPInt.val&&this.recordStop(this.recordingPInt,"pInt");this.recordingPExt.val&&this.recordStop(this.recordingPExt,"pExt");this.recordingVol.val&&this.recordStop(this.recordingVol,
"v");this.recordingWork.val&&this.recordStop(this.recordingWork,"work");this.recordingMass.val&&this.recordStop(this.recordingMass,"mass");this.recordingQ.val&&this.recordStop(this.recordingQ,"q");this.recordingRMS.val&&this.recordStop(this.recordingRMS,"RMS");return this},resetWork:function(){this.work=0;return this},resetQ:function(){this.q=0;return this},displayWork:function(a,b,d){if(this.recordingWork.val&&!this.displayingWork.val){this.displayingWork.val=!0;d=defaultTo(1,d);var e=this.data.work;
b=defaultTo("Work:",b);this.workReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.workReadout.addEntry("work"+this.handle,b,"kJ",a,void 0,d);addListener(curLevel,"update","displayWork"+this.handle,function(){this.workReadout.hardUpdate("work"+this.handle,e[e.length-1])},this);this.addCleanUpIfPrompt("displayWork",this.displayWorkStop)}else console.log("Tried to display work of wall "+this.handle+" while not recording.  Will not display.");return this},
displayTemp:function(a,b,d,e){if(this.recordingTemp.val&&!this.displayingTemp.val){this.displayingTemp.val=!0;d=defaultTo(0,d);var f=this.data.t;b=defaultTo("Temp:",b);this.tempReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=f[f.length-1];validNumber(a)||(a=0);this.tempReadout.addEntry("temp"+this.handle,b,"K",a,void 0,d);e?addListener(curLevel,"update","displayTemp"+this.handle,function(){for(var a=0,b=f.length-5;b<f.length;b++)a+=f[b];this.tempReadout.hardUpdate("temp"+this.handle,0.2*
a)},this):addListener(curLevel,"update","displayTemp"+this.handle,function(){this.tempReadout.hardUpdate("temp"+this.handle,f[f.length-1])},this);this.addCleanUpIfPrompt("displayTemp",this.displayTempStop)}else console.log("Tried to display temp of wall "+this.handle+" while not recording.  Will not display.");return this},displayTempSmooth:function(a,b,d){return this.displayTemp(a,b,d,!0)},displayPInt:function(a,b,d){if(this.recordingPInt.val&&!this.displayingPInt.val){this.displayingPInt.val=!0;
d=defaultTo(1,d);var e=this.data.pInt;b=defaultTo("Pint:",b);this.pIntReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.pIntReadout.addEntry("pInt"+this.handle,b,"bar",a,void 0,d);addListener(curLevel,"update","displayPInt"+this.handle,function(){this.pIntReadout.hardUpdate("pInt"+this.handle,e[e.length-1])},this);this.addCleanUpIfPrompt("displayPInt",this.displayPIntStop)}else console.log("Tried to display pInt of wall "+this.handle+" while not recording.  Will not display.");
return this},displayPExt:function(a,b,d){if(this.recordingPExt.val&&!this.displayingPExt.val){this.displayingPExt.val=!0;d=defaultTo(1,d);var e=this.data.pExt;b=defaultTo("Pext:",b);this.pExtReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.pExtReadout.addEntry("pExt"+this.handle,b,"bar",a,void 0,d);var f=0;addListener(curLevel,"update","displayPExt"+this.handle,function(){var a=e[e.length-1];a!=f&&(this.pExtReadout.tick("pExt"+this.handle,a),f=a)},
this);this.addCleanUpIfPrompt("displayPExt",this.displayPExtStop)}else console.log("Tried to display pExt of wall "+this.handle+" while not recording.  Will not display.");return this},displayVol:function(a,b,d){if(this.recordingVol.val&&!this.displayingVol.val){this.displayingVol.val=!0;d=defaultTo(1,d);var e=this.data.v;b=defaultTo("Volume:",b);this.volReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.volReadout.addEntry("vol"+this.handle,b,"L",
a,void 0,d);addListener(curLevel,"update","displayVolume"+this.handle,function(){this.volReadout.hardUpdate("vol"+this.handle,e[e.length-1])},this);this.addCleanUpIfPrompt("displayVol",this.displayVolStop)}else console.log("Tried to display volume of wall "+this.handle+" while not recording.  Will not display.");return this},displayMass:function(a,b,d){if(this.recordingMass.val&&!this.displayingMass.val){this.displayingMass.val=!0;d=defaultTo(0,d);var e=this.data.m;b=defaultTo("Mass:",b);this.massReadout=
defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.massReadout.addEntry("mass"+this.handle,b,"kg",a,void 0,d);var f=0;addListener(curLevel,"update","displayMass"+this.handle,function(){var a=e[e.length-1];a!=f&&(this.massReadout.hardUpdate("mass"+this.handle,a),f=a)},this);this.addCleanUpIfPrompt("displayMass",this.displayMassStop)}else console.log("Tried to display mass of wall "+this.handle+" while not recording.  Will not display.");return this},displayQ:function(a,
b,d){if(this.recordingQ.val&&!this.displayingQ.val){this.displayingQ.val=!0;d=defaultTo(1,d);var e=this.data.q;b=defaultTo("Q:",b);this.qReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.qReadout.addEntry("q"+this.handle,b,"kJ",a,void 0,d);var f=0;addListener(curLevel,"update","displayQ"+this.handle,function(){var a=e[e.length-1];a!=f&&(this.qReadout.hardUpdate("q"+this.handle,a),f=a)},this);this.addCleanUpIfPrompt("displayQ",this.displayQStop)}else console.log("Tried to display q of wall "+
this.handle+" while not recording.  Will not display.");return this},displayRMS:function(a,b,d){if(this.recordingRMS.val&&!this.displayingRMS.val){this.displayingRMS.val=!0;d=defaultTo(0,d);var e=this.data.RMS;b=defaultTo("RMS:",b);this.RMSReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.RMSReadout.addEntry("RMS"+this.handle,b,"m/s",a,void 0,d);addListener(curLevel,"data","displayRMS"+this.handle,function(){this.RMSReadout.tick("RMS"+this.handle,
e[e.length-1])},this);this.addCleanUpIfPrompt("displayRMS",this.displayRMSStop)}else console.log("Tried to display RMS of wall "+this.handle+" while not recording.  Will not display.");return this},displayQArrowsRate:function(a){this.recordingQ.val&&!this.displayingQArrowsRate.val&&!this.displayingQArrowsAmmt.val?(this.displayingQArrowsRate.val=!0,this.idxLastArrow=Math.max(0,this.data.q.length-1),this.qArrowThreshold=defaultTo(a,0.3),addListener(curLevel,"update","checkForDisplayArrows"+this.handle,
this.checkDisplayArrows,this)):(console.log("Tried to display q arrowsRate for wall "+this.handle+" while not recording or already displaying.  Will not display."),console.trace())},displayQArrowsAmmt:function(a){this.recordingQ.val&&!this.displayingQArrowsRate.val&&!this.displayingQArrowsAmmt.val?(this.displayingQArrowsAmmt.val=!0,this.qArrowsAmmtInit(defaultTo(3,a))):(console.log("Tried to display q arrowsAmmt for wall "+this.handle+" while not recording or already displaying.  Will not display."),
console.trace())},addCleanUpIfPrompt:function(a,b){-1!=currentSetupType.indexOf("prompt")&&addListener(curLevel,currentSetupType+"CleanUp",a+this.handle,b,this)},displayVolStop:function(){this.displayingVol=!1;this.volReadout.removeEntry("vol"+this.handle);removeListener(curLevel,"update","displayVolume"+this.handle);return this},displayPIntStop:function(){this.displayingPInt=!1;removeListener(curLevel,"data","displayPInt"+this.handle);this.pIntReadout.removeEntry("pInt"+this.handle);return this},
displayPExtStop:function(){this.displayingPExt=!1;removeListener(curLevel,"update","displayPExt"+this.handle);this.pExtReadout.removeEntry("pExt"+this.handle);return this},displayWorkStop:function(){this.displayingWork=!1;this.workReadout.removeEntry("work"+this.handle);removeListener(curLevel,"update","displayWork"+this.handle);return this},displayTempStop:function(){this.displayingTemp=!1;removeListener(curLevel,"update","displayTemp"+this.handle);this.tempReadout.removeEntry("temp"+this.handle);
return this},displayMassStop:function(){this.displayingMass=!1;removeListener(curLevel,"data","displayMass"+this.handle);this.massReadout.removeEntry("mass"+this.handle);return this},displayQStop:function(){this.displayingQ=!1;removeListener(curLevel,"data","displayQ"+this.handle);this.qReadout.removeEntry("q"+this.handle);return this},displayQArrowsRateStop:function(){this.displayingQArrowsRate=!1;removeListener(curLevel,"update","checkDisplayArrows"+this.handle);removeListenerByName(curLevel,"update",
"ArrowFly");return this},displayQArrowsAmmtStop:function(){this.displayingQArrowsAmmt=!1;for(var a=0;a<this.qArrowsAmmt.length;a++)this.qArrowsAmmt[a].remove();removeListener(curLevel,"update",this.handle+"updateQAmmtArrows")},displayRMSStop:function(){this.displayingRMS=!1;removeListener(curLevel,"data","displayRMS"+this.handle);this.RMSReadout.removeEntry("RMS"+this.handle);return this},displayAllStop:function(){this.displayingVol&&this.displayVolStop();this.displayingPInt&&this.displayPIntStop();
this.displayingPExt&&this.displayPExtStop();this.displayingWork&&this.displayWorkStop();this.displayingTemp&&this.displayTempStop();this.displayingMass&&this.displayMassStop();this.displayingQ&&this.displayQStop();this.displayingQArrowsRate&&this.displayQArrowsRateStop();this.displayingQArrowAmmt&&this.displayQArrowsAmmtStop();this.displayingRMS&&this.displayRMSStop();return this},resetQ:function(){this.q=0;this.displayingQArrowsAmmt&&(this.displayQArrowsAmmtStop(),this.displayQArrowsAmmt(this.qArrowAmmtMax))},
resetWork:function(){this.work=0},qArrowsAmmtInit:function(a){this.qArrowAmmtMax=a;Col(175,0,0);var b=V(30,10),d=this[3].copy().fracMoveTo(this[2],0.25),e=this[3].copy().fracMoveTo(this[2],0.75),f=e.VTo(d).perp("cw").UV();d.movePt(f.copy().mult(5));e.movePt(f.copy().mult(5));var d=new ArrowStatic({pos:d,dims:b,fill:Col(175,0,0),stroke:Col(0,0,0),label:"Q",UV:f}),b=new ArrowStatic({pos:e,dims:b,fill:Col(175,0,0),stroke:Col(0,0,0),label:"Q",UV:f}),h=a/65;this.qArrowsAmmt=[d,b];var j="out";qLast=this.q;
this.setAmmtArrowDims(this.qArrowsAmmt,15,80,70,90,this.q,a);0<=this.q&&(j="in",this.flipAmmtArrows(this.qArrowsAmmt));addListener(curLevel,"update",this.handle+"updateQAmmtArrows",function(){Math.abs(this.q-qLast)>h&&(dir=0>this.q?"out":"in",this.setAmmtArrowDims(this.qArrowsAmmt,15,80,70,90,this.q,a),j!=dir&&(this.flipAmmtArrows(this.qArrowsAmmt),j=dir),qLast=this.q)},this)},flipAmmtArrows:function(a){for(var b=0;b<a.length;b++){var d=a[b],e=angleToUV(d.getAngle()).mult(1);d.move(e.mult(d.getDims().dx));
d.rotate(Math.PI)}},setAmmtArrowDims:function(a,b,d,e,f,h,j){for(var k=0;k<a.length;k++){var l=a[k],m=l.getDims(),n=Math.abs(this.q)/j,q=b+(d-b)*n;l.size(V(q,e+(f-e)*n));0<h&&l.move(V(0,q-m.dx))}},checkDisplayArrows:function(){var a=this.data.q[this.data.q.length-1]-this.data.q[this.idxLastArrow];Math.abs(a)>this.qArrowThreshold&&(this.populateArrows(a),this.idxLastArrow=turn)},populateArrows:function(a){var b=this.parent.qArrowFill,d=this.parent.qArrowFillFinal,e=this.parent.qArrowStroke,f=getSign(a),
h={"-1":"cw",1:"ccw"}[f];this.idxLastArrow=this.data.q.length-1;a=V(110*Math.abs(a),170*Math.abs(a));var j=a.copy();j.dx*=1.4;j.dy*=0.85;var k={"-1":0,1:-j.dx-30};if(7<a.dx||7<a.dy)for(var l=0;l<this.length-1;l++)if(this[l].isothermal)for(var m=this[l].distTo(this[l+1]),n=Math.round(m/150),q=m/=n+1,r=0;r<n;r++){var s=this[l].copy().movePt(this.wallUVs[l].copy().mult(q)).movePt(this.wallPerpUVs[l].copy().mult(k[f]));new ArrowFly({pos:s,dist:30,UV:this.wallUVs[l].copy().perp(h),fill:b,fillFinal:d,stroke:e,
dims:a,dimsFinal:j,lifespan:3500});q+=m}}},collideMethods:{cPAdiabaticDamped:function(a,b,d,e,f){e=this[b];a.v.copy();var h=a.v.dy,j=e.v,k=a.m,l=e.mass,m=Math.abs(j);if(1<m){b=h*h;d=j*j;var m=0.0017*m*m*m-0.0281*m*m+0.205*m+0.8466,n=m*m,q=k*(1+k/(n*l)),r=-2*k*(h*k/l+j)/n;a.v.dy=(-r+Math.pow(r*r-4*q*((k*(k*b/l+2*j*h)+l*d)/n-k*b-l*d),0.5))/(2*q);a.y+=a.r;e.v=(k*h+l*j-k*a.v.dy)/(l*m)}else b=walls[b][d],a.v.dy=(h*(k-l)+2*l*j)/(a.m+l),e.v=(j*(l-k)+2*k*h)/(l+k),a.y=b.y+a.r;e.forceInternal+=a.m*(Math.abs(f)+
Math.abs(a.v.dy))},cPAdiabaticDamped32:function(a,b,d,e,f){e=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);var h=this[b];a.v.copy();var j=a.v.dy,k=h.v,l=a.m,m=h.mass,n=Math.abs(k);if(1<n){b=j*j;d=k*k;var n=0.0017*n*n*n-0.0281*n*n+0.205*n+0.8466,q=n*n,r=l*(1+l/(q*m)),s=-2*l*(j*l/m+k)/q;a.v.dy=(-s+Math.sqrt(s*s-4*r*((l*(l*b/m+2*k*j)+m*d)/q-l*b-m*d)))/(2*r);a.y+=a.r;h.v=(l*j+m*k-l*a.v.dy)/(m*n)}else b=walls[b][d],a.v.dy=(j*(l-m)+2*m*k)/(a.m+m),h.v=(k*(m-l)+2*l*j)/(m+l),a.y=b.y+a.r;h.forceInternal+=a.m*(Math.abs(f)+
Math.abs(a.v.dy));f=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);f=Math.sqrt((e+2*(f-e)/3)/f);a.v.dx*=f;a.v.dy*=f},cPAdiabatic:function(a,b,d,e,f){b=this[b];a.v.copy();e=a.v.dy;var h=b.v,j=a.m,k=b.mass;d=b[d];a.v.dy=(e*(j-k)+2*k*h)/(a.m+k);b.v=(h*(k-j)+2*j*e)/(k+j);a.y=d.y+a.r;b.forceInternal+=a.m*(Math.abs(f)+Math.abs(a.v.dy))},cPAdiabatic32:function(a,b,d,e,f){e=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);b=this[b];a.v.copy();var h=a.v.dy,j=b.v,k=a.m,l=b.mass;d=b[d];a.v.dy=(h*(k-l)+2*l*j)/(a.m+l);b.v=(j*(l-
k)+2*k*h)/(l+k);a.y=d.y+a.r;b.forceInternal+=a.m*(Math.abs(f)+Math.abs(a.v.dy));f=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);f=Math.sqrt((e+2*(f-e)/3)/f);a.v.dx*=f;a.v.dy*=f},staticAdiabatic:function(a,b,d,e,f){this.reflect(a,e,f);this[b].forceInternal+=2*a.m*Math.abs(f)},cVIsothermal:function(a,b,d,e,f){var h=getSign(this[b].eToAdd);d=a.temp();var j=h*Math.min(1,h*this[b].eToAdd),h=h*Math.min(h*j,cv*(d-Math.min(d,20))/N);this[b].eToAdd-=h;d=Math.sqrt((d+h*N/cv)/d);j=f*d;this.reflect(a,e,f);a.v.dx*=d;
a.v.dy*=d;this[b].forceInternal+=a.m*(Math.abs(f)+Math.abs(j));this[b].q+=h*JtoKJ},cVAdiabatic:function(a,b,d,e,f){d=a.v;d.dy=-d.dy+2*walls[b].v;this[b].forceInternal+=a.m*(f+d.dy)},cVAdiabatic32:function(a,b,d,e,f){d=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);e=a.v;e.dy=-e.dy+2*walls[b].v;this[b].forceInternal+=a.m*(f+e.dy);b=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);b=Math.sqrt((d+2*(b-d)/3)/b);a.v.dx*=b;a.v.dy*=b},reflect:function(a,b,d){a.v.dx-=2*b.dy*d;a.v.dy+=2*b.dx*d;a.x-=b.dy;a.y+=b.dx}}};function Renderer(){}
Renderer.prototype={render:function(a){currentSetupType=-1!=a.type.indexOf("section")?a.type:a.type+window[a.type+"Idx"];!curLevel[currentSetupType+"CleanUp"]&&"prompt"==a.type&&curLevel.makeListenerHolder("prompt"+promptIdx+"CleanUp");this.renderDots(a.dots);this.renderWalls(a.walls,a);this.renderObjs(a.objs);this.addRecording(a.records);this.addReadoutEntries(a.readoutEntries);this.addListeners(a.listeners)},renderDots:function(a){a=defaultTo([],a);for(var b=0;b<a.length;b++){var d=a[b];spcs[d.type]?
spcs[d.type].populate(d.pos,d.dims,d.count,d.temp,d.returnTo,d.tag):console.log("Trying to populate bad species type "+d.type)}},renderWalls:function(a,b){a=defaultTo([],a);"section"==b.type&&(window.walls=new WallHandler);for(var d=0;d<a.length;d++)walls.addWall(a[d])},renderObjs:function(a){a=defaultTo([],a);for(var b=0;b<a.length;b++){var d=a[b];curLevel[d.type+d.handle]=new window[d.type](d.attrs)}},addRecording:function(a){a=defaultTo([],a);for(var b=0;b<a.length;b++){var d=a[b];walls[d.wallHandle]["record"+
d.data]()}},addReadoutEntries:function(a){a=defaultTo([],a);for(var b=0;b<a.length;b++){var d=a[b];walls[d.wallHandle]["display"+d.data]()}},addListeners:function(a){defaultTo([],a);for(var b=0;b<a.length;b++)new StateListener(a[b])}};compressorFuncs={getBinPts:function(a,b,d,e){var f=[];e=defaultTo(5,e);f.push(P(a.x-b*d.dx/2,a.y-d.dy));f.push(P(a.x-d.dx/2,a.y));f.push(P(a.x+d.dx/2,a.y));f.push(P(a.x+b*d.dx/2,a.y-d.dy));f.push(P(a.x+b*d.dx/2+e,a.y-d.dy));f.push(P(a.x+d.dx/2+e,a.y+e));f.push(P(a.x-d.dx/2-e,a.y+e));f.push(P(a.x-b*d.dx/2-e,a.y-d.dy));f.push(P(a.x-b*d.dx/2,a.y-d.dy));return f}};
objectFuncs={addCleanUp:function(){this.cleanUpListenerName=unique(this.type+defaultTo("",this.handle),curLevel[this.cleanUpWith+"CleanUpListeners"].listeners);addListener(curLevel,this.cleanUpWith+"CleanUp",this.cleanUpListenerName,function(){this.remove();removeListener(curLevel,this.cleanUpWith+"CleanUp",this.cleanUpListenerName)},this)},removeCleanUp:function(){removeListener(curLevel,this.cleanUpWith+"CleanUp",this.cleanUpListenerName)},pickSliderPos:function(){var a;this.wall?a=(this.wall[0].x+
this.wall[1].x)/2:this.pos&&this.dims?a=this.pos.x+this.dims.dx/2:this.pos&&(a=this.pos.x);if(a){var b=$("#main").width()/3;a=Math.floor(a/b);if(0==a)return"left";if(1!=a&&2==a)return"right"}return this.checkForMigrateCenter()},addSlider:function(a,b,d,e){e||(e=this.pickSliderPos());var f;switch(e){case "left":f="sliderHolderLeft";$("#sliderHolderSingle").hide();$("#sliderHolderDouble").show();break;case "center":f="sliderHolderCenter";$("#sliderHolderSingle").show();$("#sliderHolderDouble").hide();
break;case "right":f="sliderHolderRight",$("#sliderHolderSingle").hide(),$("#sliderHolderDouble").show()}e="slider"+this.handle;this.sliderWrapper=makeSlider(f,e,a,b,d);return e},checkForMigrateCenter:function(){return""!=$("#sliderHolderCenter").html().killWhiteSpace()?(this.migrateCenterSlider(),"right"):"center"},migrateCenterSlider:function(){var a=$("#sliderHolderCenter").html();$("#sliderHolderCenter").html("");$("#sliderHolderLeft").html(a)},removeSlider:function(){this.sliderWrapper.html("")},
hideSliderDivs:function(){$("#sliderHolderSingle").hide();$("#sliderHolderDouble").hide()},valToPercent:function(a){return 100*(a-this.min)/(this.max-this.min)},percentToVal:function(a){return a*(this.max-this.min)/100+this.min},pressureToMass:function(a){return a*(this.wall[1].x-this.wall[0].x)/(pConst*g)},massToPressure:function(a){return a*pConst*g/(this.wall[1].x-this.wall[0].x)}};
function DragWeights(a){this.type="DragWeights";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.handle=unique("dragWeights"+a.handle,curLevel);this.tempWeightDefs=a.weightDefs;this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.zeroY=defaultTo(this.wall[2].y,a.min);this.pistonPt=defaultTo(this.wall[0],a.pistonPt);this.pistonOffset=defaultTo(void 0,a.pistonOffset);this.wallHandler=defaultTo("cPAdiabaticDamped",a.compMode)+compAdj;this.readout=defaultTo(curLevel.readout,
a.readout);this.binY=defaultTo(myCanvas.height-15,a.binY);this.blockCol=defaultTo(Col(224,165,75),a.blockCol);this.binCol=defaultTo(Col(150,150,150),a.binCol);this.massInit=a.pInit?this.pressureToMass(a.pInit):defaultTo(25,defaultTo(curLevel.massInit,a.massInit));this.binHeight=defaultTo(45,a.binHeight);this.weightDimRatio=defaultTo(0.5,a.weightDimRatio);this.flySpeed=defaultTo(20,a.flySpeed);this.weightScalar=defaultTo(70,a.weightScalar);this.displayText=defaultTo(!0,a.displayText);this.binSlant=
1.3;this.storeBinWidth=110;this.storeBinSpacing=60;this.pistonBinWidth=150;this.pistonBinSpacing=15;this.blockSpacing=2;this.moveSpeed=20;this.mass=this.massInit;this.massChunkName="dragWeights";this.weightsOnPiston=[];this.font="12pt Calibri";this.fontCol=Col(255,255,255);this.binThickness=5;this.wall.setMass(this.massChunkName,this.massInit);this.wall.recordPExt();this.wall.recordWork();this.wall.recordMass();this.addCleanUp();return this.init()}
_.extend(DragWeights.prototype,objectFuncs,compressorFuncs,{init:function(){this.weightGroups=this.makeWeights(this.tempWeightDefs);this.bins={};this.bins.store=this.makeStoreBins();this.bins.piston=this.makePistonBins();walls.setSubWallHandler(this.wallInfo,0,this.wallHandler);this.displayText||(this.draw=this.drawNoText);addListener(curLevel,"update","drawDragWeights"+this.wallInfo,this.draw,this);this.unfreeze();this.wall.moveInit();this.dropAllIntoStores("instant");delete this.tempWeightDefs;
return this},remove:function(){this.wall.moveStop();removeListener(curLevel,"update","drawDragWeights"+this.wallInfo);removeListener(curLevel,"mousedown","weights"+this.wallInfo)},getWeightDims:function(a){for(var b={},d=0;d<a.length;d++){var e=a[d];e.pressure&&(e.mass=this.pressureToMass(e.pressure));e.mass/=e.count;var f=Math.sqrt(e.mass*this.weightScalar/this.weightDimRatio);b[e.name]=V(f,f*this.weightDimRatio)}return b},nameWeights:function(a){for(var b=0;b<a.length;b++)a[b].name="grp"+b},makeWeights:function(a){this.nameWeights(a);
for(var b={},d=this.getWeightDims(a),e=0,f=0;f<a.length;f++){var h=a[f],j={};j.name=h.name;j.dims=d[j.name];j.mass=h.mass;j.weights=[];for(var k=0;k<h.count;k++){var l={};l.pos=P(300,500);l.name=h.name;l.status="";l.id=e;j.weights.push(l);e++}b[j.name]=j}return b},makeStoreBins:function(){var a=(this.wall[0].x+this.wall[1].x)/2,b={},d=this.getNumGroups(),a=a-this.storeBinWidth*(d-1)/2-this.storeBinSpacing*(d-1)/2,e;for(e in this.weightGroups)b[e]=this.makeStoreBin(a,this.weightGroups[e]),a+=this.storeBinWidth+
this.storeBinSpacing;return b},makeStoreBin:function(a,b){var d={};d.pts=this.getBinPts(P(a,this.binY),this.binSlant,V(this.storeBinWidth,this.binHeight),this.binThickness);d.x=a-this.storeBinWidth/2;d.y=this.binY;d.slots=this.getBinSlots(P(d.x,d.y),b);d.visible=!0;return d},makePistonBins:function(){var a=(this.wall[0].x+this.wall[1].x)/2,b={},d=this.getNumGroups(),a=a-this.pistonBinWidth*(d-1)/2-this.pistonBinSpacing*(d-1)/2,e;for(e in this.weightGroups)b[e]=this.makePistonBin(a,this.weightGroups[e]),
a+=this.pistonBinWidth+this.pistonBinSpacing;return b},makePistonBin:function(a,b){var d={};if(this.pistonOffset){var e=this.pistonOffset.dx;d.pos=P(a-this.pistonBinWidth/2,0).movePt({dx:e}).track({pt:this.pistonPt,noTrack:"x",offset:{dy:this.pistonOffset.dy},cleanUpWith:this.cleanUpWith})}else d.pos=P(a-this.pistonBinWidth/2,0).track({pt:this.pistonPt,noTrack:"x",cleanUpWith:this.cleanUpWith});d.slots=this.getPistonBinSlots(d.pos,b);d.visible=!1;return d},getBinSlots:function(a,b){var d=b.weights.length,
e=b.dims,f=Math.floor(this.storeBinWidth/(e.dx+this.blockSpacing));a.x+=(this.storeBinWidth-f*(e.dx+this.blockSpacing))/2;for(var d=Math.ceil(d/f),h=[],j=a.y-this.blockSpacing-e.dy,k=0;k<d;k++){for(var l=[],m=a.x+this.blockSpacing,n=0;n<f;n++){var q=P(m,j),r=new Boolean,r=!1;l.push(this.newSlot(r,q,b.name,"store",k,n));m+=e.dx+this.blockSpacing}h.push(l);j-=e.dy+this.blockSpacing}return h},getPistonBinSlots:function(a,b){var d=b.weights.length,e=b.dims,f=Math.floor(this.pistonBinWidth/(e.dx+this.blockSpacing));
startX=a.x+(this.pistonBinWidth-f*(e.dx+this.blockSpacing))/2;for(var d=Math.ceil(d/f),h=[],j=this.blockSpacing,k=0;k<d;k++){for(var l=[],m=startX+this.blockSpacing,n=0;n<f;n++){var q=P(m,0).track({pt:a,offset:{dy:-(j+e.dy)},noTrack:"x",cleanUpWith:this.cleanUpWith}),r=new Boolean,r=!1;l.push(this.newSlot(r,q,b.name,"piston",k,n));m+=e.dx+this.blockSpacing}h.push(l);j+=e.dy+this.blockSpacing}return h},newSlot:function(a,b,d,e,f,h){return{isFull:a,pos:b,name:d,type:e,row:f,col:h}},binIsFull:function(a,
b){var d=this.bins[a][b].slots;for(rowIdx=0;rowIdx<d.length;rowIdx++)for(var e=d[rowIdx],f=0;f<e.length;f++)if(!e[f].isFull)return!1;return!0},binIsEmpty:function(a,b){var d=this.bins[a][b].slots;for(rowIdx=0;rowIdx<d.length;rowIdx++)for(var e=d[rowIdx],f=0;f<e.length;f++)if(e[f].isFull)return!1;return!0},allEmpty:function(a){var b=new Boolean,b=!0,d;for(d in this.bins[a])b=Math.min(b,this.binIsEmpty(a,d));return b},weightCount:function(a,b){var d=this.bins[a][b].slots,e=0;for(rowIdx=0;rowIdx<d.length;rowIdx++)for(var f=
d[rowIdx],h=0;h<f.length;h++)e+=f[h].isFull;return e},getPistonMass:function(){var a=0,b;for(b in this.weightGroups)for(var d=this.weightGroups[b],e=d.weights,d=d.mass,f=0;f<e.length;f++)"piston"==e[f].status&&(a+=d);return a+this.massInit},dropAllIntoStores:function(a){for(var b in this.weightGroups)for(var d=this.weightGroups[b],e=0;e<d.weights.length;e++){var f=d.weights[e];"piston"==f.status?(f.status="inTransit",f.slot.isFull=!1,this.takeOffPiston(f),this.dropIntoBin(f,"store",a)):"store"!=f.status&&
(f.status="inTransit",this.dropIntoBin(f,"store",a))}return this},dropAllIntoPistons:function(a){for(var b in this.weightGroups)for(var d=this.weightGroups[b],e=0;e<d.weights.length;e++){var f=d.weights[e];"store"==f.status?(f.status="inTransit",f.slot.isFull=!1,this.takeOffPiston(f),this.dropIntoBin(f,"piston",a)):"piston"!=f.status&&(f.status="inTransit",this.dropIntoBin(f,"piston",a))}return this},dropIntoBin:function(a,b,d){a.status="inTransit";var e=this.getDropSlot(a.name,b),f=e.slot;f.isFull=
!0;e=e.id;"instant"==d&&(a.pos=f.pos.copy());d=a.name+a.id+"endId"+this.wallInfo;var h="moveWeight"+d+b+e;removeListenerByName(curLevel,"update",d)&&(a.slot.isFull=!1,a.slot=void 0);a.slot=f;addListener(curLevel,"update",h,function(){var b=f.pos,d=V(b.x-a.pos.x,b.y-a.pos.y).UV();a.pos.x=boundedStep(a.pos.x,b.x,d.dx*this.moveSpeed);a.pos.y=boundedStep(a.pos.y,b.y,d.dy*this.moveSpeed);this.weightArrived(a,f)&&(removeListener(curLevel,"update",h),a.status=f.type,"piston"==a.status&&this.putOnPiston(a,
f))},this)},weightArrived:function(a,b){return a.pos.sameAs(b.pos)},getDropSlot:function(a,b){for(var d=this.bins[b][a],e=0;e<d.slots.length;e++)for(var f=d.slots[e],h=0;h<f.length;h++){var j=d.slots[e][h];if(!j.isFull)return{slot:j,id:String(e)+String(h)}}alert("BOX IS FULL!  WHY IS THIS HAPPENING?")},getNumGroups:function(){var a=0;for(idx in this.weightGroups)a++;return a},draw:function(){this.drawWeights();this.drawBins();this.drawBinLabels()},drawNoText:function(){this.drawWeights();this.drawBins()},
drawWeights:function(){var a=c,b;for(b in this.weightGroups)for(var d=this.weightGroups[b],e=d.weights,d=d.dims,f=0;f<e.length;f++)draw.fillRect(e[f].pos,d,this.blockCol,a)},drawBins:function(){var a=c,b;for(b in this.bins){var d=this.bins[b],e;for(e in d){var f=d[e];f.visible&&draw.fillPts(f.pts,this.binCol,a)}}},drawBinLabels:function(){for(var a in this.bins.store){var b=this.bins.store[a];b.visible&&draw.text(this.weightGroups[a].mass+" kg each",P(b.x+this.storeBinWidth/2,b.y-this.binHeight+10),
this.font,this.fontCol,"center",0,c)}},putOnPiston:function(a,b){this.weightsOnPiston.push(a);a.pos.track({pt:b.pos,noTrack:"x",cleanUpWith:this.cleanUpWith});a.status="piston";this.mass=this.getPistonMass();this.wall.setMass(this.massChunkName,this.mass)},takeOffPiston:function(a){for(var b=0;b<this.weightsOnPiston.length;b++)a==this.weightsOnPiston[b]&&this.weightsOnPiston.splice([b],1);a.pos.trackStop();this.mass=this.getPistonMass();this.wall.setMass(this.massChunkName,this.mass)},mousedown:function(){var a=
this.getClicked();a&&(this.pickup(a),"piston"==this.selected.cameFrom&&this.takeOffPiston(this.selected),addListener(curLevel,"mousemove","weights",this.mousemove,this),addListener(curLevel,"mouseup","weights",this.mouseup,this))},mousemove:function(){var a=mouseOffset(myCanvas),b=this.selected.origPos,d=b.weight,b=b.mouse,e=d.y+(a.y-b.y);this.selected.pos.x=d.x+(a.x-b.x);this.selected.pos.y=e},mouseup:function(){removeListener(curLevel,"mousemove","weights");removeListener(curLevel,"mouseup","weights");
var a=this.getDest();new Boolean;this.dropIntoBin(this.selected,a);delete this.origPos;this.selected=void 0},getDest:function(){var a=this.selected,b=this.weightGroups[a.name].dims.dy;return"piston"==a.cameFrom||a.pos.y+b>this.zeroY?"store":"piston"},pickup:function(a){a.cameFrom=a.status;a.status="holding";var b=mouseOffset(myCanvas);void 0!==a.slot&&(a.slot.isFull=!1);"piston"==a.status&&this.takeOffPiston(a);delete a.slot;this.selected=a;this.selected.origPos={mouse:b.copy(),weight:a.pos.copy()}},
getClicked:function(){for(var a in this.weightGroups){a=this.weightGroups[a];for(var b=0;b<a.weights.length;b++){var d=a.weights[b];if(inRect(d.pos,a.dims,myCanvas)&&("inTransit"==d.status||this.isOnTop(d)))return d}}return!1},mouseOnWeight:function(a,b){var d=mouseOffset(myCanvas);return d.x>=b.x&&d.x<=b.x+a.dx&&d.y<=b.y&&d.y>=b.y-a.dy},isOnTop:function(a){var b=a.slot;a=this.bins[b.type][a.name];for(var d=b.col,b=b.row+1;b<a.slots.length;b++)if(!0==a.slots[b][d].isFull)return!1;return!0},mass:function(){return this.mass},
freeze:function(){removeListener(curLevel,"mousedown","weights"+this.wallInfo)},unfreeze:function(){addListener(curLevel,"mousedown","weights"+this.wallInfo,this.mousedown,this)}});
function Pool(a){this.type="Pool";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);var b=this;a=defaultTo({},a);this.bin={};this.tube={};this.tube.walls={};this.tube.liquid={};this.liquid={};this.drawCanvas=defaultTo(c,a.drawCanvas);this.rate=defaultTo(0.15,a.rate);this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.massMax=defaultTo(75,a.massMax);this.massMin=defaultTo(10,a.massMin);this.mass=defaultTo(10,a.massInit);this.readout=defaultTo(curLevel.readout,a.readout);
this.buttonFillId=defaultTo("buttonFill",a.fillButtonId);this.buttonDrainId=defaultTo("buttonDrain",a.drainButtonId);this.bindButtons();this.massChunkName="liquidMass"+defaultTo("",a.handle);this.wall.setMass(this.massChunkName,this.mass);this.wall.recordPExt();this.wall.recordWork();this.wallHandler=defaultTo("cPAdiabaticDamped",a.compMode)+compAdj;walls.setSubWallHandler(this.wallInfo,0,this.wallHandler);this.bin.col=defaultTo(Col(175,175,175),a.binCol);this.bin.slant=defaultTo(1.3,a.binSlant);
this.bin.width=defaultTo(220,a.binWidth);this.bin.widthUpper=this.bin.width*this.bin.slant;this.bin.height=30;this.bin.thickness=defaultTo(5,a.binThickness);this.spcVol=70;this.liquid.col=defaultTo(Col(224,165,75),a.blockCol);this.liquid.pts=this.getLiquidPts();this.liquid.level=function(){return-b.bin.thickness-b.liquid.height};this.bin.pts=this.getBinPts(P(0,0-this.bin.thickness),this.bin.slant,V(this.bin.width,this.bin.height),this.bin.thickness);this.binX=(this.wall[1].x+this.wall[0].x)/2;this.pistonY=
function(){return this.wall[0].y};this.tube.speed=defaultTo(8,a.tubeSpeed);this.tube.walls.col=defaultTo(Col(175,175,175),a.tubeWallCol);this.tube.ID=10;this.tube.OD=20;this.tube.liquid.y1=function(){return-b.pistonY()};this.tube.liquid.y2=void 0;this.tube.walls.y=void 0;this.tube.wallThickness=(this.tube.OD-this.tube.ID)/2;this.tube.walls.xPts=this.getTubeXPts(this.tube.ID,this.tube.OD);this.tube.floor=this.tube.wallThickness+5;this.addCleanUp();return this.init()}
_.extend(Pool.prototype,objectFuncs,compressorFuncs,{init:function(){addListener(curLevel,"update","drawPool",this.draw,this);this.wall.moveInit();return this.displayMass().displayPressure()},bindButtons:function(){var a=this;$("#"+this.buttonFillId).mousedown(function(){a.buttonFillDown()});$("#"+this.buttonFillId).mouseup(function(){a.buttonFillUp()});$("#"+this.buttonDrainId).mousedown(function(){a.buttonDrainDown()});$("#"+this.buttonDrainId).mouseup(function(){a.buttonDrainUp()})},draw:function(){this.drawCanvas.save();
this.drawCanvas.translate(this.binX,this.pistonY());draw.fillPts(this.bin.pts,this.bin.col,this.drawCanvas);draw.fillPts(this.liquid.pts,this.liquid.col,this.drawCanvas);this.drawCanvas.restore()},drawTube:function(){var a=this.pistonY(),b=-a,d=this.tube.walls.y-b,e=this.tube.liquid.y1();this.dyLiq=this.tube.liquid.y2-e;this.drawCanvas.save();this.drawCanvas.translate(this.binX,a);draw.fillRect(P(this.tube.walls.xPts[0],b),V(this.tube.wallThickness,d),this.tube.walls.col,this.drawCanvas);draw.fillRect(P(this.tube.walls.xPts[1],
b),V(this.tube.wallThickness,d),this.tube.walls.col,this.drawCanvas);draw.fillRect(P(-this.tube.walls.xPts[1],e),V(this.tube.ID,this.dyLiq),this.liquid.col,this.drawCanvas);this.drawCanvas.restore()},getLiquidPts:function(){var a=this.bin.widthUpper-this.bin.width;this.liquid.height=this.mass*this.spcVol/(this.bin.width+a/this.bin.height);var b=this.liquid.height,d=Array(4),a=a*b/this.bin.height;d[0]=P(-this.bin.width/2,-this.bin.thickness);d[1]=P(this.bin.width/2,-this.bin.thickness);d[2]=P((this.bin.width+
a)/2,-b-this.bin.thickness);d[3]=P((-this.bin.width-a)/2,-b-this.bin.thickness);return d},getTubeXPts:function(a){var b=Array(2);b[0]=-(a/2+this.tube.wallThickness);b[1]=a/2;return b},buttonFillDown:function(){this.extendTubeFill()},buttonFillUp:function(){this.retractTube()},buttonDrainDown:function(){this.extendTubeDrain()},buttonDrainUp:function(){this.retractTube()},changeMassFunc:function(a){return function(){this.mass=Math.min(this.massMax,Math.max(this.mass+a*this.rate,this.massMin));this.liquid.pts=
this.getLiquidPts();this.wall.setMass(this.massChunkName,this.mass);this.trackingMass&&this.readout.tick("mass"+this.wallInfo,this.mass);this.trackingPressure&&this.readout.tick("pressure"+this.wallInfo,this.wall.pExt())}},extendTubeFill:function(){void 0==this.tube.liquid.y2&&void 0==this.tube.walls.y&&(this.tube.liquid.y2=-this.pistonY(),this.tube.walls.y=-this.pistonY());removeListener(curLevel,"update","retract");var a=this.tube,b=this;a.liquid.y1=function(){return-b.pistonY()};addListener(curLevel,
"update","extendTube",function(){a.walls.y+=this.tube.speed;var b=-a.walls.y<this.liquid.level();this.liquid.level();b&&(a.walls.y=-this.tube.floor,removeListener(curLevel,"update","extendTube"))},this);addListener(curLevel,"update","extendFluid",function(){a.liquid.y2+=0.8*this.tube.speed;-a.liquid.y2<this.tube.floor&&(a.liquid.y2=-this.tube.floor,a.walls.y=-this.tube.floor,removeListener(curLevel,"update","extendTube"),removeListener(curLevel,"update","extendFluid"),addListener(curLevel,"update",
"changeLiquidMass",this.changeMassFunc(1),this))},this);addListener(curLevel,"update","drawTube",this.drawTube,this)},extendTubeDrain:function(){void 0==this.tube.liquid.y2&&void 0==this.tube.walls.y&&(this.tube.liquid.y2=-this.pistonY(),this.tube.walls.y=-this.pistonY());removeListener(curLevel,"update","retract");var a=this.tube;a.liquid.y1=function(){return 0};a.liquid.y2=0;addListener(curLevel,"update","extendTube",function(){a.walls.y+=this.tube.speed;-a.walls.y<this.tube.floor&&(a.walls.y=-this.tube.floor,
removeListener(curLevel,"update","extendTube"),this.liquidUp())},this);addListener(curLevel,"update","drawTube",this.drawTube,this)},liquidUp:function(){var a=this.tube,b=this;a.liquid.y1=function(){return-b.tube.floor};a.liquid.y2=-this.tube.floor;addListener(curLevel,"update","liquidUp",function(){var b=-this.pistonY(),e=a.liquid.y1()-a.speed;this.tube.liquid.y1=function(){return e};e<b&&(removeListener(curLevel,"update","liquidUp"),addListener(curLevel,"update","changeLiquidMass",this.changeMassFunc(-1),
this))},this)},retractTube:function(){removeListener(curLevel,"update","extendTube");removeListener(curLevel,"update","extendFluid");removeListener(curLevel,"update","changeLiquidMass");removeListener(curLevel,"update","liquidUp");var a=this.tube;addListener(curLevel,"update","retract",function(){var b=-this.pistonY(),d=a.liquid.y1()-1.5*a.speed;a.liquid.y1=function(){return d};a.liquid.y2-=1.5*a.speed;a.walls.y-=a.speed;a.liquid.y1()<b&&(a.liquid.y2<b&&a.walls.y<b)&&(removeListener(curLevel,"update",
"retract"),removeListener(curLevel,"update","drawTube"),this.tube.liquid.y2=void 0,this.tube.walls.y=void 0)},this)},remove:function(){removeListener(curLevel,"update","extendTube");removeListener(curLevel,"update","extendFluid");removeListener(curLevel,"update","changeLiquidMass");removeListener(curLevel,"update","liquidUp");removeListener(curLevel,"update","drawTube");removeListener(curLevel,"update","drawPool");this.wall.moveStop()}});
function DragArrow(a,b,d,e,f,h,j,k,l){this.type="DragArrow";this.pos=a;this.rotation=b;this.posInit=this.pos.copy();this.cols=d;this.dims=e;this.name=f;this.listeners=k;this.drawCanvas=h;this.canvasElement=j;this.bounds=l;this.bounds.x?(this.bounds.x.max||(this.bounds.x.max=j.width-e.dx),this.bounds.x.min||(this.bounds.x.min=0)):this.bounds.x={min:0,max:j.width-e.dx};this.bounds.y?(this.bounds.y.max||(this.bounds.y.max=j.height-e.dy),this.bounds.y.min||(this.bounds.y.min=0)):this.bounds.y={min:0,
max:j.height-e.dy};this.pts={};this.pts.outer=[];this.pts.inner=[];a=this.dims.dx;b=this.dims.dy;this.pts.outer.push(P(0,0));this.pts.outer.push(P(0.9*a,-b/2));this.pts.outer.push(P(a,0));this.pts.outer.push(P(0.9*a,b/2));this.pts.outer.push(P(0,0));this.makeDrawFunc();this.clickListeners=this.makeListenerFuncs();return this}
DragArrow.prototype={makeDrawFunc:function(){this.dirUV=V(Math.cos(this.rotation+Math.PI/2),Math.sin(this.rotation+Math.PI/2));this.draw=function(){};var a=this;this.draw=extend(this.draw,function(){a.drawCanvas.save();a.drawCanvas.translate(a.pos.x,a.pos.y);a.drawCanvas.rotate(a.rotation)});this.draw=this.cols.stroke?extend(this.draw,function(){draw.fillPtsStroke(a.pts.outer,a.cols.outer,a.cols.stroke,a.drawCanvas)}):extend(this.draw,function(){draw.fillPts(a.pts.outer,a.cols.outer,a.drawCanvas)});
if(this.cols.inner||this.cols.onClick){for(var b=0;b<this.pts.outer.length;b++){var d=this.pts.outer[b].copy().movePt({dx:-this.dims.dx/2}).scale(P(0,0),0.6).movePt({dx:this.dims.dx/2});this.pts.inner.push(d)}this.cols.curInner=this.cols.inner?this.cols.inner:this.cols.outer;this.draw=extend(this.draw,function(){draw.fillPts(a.pts.inner,a.cols.curInner,a.drawCanvas)})}this.draw=extend(this.draw,function(){a.drawCanvas.restore()})},makeListenerFuncs:function(){var a=this.listeners,b=this;b.amSelected=
new Boolean;if(a.onDown||a.onMove||a.onUp){var d=function(){};b.cols.onClick&&(d=extend(d,function(){b.cols.curInner=b.cols.onClick}));var d=extend(d,function(){a.onDown.apply(b)}),e=this.makeMoveListenerFunc(b),d=extend(d,e);a.onUp&&(e=this.makeUpListenerFunc(b),d=extend(d,e));return function(){b.amSelected=b.checkSelected();b.amSelected&&(b.posInit=b.pos.copy(),b.mouseInit=mouseOffset(b.canvasElement),d())}}},makeMoveListenerFunc:function(a){var b=a.listeners,d=function(){var b=mouseOffset(a.canvasElement),
d=V(b.x-a.mouseInit.x,b.y-a.mouseInit.y).dotProd(a.dirUV),b=a.posInit.x+d*Math.cos(a.rotation+Math.PI/2),d=a.posInit.y+d*Math.sin(a.rotation+Math.PI/2);a.pos.x=Math.max(a.bounds.x.min,Math.min(b,a.bounds.x.max));a.pos.y=Math.max(a.bounds.y.min,Math.min(d,a.bounds.y.max))};b.onMove&&(d=extend(d,function(){b.onMove.apply(a)}));return function(){addListener(curLevel,"mousemove","dragArrow"+a.name,d,"");addListener(curLevel,"mouseup","dragArrow"+a.name+"RemoveMove",function(){removeListener(curLevel,
"mousemove","dragArrow"+a.name);removeListener(curLevel,"mouseup","dragArrow"+a.name+"RemoveMove")},"")}},makeUpListenerFunc:function(a){var b=function(){addListener(curLevel,"mouseup","mouseup"+a.name,function(){a.listeners.onUp.apply(a)},"");addListener(curLevel,"mouseup","mouseup"+a.name+"remove",function(){removeListener(curLevel,"mouseup","mouseup"+a.name);removeListener(curLevel,"mouseup","mouseup"+a.name+"remove")},"")};if(a.cols.onClick)var d=function(){},d=a.cols.inner?extend(d,function(){a.cols.curInner=
a.cols.inner}):extend(d,function(){a.cols.curInner=a.cols.outer}),b=extend(b,function(){addListener(curLevel,"mouseup","revertCols"+a.name,function(){d();removeListener(curLevel,"mouseup","revertCols"+a.name)},"")});return b},show:function(){addListener(curLevel,"mousedown","dragArrow"+this.name,this.clickListeners,"");addListener(curLevel,"update","drawDragArrow"+this.name,this.draw,"");return this},hide:function(){removeListener(curLevel,"mousedown","dragArrow"+this.name);removeListener(curLevel,
"update","drawDragArrow"+this.name);return this},reset:function(){this.pos=this.posInit.copy();removeListener(curLevel,"update","moveWall");return this},remove:function(){removeListener(curLevel,"mousedown","dragArrow"+this.name);removeListener(curLevel,"update","drawDragArrow"+this.name)},checkSelected:function(){var a=mouseOffset(this.canvasElement).rotate(this.pos,-this.rotation),b=this.pos.copy().movePt({dy:-this.dims.dy/2});return ptInRect(b,this.dims,a)}};
function CompArrow(a){this.type="CompArrow";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);var b=defaultTo(0,a.wallInfo),d=defaultTo(1.5,a.speed),e=defaultTo("adiabatic",a.compMode),e=e+compAdj,f=defaultTo(!0,a.stops),h=defaultTo({y:{min:30,max:350}},a.bounds),j=walls[b],k=j[1].copy(),l={};l.outer=Col(44,118,172);l.onClick=Col(44,118,172);l.inner=curLevel.bgCol.copy();var m=V(25,15);a="volDragger"+defaultTo("",a.handle);var n=c,q=canvas,r={};f&&(this.stops=new Stops({stopPt:{height:h.y.max},
wallInfo:b}));r.onDown=function(){};r.onMove=function(){j.changeSetPt(this.pos.y,e,d)};r.onUp=function(){};this.dragArrow=(new DragArrow(k,0,l,m,a,n,q,r,h)).show();this.addCleanUp();return this}_.extend(CompArrow.prototype,objectFuncs,{remove:function(){this.dragArrow.remove();this.stop&&this.stops.remove()}});
function Piston(a){this.type="Piston";this.handle=a.handle;this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.min=defaultTo(2,a.min);this.max=defaultTo(15,a.max);this.makeSlider=defaultTo(!0,a.makeSlider);this.drawCanvas=defaultTo(c,a.drawCanvas);this.slant=0.07;this.left=this.wall[0].x;this.width=this.wall[1].x-this.left;this.pistonPt=this.wall[0];this.setMass(defaultTo(2,a.init));this.height=500;this.draw=this.makeDrawFunc(this.height,
this.left,this.width);this.dataSlotFont="12pt Calibri";this.dataSlotFontCol=Col(255,255,255);this.pStep=0.05;a=this.left+this.width*this.slant;var b=this.left+this.width-this.width*this.slant,d=this.pistonBottom.pos.y-2+this.pistonPt.y,e=Col(255,255,255);this.readout=new Readout("pistonReadout"+this.handle,a,b,d,"12pt calibri",e,"center");this.wall.moveInit();this.wall.recordPExt();this.wall.recordWork();walls.setSubWallHandler(this.wallInfo,0,"cPAdiabaticDamped"+compAdj);this.makeSlider&&(this.sliderId=
this.addSlider("Pressure",{value:this.pToPercent(this.val)},[{eventType:"slide",obj:this,func:this.parseSlider}]));this.addCleanUp();return this.show()}
_.extend(Piston.prototype,objectFuncs,compressorFuncs,{makeDrawFunc:function(a,b,d){var e=a-45;this.pistonTop=this.makeTop(b,d,30,e,a,35,10);this.pistonBottom=this.makePlateBottom(P(b,-a+e+35),V(d,10));var f=this;return function(){f.readout&&f.setReadoutY();f.drawCanvas.save();f.drawCanvas.translate(0,f.pistonPt.y);draw.fillPts(f.pistonTop.pts,f.pistonTop.col,f.drawCanvas);draw.fillRect(f.pistonBottom.pos,f.pistonBottom.dims,f.pistonBottom.col,f.drawCanvas);f.drawCanvas.restore()}},makeTop:function(a,
b,d,e,f,h,j){var k=this.slant,l=1-k,m=Array(14);f=P(a+b/2-d/2,-f);var n=Col(150,150,150);b=V(b,h);a=f.copy().movePt({dy:e}).position({x:a});m[0]=P(a.x,a.y+b.dy+1);m[1]=P(a.x+b.dx*k,a.y);m[2]=P(f.x-b.dx*k,a.y);m[3]=P(f.x,a.y-5*b.dy*k);m[4]=P(f.x,f.y);m[5]=P(f.x+d,f.y);m[6]=P(f.x+d,a.y-5*b.dy*k);m[7]=P(f.x+d+b.dx*k,a.y);m[8]=P(a.x+b.dx*l,a.y);m[9]=P(a.x+b.dx,a.y+b.dy+1);m[10]=P(a.x+b.dx-j,a.y+b.dy+1);m[11]=P(a.x+b.dx*l-j,a.y+j);m[12]=P(a.x+b.dx*k+j,a.y+j);m[13]=P(a.x+j,a.y+b.dy+1);n=Col(150,150,150);
return{pts:m,col:n}},makePlateBottom:function(a,b){var d=Col(100,100,100);b.adjust(0,1);return{pos:a,dims:b,col:d}},show:function(){addListener(curLevel,"update","drawPiston"+this.handle,this.draw,"");this.readout.show();return this},hide:function(){removeListener(curLevel,"update","drawPiston"+this.handle);this.readout.hide()},parseSlider:function(a,b){this.setPressure(this.percentToVal(b.value))},setPressure:function(a){this.setMass(a)},setMass:function(a){this.mass=this.pressureToMass(a);this.wall.setMass("piston"+
this.handle,this.mass)},setReadoutY:function(){this.readout.position({y:this.pistonBottom.pos.y-2+this.pistonPt.y})},remove:function(){this.wall.moveStop();this.wall.unsetMass("piston"+this.handle);this.hide();this.sliderId&&this.removeSlider();this.hideSliderDivs();removeListener(curLevel,"update","moveWalls")}});
function Heater(a){this.type="Heater";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.dims=defaultTo(V(100,40),a.dims);a.wallInfo?(this.wall=walls[a.wallInfo],this.pos=this.centerOnWall(a.wallInfo,this.dims)):this.pos=a.pos;this.makeSlider=defaultTo(!0,a.makeSlider);this.handle=defaultTo("heaty",a.handle);this.drawCanvas=defaultTo(c,a.drawCanvas);this.cornerRound=0.2;this.temp=defaultTo(0,a.init);this.tempMax=defaultTo(35,a.max);this.tempMin=-this.tempMax;this.rot=defaultTo(0,a.rotation);
this.center=this.pos.copy().movePt(this.dims.copy().mult(0.5));a=Col(200,0,0);var b=Col(0,0,200),d=Col(100,100,100);this.draw=this.makeDrawFunc(b,d,a);this.wallPts=this.pos.roundedRect(this.dims,0.3,"ccw");this.eAdded=0;this.addCleanUp();this.makeSlider&&(this.sliderId=this.addSlider("Heater",{value:50},[{eventType:"slide",obj:this,func:this.parseSlider},{eventType:"slidestop",obj:this,func:function(a,b){$("#"+this.sliderId).slider("option",{value:50});b.value=50;this.parseSlider(a,b)}}]));return this.init()}
_.extend(Heater.prototype,objectFuncs,{parseSlider:function(a,b){this.setTemp(b.value)},setTemp:function(a){this.temp=0.02*(a-50)*this.tempMax},makeDrawFunc:function(a,b,d){this.pts=this.getPts(this.pos,this.dims);rotatePts(this.pts,this.center,this.rot);var e=this.getColorSteps(a,b,d),f=this,h=this.pts;return function(){var a=getSign(f.temp),d=e[String(a)],a=a*f.temp/f.tempMax,d=b.copy().adjust(d[0]*a,d[1]*a,d[2]*a);draw.path(h,d,f.drawCanvas)}},centerOnWall:function(a,b){var d=walls[a];return P((d[3].x+
d[2].x)/2-b.dx/2,d[2].y-30-b.dy)},getPts:function(a,b){var d=[],e=a.copy().movePt({dy:b.dy/2}),f=b.dy/2+2.5,h=b.dy/2-2.5,j=Math.floor((b.dx-2*f)/(2*(f-h)));d.push(e.copy().movePt({dy:200}));d.push(e.copy());d=d.concat(this.halfElipse(e,f,b.dy/2,0,5));e.movePt({dx:2*f});for(var k=0;k<j;k++)d=d.concat(this.halfElipse(e,h,b.dy/2,Math.PI,5)),e.movePt({dx:-2*h}),d=d.concat(this.halfElipse(e,f,b.dy/2,0,5)),e.movePt({dx:2*f});d.push(e.copy());d.push(e.copy().movePt({dy:200}));this.endX=d[d.length-1].x;this.dims=
V(this.endX-this.pos.x,b.dy);this.center=this.pos.copy().movePt(this.dims.copy().mult(0.5));return d},halfElipse:function(a,b,d,e,f){f=defaultTo(5,f);for(var h=Array(f),j=Math.PI/f,k=a.x+b,l=Math.PI,m=0;m<f;m++){var n=k+b*Math.cos(l),q=a.y+d*Math.sin(l);h[m]=P(n,q);l+=j}rotatePts(h,a,e);return h},getColorSteps:function(a,b,d){var e={};d=[d.r-b.r,d.g-b.g,d.b-b.b];e["-1"]=[a.r-b.r,a.g-b.g,a.b-b.b];e["1"]=d;return e},init:function(){addListener(curLevel,"update","drawHeater"+this.handle,this.draw,"");
this.setupWalls();this.eAdded=0;return this},setupWalls:function(){walls.addWall({pts:this.wallPts,handler:this.wall?{func:this.hitAddQToWall,obj:this}:{func:this.hit,obj:this},handle:"heater"+this.handle,record:!1,show:!1})},hit:function(a,b,d,e,f){walls.reflect(a,e,f);0!=this.temp&&(b=a.temp(),d=Math.max(b+this.temp,50),a.setTemp(d),this.eAdded+=(d-b)*cv/(N*JtoKJ))},hitAddQToWall:function(a,b,d,e,f){walls.reflect(a,e,f);0!=this.temp&&(b=a.temp(),d=Math.max(b+this.temp,50),a.setTemp(d),a=(d-b)*cv*
JtoKJ/N,this.eAdded+=a,this.wall.q+=a)},remove:function(){this.removeSlider();removeListener(curLevel,"update","drawHeater"+this.handle);window.walls&&!walls.removed&&walls.removeWall("heater"+this.handle)}});
function Stops(a){this.type="Stops";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.stopWidth=20;this.stopHeight=5;this.boundToSet=void 0;var b=a.stopPt;this.wallInfo=defaultTo(0,a.wallInfo);this.pts=this.wall=walls[this.wallInfo];if(b.volume){var d=this.pts[0].distTo(this.pts[1]);this.height=this.pts[2].y-b.volume/(vConst*d)}else b.height&&(this.height=b.height);if(this.willDraw=defaultTo(!0,a.draw))this.draw=this.makeDrawFunc(this.height);this.addCleanUp();return this.init()}
_.extend(Stops.prototype,objectFuncs,{makeDrawFunc:function(a){var b=this.pts[3].copy().position({y:a}),d=this.pts[2].copy().position({y:a}).movePt({dx:-this.stopWidth}),e=V(this.stopWidth,this.stopHeight),f=borderCol;return function(){draw.fillRect(b,e,f,c);draw.fillRect(d,e,f,c)}},init:function(){this.boundToSet=this.height>this.wall[0].y?"yMax":"yMin";this.yBoundSave=this.wall.bounds[this.boundToSet];var a={};a[this.boundToSet]=this.height;walls.setBounds(this.wallInfo,a);this.willDraw&&addListener(curLevel,
"update","drawStops"+this.wallInfo,this.draw,"");return this},remove:function(){if(window.walls&&!walls.removed){var a={};a[this.boundToSet]=this.yBoundSave;walls.setBounds(this.wallInfo,a)}this.willDraw&&removeListener(curLevel,"update","drawStops"+this.wallInfo);return this}});
function StateListener(a){this.type="StateListener";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.conditionsOn=this.cleanUpWith.killNumbers();this.dataList=walls[a.wallHandle].data[a.dataList];this.is=a.is;this.targetVal=a.targetVal;this.tolerance=defaultTo(0.05,a.tolerance);this.checkOn=a.checkOn;this.alerts={"true":a.alertSatisfied,"false":a.alertUnsatisfied};this.priorities={"true":defaultTo(0,a.prioritySatisfied),"false":defaultTo(0,a.priorityUnsatisfied)};this.storeAtSatisfy=
defaultTo({},a.storeAtSatisfy);this.atSatisfyFunc=defaultTo(void 0,a.atSatisfyFunc);this.amSatisfied=!1;this.makeConditionFunc();return this.init()}
_.extend(StateListener.prototype,objectFuncs,{init:function(){"conditions"==this.checkOn?this.initCheckOnConditions():this.initCheckOnInterval();this.addCleanUp()},initCheckOnConditions:function(){this.handle=unique("StateListener"+this.is,curLevel[this.conditionsOn+"ConditionListeners"].listeners);addListener(curLevel,this.conditionsOn+"Condition",this.handle,function(){var a=this.condition();return{didWin:a,alert:this.alerts[a],priority:this.priorities[a]}},this)},initCheckOnInterval:function(){this.handle=
unique("StateListener"+this.is,curLevel.updateListeners.listeners);addListener(curLevel,"update",this.handle,function(){this.condition()&&(this.amSatisfied=!0,this.recordVals(),this.atSatisfyFunc&&this.atSatisfyFunc.func.apply(this.atSatisfyFunc.obj),removeListener(curLevel,"update",this.handle))},this);addListener(curLevel,this.conditionsOn+"Condition",this.handle,function(){return{didWin:this.amSatisfied,alert:this.alerts[this.amSatisfied],priority:this.priorities[this.amSatisfied]}},this)},makeConditionFunc:function(){this.condition=
this.targetVal instanceof Array?function(){return this[this.is](this.dataList[this.dataList.length-1],this.targetVal[this.targetVal.length-1])}:function(){return this[this.is](this.dataList[this.dataList.length-1],this.targetVal)}},lessThan:function(a,b){return a<b},greaterThan:function(a,b){return a>b},equalTo:function(a,b){return fracDiff(a,b)<this.tolerance},notEqualTo:function(a,b){return fracDiff(a,b)>this.tolerance},recordVals:function(){this.results={};for(var a in this.storeAtSatisfy){var b=
a+"B"+blockIdx+"P"+promptIdx,d=this.storeAtSatisfy[a],d=round(d[d.length-1],1);store(b,d);this.results[b]=d}},isSatisfied:function(){return this.amSatisfied},remove:function(){removeListener(curLevel,this.conditionsOn+"Condition",this.handle);removeListener(curLevel,"update",this.handle)}});function Sandbox(a){this.type="Sandbox";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);a=defaultTo({},a);this.bin={};this.sand={};this.drawCanvas=defaultTo(c,a.drawCanvas);this.wallInfo=defaultTo(0,a.wallInfo);this.wall=walls[this.wallInfo];this.mass=a.pInit?this.pressureToMass(a.pInit):defaultTo(10,a.massInit);this.massMax=a.pMax?this.pressureToMass(a.pMax):defaultTo(75,a.massMax);this.massMin=a.pMin?this.pressureToMass(a.pMin):defaultTo(10,a.massMin);this.particleMass=defaultTo(0.01,
a.partMass);this.buttonAddId="sandAdd";this.buttonRemoveId="sandRemove";this.makeButtons();this.massChunkName="sandMass"+defaultTo("",a.handle);this.wall.setMass(this.massChunkName,this.mass);this.wall.recordPExt();this.wall.recordWork();this.wallHandler=defaultTo("cPAdiabaticDamped",a.compMode)+compAdj;walls.setSubWallHandler(this.wallInfo,0,this.wallHandler);this.wallPt=this.wall[0];this.emitters=[];this.binX=(this.wall[1].x+this.wall[0].x)/2;this.spcVol=70;this.sand.col=defaultTo(Col(224,165,75),
a.sandCol);this.sand.pts=this.getSandPts();this.sand.pos=P(this.binX,this.wall[0].y).track({pt:this.wallPt,noTrack:"x",cleanUpWith:this.cleanUpWith});this.pistonPt=this.wall[0].y;this.addCleanUp();return this.init()}
_.extend(Sandbox.prototype,compressorFuncs,objectFuncs,{init:function(){this.drawListenerName=unique("drawSand"+this.handle,curLevel.updateListeners.listeners);addListener(curLevel,"update",this.drawListenerName,this.draw,this);this.wall.moveInit();this.wall.recordMass();this.wall.recordPExt();return this},makeButtons:function(){addButton(this.buttonAddId,"Add mass");addButton(this.buttonRemoveId,"Remove mass");var a=this;$("#"+this.buttonAddId).mousedown(function(){a.buttonAddDown()});$("#"+this.buttonRemoveId).mousedown(function(){a.buttonRemoveDown()})},
removeButtons:function(){removeButton(this.buttonAddId);removeButton(this.buttonRemoveId)},draw:function(){this.drawCanvas.save();this.drawCanvas.translate(this.sand.pos.x,this.sand.pos.y);var a=Math.sqrt(0.4*this.mass);this.drawCanvas.scale(a,a);draw.fillPts(this.sand.pts,this.sand.col,this.drawCanvas);this.width=a*(this.sand.pts[this.sand.pts.length-1].x-this.sand.pts[0].x);this.drawCanvas.restore()},getSandPts:function(){var a=Array(4);a[0]=P(-10,0);a[1]=P(-7,-2);a[2]=P(-3,-6);a[3]=P(0,-7);ptsRight=
deepCopy(a).splice(0,a.length-1).reverse();mirrorPts(ptsRight,P(0,0),V(0,-10));return a=a.concat(ptsRight)},buttonAddDown:function(){this.mass<this.massMax&&(this.boundUpper(),this.addMass(),addListener(curLevel,"mouseup","mouseUpSandbox",this.buttonAddUp,this))},buttonAddUp:function(){this.boundUpperStop();this.addMassStop();removeListener(curLevel,"mouseup","mouseUpSandbox")},buttonRemoveDown:function(){this.mass>this.massMin&&(this.boundLower(),this.removeMass(),addListener(curLevel,"mouseup",
"mouseUpSandbox",this.buttonRemoveUp,this))},buttonRemoveUp:function(){this.boundLowerStop();this.removeMassStop();removeListener(curLevel,"mouseup","mouseUpSandbox")},boundUpper:function(){var a=this.handle+"BoundUpper";curLevel.updateListeners.listeners[a]||addListener(curLevel,"update",a,function(){this.mass>this.massMax&&(this.stopAllEmitters(),removeListener(curLevel,"update",a))},this)},boundLower:function(){var a=this.handle+"BoundLower";curLevel.updateListeners.listeners[a]||addListener(curLevel,
"update",a,function(){this.mass<this.massMin&&(this.stopAllEmitters(),removeListener(curLevel,"update",a))},this)},boundUpperStop:function(){removeListener(curLevel,"update",this.handle+"BoundUpper")},boundLowerStop:function(){removeListener(curLevel,"update",this.handle+"BoundLower")},stopAllEmitters:function(){for(var a=0;a<this.emitters.length;a++)this.emitters[a].stopFlow()},addMass:function(){this.emitters.push(this.makeAddEmitter())},addMassStop:function(){this.emitters[this.emitters.length-
1].stopFlow()},removeMass:function(){this.emitters.push(this.makeRemoveEmitter())},removeMassStop:function(){this.emitters[this.emitters.length-1].stopFlow()},makeAddEmitter:function(){var a={func:this.onArriveAdd,obj:this},b=this.emitters.length,d=Math.PI/2,e=this.sand.col,f=this.wall[0].y,h=new ParticleEmitter({pos:P((this.wall[0].x+this.wall[1].x)/2,0),width:this.width,dist:f,dir:d,col:e,onRemove:j,parentList:this.emitters,onArrive:a});h.adding=!0;moveListenerName=unique("adjustEmitter"+b,curLevel.updateListeners.listeners);
addListener(curLevel,"update",moveListenerName,function(){h.adjust({dist:this.wallPt.y,width:this.width})},this);var j={func:function(){removeListener(curLevel,"update",moveListenerName)},obj:this};return h},makeRemoveEmitter:function(){var a={func:this.onGenerateRemove,obj:this},b=this.emitters.length,d=-Math.PI/2,e=this.sand.col,f=(this.wall[0].x+this.wall[1].x)/2,h=this.wall[0].y,j=new ParticleEmitter({pos:P(f,0),width:this.width,dist:h,dir:d,col:e,onRemove:l,parentList:this.emitters,onGenerate:a,
cleanUpWith:this.cleanUpWith});j.removing=!0;moveListenerName=unique("adjustEmitter"+b,curLevel.updateListeners.listeners);var k=this.wall[0];addListener(curLevel,"update",moveListenerName,function(){j.adjust({pos:P(f,k.y),dist:k.y,width:this.width})},this);var l={func:function(){removeListener(curLevel,"update",moveListenerName)},obj:this};return j},onGenerateRemove:function(){this.mass-=this.particleMass;this.wall.setMass(this.massChunkName,this.mass)},onArriveAdd:function(){this.mass+=this.particleMass;
this.wall.setMass(this.massChunkName,this.mass)},remove:function(){for(var a=0;a<this.emitters.length;a++)this.emitters[a].remove();this.emitters=[];this.sand.pos.trackStop();this.removeButtons();removeListener(curLevel,"update",this.drawListenerName);removeListener(curLevel,"data",this.cleanUpEmittersListenerName);this.wall.moveStop()}});
function ParticleEmitter(a){this.type="ParticleEmitter";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.pos=a.pos;this.handle=unique("emitter"+defaultTo("",a.handle),curLevel.updateListeners.listeners);this.dir=a.dir;this.parentList=a.parentList;this.width=a.width;this.col=a.col;this.dist=a.dist;this.onGenerate=a.onGenerate;this.onArrive=a.onArrive;this.onRemove=a.onRemove;this.rate=defaultTo(Math.round(0.1*this.width),a.rate);this.speed=defaultTo(5,a.speed);this.speedSpread=defaultTo(1,
a.speedSpread);2*this.speedSpread>this.speed&&console.log("Uh-oh.  Making particle emitter with handle "+this.handle+" with speed spread such that particles will hit ~0 speed");this.accel=defaultTo(0.5,a.accel);this.accelSpread=defaultTo(1,a.accelSpread);this.dirSpread=defaultTo(0,a.dirSpread);this.drawCanvas=defaultTo(c,a.drawCanvas);this.makeBounds();this.addCleanUp();this.particles=[];return this.init()}
_.extend(ParticleEmitter.prototype,objectFuncs,{init:function(){this.runListenerName=unique("particle"+this.handle,curLevel.updateListeners.listeners);addListener(curLevel,"update",this.runListenerName,this.run,this);return this},adjust:function(a){for(var b in a)this[b]=a[b];this.makeBounds()},makeBounds:function(){this.UV=angleToUV(this.dir);var a=this.pos.copy().movePt(this.UV.copy().rotate(-Math.PI/2).mult(this.width/2)),b=this.pos.copy().movePt(this.UV.copy().rotate(Math.PI/2).mult(this.width/
2));this.prodPt=a;this.prodV=a.VTo(b);this.finishPt=a.copy().movePt(this.UV.copy().mult(this.dist));this.finishV=this.finishPt.VTo(this.prodPt)},run:function(){this.generateNew();this.updateParticles();this.draw()},trickleOut:function(){this.updateParticles();this.draw();0==this.particles.length&&this.remove()},generateNew:function(){for(var a=Math.round(Math.random()*this.rate),b=0;b<a;b++)this.particles.push(this.newParticle()),this.onGenerate&&this.onGenerate.func.apply(this.onGenerate.obj)},newParticle:function(){var a=
this.prodPt.copy().movePt(this.prodV.copy().mult(Math.random())),b=Math.max(0.01,this.speed+this.speedSpread*(Math.random()-0.5)),d=Math.max(0,this.accel+this.accelSpread*(Math.random()-0.5)),e=angleToUV(this.dir+this.dirSpread*(Math.random()-0.5)),f=this.getlifespan(a,b,d,e);return{pos:a,V:e.copy().mult(b),accelV:e.copy().mult(d),age:0,lifespan:f}},getlifespan:function(a,b,d,e){a=e.dotProd(this.UV);d=0.5*d*a;b*=a;return(-b+Math.sqrt(b*b-4*d*-this.dist))/(2*d)},updateParticles:function(){for(var a=
this.particles.length-1;0<=a;a-=1){var b=this.particles[a];b.pos.movePt(b.V);b.V.add(b.accelV);b.age++;b.age>b.lifespan&&(this.particles.splice(a,1),this.onArrive&&this.onArrive.func.apply(this.onArrive.obj))}},draw:function(){this.drawCanvas.strokeStyle=this.col.hex;for(var a=0;a<this.particles.length;a++){var b=this.particles[a];c.beginPath();c.moveTo(b.pos.x,b.pos.y);c.lineTo(b.pos.x+2,b.pos.y+2);c.stroke()}},stopFlow:function(){removeListener(curLevel,"update",this.runListenerName);addListener(curLevel,
"update",this.runListenerName,this.trickleOut,this)},remove:function(){this.onRemove&&this.onRemove.func.apply(this.onRemove.obj);this.parentList&&this.parentList.splice(_.indexOf(this.parentList,this),1);removeListener(curLevel,"update",this.runListenerName);removeListener(curLevel,this.cleanUpWith+"CleanUp",this.cleanUpListenerName);this.removed=!0}});
function ArrowFly(a){this.type="ArrowFly";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.pos=a.pos.copy();if(a.posFinal)this.posFinal=a.posFinal,this.UV=this.pos.VTo(this.posFinal).UV(),this.dir=this.UV.angle(),this.dist=this.pos.distTo(this.posFinal);else if(a.V)this.posFinal=this.pos.copy().movePt(a.V),this.UV=a.V.UV(),this.dir=this.UV.angle();else if((a.dir||a.UV)&&a.dist)a.dir?(this.dir=a.dir,this.UV=angleToUV(a.dir)):(this.UV=a.UV,this.dir=this.UV.angle(),this.UV=a.UV),this.posFinal=
this.pos.copy().movePt(this.UV.copy().mult(a.dist)),this.dist=a.dist;this.drawCanvas=defaultTo(c,a.drawCanvas);this.dims=a.dims.copy();this.dimsFinal=defaultTo(this.dims,a.dimsFinal);this.fill=a.fill.copy();this.fillUnround={r:this.fill.r,g:this.fill.g,b:this.fill.b};this.fillFinal=defaultTo(this.fill,a.fillFinal);this.stroke=defaultTo(this.fill,a.stroke.copy());this.fade=defaultTo(!0,a.fade);this.fadeTurns=defaultTo(4,a.fadeTurns);this.strokeUnround={r:this.stroke.r,g:this.stroke.g,b:this.stroke.b};
this.strokeFinal=defaultTo(this.fillFinal,a.strokeFinal);this.alpha=defaultTo(1,a.alpha);this.alphaFinal=defaultTo(this.alpha,a.alphaFinal);this.age=0;this.lifespan=Math.round(a.lifespan/updateInterval);this.getSteps();this.pts=this.getPts();this.onFinish=a.onFinish;return this.init()}
_.extend(ArrowFly.prototype,objectFuncs,toInherit.ArrowFuncs,{getSteps:function(){var a=1/this.lifespan;this.posStep=this.pos.VTo(this.posFinal).mult(a);this.dimsStep=V(this.dimsFinal.dx-this.dims.dx,this.dimsFinal.dy-this.dims.dy).mult(a);this.fillStep={r:a*(this.fillFinal.r-this.fill.r),g:a*(this.fillFinal.g-this.fill.g),b:a*(this.fillFinal.b-this.fill.b)};this.strokeStep={r:a*(this.strokeFinal.r-this.stroke.r),g:a*(this.strokeFinal.g-this.stroke.g),b:a*(this.strokeFinal.b-this.stroke.b)};this.alphaStep=
(this.alphaFinal-this.alpha)*a},init:function(){this.updateListenerName=unique(this.type+defaultTo("",this.handle),curLevel.updateListeners.listeners);addListener(curLevel,"update",this.updateListenerName,this.run,this);this.addCleanUp();return this},run:function(){this.drawCanvas.save();this.drawCanvas.globalAlpha=this.alpha;this.drawCanvas.translate(this.pos.x,this.pos.y);this.drawCanvas.rotate(this.dir);draw.fillPtsStroke(this.pts,this.fill,this.stroke,this.drawCanvas);this.drawCanvas.restore();
this.takeStep();this.age++;this.age==this.lifespan&&(this.onFinish&&this.onFinish.func.apply(this.onFinish.obj),this.fade?(this.alphaStep=-this.alpha/this.fadeTurns,this.remove(),this.updateListenerName=unique(this.type+defaultTo("",this.handle)+"fade",curLevel.updateListeners.listeners),addListener(curLevel,"update",this.updateListenerName,this.runFade,this),this.addCleanUp()):this.remove())},runFade:function(){this.drawCanvas.save();this.drawCanvas.globalAlpha=this.alpha;this.drawCanvas.translate(this.pos.x,
this.pos.y);this.drawCanvas.rotate(this.dir);draw.fillPtsStroke(this.pts,this.fill,this.stroke,this.drawCanvas);this.drawCanvas.restore();this.takeStepFade();this.age++;this.age==this.lifespan+this.fadeTurns&&this.remove()},scale:function(){for(var a=(this.dims.dx+this.dimsStep.dx)/this.dims.dx,b=(this.dims.dy+this.dimsStep.dy)/this.dims.dy,d=0;d<this.pts.length;d++)this.pts[d].x*=a,this.pts[d].y*=b},takeStep:function(){this.pos.movePt(this.posStep);this.dims.add(this.dimsStep);this.scale();this.alpha+=
this.alphaStep;this.fillUnround.r+=this.fillStep.r;this.fillUnround.g+=this.fillStep.g;this.fillUnround.b+=this.fillStep.b;this.strokeUnround.r+=this.strokeStep.r;this.strokeUnround.g+=this.strokeStep.g;this.strokeUnround.b+=this.strokeStep.b;this.fill.setFromUnround(this.fillUnround);this.stroke.setFromUnround(this.strokeUnround)},takeStepFade:function(){this.pos.movePt(this.posStep);this.dims.add(this.dimsStep);this.scale();this.alpha+=this.alphaStep},remove:function(){removeListener(curLevel,"update",
this.updateListenerName);this.removeCleanUp()}});function CheckMark(a,b,d,e,f){var h=P(a.x,a.y+0.6*b.dy),j=P(a.x+0.4*b.dx,a.y+b.dy),k=P(a.x+b.dx,a.y);a=P(a.x+0.35*b.dx,a.y+0.75*b.dy);this.pts=[h,j,k,a];this.col=d;this.stroke=e;this.drawCanvas=f}CheckMark.prototype={draw:function(){draw.fillPtsStroke(this.pts,this.col,this.stroke,this.drawCanvas)}};
function ArrowLine(a,b,d,e,f){this.handle=a;this.pts={line:b,arrow:Array(3)};this.col=d;this.drawCanvas=defaultTo(c,f);a=this.pts.line[this.pts.line.length-1];d=a.VTo(this.pts.line[this.pts.line.length-2]).UV();b=d.copy().rotate(0.5);d=d.copy().rotate(-0.5);this.pts.arrow[0]=a.copy().movePt(b.mult(10));this.pts.arrow[1]=a;this.pts.arrow[2]=a.copy().movePt(d.mult(10));return this.show(e)}
ArrowLine.prototype={draw:function(){for(var a=this.pts.line,b=0;b<a.length-1;b++)draw.line(a[b],a[b+1],this.col,this.drawCanvas);a=this.pts.arrow;draw.line(a[0],a[1],this.col,this.drawCanvas);draw.line(a[1],a[2],this.col,this.drawCanvas)},show:function(a){addListener(curLevel,"update","drawArrow"+this.handle,this.makeDrawFunc(a),this);return this},makeDrawFunc:function(a){var b=0,d=this,e=function(){d.draw()};a&&(e=extend(e,function(){b++;b==a&&removeListener(curLevel,"update","drawArrow"+d.handle)}));
return e},hide:function(){removeListener(curLevel,"update","drawArrow"+this.handle)}};
function TempChanger(a){this.type="tempChanger";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.info=a.info;this.min=defaultTo(100,a.min);this.val=dataHandler.temp(this.info);this.max=defaultTo(1500,a.max);this.sliderPos=a.sliderPos;this.handle="TempChanger"+Math.round(this.min).toString()+Math.round(this.val).toString()+Math.round(this.max).toString()+Math.round(1E3*Math.random());this.totalDots=dataHandler.count(this.info);this.addCleanUp();return this.init()}
_.extend(TempChanger.prototype,objectFuncs,{init:function(){this.sliderId=this.addSlider(1<this.totalDots?"System temperature":"Molecule's kinetic energy",{value:this.valToPercent(this.val)},[{eventType:"slide",obj:this,func:this.parseSlider}],this.sliderPos)},parseSlider:function(a,b){changeTemp(this.info,this.percentToVal(b.value))},remove:function(){this.removeSlider()}});
function RMSChanger(a){this.type="RMSChanger";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.info=a.info;this.min=defaultTo(1,a.min);this.val=dataHandler.RMS(this.info);this.max=defaultTo(15,a.max);this.handle="RMSChanger"+Math.round(this.min).toString()+Math.round(this.val).toString()+Math.round(this.max).toString()+Math.round(1E3*Math.random());this.totalDots=dataHandler.count(this.info);this.sliderPos=a.sliderPos;this.addCleanUp();return this.init()}
_.extend(RMSChanger.prototype,objectFuncs,{init:function(){this.sliderId=this.addSlider(1<this.totalDots?"Molecules' RMS":"Molecule's RMS",{value:this.valToPercent(this.val)},[{eventType:"slide",obj:this,func:this.parseSlider}],this.sliderPos)},parseSlider:function(a,b){changeRMS(this.info,this.percentToVal(b.value))},remove:function(){this.removeSlider()}});function Clamps(a){this.type="Clamps";this.draw=defaultTo(!1,a.draw);this.releaseWith=defaultTo("button",a.releaseWith);this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.clampee=a.clampee;this.currentClamper=void 0;this.clamps=a.clamps;this.wall=this.clampee.wall;this.buttonId="clampRelease"+this.wall.handle;this.wallHandler=this.wall.parent.getSubWallHandler(this.wall.handle,0);this.init()}
_.extend(Clamps.prototype,objectFuncs,{init:function(){this.addCleanUp();this.wall.moveStop();this.assembleClamps();"button"==this.releaseWith?this.makeReleaseButton():this.setupClampClicking();this.draw&&this.drawClamps();this.freezeWall()},assembleClamps:function(){for(var a=0;a<this.clamps.length;a++){var b=this.clamps[a];b.vol&&(b.y=this.wall.volToY(b.vol),b.vol=void 0);b.clamping=!1}this.sortClamps();this.addInitClamp()},sortClamps:function(){for(var a=0;a<this.clamps.length;a++){for(var b=!1,
d=0;d<this.clamps.length-1;d++)this.clamps[d].y>this.clamps[d+1].y&&(this.clamps.switchElements(d,d+1),b=!0);if(!b)break}},addInitClamp:function(){for(var a=this.wall[0].y,b=0;b<this.clamps.length;b++)if(this.clamps[b].y>a){this.clamps.splice(b,0,{y:a,clamping:!0});this.currentClamper=this.clamps[b];break}},makeReleaseButton:function(){var a=this;addButton(this.buttonId,"Release");buttonBind(this.buttonId,function(){a.release()})},removeReleaseButton:function(){removeButton(this.buttonId)},release:function(){var a=
void 0,b=void 0;this.currentClamper.clamping=!1;var d=this.clamps.indexOf(this.currentClamper),e=this.clamps[d+1],d=this.clamps[d-1];e&&(a=e.y);d&&(b=d.y);var f=this;this.wall.releaseWithBounds(b,a,this.wallHandler,function(a){f.activateClamp(a)})},activateClamp:function(a){var b=this.clamps.indexOf(this.currentClamper);this.currentClamper.clamping=!1;this.currentClamper=a<this.currentClamper.y?this.clamps[b-1]:this.clamps[b+1];this.currentClamper.clamping=!0;this.freezeWall()},freezeWall:function(){walls.setSubWallHandler(this.wall.handle,
0,"staticAdiabatic")},remove:function(){this.wall.removed||(this.wall.moveInit(),this.wall.parent.setSubWallHandler(walls.indexOf(this.wall),0,this.wallHandler));"button"==this.releaseWith&&this.removeReleaseButton()}});function sillyArrow(){new ArrowFly({pos:P(100,100),dist:100,V:V(300,30),fill:Col(200,0,0),fillFinal:Col(0,200,0),stroke:Col(0,0,200),dims:V(100,50),dimsFinal:V(50,100),lifespan:5E3,cleanUpWith:"section"})}
function sillierArrow(){return new ArrowStatic({pos:P(100,100),dims:V(100,50),angle:Math.PI,fill:Col(150,0,0),stroke:Col(0,255,255),label:"LOL"})}
function ArrowStatic(a){this.type="ArrowStatic";this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);this.pos=a.pos.copy();this.dims=a.dims.copy();this.pts=this.getPts();this.drawCanvas=defaultTo(c,a.drawCanvas);this.label=a.label?a.label:!1;a.angle?this.angle=a.angle:a.UV&&(this.angle=UVToAngle(a.UV));this.setTextOffset();this.fill=a.fill.copy();this.textCol=defaultTo(Col(255,255,255),a.textCol);this.stroke=defaultTo(a.stroke,Col(0,0,0));this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith);
return this.init()}
_.extend(ArrowStatic.prototype,objectFuncs,toInherit.ArrowFuncs,{init:function(){this.updateListenerName=unique(this.type+defaultTo("",this.handle),curLevel.updateListeners.listeners);this.label?addListener(curLevel,"update",this.updateListenerName,this.runLabel,this):addListener(curLevel,"update",this.updateListenerName,this.runNoLabel,this);this.addCleanUp();return this},runLabel:function(){this.drawCanvas.save();this.drawCanvas.translate(this.pos.x,this.pos.y);this.drawCanvas.rotate(this.angle);draw.fillPtsStroke(this.pts,
this.fill,this.stroke,this.drawCanvas);this.drawCanvas.translate(this.textOffset.dx,this.textOffset.dy);this.drawCanvas.rotate(-this.angle);draw.text(this.label,P(0,0),"13pt calibri",this.textCol,"center",0,this.drawCanvas);this.drawCanvas.restore()},runNoLabel:function(){this.drawCanvas.save();this.drawCanvas.translate(this.pos.x,this.pos.y);this.drawCanvas.rotate(this.angle);draw.fillPtsStroke(this.pts,this.fill,this.stroke,this.drawCanvas);this.drawCanvas.restore()},setTextOffset:function(){this.textOffset=
V(7+5*Math.sin(Math.abs(-this.angle)),5*Math.cos(this.angle))},getDims:function(){return this.dims},move:function(a){this.pos.movePt(a);return this},scale:function(a){this.dims.multVec(a);this.pts=this.getPts();return this},size:function(a){this.dims=a.copy();this.pts=this.getPts();return this},rotate:function(a){this.angle+=a;this.setTextOffset();return this},getAngle:function(){return this.angle},setFill:function(a){this.fill=a.copy()},setStroke:function(a){this.stroke=a.copy()},remove:function(){removeListener(curLevel,
"update",this.updateListenerName);this.removeCleanUp()}});function AuxPicture(a){this.type="AuxPicture";this.cleanUpWith="block";this.dims=this.getDims();this.bgCol=curLevel.bgCol;this.makeDiv();this.addImage(a);this.addCleanUp()}
_.extend(AuxPicture.prototype,AuxFunctions,objectFuncs,{makeDiv:function(){this.parentDiv=this.pickParentDiv("picture");this.parentDiv.html("");$(this.parentDiv).css("width",this.dims.dx).css("height",this.dims.dy).css("background-color",this.bgCol.hex).css("border-radius",20).css("padding",0)},addImage:function(a){$(this.parentDiv).append("<center><img src="+a+"></img></center")},remove:function(){this.cleanUpParent()}});function AnimText(a){this.drawCanvas=a}
AnimText.prototype={newAnim:function(a,b,d){var e="animText"+Math.round(1E4*Math.random()),f=d.text,h=new Boolean,j=new Boolean,k=new Boolean,l=new Boolean,h=void 0!==b.pos,j=void 0!==b.col,k=void 0!==b.rotation,l=void 0!==b.size,m;m=Col(255,255,255);var n=defaultTo("calibri",d.font),q=defaultTo("center",d.align);d=defaultTo(300,d.time);var r,s,u,p;a.size=defaultTo(13,a.size);a.rot=defaultTo(0,a.rot);a.col=defaultTo(m,a.col);r=a.size;s=a.rot;u=a.col;p=a.pos.copy();var t=Math.floor(d/updateInterval),
v=function(){},w=function(){},x=function(){},y=function(){},z,A,B,C,E,F;h&&(h=V(b.pos.x-a.pos.x,b.pos.y-a.pos.y),z=h.UV().mult(h.mag()/t),v=function(){p.x+=z.dx;p.y+=z.dy});j&&(A=Math.ceil((b.col.r-a.col.r)/t),B=Math.ceil((b.col.g-a.col.g)/t),C=Math.ceil((b.col.b-a.col.b)/t),w=function(){u.adjust(A,B,C)});k&&(j=b.rotation-a.rotation,E=j<=Math.PI?j/t:-j/t,x=function(){s+=E});l&&(F=(b.size-a.size)/t,y=function(){r+=F});var G=0,H=this.drawCanvas;addListener(curLevel,"update",e,function(){draw.text(f,
p,Math.floor(r)+"pt "+n,u,q,s,H);v();w();x();y();G==t&&removeListener(curLevel,"update",e);G++},"")}};function Readout(a,b,d,e,f,h,j){this.handle=a;this.align=defaultTo("left",j);this.drawCanvas=c;this.font=defaultTo("13pt calibri",f);this.fontCol=defaultTo(Col(255,255,255),h);this.leftBound=b;this.width=d-b;this.y=e;this.entries=[];curLevel.readouts[a]=this}
Readout.prototype={draw:function(){this.drawCanvas.save();this.drawCanvas.translate(this.leftBound,this.y);for(var a=0;a<this.entries.length;a++){var b=this.entries[a],d=b.pos,b=b.text+" "+round(b.val,b.decPlaces)+" "+b.units;draw.text(b,d,this.font,this.fontCol,this.align,0,this.drawCanvas)}this.drawCanvas.restore()},hardUpdate:function(a,b){var d=byAttr(this.entries,a,"name");d.val=round(b,d.decPlaces)},tick:function(a,b){var d=byAttr(this.entries,a,"name");isNaN(d.val)&&(d.val=b);var e=(b-d.val)/
10;removeListener(curLevel,"update",this.handle+d.name+"tick");0!=e&&(e=this.makeTickFunc(d,e,b),addListener(curLevel,"update",this.handle+d.name+"tick",e,this))},makeTickFunc:function(a,b,d){return function(){a.val=boundedStep(a.val,d,b);var e=a.decPlaces;round(a.val,e+1)==round(d,e+1)&&removeListener(curLevel,"update",this.handle+a.name+"tick")}},addEntry:function(a,b,d,e,f,h){a={name:a,text:b,units:d,val:e,initVal:e,decPlaces:h};f?this.entries.splice(f,0,a):this.entries.push(a);this.positionEntries();
this.hide().show()},removeEntry:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].name==a)return this.entries.splice(b,1),this.positionEntries(),this;console.log("Tried to remove entry that does not exist: "+a)},entryExists:function(a){for(var b=0;b<this.entries.length;b++)if(this.entries[b].name==a)return!0;return!1},removeAllEntries:function(){this.entries=[]},positionEntries:function(){var a=this.entries.length,b;b=1<a?Math.floor(this.width/(a-1)):this.width;if("center"==this.align){b=
this.width/(a+1);for(var d=0;d<a;d++){var e=this.entries[d],f=b*(d+1),h=0;e.pos=P(f,h)}}else if("left"==this.align)for(d=0;d<a;d++)e=this.entries[d],f=b*d,h=0,e.pos=P(f,h)},getNumEntries:function(){var a=0,b;for(b in this.entries)a++;return a},reset:function(a){var b=byName(this.entries,a);this.tickReadout(b.curVal,b.setPt,a)},resetAll:function(){for(var a=0;a<this.entries.length;a++){var b=this.entries[a];this.hardUpdate(b.initVal,b.name)}},position:function(a){void 0!==a.x&&(this.leftBound=a.x);
void 0!==a.y&&(this.y=a.y)},show:function(){curLevel.readouts[this.handle]=this;addListener(curLevel,"update","drawReadout"+this.handle,this.draw,this);return this},hide:function(){delete curLevel.readouts[this.handle];removeListener(curLevel,"update","drawReadout"+this.handle);return this}};LevelTools={setStds:function(){this.addEqs();this.setDefaultPromptVals();this.graphs={};this.makePromptCleanUpHolders(0);this.eUnits="kJ";this.bgCol=Col(5,17,26);this.wallCol=Col(255,255,255);this.numUpdates=0;this.wallSpeed=defaultTo(1,this.wallSpeed);this.makeListenerHolders();this.dataHandler=dataHandler=new DataHandler;this.gravitying=this.attracting=!1;this.setUpdateRunListener();addListener(this,"data","run",this.dataRun,this);this.spcs=spcs},addEqs:function(){for(var a=0;a<this.sections.length;a++)for(var b=
this.sections[a],d=0;d<b.prompts.length;d++){var e=b.prompts[d],f=e.title,h=e.text,j=e.quiz;f&&(e.title=addEqs(f));h&&(e.text=addEqs(h));if(j)for(e=0;e<j.length;e++)if(f=j[e],f.options)for(optionIdx=0;optionIdx<f.options.length;optionIdx++)for(optionElement in h=f.options[optionIdx],h){var k=h[optionElement];"string"==typeof k&&(h[optionElement]=addEqs(k))}}},move:function(){var a=this.spcs,b;for(b in a)for(var d=a[b].dots,e=0;e<d.length;e++)d[e].x+=d[e].v.dx,d[e].y+=d[e].v.dy},cutSceneStart:function(a,
b,d){addListener(window.curLevel,"prompt"+promptIdx+"CleanUp","endCutScene",function(){this.cutSceneEnd()},this);this.inCutScene=!0;$("#intText").html("");a=defaultTo("",a);this.pause();$("#dashRun").hide();!0===b&&!d?($("#dashCutScene").show(),this.cutSceneText(a),$("#prompt").html("")):"intro"==b?($("#dashIntro").show(),$("#base").hide(),this.cutSceneText(a)):"outro"==b?($("#dashOutro").show(),$("#base").hide(),this.cutSceneText(a)):d&&($("#dashCutScene").show(),$("#base").hide(),this.cutSceneText(a),
this.appendQuiz(d,"intText"));$("#canvasDiv").hide();$("#display").show();this.cutSceneDivShow()},appendQuiz:function(a,b){var d=!1;this.quiz=Array(a.length);this.quiz.allAnswered=function(){for(var a=0;a<this.length;a++)if(!this[a].isAnswered)return 0;return 1};for(var e=0;e<a.length;e++){var f=a[e];if("text"==f.type||"textSmall"==f.type)d=!0;this.appendQuestion(f,b,e)}d&&this.makeSubmitButton(b);$("button").button()},makeSubmitButton:function(a){var b=this;submitHTML="<table border=0><tr><td width=75%></td><td><button id='textAreaSubmit' class='noSelect'>Submit</button></td></tr></table>";
$("#"+a).html($("#"+a).html()+submitHTML);buttonBind("textAreaSubmit",function(){for(var a=0;a<b.quiz.length;a++){var e=b.quiz[a];if("text"==e.type||"textSmall"==e.type){var f=b.getTextAreaId(a),f=$("#"+f).val();""!=f.killWhiteSpace()?(store("userAnswerB"+sectionIdx+"P"+promptIdx+"Q"+a,f),e.answerText(f),e.isAnswered=!0,e.correct=e.answer?0.05>fracDiff(parseFloat(e.answer),parseFloat(f))?!0:!1:!0):(e.correct=!1,e.isAnswered=!1)}}nextPrompt()})},appendQuestion:function(a,b,d){a.answered=!1;a.correct=
!1;"buttons"==a.type?this.appendButtons(a,b,d):"multChoice"==a.type?this.appendMultChoice(a,b,d):"text"==a.type?this.appendTextBox(a,b,3,60,a.units,d):"textSmall"==a.type&&this.appendTextBox(a,b,1,6,a.units,d);this.quiz[d]=a},cutSceneDivShow:function(){$("#intText").show()},cutSceneText:function(a){$("#intText").html(a)},cutSceneEnd:function(){this.inCutScene=!1;this.resume();$("#intText").html("");$("#dashRun").show();$("#dashOutro").hide();$("#dashIntro").hide();$("#dashCutScene").hide();$("#nextPrevDiv").show();
$("#base").show();$("#canvasDiv").show();$("#display").hide();$("#intText").hide()},pause:function(){saveListener(this,"update");saveListener(this,"data");saveListener(this,"wallMove");saveListener(this,"mousedown");saveListener(this,"mouseup");saveListener(this,"mousemove");emptyListener(this,"update");emptyListener(this,"data");emptyListener(this,"wallMove");emptyListener(this,"mousedown");emptyListener(this,"mouseup");emptyListener(this,"mousemove")},resume:function(){loadListener(this,"update");
loadListener(this,"data");loadListener(this,"wallMove");loadListener(this,"mousedown");loadListener(this,"mouseup");loadListener(this,"mousemove");emptySave(this,"update");emptySave(this,"data");emptySave(this,"wallMove");emptySave(this,"mousedown");emptySave(this,"mouseup");emptySave(this,"mousemove")},questionIsCorrect:function(){return this.correct},appendButtons:function(a,b,d){var e;a.isAnswered=!1;a.isCorrect=this.questionIsCorrect;var f=a.options;e="<br><center><table border='0'><tr>";for(var h=
Array(f.length),j=0;j<f.length;j++){var k=f[j];h[j]=defaultTo("question"+d+"option"+j,k.buttonId);e+="<td><button id='"+h[j]+"' class='noSelect'>"+k.text+"</button></td>"}e+="</tr></table></center>";$("#"+b).html($("#"+b).html()+e);this.bindButtonListeners(a,f,h)},bindButtonListeners:function(a,b,d){for(var e=0;e<b.length;e++)this.bindButtonListener(a,b[e],d[e])},bindButtonListener:function(a,b,d){buttonBind(d,function(){b.message&&alert(b.message);b.response&&store("B"+sectionIdx+"P"+promptIdx+"Response",
b.response);b.func&&b.func();a.isAnswered=!0;a.correct=b.isCorrect;nextPrompt()})},appendMultChoice:function(a,b,d){a.answerIs=!1;a.isCorrect=this.questionIsCorrect;var e=a.options,f;f="<br><table width=100%<tr><td width=10%></td><td>";for(var h=Array(e.length),j=0;j<e.length;j++){var k=e[j];h[j]="question"+d+"option"+j;f+="<div id='"+h[j]+"' class='multChoiceBlock'>"+k.text+"</div>"}$("#"+b).html($("#"+b).html()+f);this.bindMultChoiceFuncs(a,e,h)},bindMultChoiceFuncs:function(a,b,d){for(var e=0;e<
b.length;e++)this.bindMultChoiceFunc(a,b[e],d[e])},bindMultChoiceFunc:function(a,b,d){$("#"+d).click(function(){b.message&&alert(b.message);b.response&&store("B"+sectionIdx+"P"+promptIdx+"Response",b.response);b.func&&b.func();a.correct=b.isCorrect;a.isAnswered=!0;nextPrompt()});$("#"+d).hover(function(){$(this).css("background-color",hoverCol.hex)},function(){$(this).css("background-color","transparent")})},appendTextBox:function(a,b,d,e,f,h){f="";a.answerIs=!1;a.answerText=function(b){a.answerTextSubmitted=
b};a.isCorrect=this.questionIsCorrect;a.label=defaultTo("",a.label);h=this.getTextAreaId(h);var j=defaultTo("Type your answer here.",a.text);f=f+"<br>"+a.label;20<e&&(f+="<br>");f+="<textarea id='"+h+"' rows='"+d+"' cols='"+e+"' placeholder='"+j+"'></textarea>";a.units&&(f+=a.units);$("#"+b).html($("#"+b).html()+f)},getTextAreaId:function(a){return"textArea"+a},hideDash:function(){$("#dashIntro").hide();$("#dashRun").hide();$("#dashOutro").hide();$("#dashCutScene").hide()},borderStd:function(a){a=
defaultTo({},a);var b=defaultTo(0,a.wallInfo);walls[b].border([1,2,3,4],5,this.wallCol.copy().adjust(-100,-100,-100),[{y:a.min},{},{},{y:a.min}])},update:function(){this.numUpdates++;turn++;for(var a in this.updateListeners.listeners){var b=this.updateListeners.listeners[a];b.func.apply(b.obj)}for(var d in this.wallMoveListeners.listeners)b=this.wallMoveListeners.listeners[d],b.func.apply(b.obj)},updateData:function(){for(var a in this.dataListeners.listeners){var b=this.dataListeners.listeners[a];
b.func.apply(b.obj)}this.numUpdates=0},delayGraphs:function(){addListener(window.curLevel,"data","run",function(){this.dataRunNoGraphs();addListener(window.curLevel,"data","run",this.dataRun,this)},this)},dataRunNoGraphs:function(){for(var a in this.recordListeners.listeners){var b=this.recordListeners.listeners[a];b.func.apply(b.obj)}},dataRun:function(){for(var a in this.recordListeners.listeners){var b=this.recordListeners.listeners[a];b.func.apply(b.obj)}for(var d in this.graphs)this.graphs[d].active&&
this.graphs[d].addLast()},setUpdateRunListener:function(){this.attracting&&this.gravitying?addListener(this,"update","run",this.updateRunAttractAndGravity,this):this.attracting?addListener(this,"update","run",this.updateRunAttract,this):this.gravitying?addListener(this,"update","run",this.updateRunGravity,this):addListener(this,"update","run",this.updateRunBasic,this)},gravity:function(a){this.gravitying=!0;a=defaultTo("section",a);for(var b=0;b<walls.length;b++)walls[b].setHitMode("Gravity");this.setUpdateRunListener();
addListener(window.curLevel,a+"CleanUp","gravityStop",this.gravityStop,this)},gravityStop:function(){this.gravitying=!1;this.setUpdateRunListener()},doGravity:function(){for(var a in spcs)for(var b=spcs[a].dots,d=0;d<b.length;d++)b[d].v.dy+=gInternal,b[d].y+=0.5*gInternal},attract:function(a){this.attracting=!0;a=defaultTo("section",a);attractor.assignELastAll();this.setUpdateRunListener();addListener(window.curLevel,a+"CleanUp","attractStop",this.attractStop,this)},attractStop:function(){this.attracting=
!1;attractor.zeroAllEnergies();this.setUpdateRunListener()},updateRunBasic:function(){this.move();collide.check();walls.check();this.drawRun()},updateRunGravity:function(){this.move();collide.check();this.doGravity();walls.check();this.drawRun()},updateRunAttract:function(){this.move();collide.check();attractor.attract();walls.check();this.drawRun()},updateRunAttractAndGravity:function(){this.move();collide.check();attractor.attract();this.doGravity();walls.check();this.drawRun()},drawRun:function(){draw.clear(this.bgCol);
draw.dots();draw.walls(walls,this.wallCol)},resetGraphs:function(){for(var a in this.graphs)this.graphs[a].reset()},removeGraph:function(a){this.graphs[a].remove();this.graphs[a]=void 0},removeAllGraphs:function(){for(var a in this.graphs)this.removeGraph(a),delete this.graphs[a]},saveAllGraphs:function(){for(var a in this.graphs)this.graphs[a].save(a+"section"+sectionIdx+"prompt"+promptIdx)},freezeAllGraphs:function(){for(var a in this.graphs)this.graphs[a].freeze()},makeListenerHolders:function(){this.makeListenerHolder("update");
this.makeListenerHolder("wallMove");this.makeListenerHolder("data");this.makeListenerHolder("mousedown");this.makeListenerHolder("mouseup");this.makeListenerHolder("mousemove");this.makeListenerHolder("init");this.makeListenerHolder("record");this.makeListenerHolder("sectionCondition");this.makeListenerHolder("promptCondition");this.makeListenerHolder("sectionCleanUp")},makeListenerHolder:function(a){this[a+"Listeners"]={listeners:{},save:{}};return this[a+"Listeners"]},makePromptCleanUpHolders:function(a){a=
this.sections[a];this.promptCleanUpHolders=Array(a.prompts.length);for(var b=0;b<a.prompts.length;b++)this.promptCleanUpHolders[b]=this.makeListenerHolder("prompt"+b+"CleanUp")},reset:function(){showPrompt(sectionIdx,promptIdx,!0)},setDefaultPromptVals:function(){for(var a=0;a<this.sections.length;a++)for(var b=this.sections[a],d=0;d<b.prompts.length;d++){var e=b.prompts[d];e.finished=!1;e.title=defaultTo("",e.title);e.text=defaultTo("",e.text)}},sectionConditions:function(){var a=1,b={1:void 0,"0":void 0},
d={1:0,"0":0},e=this.sectionConditionListeners.listeners,f;for(f in e){var h=e[f];winResults=h.func.apply(h.obj);a=Math.min(a,winResults.didWin);winResults.alert&&defaultTo(0,winResults.priority)>=d[Number(winResults.didWin)]&&(b[Number(winResults.didWin)]=winResults.alert)}return{didWin:a,alert:b[a]}},promptConditions:function(){var a=1,b={1:void 0,"0":void 0},d={1:0,"0":0},e=this.promptConditionListeners.listeners,f;for(f in e){var h=e[f];winResults=h.func.apply(h.obj);a=Math.min(a,winResults.didWin);
winResults.alert&&defaultTo(0,winResults.priority)>=d[Number(winResults.didWin)]&&(b[Number(winResults.didWin)]=winResults.alert)}return{didWin:a,alert:b[a]}},sectionCleanUp:function(){var a=this.sectionCleanUpListeners.listeners,b;for(b in a){var d=a[b];d.func.apply(d.obj)}},promptCleanUp:function(a){a=this["prompt"+a+"CleanUpListeners"].listeners;for(var b in a){var d=a[b];d.func.apply(d.obj)}}};$(function(){_.extend(Array.prototype,toInherit.ArrayExtenders);_.extend(Math,toInherit.MathExtenders);_.extend(String.prototype,toInherit.StringExtenders);hoverCol=Col(0,81,117);dotManager=new DotManager;turn=0;$("#canvasDiv").hide();$("#base").hide();$("#dashIntro").hide();$("#dashRun").hide();$("#dashOutro").hide();$("#dashCutScene").hide();$("#display").hide();$("#intText").hide();canvas=document.getElementById("myCanvas");c=canvas.getContext("2d");R=8.314;cv=1.5*R;cp=2.5*R;compAdj="32";extraIntervals=
{};vConst=1E-4;pConst=16.3562;tConst=20;LtoM3=0.001;ATMtoPA=101325;PUNITTOPA=BARTOPA=1E5;JtoKJ=0.001;N=1E3;pxToE=Math.sqrt(tConst);KB=1.38*Math.pow(10,-23);ACTUALN=6.022*Math.pow(10,23);g=1.75;gInternal=0.01;workConst=1.58E-4;updateInterval=30;dataInterval=1250;borderCol=Col(155,155,155);pxToMS=19.33821;auxHolderDivs=["aux1","aux2"];sectionIdx=promptIdx=0;sliderList=[];spcs={};stored={};draw=new DrawingTools;collide=new CollideHandler;attractor=new Attractor;turnUpdater=setInterval("curLevel.update()",
updateInterval);dataUpdater=setInterval("curLevel.updateData()",dataInterval);started=!1;total=counted=0});function gauss(a,b){var d=Math.random()+Math.random()+Math.random()-1.5;return a+d*b}function boundedStep(a,b,d){d=Math.abs(d);var e=1;if(a==b)return a;e=b-a;e=Math.abs(e)/e;return e*Math.min(a*e+d,b*e)}
function addSpecies(a){var b=!1;if(String(a)===a)!spcs[a]&&a&&(b=speciesDefs[a],spcs[a]=new Species(b.m,b.r,b.cols,b),b=!0);else if(a instanceof Array)for(var d=0;d<a.length;d++){var e=a[d];!spcs[e]&&e&&(b=speciesDefs[e],spcs[e]=new Species(b.m,b.r,b.cols,b),b=!0)}b&&collide.setup()}function removeSpecies(a){if(String(toRemove)===toRemove)spcs[toRemove]=void 0;else if(a instanceof Array)for(var b=0;b<a.length;b++)spcs[toAdd[b]]=void 0;collide.setup()}
function changeTemp(a,b){for(var d=dotManager.get(a),e=0;e<d.length;e++)d[e].setTemp(b)}function changeRMS(a,b){for(var d=dotManager.get(a),e=rms(dataHandler.velocities(a)),e=b/e,f=0;f<d.length;f++)d[f].v.mult(e)}function tempToV(a,b){b=2*b/tConst;return Math.sqrt(b/a)}function VToTemp(a,b){return 0.5*a*b*b*tConst}
function returnEscapist(a){returnTo=defaultTo(0,a.returnTo);var b=walls[returnTo][0],d=walls[returnTo][1],e=walls[returnTo].wallUVs[0],f=(b.x+d.x)/2-5*e.dy,b=(b.y+d.y)/2+5*e.dx;a.v.dy=Math.abs(a.v.dy);a.x=f;a.y=b}function defaultTo(a,b){return void 0!==b?b:a}function validNumber(a){return!isNaN(a)?a:!1}function round(a,b){var d=Math.pow(10,b);return Math.round(a*d)/d}
function unique(a,b){if("function"==typeof b){if(b(a)){for(var d=1;b(a+d);)d++;return a+d}}else if(b[a]){for(d=1;b[a+d];)d++;return a+d}return a}function addListener(a,b,d,e,f){a[b+"Listeners"].listeners[d]={func:e,obj:f}}function addListenerOnce(a,b,d,e,f){a[b+"Listeners"].listeners[d]={func:e,obj:f};a[b+"Listeners"].listeners[d+"Remove"]={func:function(){removeListener(a,b,d);removeListener(a,b,d+"Remove")},obj:""}}
function addInterval(a,b,d,e){extraIntervals[a]=window.setInterval(function(){b.apply(d)},e)}function removeInterval(a){extraIntervals[a]&&(window.clearInterval(extraIntervals[a]),extraIntervals[a]=void 0)}function removeListener(a,b,d){delete a[b+"Listeners"].listeners[d]}function removeSave(a,b,d){delete a[b+"Listeners"].save[d]}function removeListenerByName(a,b,d){for(var e=!1,f=getListenerByName(a,b,d);void 0!==f;)e=!0,delete a[b+"Listeners"].listeners[f],f=getListenerByName(a,b,d);return e}
function removeSaveByName(a,b,d){for(var e=!1,f=getSaveByName(a,b,d);void 0!==f;)e=!0,delete a[b+"Listeners"].save[f],f=getSaveByName(a,b,d);return e}function listenerExists(a,b,d){return void 0!==a[b+"Listeners"].listeners[d]}function emptyListener(a,b){a[b+"Listeners"].listeners={}}function emptySave(a,b){a[b+"Listeners"].save={}}function getListenerByName(a,b,d){for(thisFuncName in a[b+"Listeners"].listeners)if(-1!=thisFuncName.indexOf(d))return thisFuncName}
function getSaveByName(a,b,d){for(thisFuncName in a[b+"Listeners"].save)if(-1!=thisFuncName.indexOf(d))return thisFuncName}function saveListener(a,b){var d=a[b+"Listeners"],e=d.save,d=d.listeners,f;for(f in d)e[f]=d[f]}function loadListener(a,b){var d=a[b+"Listeners"],e=d.save,d=d.listeners,f;for(f in e)d[f]=e[f]}function store(a,b){stored[a]=b}function getStore(a){return stored[a]}function eraseStore(a){a?stored[a]=void 0:stored={}}
function deepCopy(a){var b=new a.constructor,d;for(d in a)b[d]="object"==typeof a[d]?deepCopy(a[d]):a[d];return b}function recordData(a,b,d,e,f){f=defaultTo("record",f);store("record"+a,f);addListener(window.curLevel,f,a,function(){b.pushNumber(d.apply(e))},e)}function recordDataStop(a){var b=getStore("record"+a);removeListener(window.curLevel,b,a)}
function addEqs(a){for(var b=/\|\|EQ[0-9]*(CE|BR|\|\|)/,d;;){var e=b.exec(a);if(null==e)break;str=e[0];/CE$/.test(str)?d='<p><center><img src = "img/'+imgPath+"/eq"+parseFloat(str.slice(4,str.length))+'.gif"</img></center></p>':/BR$/.test(str)?d='<br><center><img src = "img/'+imgPath+"/eq"+parseFloat(str.slice(4,str.length))+'.gif"</img></center>':/\|\|$/.test(str)&&(d='<img src = "img/'+imgPath+"/eq"+parseFloat(str.slice(4,str.length))+'.gif"</img>');a=a.replace(str,d)}return a}
function makeSlider(a,b,d,e,f,h){a=$("#"+a);a.html("");a.append("<center>"+d+"</center>");a.append("<div id='"+b+"parent' style='padding:5px'><div id='"+b+"'></div></div>");divParent=$("#"+b+"parent");sliderDiv=$("#"+b);sliderDiv.slider({});sliderDiv.slider("option",e);for(d=0;d<f.length;d++){var j=f[d];e=j.eventType;var k=j.obj,j=j.func;void 0===k?sliderBind(sliderDiv,e,j,""):sliderBind(sliderDiv,e,j,k)}if(h)div[h]();sliderList.push(b);return a}
function sliderBind(a,b,d,e){a.bind(b,function(a,b){d.apply(e,[a,b])});return a}function addButton(a,b,d){d=defaultTo("buttons",d);$("#"+d).append("<button id="+a+">"+b+"</button>");a=$("button#"+a);a.button();return a}function removeButton(a){$("#"+a).remove()}function buttonBind(a,b){var d=$("#"+a);d.click(b);return d}function hideSliders(){for(;0<sliderList.length;idIdx++)$("#"+sliderList[0]).hide()}function S(a,b,d){showPrompt(a,b,d)}
function showPrompt(a,b,d){var e=window.curLevel.sections[a],f=e.prompts[b],h=a!=sectionIdx;getpromptIdxsToClean(a,b).applyFunc(function(a){curLevel.promptCleanUp(a)});emptyListener(curLevel,"promptCondition");h&&curLevel.makePromptCleanUpHolders(a);if(h||d)curLevel.saveAllGraphs(),curLevel.freezeAllGraphs(),curLevel.removeAllGraphs(),dotManager.clearAll(),curLevel.sectionCleanUp(),emptyListener(curLevel,"sectionCleanUp"),emptyListener(curLevel,"sectionCondition"),e.setup&&e.setup.apply(curLevel),
addListener(curLevel,"sectionCleanUp","removeArrowAndText",function(){removeListenerByName(curLevel,"update","drawArrow");removeListenerByName(window.curLevel,"update","animText")},this),window.curLevel.delayGraphs();f.setup&&f.setup.apply(window.curLevel);f.text=evalText(addStored(f.text));f.quiz||$("#nextPrevDiv").show();sectionIdx=a;promptIdx=b;f.cutScene?window.curLevel.cutSceneStart(f.text,f.cutScene,f.quiz):f.quiz?($("#nextPrevDiv").hide(),$("#prompt").html(defaultTo("",f.text)),window.curLevel.appendQuiz(f.quiz,
"prompt")):$("#prompt").html(f.text);$("#baseHeader").html(f.title)}function getpromptIdxsToClean(a,b){var d=window.curLevel.sections[sectionIdx];if(a>sectionIdx||sectionIdx==a&&b>promptIdx){for(var e=[],f=promptIdx;f<d.prompts.length;f++)e.push(f);return e}return[promptIdx]}function nextPrompt(a){var b=defaultTo({},window.curLevel.sections[sectionIdx].prompts[promptIdx]);return a||checkWillAdvance()?(b&&(b.finished=!0),a=getNextIdxs(),showPrompt(a.newSectionIdx,a.newPromptIdx),!0):!1}
function getNextIdxs(){var a=sectionIdx,b=promptIdx;promptIdx+1==window.curLevel.sections[sectionIdx].prompts.length?sectionIdx+1<window.curLevel.sections.length&&(a++,b=0):b++;return{newSectionIdx:a,newPromptIdx:b}}function getPrevIdxs(){var a=sectionIdx,b=promptIdx;0==promptIdx?0<sectionIdx&&(a--,b=window.curLevel.sections[a].prompts.length-1):b--;return{newSectionIdx:a,newPromptIdx:b}}
function checkWillAdvance(){var a=getNextIdxs();(a=Math.min(1,checkWillAdvanceConditions(a.newSectionIdx,a.newPromptIdx)))&&(a=Math.min(a,checkWillAdvanceQuiz()));return a}
function checkWillAdvanceConditions(a){var b=sectionIdx!=a;a=0;var d=defaultTo({},curLevel.sections[sectionIdx].prompts[promptIdx]),d=defaultTo(!1,d.finished);a=Math.max(a,d);a||(d=curLevel.promptConditions(),d.didWin?b?(b=curLevel.sectionConditions(),b.didWin?a=1:(a=0,alertValid(b.alert))):a=1:(a=0,alertValid(d.alert)));return a}function execListOnObj(a,b){for(var d=0;d<a.length;d++)a[d].apply(b)}
function checkWillAdvanceQuiz(){var a=1,b=curLevel.quiz;if(0<b.length){if(b.allAnswered()){for(var d=0;d<b.length;d++)a=Math.min(a,b[d].isCorrect());return a}alert("You haven't answered all the questions");return 0}return a}function prevPrompt(){var a=getPrevIdxs();showPrompt(a.newSectionIdx,a.newPromptIdx)}
function addStored(a){for(var b,d=/GET_#{0,1}[A-Za-z0-9]\|/;;){var e=d.exec(a);if(null==e)break;e=e[0];e.indexOf("#")?(b=e.slice(5,e.length-1),b=parseFloat(getStore(b))):(b=e.slice(4,e.length-1),b=getStore(b));a=a.replace(e,b)}return a}function evalText(a){for(var b=/EVAL_[0-9\(\)\+\-\*\/]*\|/;;){var d=b.exec(a);if(null==d)break;var d=d[0],e=d.slice(5,e.length-1);try{result=eval(e)}catch(f){console.log("Bad eval "+d+", cmmd is "+e)}a=a.replace(d,result)}return a}
function alertValid(a){void 0!==a&&""!=a&&alert(a)}function fillEmptyGraphDivs(){for(var a=0;a<graphHolderDivs.length;a++)fillEmptyGraphDiv($("#"+graphHolderDivs[a]))}function fillEmptyGraphDiv(a){"empty"==$(a).attr("filledWith")&&new GraphBlank(a)}function rotatePts(a,b,d){for(var e=0;e<a.length;e++)a[e].rotate(b,d)}function mirrorPts(a,b,d){for(var e=0;e<a.length;e++)a[e].mirror(b,d);return a}function angleToUV(a){return V(Math.cos(a),Math.sin(a))}
function UVToAngle(a){return Math.atan2(a.dy,a.dx)}function getSign(a){var b=1;0!=a&&(b=Math.abs(a)/a);return b}function fracDiff(a,b){return Math.abs(a-b)/Math.min(Math.abs(a),Math.abs(b))}function getLen(a){for(var b=0,d=0;d<a.length-1;d++)b+=a[d].distTo(a[d+1]);return b}function nameVar(a){return"section"==currentSetupType?a+"S"+sectionIdx:a+"S"+sectionIdx+"P"+promptIdx}
function byAttr(a,b,d){if(a instanceof Array)for(var e=0;e<a.length;e++){if(a[e][d]==b)return a[e]}else for(e in a)if(a[e][d]==b)return a[e]}function inRect(a,b,d){d=mouseOffset(d);return d.x>=a.x&&d.x<=a.x+b.dx&&d.y>=a.y&&d.y<=a.y+b.dy}function ptInRect(a,b,d){return d.x>=a.x&&d.x<=a.x+b.dx&&d.y>=a.y&&d.y<=a.y+b.dy}function extend(a,b){return function(){return b(a())}}function rms(a){for(var b=0,d=0;d<a.length;d++)b+=a[d]*a[d];b/=a.length;return Math.sqrt(b)}globalMousePos=P(0,0);
function mouseOffset(a){return P(globalMousePos.x-a.offsetLeft,globalMousePos.y-a.offsetTop)}function mouseOffsetDiv(a){return P(globalMousePos.x-$("#"+a).offset().left,globalMousePos.y-$("#"+a).offset().top)}$(document).mousemove(function(a){globalMousePos.x=a.pageX;globalMousePos.y=a.pageY;for(var b in curLevel.mousemoveListeners.listeners)a=curLevel.mousemoveListeners.listeners[b],a.func.apply(a.obj)});
$(document).mousedown(function(){for(var a in curLevel.mousedownListeners.listeners){var b=curLevel.mousedownListeners.listeners[a];b.func.apply(b.obj)}});$(document).mouseup(function(){for(var a in curLevel.mouseupListeners.listeners){var b=curLevel.mouseupListeners.listeners[a];b.func.apply(b.obj)}});

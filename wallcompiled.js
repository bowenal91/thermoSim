function WallHandler(a){var b=a?Array(a.pts.length):[];_.extend(b,WallMethods.main,WallMethods.collideMethods);addListener(curLevel,"sectionCleanUp","walls",b.remove,b);b.cVIsothermal32=b.cVIsothermal;a&&(b.assemble(a),a.handles.length!=a.pts.length&&console.log("NAME YOUR WALLS"),a.handlers&&b.doInitHandlers(a.handlers));b.setup();return b}
WallMethods={main:{assemble:function(a){this.removed=!1;var b=a.pts,d=a.handles;this.numWalls=b.length;this.qArrowFill=Col(200,0,0);this.qArrowFillFinal=Col(100,0,0);this.qArrowStroke=Col(255,255,255);var e=defaultTo([],a.includes),f=defaultTo([],a.bounds),h=defaultTo([],a.vols),j=defaultTo([],a.shows),l=defaultTo([],a.records);a=defaultTo([],a.temps);for(var k=0;k<b.length;k++)this.setWallVals(k,b[k],d[k],f[k],e[k],h[k],j[k],l[k],a[k])},setDefaultReadout:function(a){this.defaultReadout=a;return this},
unsetDefaultReadout:function(){this.defaultReadout=void 0;return this},setBounds:function(a,b){var d=this[this.idxByInfo(a)].bounds,e;for(e in b)d[e]=b[e];return this},setup:function(){this.gridDim=20;this.xSpan=Math.floor(myCanvas.width/this.gridDim);this.ySpan=Math.floor(myCanvas.height/this.gridDim);this.numCols=Math.ceil(myCanvas.width/this.gridDim);this.numRows=Math.ceil(myCanvas.height/this.gridDim);for(var a=0;a<this.length;a++)this.setupWall(a)},doInitHandlers:function(a){if(a instanceof Array)for(var b=
0;b<a.length;b++)if(a[b]instanceof Array)for(var d=a[b],e=0;e<d.length;e++)this.setSubWallHandler(b,e,d[e]);else"string"==typeof a[b]&&this.setWallHandler(b,a[b]);else"string"==typeof a||"object"==typeof a?this.setAllHandler(a):console.log("YOU SEND POOR WALL HANDLERS.  THEY ARE NEITHER STRING NOR ARRAY NOR OBJECT")},setAllHandler:function(a){for(var b=0;b<this.length;b++)this.setWallHandler(b,a)},setWallHandler:function(a,b){for(var d=this.idxByInfo(a),e=0;e<this[d].length;e++)this.setSubWallHandler(d,
e,b)},setSubWallHandler:function(a,b,d){a=this.idxByInfo(a);"string"==typeof d?(this[a+"-"+b]={obj:this,func:this[d]},-1!=d.toLowerCase().indexOf("isothermal")?this[a].isothermalInit():this[a][b].isothermal=!1):"object"==typeof d&&(this[a+"-"+b]=d,d.isothermal?this[a].isothermalInit():this[a][b].isothermal=!1)},getSubWallHandler:function(a,b){return this[this.idxByInfo(a)+"-"+b]},setupWall:function(a){this[a].wallUVs=this.getWallUV(a);this[a].wallPerpUVs=this.getPerpUVs(a);this[a].wallGrids=this.scatterPts(a)},
scatterPts:function(a){var b=this.makeBlankGrid(),d=this[a];d.scatter=Array(d.length-1);var e=d.wallUVs,f=this.gridDim;for(a=0;a<d.scatter.length;a++)for(var h=e[a],j=d[a].distTo(d[a+1]),j=Math.ceil(j/f),l=d[a],k=0;k<j;k++){var m=Math.floor((l.x+h.dx*f*k)/f),n=Math.floor((l.y+h.dy*f*k)/f);(-1!=m||-1!=n)&&b[m][n].push(a)}return b},makeBlankGrid:function(){for(var a=Array(this.numCols+1),b=0;b<this.numCols+1;b++){for(var d=Array(this.numRows+1),e=0;e<this.numRows+1;e++)d[e]=[];a[b]=d}return a},setWallVals:function(a,
b,d,e,f,h,j,l,k){e=defaultTo({yMin:30,yMax:435},e);f=defaultTo(1,f);this[a]=b;_.extend(this[a],WallMethods.wall);this[a].handle=d;this[a].include=f;this[a].hitMode="Std";this[a].v=0;this[a].bounds=e;h&&this[a].setVol(h);this[a].show=defaultTo(!0,j);this.closeWall(this[a]);this[a].ptsInit=this.copyWallPts(this[a]);this[a].g=g;this[a].pConst=pConst;this[a].data={};this[a].data.pInt=[];this[a].data.pExt=[];this[a].data.t=[];this[a].data.RMS=[];this[a].data.v=[];this[a].data.m=[];this[a].data.work=[];
this[a].data.q=[];this[a].recordingTemp={val:!1};this[a].recordingPInt={val:!1};this[a].recordingPExt={val:!1};this[a].recordingVol={val:!1};this[a].recordingWork={val:!1};this[a].recordingMass={val:!1};this[a].recordingQ={val:!1};this[a].recordingRMS={val:!1};this[a].displayingTemp={val:!1};this[a].displayingPInt={val:!1};this[a].displayingPExt={val:!1};this[a].displayingVol={val:!1};this[a].displayingWork={val:!1};this[a].displayingMass={val:!1};this[a].displayingQ={val:!1};this[a].displayingRMS=
{val:!1};this[a].q=0;this[a].pIntLen=35;this[a].eToAdd=0;this[a].isothermal=!1;this[a].tSet=k;this[a].massChunks={};this[a].forceInternal=0;this[a].pLastRecord=turn;this[a].mass=0;this[a].parent=this;this[d]=this[a];(l=defaultTo(!0,l))&&this[a].recordDefaults()},addWall:function(a){this.numWalls++;var b=this.length;this.setWallVals(b,a.pts,a.handle,a.bounds,a.include,a.vol,a.show,a.record,a.temp);this.setupWall(b);this.setWallHandler(b,a.handler)},setPtsInit:function(){for(var a=0;a<this.length;a++)this[a].ptsInit=
this.copyWallPts(this[a])},copyWallPts:function(a){for(var b=a.length,d=Array(b),e=0;e<b;e++)d[e]=a[e].copy();return d},idxByHandle:function(a){for(var b=0;b<this.length;b++)if(a==this[b].handle)return b;console.log("Failed to get wall idx by handle\nHandle:"+a)},idxByInfo:function(a){return parseFloat(a)!=a?this.idxByHandle(a):a},remove:function(){for(var a=this.length-1;0<=a;a-=1)this.removeWall(a);this.removed=!0;emptyListener(curLevel,"wallMove")},removeWall:function(a){this.numWalls-=1;this[a].recordAllStop();
this[a].displayAllStop();this[a].bordered&&this[a].removeBorder();a=this.idxByInfo(a);this[this[a].handle]=void 0;this.splice(a,1);this.removeHandlers(a)},removeHandlers:function(a){for(var b in this)-1!=b.indexOf(a+"-")&&(this[b]=void 0)},closeWall:function(a){a.push(P(a[0].x,a[0].y))},getPerpUVs:function(a){a=this[a].wallUVs;for(var b=Array(a.length),d=0;d<a.length;d++){var e=a[d];b[d]=V(-e.dy,e.dx)}return b},getWallUV:function(a){for(var b=this[a].length-1,d=Array(b),e=0;e<b;e++){var f=this[a][e],
h=this[a][e+1];d[e]=V(h.x-f.x,h.y-f.y).UV()}return d},check:function(){var a=this.gridDim,b=this.xSpan,d=this.ySpan,e=spcs,f;for(f in e)for(var h=e[f].dots,j=0;j<h.length;j++)for(var l=h[j],k=[],m=Math.floor(l.x/a),n=Math.floor(l.y/a),p=Math.max(m-1,0);p<=Math.min(m+1,b);p++)for(var q=Math.max(n-1,0);q<=Math.min(n+1,d);q++)for(var r=0;r<this.length;r++)for(var u=this[r].wallGrids[p][q],s=0;s<u.length;s++){var t=u[s];!1===this.haveChecked([r,t],k)&&(this.checkWallHit(l,[r,t]),k.push([r,t]))}},checkWallHit:function(a,
b){var d=b[0],e=b[1],f=this[d][e],h=this[d].wallUVs[e],j=this[d].wallPerpUVs[e],f=V(a.x+a.v.dx-j.dx*a.r-f.x,a.y+a.v.dy-j.dy*a.r-f.y),f=j.dotProd(f),l=-j.dotProd(a.v),k=this[b[0]].hitMode;if(0>f&&-30<f&&this.isBetween(a,d,e,h))this["didHit"+k](a,d,e,h,l,j)},isBetween:function(a,b,d,e){var f=a.v.dotProd(e),h=f*e.dx,j=f*e.dy,f=P(walls[b][d].x+h,walls[b][d].y+j);d=P(walls[b][d+1].x+h,walls[b][d+1].y+j);b=V(-e.dx,-e.dy);f=V(a.x-f.x,a.y-f.y);a=V(a.x-d.x,a.y-d.y);return 0<=f.dotProd(e)&&0<=a.dotProd(b)},
didHitStd:function(a,b,d,e,f,h){var j=this[b+"-"+d];j.func.apply(j.obj,[a,b,d,e,f,h])},didHitArrow:function(a,b,d,e,f,h){var j=a.v.copy(),l=this[b+"-"+d];l.func.apply(l.obj,[a,b,d,e,f,h]);b=P(a.x,a.y);d=a.v.copy();a=-h.dotProd(a.v);this.drawArrowV(b,j,d,f,a)},didHitArrowSpd:function(a,b,d,e,f,h){var j=a.v.copy(),l=this[b+"-"+d];l.func.apply(l.obj,[a,b,d,e,f,h]);b=P(a.x,a.y);d=a.v.copy();a=-h.dotProd(a.v);this.drawArrowSpd(b,j,d,f,a)},didHitGravity:function(a,b,d,e,f,h){var j=this[b+"-"+d];if(0!=e.dx)var l=
a.y,k=a.v.dy;j.func.apply(j.obj,[a,b,d,e,f,h]);0!=e.dx&&(b=a.v.dy*a.v.dy+2*gInternal*(a.y-l),0<=b?a.v.dy=0<a.v.dy?Math.sqrt(b):-Math.sqrt(b):(a.v.dy=-1E-7,a.y=(a.v.dy*a.v.dy-k*k)/(2*gInternal)+l))},haveChecked:function(a,b){for(var d=0;d<b.length;d++)if(b[d][0]==a[0]&&b[d][1]==a[1])return!0;return!1},totalVolume:function(){for(var a=0,b=0;b<this.length;b++)a+=this[b].include*this.wallArea(b);return a*vConst},wallVolume:function(a){return this.area(this[a].slice(0,this[a].length-1))*vConst},area:function(a){var b=
0,d=this.isConvex(a),e=d.multiplier;if(d.isConvex)return this.areaConvex(a);a=this.splitConcave(a,e);b+=this.area(a[0]);return b+=this.area(a[1])},isConvex:function(a){for(var b=this.getMult(a),d=1;d<a.length-1;d++){var e=this.abcs(a,d),e=this.angleBetweenPts(e.a,e.b,e.c,b);if(e>Math.PI)return{isConvex:!1,multiplier:b}}this.angleBetweenPts(a[a.length-2],a[a.length-1],a[0],b);e=this.angleBetweenPts(a[a.length-1],a[0],a[1],b);return e>Math.PI?{isConvex:!1,multiplier:b}:{isConvex:!0,multiplier:b}},getMult:function(a){var b=
Math.PI*(a.length-2),d=this.getAreaUVs(a),e=this.getIntAngles(a,d,1);a=this.getIntAngles(a,d,-1);if(round(e,2)==round(b,2))return 1;if(round(a,2)==round(b,2))return-1},getAreaUVs:function(a){for(var b=Array(a.length),d=0;d<a.length-1;d++){var e=a[d],f=a[d+1];b[d]=e.VTo(f).UV()}e=a[a.length-1];f=a[0];b[b.length]=e.VTo(f).UV();return b},getIntAngles:function(a,b,d){b=0;for(var e=1;e<a.length-1;e++)b+=this.angleBetweenPts(a[e-1],a[e],a[e+1],d);b+=this.angleBetweenPts(a[a.length-2],a[a.length-1],a[0],
d);return b+=this.angleBetweenPts(a[a.length-1],a[0],a[1],d)},splitConcave:function(a,b){for(var d=Array(a.length+2),e=0;e<a.length;e++)d[e]=a[e];d[d.length-2]=a[0];d[d.length-1]=a[1];for(e=1;e<d.length-1;e++){var f=this.abcs(d,e);if(this.angleBetweenPts(f.a,f.b,f.c,b)>Math.PI)return e==a.length&&(e=0),this.splitAt(d.slice(0,d.length-2),e,b)}},splitAt:function(a,b){a=a.slice(b,a.length).concat(a.slice(0,b));var d=a[0];for(b=2;b<a.length-1;b++)if(!this.crossesWall(d,a[b],a)){var d=a.slice(0,b+1),e=
a.slice(0,1).concat(a.slice(b,a.length));return[d,e]}},abcs:function(a,b){return{a:a[b-1],b:a[b],c:a[b+1]}},crossesWall:function(a,b,d){a.VTo(b);for(var e=1;e<d.length;e++){var f,h;e==d.length-1?(f=d[e],h=d[0]):(f=d[e],h=d[e+1]);if(this.linesCross({p1:a,p2:b},{p1:f,p2:h}))return!0}return!1},linesCross:function(a,b){var d=a.p1.VTo(a.p2),e=b.p1.VTo(b.p2),f=d.mag(),h=e.mag(),d=d.UV(),j=e.UV(),e=this.getDist(a,b,d,j,"p1"),d=this.getDist(a,b,d.neg(),j.neg(),"p2");e.da=round(e.da,5);e.db=round(e.db,5);
d.da=round(d.da,5);d.db=round(d.db,5);f=round(f,5);h=round(h,5);return e.da>=f||e.db>=h||d.da>=f||d.db>=h?!1:!0},getDist:function(a,b,d,e,f){"p1"==f?(a=a.p1,b=b.p1):(a=a.p2,b=b.p2);if(0==d.dx&&0==e.dx)return{da:Infinity,db:Infinity};if(0==d.dx)return f=a.x-b.x,f=Math.abs(f/e.dx),d=b.copy().movePt(e.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==e.dx)return f=b.x-a.x,f=Math.abs(f/d.dx),d=a.copy().movePt(d.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==d.dy&&0==e.dy)return{da:Infinity,
db:Infinity};if(0==d.dy)return f=a.y-b.y,f=Math.abs(f/e.dy),d=b.copy().movePt(e.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};if(0==e.dy)return f=b.y-a.y,f=Math.abs(f/d.dy),d=a.copy().movePt(d.copy().mult(f)),{da:a.distTo(d),db:b.distTo(d)};f=e.dx*d.dy/d.dx-e.dy;if(0==f)return{da:Infinity,db:Infinity};f=(b.y-a.y-d.dy*b.x/d.dx+a.x*d.dy/d.dx)/f;return{da:(b.x+e.dx*f-a.x)/d.dx,db:f}},angleBetweenPts:function(a,b,d,e){var f=a.VTo(b).UV();a=f.copy().neg();b=b.VTo(d).UV();e=f.copy().add(b).rotate(Math.PI/
2*e);a=Math.atan2(a.dy,a.dx);b=Math.atan2(b.dy,b.dx);e=Math.atan2(e.dy,e.dx);return this.distBetweenAngles(a,e)+this.distBetweenAngles(e,b)},distBetweenAngles:function(a,b){0>a&&(a+=2*Math.PI);0>b&&(b+=2*Math.PI);var d=Math.max(a,b),e=Math.min(a,b),d=d-e;return d>Math.PI?2*Math.PI-d:d},areaConvex:function(a){for(var b=0,d=a[0],e=2;e<a.length;e++)b+=d.area(a[e-1],a[e]);return b},drawArrowV:function(a,b,d,e,f){var h=Array(3);h[0]=a.copy().movePt(b.copy().mult(10).neg());h[1]=a.copy();h[2]=a.copy().movePt(d.copy().mult(10));
b="drawArrow"+round(a.x,0)+round(a.y,0);new ArrowLine(b,h,Col(255,0,0),50,c);a=a.copy().movePt(d.mult(15));e=(Math.abs(e)+Math.abs(f))*pxToMS;animText.newAnim({pos:a},{pos:a.copy().movePt({dy:-20}),col:curLevel.bgCol},{text:"deltaV = "+round(e,1)+"m/s",time:3E3})},drawArrowSpd:function(a,b,d){var e=Array(3);e[0]=a.copy().movePt(b.copy().mult(10).neg());e[1]=a.copy();e[2]=a.copy().movePt(d.copy().mult(10));b="drawArrow"+round(a.x,0)+round(a.y,0);new ArrowLine(b,e,Col(255,0,0),50,c);a=a.copy().movePt(d.mult(15));
d=0.1*d.mag()*pxToMS;animText.newAnim({pos:a},{pos:a.copy().movePt({dy:-20}),col:curLevel.bgCol},{text:"Speed = "+round(d,1)+"m/s",time:3E3})}},wall:{reset:function(){for(var a=this.ptsInit,b=0;b<a.length;b++)this[b].x=a[b].x,this[b].y=a[b].y;this.v=this.forceInternal=0;this.parent.setupWall(this.parent.indexOf(this))},setVol:function(a){a=this.volToY(a);this[0].position({y:a});this[1].position({y:a})},volToY:function(a){var b=this[2].distTo(this[3]);a/=vConst*b;this[2].VTo(this[3]).UV().perp("cw");
return this[2].y-a},changeSetPt:function(a,b,d){if(-1!=b.indexOf("isothermal"))var e="cVIsothermal";else-1!=b.indexOf("adiabatic")&&(e="cVAdiabatic");removeListener(curLevel,"wallMove","cV"+this.handle);var f=function(a){this[0].y=a;this[1].y=a;this[this.length-1].y=a};b=a-this[0].y;0!=b&&(b=getSign(b),this.v=d*b,this.parent.setSubWallHandler(this.handle,0,e+compAdj),addListener(curLevel,"wallMove","cV"+this.handle,function(){var b=this[0].y;f.apply(this,[boundedStep(b,a,this.v)]);this.parent.setupWall(this.handle);
round(b,2)==round(a,2)&&(removeListener(curLevel,"wallMove","cV"+this.handle),this.parent.setSubWallHandler(this.handle,0,"staticAdiabatic"),this.v=0)},this))},releaseWithBounds:function(a,b,d,e){this.moveStop();removeListener(curLevel,"wallMove","releaseWithBounds"+this.handle);removeListener(curLevel,"wallMove","cP"+this.handle);this.parent.setSubWallHandler(this.handle,0,d);a=defaultTo(0,a);b=defaultTo(Number.MAX_VALUE,b);var f=g,h=this.bounds;addListener(curLevel,"wallMove","releaseWithBounds"+
this.handle,function(){var d=this[0].y,l=d+this.v+0.5*f;l<a||l>b?(this.moveStop(),this.parent.setSubWallHandler(this.handle,0,"staticAdiabatic"),l<a?(e(a),d=a):(e(b),d=b)):l>h.yMax||l<h.yMin?d=this.hitBounds(d,f,h.yMin,h.yMax):(d=l,this.v+=f);this[0].y=d;this[1].y=d;this[this.length-1].y=d;this.parent.setupWall(this.handle)},this)},moveInit:function(){var a=g,b=this.bounds;addListener(curLevel,"wallMove","cP"+this.handle,function(){var d=this[0].y,e=d+this.v+0.5*a;e>b.yMax||e<b.yMin?d=this.hitBounds(d,
a,b.yMin,b.yMax):(d=e,this.v+=a);this[0].y=d;this[1].y=d;this[this.length-1].y=d;this.parent.setupWall(this.handle)},this)},moveStop:function(){this.v=0;removeListener(curLevel,"wallMove","cP"+this.handle);removeListener(curLevel,"wallMove","releaseWithBounds"+this.handle)},hitBounds:function(a,b,d,e){var f=1,h=Math.max(d,Math.min(e,a+this.v*f+0.5*b*f*f));a=this.v*this.v+2*b*(h-a);if(h==e)var j=(-this.v+Math.sqrt(a))/b;else h==d&&(j=(-this.v-Math.sqrt(a))/b);this.v+=b*j;this.v*=-1;f-=j;-2*this.v<
f*b&&0>this.v&&(d=Math.abs(2*this.v/b),f-=Math.floor(f/d)*d);h=h+this.v*f+0.5*b*f*f;this.v+=b*f;return h},setHitMode:function(a){this.hitMode=a},setDefaultReadout:function(a){this.defaultReadout=a;return this},unsetDefaultReadout:function(){this.defaultReadout=void 0;return this},setTemp:function(a){this.tSet=a},isothermalInit:function(){this.eToAdd=0;var a=1<this.parent.numWalls?dataHandler.countFunc({tag:this.handle}):dataHandler.countFunc();this.isothermal||addListener(curLevel,"data","recordEnergyForIsothermal"+
this.handle,function(){var b=defaultTo(this.tSet,this.data.t[this.data.t.length-1]),b=this.tSet-b;this.eToAdd=cv*a()*b/N},this);for(var b=0;b<this.length;b++)this[b].isothermal=!0;this.isothermal=!0},isothermalStop:function(){this.isothermal=!1;removeListener(curLevel,"data","recordEnergyForIsothermal"+this.handle)},pExt:function(){return this.pConst*this.mass*this.g/(this[1].x-this[0].x)},pInt:function(){var a=this.surfArea(),a=this.pConst*this.forceInternal/((turn-this.pLastRecord)*a);this.forceInternal=
0;this.pLastRecord=turn;this.pIntList[this.pIntIdx]=a;this.pIntIdx++;this.pIntIdx==this.pIntLen&&(this.pIntIdx=0);return this.pIntList.average()},surfArea:function(){var a=0;for(ptIdx=0;ptIdx<this.length-1;ptIdx++)a+=this[ptIdx].distTo(this[ptIdx+1]);return a},updateMass:function(){var a=0,b;for(b in this.massChunks)a+=this.massChunks[b];this.mass=a},setMass:function(a,b){this.massChunks[a]=b;this.updateMass();return this},unsetMass:function(a){if(a)this.massChunks[a]=void 0;else for(a in this.massChunks)this.massChunks[a]=
void 0;this.updateMass();return this},border:function(a,b,d,e){this.bordered=!0;for(var f=c,h=Array(a.length),j=Array(a.length-1),l=[],k=this.wallPerpUVs,m=0;m<a.length;m++)h[m]=this[a[m]].copy();for(m=0;m<a.length-1;m++)j[m]=k[a[m]].copy().neg();for(a=0;a<h.length;a++)k=h[a],k.movePt(e[a]),k.position(e[a]),l.push(k);e=j[j.length-1].copy().mult(b);l.push(h[h.length-1].copy().movePt(e));for(a=h.length-2;0<a;a-=1)e=[j[a],j[a-1]],k=h[a],l.push(this.spacedPt(k,e,b));b=j[0].mult(b);l.push(h[0].copy().movePt(b));
l.push(h[0]);addListener(curLevel,"update","drawBorder"+this.handle,function(){draw.fillPts(l,d,f)},"")},spacedPt:function(a,b,d){b=b[0].add(b[1]);return a.copy().movePt(b.mult(d))},removeBorder:function(){this.bordered=!1;removeListener(curLevel,"update","drawBorder"+this.handle)},recordDefaults:function(){this.recordTemp();this.recordPInt();this.recordVol();this.recordQ()},recordTemp:function(){this.recordingTemp.val=!0;var a=dataHandler.tempFunc({tag:this.handle});recordData("t"+this.handle,this.data.t,
a,this,"update");return this},recordRMS:function(){if(this.recordingTemp.val){this.recordingRMS.val=!0;var a=this.getRMSMass(1<this.parent.numWalls?this.handle:void 0);recordData("RMS"+this.handle,this.data.RMS,function(){return Math.sqrt(3E3*KB*this.data.t[this.data.t.length-1]*ACTUALN/a)},this,"update")}else console.log("Tried to record RMS of wall "+this.handle+" while not recording temp.  Will not record.");return this},getRMSMass:function(a){if(a)for(var b in spcs)for(var d=spcs[b].dots,e=0;e<
d.length;e++)if(a){if(d[e].tag==a)return d[e].m}else return d[e].m},recordPInt:function(){this.recordingPInt.val=!0;this.pIntList=[];this.pIntIdx=0;recordData("pInt"+this.handle,this.data.pInt,this.pInt,this,"update");return this},recordPExt:function(){this.recordingPExt.val=!0;recordData("pExt"+this.handle,this.data.pExt,this.pExt,this,"update");return this},recordVol:function(){this.recordingVol.val=!0;recordData("v"+this.handle,this.data.v,function(){return this.parent.wallVolume(this.handle)},
this,"update");return this},recordWork:function(){if(!this.recordingWork.val){this.recordingWork.val=!0;this.work=0;var a=LtoM3,b=PUNITTOPA,d=JtoKJ,e=this;recordData("work"+this.handle,this.data.work,function(){var f=e.data.v.length,f=a*(e.data.v[f-1]-e.data.v[f-2]);if(void 0!=f){var h=e.pExt()*b;e.work-=d*h*f;return e.work}return e.work=0},this,"update")}return this},recordMass:function(){this.recordingMass.val||(this.recordingMass.val=!0,recordData("mass"+this.handle,this.data.m,function(){return this.mass},
this,"update"));return this},recordQ:function(){this.recordingQ.val||(this.recordingQ.val=!0,recordData("q"+this.handle,this.data.q,function(){return this.q},this,"update"));return this},recordStop:function(a,b){a.val=!1;recordDataStop(b+this.handle)},recordAllStop:function(){this.recordingTemp.val&&this.recordStop(this.recordingTemp,"t");this.recordingPInt.val&&this.recordStop(this.recordingPInt,"pInt");this.recordingPExt.val&&this.recordStop(this.recordingPExt,"pExt");this.recordingVol.val&&this.recordStop(this.recordingVol,
"v");this.recordingWork.val&&this.recordStop(this.recordingWork,"work");this.recordingMass.val&&this.recordStop(this.recordingMass,"mass");this.recordingQ.val&&this.recordStop(this.recordingQ,"q");this.recordingRMS.val&&this.recordStop(this.recordingRMS,"RMS");return this},resetWork:function(){this.work=0;return this},resetQ:function(){this.q=0;return this},displayWork:function(a,b,d){if(this.recordingWork.val&&!this.displayingWork.val){this.displayingWork.val=!0;d=defaultTo(1,d);var e=this.data.work;
b=defaultTo("Work:",b);this.workReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.workReadout.addEntry("work"+this.handle,b,"kJ",a,void 0,d);addListener(curLevel,"update","displayWork"+this.handle,function(){this.workReadout.hardUpdate("work"+this.handle,e[e.length-1])},this);this.addCleanUpIfPrompt("displayWork",this.displayWorkStop)}else console.log("Tried to display work of wall "+this.handle+" while not recording.  Will not display.");return this},
displayTemp:function(a,b,d,e){if(this.recordingTemp.val&&!this.displayingTemp.val){this.displayingTemp.val=!0;d=defaultTo(0,d);var f=this.data.t;b=defaultTo("Temp:",b);this.tempReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=f[f.length-1];validNumber(a)||(a=0);this.tempReadout.addEntry("temp"+this.handle,b,"K",a,void 0,d);e?addListener(curLevel,"update","displayTemp"+this.handle,function(){for(var a=0,b=f.length-5;b<f.length;b++)a+=f[b];this.tempReadout.hardUpdate("temp"+this.handle,0.2*
a)},this):addListener(curLevel,"update","displayTemp"+this.handle,function(){this.tempReadout.hardUpdate("temp"+this.handle,f[f.length-1])},this);this.addCleanUpIfPrompt("displayTemp",this.displayTempStop)}else console.log("Tried to display temp of wall "+this.handle+" while not recording.  Will not display.");return this},displayTempSmooth:function(a,b,d){return this.displayTemp(a,b,d,!0)},displayPInt:function(a,b,d){if(this.recordingPInt.val&&!this.displayingPInt.val){this.displayingPInt.val=!0;
d=defaultTo(1,d);var e=this.data.pInt;b=defaultTo("Pint:",b);this.pIntReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.pIntReadout.addEntry("pInt"+this.handle,b,"bar",a,void 0,d);addListener(curLevel,"update","displayPInt"+this.handle,function(){this.pIntReadout.hardUpdate("pInt"+this.handle,e[e.length-1])},this);this.addCleanUpIfPrompt("displayPInt",this.displayPIntStop)}else console.log("Tried to display pInt of wall "+this.handle+" while not recording.  Will not display.");
return this},displayPExt:function(a,b,d){if(this.recordingPExt.val&&!this.displayingPExt.val){this.displayingPExt.val=!0;d=defaultTo(1,d);var e=this.data.pExt;b=defaultTo("Pext:",b);this.pExtReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.pExtReadout.addEntry("pExt"+this.handle,b,"bar",a,void 0,d);var f=0;addListener(curLevel,"update","displayPExt"+this.handle,function(){var a=e[e.length-1];a!=f&&(this.pExtReadout.tick("pExt"+this.handle,a),f=a)},
this);this.addCleanUpIfPrompt("displayPExt",this.displayPExtStop)}else console.log("Tried to display pExt of wall "+this.handle+" while not recording.  Will not display.");return this},displayVol:function(a,b,d){if(this.recordingVol.val&&!this.displayingVol.val){this.displayingVol.val=!0;d=defaultTo(1,d);var e=this.data.v;b=defaultTo("Volume:",b);this.volReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.volReadout.addEntry("vol"+this.handle,b,"L",
a,void 0,d);addListener(curLevel,"update","displayVolume"+this.handle,function(){this.volReadout.hardUpdate("vol"+this.handle,e[e.length-1])},this);this.addCleanUpIfPrompt("displayVol",this.displayVolStop)}else console.log("Tried to display volume of wall "+this.handle+" while not recording.  Will not display.");return this},displayMass:function(a,b,d){if(this.recordingMass.val&&!this.displayingMass.val){this.displayingMass.val=!0;d=defaultTo(0,d);var e=this.data.m;b=defaultTo("Mass:",b);this.massReadout=
defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.massReadout.addEntry("mass"+this.handle,b,"kg",a,void 0,d);var f=0;addListener(curLevel,"update","displayMass"+this.handle,function(){var a=e[e.length-1];a!=f&&(this.massReadout.hardUpdate("mass"+this.handle,a),f=a)},this);this.addCleanUpIfPrompt("displayMass",this.displayMassStop)}else console.log("Tried to display mass of wall "+this.handle+" while not recording.  Will not display.");return this},displayQ:function(a,
b,d){if(this.recordingQ.val&&!this.displayingQ.val){this.displayingQ.val=!0;d=defaultTo(1,d);var e=this.data.q;b=defaultTo("Q:",b);this.qReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.qReadout.addEntry("q"+this.handle,b,"kJ",a,void 0,d);var f=0;addListener(curLevel,"update","displayQ"+this.handle,function(){var a=e[e.length-1];a!=f&&(this.qReadout.hardUpdate("q"+this.handle,a),f=a)},this);this.addCleanUpIfPrompt("displayQ",this.displayQStop)}else console.log("Tried to display q of wall "+
this.handle+" while not recording.  Will not display.");return this},displayRMS:function(a,b,d){if(this.recordingRMS.val&&!this.displayingRMS.val){this.displayingRMS.val=!0;d=defaultTo(0,d);var e=this.data.RMS;b=defaultTo("RMS:",b);this.RMSReadout=defaultTo(curLevel.readout,curLevel.readouts[a]);a=e[e.length-1];validNumber(a)||(a=0);this.RMSReadout.addEntry("RMS"+this.handle,b,"m/s",a,void 0,d);addListener(curLevel,"data","displayRMS"+this.handle,function(){this.RMSReadout.tick("RMS"+this.handle,
e[e.length-1])},this);this.addCleanUpIfPrompt("displayRMS",this.displayRMSStop)}else console.log("Tried to display RMS of wall "+this.handle+" while not recording.  Will not display.");return this},displayQArrowsRate:function(a){this.recordingQ.val&&!this.displayingQArrowsRate.val&&!this.displayingQArrowsAmmt.val?(this.displayingQArrowsRate.val=!0,this.idxLastArrow=Math.max(0,this.data.q.length-1),this.qArrowThreshold=defaultTo(a,0.3),addListener(curLevel,"update","checkForDisplayArrows"+this.handle,
this.checkDisplayArrows,this)):(console.log("Tried to display q arrowsRate for wall "+this.handle+" while not recording or already displaying.  Will not display."),console.trace())},displayQArrowsAmmt:function(a){this.recordingQ.val&&!this.displayingQArrowsRate.val&&!this.displayingQArrowsAmmt.val?(this.displayingQArrowsAmmt.val=!0,this.qArrowsAmmtInit(defaultTo(3,a))):(console.log("Tried to display q arrowsAmmt for wall "+this.handle+" while not recording or already displaying.  Will not display."),
console.trace())},addCleanUpIfPrompt:function(a,b){-1!=currentSetupType.indexOf("prompt")&&addListener(curLevel,currentSetupType+"CleanUp",a+this.handle,b,this)},displayVolStop:function(){this.displayingVol=!1;this.volReadout.removeEntry("vol"+this.handle);removeListener(curLevel,"update","displayVolume"+this.handle);return this},displayPIntStop:function(){this.displayingPInt=!1;removeListener(curLevel,"data","displayPInt"+this.handle);this.pIntReadout.removeEntry("pInt"+this.handle);return this},
displayPExtStop:function(){this.displayingPExt=!1;removeListener(curLevel,"update","displayPExt"+this.handle);this.pExtReadout.removeEntry("pExt"+this.handle);return this},displayWorkStop:function(){this.displayingWork=!1;this.workReadout.removeEntry("work"+this.handle);removeListener(curLevel,"update","displayWork"+this.handle);return this},displayTempStop:function(){this.displayingTemp=!1;removeListener(curLevel,"update","displayTemp"+this.handle);this.tempReadout.removeEntry("temp"+this.handle);
return this},displayMassStop:function(){this.displayingMass=!1;removeListener(curLevel,"data","displayMass"+this.handle);this.massReadout.removeEntry("mass"+this.handle);return this},displayQStop:function(){this.displayingQ=!1;removeListener(curLevel,"data","displayQ"+this.handle);this.qReadout.removeEntry("q"+this.handle);return this},displayQArrowsRateStop:function(){this.displayingQArrowsRate=!1;removeListener(curLevel,"update","checkDisplayArrows"+this.handle);removeListenerByName(curLevel,"update",
"ArrowFly");return this},displayQArrowsAmmtStop:function(){this.displayingQArrowsAmmt=!1;for(var a=0;a<this.qArrowsAmmt.length;a++)this.qArrowsAmmt[a].remove();removeListener(curLevel,"update",this.handle+"updateQAmmtArrows")},displayRMSStop:function(){this.displayingRMS=!1;removeListener(curLevel,"data","displayRMS"+this.handle);this.RMSReadout.removeEntry("RMS"+this.handle);return this},displayAllStop:function(){this.displayingVol&&this.displayVolStop();this.displayingPInt&&this.displayPIntStop();
this.displayingPExt&&this.displayPExtStop();this.displayingWork&&this.displayWorkStop();this.displayingTemp&&this.displayTempStop();this.displayingMass&&this.displayMassStop();this.displayingQ&&this.displayQStop();this.displayingQArrowsRate&&this.displayQArrowsRateStop();this.displayingQArrowAmmt&&this.displayQArrowsAmmtStop();this.displayingRMS&&this.displayRMSStop();return this},resetQ:function(){this.q=0;this.displayingQArrowsAmmt&&(this.displayQArrowsAmmtStop(),this.displayQArrowsAmmt(this.qArrowAmmtMax))},
resetWork:function(){this.work=0},qArrowsAmmtInit:function(a){this.qArrowAmmtMax=a;Col(175,0,0);var b=V(30,10),d=this[3].copy().fracMoveTo(this[2],0.25),e=this[3].copy().fracMoveTo(this[2],0.75),f=e.VTo(d).perp("cw").UV();d.movePt(f.copy().mult(5));e.movePt(f.copy().mult(5));var d=new ArrowStatic({pos:d,dims:b,fill:Col(175,0,0),stroke:Col(0,0,0),label:"Q",UV:f}),b=new ArrowStatic({pos:e,dims:b,fill:Col(175,0,0),stroke:Col(0,0,0),label:"Q",UV:f}),h=a/65;this.qArrowsAmmt=[d,b];var j="out";qLast=this.q;
this.setAmmtArrowDims(this.qArrowsAmmt,15,80,70,90,this.q,a);0<=this.q&&(j="in",this.flipAmmtArrows(this.qArrowsAmmt));addListener(curLevel,"update",this.handle+"updateQAmmtArrows",function(){Math.abs(this.q-qLast)>h&&(dir=0>this.q?"out":"in",this.setAmmtArrowDims(this.qArrowsAmmt,15,80,70,90,this.q,a),j!=dir&&(this.flipAmmtArrows(this.qArrowsAmmt),j=dir),qLast=this.q)},this)},flipAmmtArrows:function(a){for(var b=0;b<a.length;b++){var d=a[b],e=angleToUV(d.getAngle()).mult(1);d.move(e.mult(d.getDims().dx));
d.rotate(Math.PI)}},setAmmtArrowDims:function(a,b,d,e,f,h,j){for(var l=0;l<a.length;l++){var k=a[l],m=k.getDims(),n=Math.abs(this.q)/j,p=b+(d-b)*n;k.size(V(p,e+(f-e)*n));0<h&&k.move(V(0,p-m.dx))}},checkDisplayArrows:function(){var a=this.data.q[this.data.q.length-1]-this.data.q[this.idxLastArrow];Math.abs(a)>this.qArrowThreshold&&(this.populateArrows(a),this.idxLastArrow=turn)},populateArrows:function(a){var b=this.parent.qArrowFill,d=this.parent.qArrowFillFinal,e=this.parent.qArrowStroke,f=getSign(a),
h={"-1":"cw",1:"ccw"}[f];this.idxLastArrow=this.data.q.length-1;a=V(110*Math.abs(a),170*Math.abs(a));var j=a.copy();j.dx*=1.4;j.dy*=0.85;var l={"-1":0,1:-j.dx-30};if(7<a.dx||7<a.dy)for(var k=0;k<this.length-1;k++)if(this[k].isothermal)for(var m=this[k].distTo(this[k+1]),n=Math.round(m/150),p=m/=n+1,q=0;q<n;q++){var r=this[k].copy().movePt(this.wallUVs[k].copy().mult(p)).movePt(this.wallPerpUVs[k].copy().mult(l[f]));new ArrowFly({pos:r,dist:30,UV:this.wallUVs[k].copy().perp(h),fill:b,fillFinal:d,stroke:e,
dims:a,dimsFinal:j,lifespan:3500});p+=m}}},collideMethods:{cPAdiabaticDamped:function(a,b,d,e,f){e=this[b];a.v.copy();var h=a.v.dy,j=e.v,l=a.m,k=e.mass,m=Math.abs(j);if(1<m){b=h*h;d=j*j;var m=0.0017*m*m*m-0.0281*m*m+0.205*m+0.8466,n=m*m,p=l*(1+l/(n*k)),q=-2*l*(h*l/k+j)/n;a.v.dy=(-q+Math.pow(q*q-4*p*((l*(l*b/k+2*j*h)+k*d)/n-l*b-k*d),0.5))/(2*p);a.y+=a.r;e.v=(l*h+k*j-l*a.v.dy)/(k*m)}else b=walls[b][d],a.v.dy=(h*(l-k)+2*k*j)/(a.m+k),e.v=(j*(k-l)+2*l*h)/(k+l),a.y=b.y+a.r;e.forceInternal+=a.m*(Math.abs(f)+
Math.abs(a.v.dy))},cPAdiabaticDamped32:function(a,b,d,e,f){e=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);var h=this[b];a.v.copy();var j=a.v.dy,l=h.v,k=a.m,m=h.mass,n=Math.abs(l);if(1<n){b=j*j;d=l*l;var n=0.0017*n*n*n-0.0281*n*n+0.205*n+0.8466,p=n*n,q=k*(1+k/(p*m)),r=-2*k*(j*k/m+l)/p;a.v.dy=(-r+Math.sqrt(r*r-4*q*((k*(k*b/m+2*l*j)+m*d)/p-k*b-m*d)))/(2*q);a.y+=a.r;h.v=(k*j+m*l-k*a.v.dy)/(m*n)}else b=walls[b][d],a.v.dy=(j*(k-m)+2*m*l)/(a.m+m),h.v=(l*(m-k)+2*k*j)/(m+k),a.y=b.y+a.r;h.forceInternal+=a.m*(Math.abs(f)+
Math.abs(a.v.dy));f=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);f=Math.sqrt((e+2*(f-e)/3)/f);a.v.dx*=f;a.v.dy*=f},cPAdiabatic:function(a,b,d,e,f){b=this[b];a.v.copy();e=a.v.dy;var h=b.v,j=a.m,l=b.mass;d=b[d];a.v.dy=(e*(j-l)+2*l*h)/(a.m+l);b.v=(h*(l-j)+2*j*e)/(l+j);a.y=d.y+a.r;b.forceInternal+=a.m*(Math.abs(f)+Math.abs(a.v.dy))},cPAdiabatic32:function(a,b,d,e,f){e=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);b=this[b];a.v.copy();var h=a.v.dy,j=b.v,l=a.m,k=b.mass;d=b[d];a.v.dy=(h*(l-k)+2*k*j)/(a.m+k);b.v=(j*(k-
l)+2*l*h)/(k+l);a.y=d.y+a.r;b.forceInternal+=a.m*(Math.abs(f)+Math.abs(a.v.dy));f=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);f=Math.sqrt((e+2*(f-e)/3)/f);a.v.dx*=f;a.v.dy*=f},staticAdiabatic:function(a,b,d,e,f){this.reflect(a,e,f);this[b].forceInternal+=2*a.m*Math.abs(f)},cVIsothermal:function(a,b,d,e,f){var h=getSign(this[b].eToAdd);d=a.temp();var j=h*Math.min(1,h*this[b].eToAdd),h=h*Math.min(h*j,cv*(d-Math.min(d,20))/N);this[b].eToAdd-=h;d=Math.sqrt((d+h*N/cv)/d);j=f*d;this.reflect(a,e,f);a.v.dx*=d;
a.v.dy*=d;this[b].forceInternal+=a.m*(Math.abs(f)+Math.abs(j));this[b].q+=h*JtoKJ},cVAdiabatic:function(a,b,d,e,f){d=a.v;d.dy=-d.dy+2*walls[b].v;this[b].forceInternal+=a.m*(f+d.dy)},cVAdiabatic32:function(a,b,d,e,f){d=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);e=a.v;e.dy=-e.dy+2*walls[b].v;this[b].forceInternal+=a.m*(f+e.dy);b=0.5*a.m*(a.v.dx*a.v.dx+a.v.dy*a.v.dy);b=Math.sqrt((d+2*(b-d)/3)/b);a.v.dx*=b;a.v.dy*=b},reflect:function(a,b,d){a.v.dx-=2*b.dy*d;a.v.dy+=2*b.dx*d;a.x-=b.dy;a.y+=b.dx}}};

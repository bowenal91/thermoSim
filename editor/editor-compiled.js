function Dot(a,b,c,d,e,f,g,h,l){this.x=a;this.y=b;this.v=c;this.m=d;this.r=e;this.spcName=f;this.idNum=g;this.tag=h;this.returnTo=l;this.tConst=tConst;this.pxToE=pxToE;this.parentLists=[];this.peCur=this.tempLast=this.peLast=0;a=speciesDefs[f];this.attractStr=a.attractStr;this.attractStrs=a.attractStrs;this.attractRad=a.attractRad;return this}function Species(a,b,c,d){this.m=a;this.r=b;this.cols=c;this.def=d;this.idNum=d.idNum;this.dots=dotManager.addSpcs(d.spcName)}
Species.prototype={populate:function(a,b,c,d,e,f){var g=a.x;a=a.y;var h=b.dx;b=b.dy;for(var l=[],j=0;j<c;j++){var k=g+Math.random()*h,m=a+Math.random()*b,n=tempToV(this.m,d),p=2*Math.random()*Math.PI,q=n*Math.cos(p),n=n*Math.sin(p);l.push(D(k,m,V(q,n),this.m,this.r,this.def.spcName,this.def.idNum,e,f))}dotManager.add(l)},depopulate:function(a){console.trace();a?dotManager.removeByInfo({name:this.def.spcName,tag:a}):dotManager.removeByInfo({name:this.def.spcName})}};
function Point(a,b){this.x=a;this.y=b;return this}function Vector(a,b){this.dx=a;this.dy=b;return this}function Color(a,b,c){this.r=a;this.g=b;this.b=c;this.setHex();return this}function D(a,b,c,d,e,f,g,h,l){return new Dot(a,b,c,d,e,f,g,h,l)}function P(a,b){return new Point(a,b)}function V(a,b){return new Vector(a,b)}function Col(a,b,c){return new Color(a,b,c)}
Vector.prototype={UV:function(){var a=Math.sqrt(this.dx*this.dx+this.dy*this.dy);return V(this.dx/a,this.dy/a)},mag:function(){return Math.sqrt(this.dx*this.dx+this.dy*this.dy)},add:function(a){this.dx+=a.dx;this.dy+=a.dy;return this},neg:function(){this.dx*=-1;this.dy*=-1;return this},dotProd:function(a){return this.dx*a.dx+this.dy*a.dy},magSqr:function(){return this.dx*this.dx+this.dy*this.dy},copy:function(){return new Vector(this.dx,this.dy)},mult:function(a){this.dx*=a;this.dy*=a;return this},
multVec:function(a){this.dx*=a.dx;this.dy*=a.dy;return this},setMag:function(a){this.mult(a/this.mag());return this},adjust:function(a,b){this.dx+=a;this.dy+=b;return this},rotate:function(a){var b=this.dx,c=this.dy;this.dx=b*Math.cos(a)-c*Math.sin(a);this.dy=b*Math.sin(a)+c*Math.cos(a);return this},perp:function(a){var b=this.dx,c=this.dy;a?"cw"==a?(this.dx=c,this.dy=-b):(this.dx=-c,this.dy=b):(this.dx=c,this.dy=-b);return this},angle:function(){return Math.atan2(this.dy,this.dx)},sameAs:function(a){return this.dx==
a.dx&&this.dy==a.dy},isValid:function(){return void 0!==this.dx&&!isNaN(this.dx)&&void 0!==this.dy&&!isNaN(this.dy)}};
Color.prototype={adjust:function(a,b,c){this.r=Math.round(Math.min(255,Math.max(0,this.r+a)));this.g=Math.round(Math.min(255,Math.max(0,this.g+b)));this.b=Math.round(Math.min(255,Math.max(0,this.b+c)));this.setHex();return this},set:function(a){void 0!==a.r&&(this.r=a.r);void 0!==a.g&&(this.g=a.g);void 0!==a.b&&(this.b=a.b);this.setHex();return this},setFromUnround:function(a){void 0!==a.r&&(this.r=Math.round(a.r));void 0!==a.g&&(this.g=Math.round(a.g));void 0!==a.b&&(this.b=Math.round(a.b));this.setHex();
return this},setHex:function(){var a=Number(Math.round(this.r)).toString(16),b=Number(Math.round(this.g)).toString(16),c=Number(Math.round(this.b)).toString(16);1==a.length&&(a="0"+a);1==b.length&&(b="0"+b);1==c.length&&(c="0"+c);this.hex=a+b+c},copy:function(){return new Color(this.r,this.g,this.b)},add:function(a){this.r=Math.round(Math.min(255,Math.max(0,this.r+a.r)));this.g=Math.round(Math.min(255,Math.max(0,this.g+a.g)));this.b=Math.round(Math.min(255,Math.max(0,this.b+a.b)));this.setHex();return this},
addNoBounds:function(a){this.r=Math.round(this.r+a.r);this.g=Math.round(this.g+a.g);this.b=Math.round(this.b+a.b);this.setHex();return this},mult:function(a){this.r=Math.round(Math.min(255,Math.max(0,this.r*a)));this.g=Math.round(Math.min(255,Math.max(0,this.g*a)));this.b=Math.round(Math.min(255,Math.max(0,this.b*a)));this.setHex();return this},sameAs:function(a){return this.r==a.r&&this.g==a.g&&this.b==a.b}};
Point.prototype={distTo:function(a){var b=this.x-a.x;a=this.y-a.y;return Math.sqrt(b*b+a*a)},VTo:function(a){return V(a.x-this.x,a.y-this.y)},fracVTo:function(a,b){return this.VTo(a).mult(b)},fracMoveTo:function(a,b){this.movePt(this.fracVTo(a,b));return this},set:function(a){this.x=a.x;this.y=a.y},avg:function(a){return P((this.x+a.x)/2,(this.y+a.y)/2)},area:function(a,b){var c=V(a.x-this.x,a.y-this.y),d=c.UV(),c=c.mag(),d=V(-d.dy,d.dx),e=V(b.x-this.x,b.y-this.y),d=Math.abs(d.dotProd(e));return 0.5*
c*d},copy:function(){return new Point(this.x,this.y)},movePt:function(a){void 0!==a.dx&&(this.x+=a.dx);void 0!==a.dy&&(this.y+=a.dy);return this},position:function(a){void 0!==a.x&&(this.x=a.x);void 0!==a.y&&(this.y=a.y);return this},scale:function(a,b){var c=this.y-a.y;this.x=a.x+(this.x-a.x)*b;this.y=a.y+c*b;return this},rotate:function(a,b){var c=V(a.x,a.y);this.movePt(c.copy().neg());var d=this.x,e=this.y;this.x=d*Math.cos(b)-e*Math.sin(b);this.y=d*Math.sin(b)+e*Math.cos(b);this.movePt(c);return this},
mirror:function(a,b){var c=b.UV(),d=a.VTo(this),c=c.perp("cw"),d=d.dotProd(c);0>d?this.movePt(c.mult(Math.abs(2*d))):0<d&&this.movePt(c.neg().mult(2*d));return this},rect:function(a,b){var c=Array(4);"ccw"==b?(c[0]=this.copy(),c[1]=this.copy().movePt({dy:a.dy}),c[2]=this.copy().movePt(a),c[3]=this.copy().movePt({dx:a.dx})):(c[0]=this.copy(),c[1]=this.copy().movePt({dx:a.dx}),c[2]=this.copy().movePt(a),c[3]=this.copy().movePt({dy:a.dy}));return c},roundedRect:function(a,b,c){a=this.rect(a,c);return this.roundPts(a,
b)},roundPts:function(a,b){this.sameAs(a[0])||(a=[this].concat(a));var c=Array(2*a.length);a["-1"]=a[a.length-1];a.push(a[0]);for(var d=0;d<a.length-1;d++)c[2*d]=a[d].copy().fracMoveTo(a[String(d-1)],b/2),c[2*d+1]=a[d].copy().fracMoveTo(a[String(d+1)],b/2);return c},sameAs:function(a){return this.x==a.x&&this.y==a.y},closeTo:function(a){return 1>Math.abs(this.x-a.x)&&1>Math.abs(this.y-a.y)},isValid:function(){return void 0!==this.x&&!isNaN(this.x)&&void 0!==this.y&&!isNaN(this.y)},track:function(a){if(a instanceof
Point)b=a,d=e=c=!1;else var b=a.pt,c=a.offset,d=defaultTo("",a.noTrack),e=d.indexOf("x")+1,d=d.indexOf("y")+1;this.trackListenerId=unique(this.x+","+this.y+"tracksWithUniqueId",curLevel.updateListeners.listeners);-1!=this.trackListenerId.indexOf("NaN")&&(console.log("Trying to track NaN!"),console.trace());if(!e&&!d)if(c)c.dx?f=function(){this.x=b.x+c.dx;this.y=b.y}:c.dy?f=function(){this.x=b.x;this.y=b.y+c.dy}:c.dy&&c.dx&&(f=function(){this.x=b.x+c.dx;this.y=b.y+c.dy});else var f=function(){this.x=
b.x;this.y=b.y};else e?c?c.dy&&(f=function(){this.y=b.y+c.dy}):f=function(){this.y=b.y}:d&&(c?c.dx&&(f=function(){this.x=b.x+c.dx}):f=function(){this.x=b.x});f?(addListener(curLevel,"update",this.trackListenerId,f,this),this.cleanUpWith=defaultTo(currentSetupType,a.cleanUpWith),addListener(curLevel,this.cleanUpWith+"CleanUp",this.trackListenerId,this.trackStop,this)):(console.log("tried to track "+this.trackListenerId+" but input wasn't right"),console.trace());return this},trackStop:function(){removeListener(curLevel,
"update",this.trackListenerId);removeListener(curLevel,this.cleanUpWith+"CleanUp",this.trackListenerId);this.cleanUpWith=this.trackListenerId=void 0;return this}};
Dot.prototype={KE:function(){return 0.5*this.m*(this.v.dx*this.v.dx+this.v.dy*this.v.dy)},temp:function(){return 0.5*this.m*(this.v.dx*this.v.dx+this.v.dy*this.v.dy)*this.tConst},setTemp:function(a){var b=this.temp();this.v.mult(Math.sqrt(a/b));return this},adjTemp:function(a){var b=this.temp();this.v.mult(Math.sqrt((b+a)/b));return this},speed:function(){return this.v.mag()*this.pxToMS},kill:function(){for(var a=0;a<this.parentLists.length;a++)this.parentLists[a].splice(this.parentLists[a].indexOf(this),
1)}};elementAttrs={handle:{type:String},pos:{type:Point},dims:{type:Vector},bounds:{type:Object},compMode:{type:String},wallHandle:{type:String},dotInfo:{type:Object}};
elementMd={wall:{labelText:"Wall",attrs:{isBox:{type:Boolean},pts:{type:Array},pos:elementAttrs.pos,dims:elementAttrs.dims,handle:elementAttrs.handle,handler:{type:String},vol:{type:Number},bounds:{type:Object},show:{type:Boolean},temp:{type:Number}}},readoutEntry:{labelText:"Readout entry",attrs:{wallHandle:elementAttrs.wallHandle,data:{type:String},readoutHandle:{type:String}}},dots:{labelText:"Molecules",attrs:{pos:elementAttrs.pos,dims:elementAttrs.dims,spc:{type:String},count:{type:Number},temp:{type:Number},
returnTo:{type:String},tag:{type:String}}},listener:{labelText:"Listener",attrs:{wallHandle:elementAttrs.wallHandle,dataList:{type:String},is:{type:String},targetVal:{type:Number},alertSatisfied:{type:String},alertUnsatisfied:{type:String},priorityUnsatisfied:{type:Number},checkOn:{type:String}}},weights:{labelText:"Weights",attrs:{handle:elementAttrs.handle,weightDefs:{type:Array},weightScalar:{type:Number},displayText:{type:Boolean},massInit:{type:Number},wallHandle:elementAttrs.wallHandle,compMode:elementAttrs.compMode,
pistonOffset:{type:Vector}}},compArrow:{labelText:"Compression Arrow",attrs:{handle:elementAttrs.handle,compMode:elementAttrs.compMode,bounds:elementAttrs.bounds}},piston:{labelText:"Piston",attrs:{handle:elementAttrs.handle,compMode:elementAttrs.compMode,wallHandle:elementAttrs.wallHandle,min:{type:Number},init:{type:Number},max:{type:Number},makePiston:{type:Boolean}}},heater:{labelText:"Heater",attrs:{handle:elementAttrs.handle,wallHandle:elementAttrs.wallHandle,dims:elementAttrs.dims,max:{type:Number}}},
stops:{labelText:"Stops",attrs:{handle:elementAttrs.handle,wallHandle:elementAttrs.wallHandle}},sandbox:{labelText:"Sandbox",attrs:{handle:elementAttrs.handle,min:{type:Number},init:{type:Number},max:{type:Number}}},tempChanger:{labelText:"Temp changer",attrs:{min:{type:Number},max:{type:Number},sliderPos:{type:String},info:elementAttrs.dotInfo}},RMSChanger:{labelText:"RMS changer",attrs:{min:{type:Number},max:{type:Number},sliderPos:{type:String},info:elementAttrs.dotInfo}},arrowStatic:{labelText:"Arrow static",
attrs:{}}};function SceneData(){this.type=void 0;this.walls=[];this.listeners=[];this.objects=[];this.dots=[];this.readoutEntries=[];this.commands=[]}
_.extend(SceneData.prototype,updateValue={addWall:function(){var a=this.buildNewElement("wall");a.id=data.getWallId();this.walls.push(a);return a},addListener:function(){var a=this.buildNewElement("listener");a.id=data.getListenerId();this.listeners.push(a);return a},addObject:function(a){a=this.buildNewElement(a);a.id=data.getObjectId();this.objects.push(a);return a},addDots:function(){var a=this.buildNewElement("dots");a.id=data.getDotsId();this.dots.push(a);return a},addReadoutEntry:function(){var a=
this.buildNewElement("readoutEntry");a.id=data.getReadoutEntryId();this.readoutEntries.push(a);return a},addCommand:function(){var a=this.buildNewElement("command");a.id=data.getCommandId();this.commands.push(a);return a},buildNewElement:function(a){a=elementData[a];var b={};b.labelText=a.labelText;for(var c in a.attrs)b[c]=void 0;return b}});function updateValue(a,b,c,d,e,f){!e&&(!f&&a[b]!=c)&&data.change(d,c);a[b]=c};function ElementAdder(a,b,c,d,e,f,g){this.elementOrder="wall dots readoutEntry listener weights piston sandbox compArrow heater stops tempChanger RMSChanger".split(" ");this.paper=a;this.tree=b;this.pos=c.copy();this.buttonDims=d.copy();this.labelText=e;this.rectCol=f.copy();this.rectColHover=g.copy();this.elementMd=elementMd;this.elememtAttrs=elementAttrs;this.dropdown=this.makeDropdown()}
ElementAdder.prototype={show:function(){this.dropdown.show()},hide:function(){this.dropdown.hide()},toFront:function(){this.dropdown.toFront()},makeDropdown:function(){for(var a=new Dropdown(this.paper,this.tree,"elementAdder",this.pos,this.buttonDims,this.labelText,this.rectCol,this.rectColHover),b=0;b<this.elementOrder.length;b++)a.addItem(this.elementMd[this.elementOrder[b]].labelText,function(){console.log("woo!")});return a},makeClickFunc:function(){var a=this;return function(){a.tree.addElement}}};config={buttonRounding:3,labelIndent:3,buttonFillCol:Col(0,164,255),buttonFillColHover:Col(0,144,224),textSizeMed:13,textCol:Col(255,255,255),buttonDimsSmall:V(30,30),buttonDimsMedium:V(70,30),buttonDimsLarge:V(150,30),imagePadding:0.05};assignHover={assignHover:function(a,b,c,d){this.isPlacerButton?a.hover(this.hoverOnChangeAll,this.hoverOffChangeAll):a.hover(function(){this.parent[b].attr({fill:c.hex})},function(){try{this.parent[b].attr({fill:d.hex})}catch(a){console.log("Hovering out of removed shape")}})}};
SectionFuncs={sectionDragStartTreeMode:function(){this.parent.sectionIds=this.parent.tree.getSectionIds();this.parent.posO=posOnPaper(globalMousePos,this.parent.tree.paper);this.parent.released=!1;this.parent.tree.clickedButton=this.parent;this.parent.tree.activateReceptacles.apply(this.parent.tree,[this.parent]);this.parent.sectionIdx=this.parent.tree.getSectionIdx(this.parent.parent);this.parent.mousePos=posOnPaper(globalMousePos,this.parent.tree.paper);this.parent.sectionYs=this.parent.tree.getSectionYs()},
sectionDragMoveTreeMode:function(){var a=posOnPaper(globalMousePos,this.parent.tree.paper),b=this.parent.mousePos.VTo(a);if(this.parent.posO.VTo(a).magSqr()>this.parent.tree.snapDist*this.parent.tree.snapDist||this.parent.released){this.parent.tree.checkReceptacles(this.parent);this.parent.released=!0;var c=this.parent.tree.sections,d=this.parent.sectionIdx;this.parent.parent.move(b);var b=this.parent.pos,e=this.parent.parent.totalHeight();this.parent.mousePos.set(a);for(var a=this.parent.sectionYs,
f=0;f<a.length;f++){var g=a[f]+c[f].totalHeight()/2;if(f<d){if(b.y<=g){var h=f;break}}else if(f>d&&b.y+e>=g){h=f;break}}void 0!==h&&(d=this.parent.sectionIdx,b=c[d],c.splice(d,1),c.splice(h,0,b),this.parent.sectionYs=this.parent.tree.getSectionYs(),this.parent.tree.sections=c,this.parent.sectionIdx=h,this.parent.tree.moveAllToPositions("fly"))}},sectionDragEndTreeMode:function(){var a=this.parent.tree,b=this.parent.sectionIds,c=!1;this.parent.tree.onReleaseReceptacle.apply(this.parent.tree,[this.parent])&&
(!this.parent.released&&this.parent.clickFuncs&&(c=!0,this.parent.clickFuncs[this.parent.mode][this.type].apply(this.parent)),this.parent.sectionIdx=void 0,this.parent.released=!1,this.parent.posO=P(0,0),this.parent.mousePos=P(0,0),this.parent.sectionYs=[]);a.clickedButton=void 0;a.setDefaultLabels();c||a.moveAllToPositions("fly");a=a.getSectionIds();objectsEqual(b,a)||data.change("tSections",a)},defineSectionDragFuncs:function(){this.sectionDragFuncs={tree:{onStart:this.sectionDragStartTreeMode,
onMove:this.sectionDragMoveTreeMode,onEnd:this.sectionDragEndTreeMode},object:void 0}}};
PromptFuncs={promptDragStartTreeMode:function(){this.parent.promptIds=this.parent.parent.section.getPromptIds();this.parent.posO=posOnPaper(globalMousePos,this.parent.tree.paper);this.parent.released=!1;this.parent.tree.clickedButton=this.parent;this.parent.tree.activateReceptacles.apply(this.parent.tree,[this.parent]);this.parent.promptIdx=this.parent.parent.section.getPromptIdx(this.parent.parent);this.parent.mousePos=posOnPaper(globalMousePos,this.parent.tree.paper);this.parent.sectionYs=this.parent.tree.getSectionYs();
this.parent.sectionTop=this.parent.parent.section.pos.y;this.parent.sectionBottom=this.parent.sectionTop+this.parent.parent.section.totalHeight()},promptDragMoveTreeMode:function(){var a=posOnPaper(globalMousePos,this.parent.tree.paper),b=V(a.x-this.parent.mousePos.x,a.y-this.parent.mousePos.y);if(this.parent.posO.VTo(a).magSqr()>this.parent.tree.snapDist*this.parent.tree.snapDist||this.parent.released){this.parent.tree.checkReceptacles(this.parent);this.parent.released=!0;this.parent.mousePos.set(a);
this.parent.parent.move(b);var a=this.parent.parent.section.prompts,b=this.parent.tree.totalButtonHeight,b=Math.floor((this.parent.pos.y+b/2-(this.parent.sectionTop+b))/b),c=Math.min(a.length-1,Math.max(-1,b));b!=this.parent.promptIdx&&b==c&&(c=a[this.parent.promptIdx],b=Math.max(0,b),a.splice(this.parent.promptIdx,1),a.splice(b,0,c),this.parent.promptIdx=b,this.parent.tree.moveAllToPositions("fly"))}},promptDragEndTreeMode:function(){var a=this.parent.parent.section,b=a.id,c=this.parent.tree,d=this.parent.promptIds,
e=!1;this.parent.tree.onReleaseReceptacle.apply(this.parent.tree,[this.parent])&&(!this.parent.released&&this.parent.clickFuncs&&(e=!0,this.parent.clickFuncs[this.parent.mode][this.type].apply(this.parent)),this.parent.promptIdx=void 0,this.parent.released=!1,this.parent.mousePos=P(0,0),this.parent.sectionYs=void 0,this.parent.sectionTop=void 0,this.parent.sectionBottom=void 0);c.clickedButton=void 0;c.setDefaultLabels();e||c.moveAllToPositions("fly");a=a.getPromptIds();objectsEqual(d,a)||data.change(b+
"Prompts",a)},definePromptDragFuncs:function(){this.promptDragFuncs={tree:{onStart:this.promptDragStartTreeMode,onMove:this.promptDragMoveTreeMode,onEnd:this.promptDragEndTreeMode},object:void 0}}};
BGRectFuncs={makeBGRect:function(){var a=this.paper.rect(0,0,this.paper.width,this.paper.height);a.attr({"stroke-width":0,fill:this.bgCol.hex});a.parent=this;a.drag(this.bgRectDragFuncs.onMove,this.bgRectDragFuncs.onStart,this.bgRectDragFuncs.onEnd);a.toBack();return a},bgRectDragStart:function(){this.totalHeight=this.parent.totalHeight();this.mousePos=posOnPaper(globalMousePos,this.parent.paper)},bgRectDragMove:function(){var a=posOnPaper(globalMousePos,this.parent.paper),b=this.mousePos.VTo(a);
this.mousePos.set(a);this.parent.pos.y=Math.min(this.parent.posO.y,Math.max(this.parent.paper.height-this.totalHeight-2*this.parent.buttonDims.dy,this.parent.pos.y+b.dy));this.parent.moveAllToPositions("snap")},bgRectDragEnd:function(){this.totalHeight=void 0;this.mousePos=P(0,0)},defineBGRectDragFuncs:function(){this.bgRectDragFuncs={onStart:this.bgRectDragStart,onMove:this.bgRectDragMove,onEnd:this.bgRectDragEnd}}};
PlacerRectFuncs={makePlacerButton:function(a){var b,c=this.placerButtonPos;a&&(b=this.placerRectDragFuncs);return new TreeSection(this,c,b,void 0,void 0,"New Block",!0)},placerRectDragStart:function(){var a=this.parent.tree;a.clickedButton=this;this.parent.outline=a.makeOutline.apply(a,[P(this._.dx,this._.dy)]);this.parent.outlinePos=P(this._.dx,this._.dy);this.parent.mousePos=posOnPaper(globalMousePos,a.paper);this.parent.displaced=void 0;this.parent.inColumn=a.inButtonColumn(this.parent.pos)},placerRectDragMove:function(){var a,
b;a=this.parent.tree;var c=this.parent.parent.pos,d=this.parent.inColumn,e=a.inButtonColumn(c);this.parent.outlinePos&&(b=this.parent.outlinePos.copy());var f=this.parent.outline,g=posOnPaper(globalMousePos,this.parent.tree.paper),h=this.parent.mousePos.VTo(g);this.parent.mousePos.set(g);this.parent.parent.move(h);if(e){var l=a.getIdxsToDisplace(c);objectsEqual(l,this.parent.displaced)||(this.parent.tree.returnDisplaced(this.parent.displaced),this.parent.tree.displace(l),this.parent.displaced=l)}else this.parent.displaced&&
(this.parent.tree.returnDisplaced(this.parent.displaced),this.parent.displaced=void 0);if(this.parent.inColumn=e){if(a=a.getOutlinePos(c,l),!b||!a.sameAs(b))f.animate({transform:"t"+a.x+","+a.y},250,"ease-in-out").toFront(),this.parent.outlinePos=a.copy()}else d?(this.parent.outlinePos=void 0,this.parent.tree.fadeOut(f),this.parent.outline=a.makeOutline.apply(a,[c])):f.transform("t"+c.x+","+c.y)},placerRectDragEnd:function(){var a=this.parent.parent.pos;this.parent.tree.clickedButton=void 0;this.parent.tree.inButtonColumn(a)&&
(this.parent.displaced?void 0==this.parent.displaced.up?this.parent.tree.addSection(a):this.parent.displaced.down&&-1==this.parent.displaced.down.promptIdx&&this.parent.tree.inSectionColumn(a)?this.parent.tree.addSection(a):void 0==this.parent.displaced.down&&this.parent.tree.inSectionColumn(a)?this.parent.tree.addSection(a):this.parent.tree.addPrompt(a):this.parent.tree.addSection(a));this.parent.outlinePos=P(0,0);this.parent.tree.fadeOut(this.parent.outline);this.parent.outline=void 0;this.parent.displaced=
void 0;this.parent.mousePos=P(0,0);this.parent.parent.move(this.parent.tree.placerButtonPos,"snap")},makeOutline:function(a){var b=this.buttonDims,b=this.paper.rect(0,0,b.dx,b.dy);b.attr({"stroke-dasharray":"-"});b.transform("t"+a.x+","+a.y);return b},getOutlinePos:function(a,b){var c=this.pos,d=this.totalHeight(),e=this.promptIndent,f=this.buttonDims.dy/2;if(b){if(b.up){if(b.down)return d=this.getButtonPosFromIdxs(b.up),f=this.getButtonPosFromIdxs(b.down),d=(d.y+f.y)/2,c=-1==b.down.promptIdx&&this.inSectionColumn(a)?
c.x:c.x+e,P(c,d);d-=f;return this.inSectionColumn(a)?c.copy().movePt(V(0,d)):c.copy().movePt(V(e,d))}return c.copy().movePt(V(0,-f))}return a.y>=c.y+d?P(c.x,c.y+d):!1},displace:function(a){for(var b in a){var c=a[b];c&&(-1==c.promptIdx?this.sections[c.sectionIdx].button.displace(b):this.sections[c.sectionIdx].prompts[c.promptIdx].button.displace(b))}this.staticsToFront()},getIdxsToDisplace:function(a){var b,c=this.pos.y;if(a.y<this.pos.y)return b={sectionIdx:0,promptIdx:-1},{up:void 0,down:b};for(b=
0;b<this.sections.length;b++){var d=this.sections[b].prompts;if(a.y>=c&&a.y<c+this.totalButtonHeight)return a={sectionIdx:b,promptIdx:-1},{up:a,down:this.getToDisplaceDown(b,-1,d)};for(var c=c+this.totalButtonHeight,e=0;e<d.length;e++){if(a.y>=c&&a.y<c+this.totalButtonHeight)return a={sectionIdx:b,promptIdx:e},{up:a,down:this.getToDisplaceDown(b,e,d)};c+=this.totalButtonHeight}}},getToDisplaceDown:function(a,b,c){if(c[b+1])return{sectionIdx:a,promptIdx:b+1};if(this.sections[a+1])return{sectionIdx:a+
1,promptIdx:-1}},returnDisplaced:function(a){if(a)for(var b in a){var c=a[b];c&&(-1==c.promptIdx?this.sections[c.sectionIdx].button.toPos():this.sections[c.sectionIdx].prompts[c.promptIdx].button.toPos())}},definePlacerRectFuncs:function(){this.placerRectDragFuncs={tree:{onStart:this.placerRectDragStart,onMove:this.placerRectDragMove,onEnd:this.placerRectDragEnd},object:{onStart:void 0,onMove:void 0,onEnd:void 0}}}};
TrashFuncs={trashOnHoverIn:function(){this.rect.attr({fill:this.tree.rectColHover.hex})},trashOnHoverOut:function(){this.rect.attr({fill:this.tree.bgCol.hex})},trashOnDropInto:function(a){a.tree.fadeOutUnknown(a.parent);return!1}};
ReceptacleFuncs={activateReceptacles:function(a){a.hoveringOver=[];a.storedDims=V(a.parent.totalWidth(),a.parent.totalHeight());this.checkReceptacles(a)},checkReceptacles:function(a){var b=this.getReceptaclesTouched(a),c=arrayDifference(a.hoveringOver,b),d=c.asNotInB,c=c.bsNotInA;a.hoveringOver=b;for(a=0;a<d.length;a++)d[a].onHoverOut();for(d=0;d<c.length;d++)c[d].onHoverIn()},getReceptaclesTouched:function(a){for(var b=[],c=0;c<this.receptacles.length;c++){var d=this.receptacles[c];rectsOverlap({pos:d.pos,
dims:d.dims},{pos:a.pos,dims:a.storedDims})&&b.push(d)}return b},onReleaseReceptacle:function(a){this.deactivateReceptacles(a);if(0<a.hoveringOver.length)return a.hoveringOver[a.hoveringOver.length-1].onDropInto(a);a.hoveringOver=void 0;return!0},deactivateReceptacles:function(a){a.storedDims=void 0;for(var b=0;b<a.hoveringOver.length;b++)a.hoveringOver[b].onHoverOut()}};function SearchTree(){this.root=void 0}
SearchTree.prototype={add:function(a,b){this.root=this.addPrivate(this.root,a,b)},get:function(a){return this.getPrivate(this.root,a)},withChange:function(a,b){return(new SearchTree).setRoot(this.withChangePrivate(this.root,a,b))},withChangePrivate:function(a,b,c){var d;if(void 0===a)console.log("Tried to change bad key "+b),console.trace();else return a.key==b?(d=new Node(b,c),d.left=a.left,d.right=a.right,d.height=a.height):this.aBeforeB(b,a.key)?(d=new Node(a.key,a.value),d.right=a.right,d.height=
a.height,d.left=this.withChangePrivate(a.left,b,c)):(d=new Node(a.key,a.value),d.left=a.left,d.height=a.height,d.right=this.withChangePrivate(a.right,b,c)),d},setRoot:function(a){this.root=a;return this},getPrivate:function(a,b){if(void 0===a)console.log("Tried to get bad key: "+b),console.trace();else return b==a.key?a.value:this.aBeforeB(b,a.key)?this.getPrivate(a.left,b):this.getPrivate(a.right,b)},addPrivate:function(a,b,c){if(void 0===a)return new Node(b,c);this.aBeforeB(b,a.key)?a.left=this.addPrivate(a.left,
b,c):a.right=this.addPrivate(a.right,b,c);a.height=void 0===a.right?a.left.height+1:void 0===a.left?a.right.height+1:a.right.height>a.left.height?a.right.height+1:a.left.height+1;return a=this.balance(a)},height:function(a){return void 0===a?-1:a.height},assignHeightFromChildren:function(a){a.height=void 0===a.left&&void 0===a.right?0:void 0===a.left?a.right.height+1:void 0===a.right?a.left.height+1:a.left.height>a.right.height?a.left.height+1:a.right.height+1},rotateRight:function(a){a=a.copy();
var b=a.left.copy();a.left=a.left.right?a.left.right.copy():void 0;b.right=a;this.assignHeightFromChildren(a);this.assignHeightFromChildren(b);return b},rotateLeft:function(a){a=a.copy();var b=a.right.copy();a.right=a.right.left?a.right.left.copy():void 0;b.left=a;this.assignHeightFromChildren(a);this.assignHeightFromChildren(b);return b},balance:function(a){var b=this.height(a.right),c=this.height(a.left);return c>b+1?(b=this.height(a.left.left),c=this.height(a.left.right),b>c||(a.left=this.rotateLeft(a.left),
this.assignHeightFromChildren(a)),this.rotateRight(a)):b>c+1?(b=this.height(a.right.left),this.height(a.right.right)>b||(a.right=this.rotateRight(a.right),this.assignHeightFromChildren(a)),this.rotateLeft(a)):a},aBeforeB:function(a,b){for(var c=Math.min(a.length,b.length),d=0,e=0,f=0;f<c;f++){d+=a.charCodeAt(f);e+=b.charCodeAt(f);if(a<b)return!0;if(a>b)return!1}return a.length<b.length?!0:!1}};function Node(a,b){this.key=a;this.value=b;this.right=this.left=void 0;this.height=0}
Node.prototype={copy:function(){var a=new Node(this.key,this.value);a.left=this.left;a.right=this.right;a.height=this.height;return a}};function Dropdown(a,b,c,d,e,f,g,h){this.paper=a;this.textSize=config.textSizeMed;this.handle=c;this.expanded=!1;this.tree=b;this.pos=d.copy();this.dims=e.copy();this.text=f;this.itemDims=V(e.dx,1.7*this.textSize);this.mouseOutPadding=30;this.fillCol=g.copy();this.hoverCol=h.copy();this.textSize=config.textSizeMed;this.defineClickFuncs();this.button=new ArrowButton(this.tree,this,this.pos,void 0,this.clickFuncs,this.text,!0);this.button.toObjectMode(!1);this.button.pointArrows("down");this.items=[];
this.dropdownDiv=this.makeDropdownDiv();this.dropdownPaper=this.makeDropdownPaper();$(this.dropdownDiv).hide();this.bottomRound=this.makeBottomRound()}
Dropdown.prototype={addItem:function(a,b){var c=P(0,0).movePt(V(0,this.items.length*this.itemDims.dy-1));this.items.push(new DropdownItem(this.dropdownPaper,c,this.itemDims,this.textSize,a,b,this.fillCol,this.hoverCol));$(this.dropdownDiv).css({height:this.items.length*this.itemDims.dy+config.buttonRounding});this.dropdownPaper.setSize($(this.dropdownDiv).width(),$(this.dropdownDiv).height());translateObj(this.bottomRound,c.copy().movePt(V(0,this.itemDims.dy-config.buttonRounding)))},expand:function(){this.expanded=
!0;this.setupMouseOut();posGlobal(this.pos.copy().movePt(V(0,this.dims.dy)),$("#treeDiv"));$(this.dropdownDiv).show()},contract:function(){this.expanded=!1;$(document).unbind("mousemove",this.hoverFunc);this.hoverFunc=void 0;$(this.dropdownDiv).hide()},makeDropdownDiv:function(){var a=this.pos.copy().movePt(V(0,this.dims.dy)),b=$("<div></div>");$("#treeWrapper").append(b);$(b).css({position:"absolute",left:a.x,top:a.y,width:this.dims.dx,"z-index":3,height:0});$(b).attr("id",this.handle);return $("#"+
this.handle)[0]},makeDropdownPaper:function(){return Raphael(this.handle,$("#"+this.handle).width(),$("#"+this.handle).height())},makeHoverFunc:function(a,b,c){return function(){var d=posOnPaper(globalMousePos,a.paper);(d.x<b.x||d.x>b.x+c.dx||d.y<b.y||d.y>b.y+c.dy)&&a.contract()}},setupMouseOut:function(){var a=V(this.dims.dx,this.dims.dy+this.items.length*this.itemDims.dy),b=posGlobal(this.pos,$("#treeDiv"));this.hoverFunc=this.makeHoverFunc(this,b,a);$(document).mousemove(this.hoverFunc)},makeBottomRound:function(){var a=
this.dropdownPaper.rect(0,0,this.dims.dx,2*config.buttonRounding,config.buttonRounding);a.attr({"stroke-width":0,fill:this.fillCol.hex});translateObj(a,P(0,0).movePt(V(0,this.dims.dy-config.buttonRounding)));return a},toFront:function(){this.button.toFront()},show:function(){this.button.show()},hide:function(){this.expanded&&this.contract();this.button.hide()},defineClickFuncs:function(){var a=this,b=function(){a.expanded?a.contract():a.expand()};this.clickFuncs={object:{rect:b,arrows:b},tree:{rect:function(){console.log("Dropdown is in tree mode!")},
arrows:function(){console.log("Dropdown is in tree mode!")}}}}};function DropdownItem(a,b,c,d,e,f,g,h){this.paper=a;this.labelText=e;this.textSize=d;this.labelIndent=config.labelIndent;this.onClick=f;this.pos=b.copy();this.dims=c.copy();this.fillCol=g.copy();this.fillColHover=h.copy();this.rect=this.makeRect();this.label=this.makeLabel()}
DropdownItem.prototype={show:function(){this.rect.show().toFront();this.label.show().toFront()},hide:function(){this.rect.hide();this.label.hide()},getLabelText:function(){},makeRect:function(){var a=this.paper.rect(0,0,this.dims.dx,this.dims.dy).attr({"stroke-width":0,fill:this.fillCol.hex});translateObj(a,this.pos);a.hover(function(){this.attr({fill:this.parent.fillColHover.hex})},function(){this.attr({fill:this.parent.fillCol.hex})});a.parent=this;a.click(this.onClick);return a},makeLabel:function(){var a=
this.pos.copy().movePt(V(this.labelIndent,this.dims.dy/2+this.textSize/2)),b=this.paper.text(0,0,this.labelText).attr({"font-size":this.textSize,"text-anchor":"start",fill:config.textCol.hex});translateObj(b,a);b.hover(function(){this.parent.rect.attr({fill:this.parent.fillColHover.hex})},function(){this.parent.rect.attr({fill:this.parent.fillCol.hex})});b.parent=this;b.click(this.onClick);return b}};function DataManager(){this.commandNum=this.readoutEntryNum=this.dotsNum=this.listenerNum=this.wallNum=this.objNum=this.promptNum=this.sectionNum=this.curIdx=0;this.hist=[new SearchTree]}
DataManager.prototype={add:function(a,b){this.hist[this.curIdx].add(a,b)},change:function(a,b){this.curIdx!=this.hist.length-1&&(this.hist=this.hist.slice(0,this.curIdx+1));this.hist.push(this.hist[this.hist.length-1].withChange(a,b));this.curIdx++},redo:function(){var a=Math.min(this.hist.length-1,this.curIdx+1);a!=this.curIdx&&(tree.load(this.hist[a]),this.curIdx=a)},undo:function(){var a=Math.max(0,this.curIdx-1);a!=this.curIdx&&(tree.load(this.hist[a]),this.curIdx=a)},getSectionId:function(){var a=
"s"+this.sectionNum;this.sectionNum++;return a},getPromptId:function(){var a="p"+this.promptNum;this.promptNum++;return a},getObjId:function(){var a="o"+this.objNum;this.objNum++;return a},getWallId:function(){var a="w"+this.wallNum;this.wallNum++;return a},getListenerId:function(){var a="l"+this.listenerNum;this.listenerNum++;return a},getDotsId:function(){var a="d"+this.dotsNum;this.dotsNum++;return a},getReadoutEntryId:function(){var a="rE"+this.readoutEntryNum;this.readoutEntryNum++;return a},
getCommandId:function(){var a="c"+this.commandNum;this.commandNum++;return a}};function ArrowButton(a,b,c,d,e,f,g){this.tree=a;this.memberOf=[];this.mode="tree";this.pos=c.copy();this.dragFuncs=d;this.clickFuncs=e;this.released=!1;this.posO=P(0,0);this.sectionIdx=Number();this.mousePos=P(0,0);this.sectionYs=[];this.parent=b;this.labelText=void 0;this.isPlacerButton=defaultTo(g,!1);this.rect=this.makeRect();this.innerRect=this.makeInnerRect();this.arrows=this.makeArrows();this.haveUpdatedLabel=!1;this.updateLabel(f,!0);this.inUse=!1;this.dragFuncs?this.assignDragFuncs():this.assignClickFuncs();
this.arrowAngle=0}
_.extend(ArrowButton.prototype,assignHover,{toTreeMode:function(){this.mode="tree";!this.dragFuncs||!this.dragFuncs[this.mode]?this.assignClickFuncs():this.assignDragFuncs();(this.arrowAngle=Math.PI)&&this.pointArrows("right")},toObjectMode:function(a){this.mode="object";!this.dragFuncs||!this.dragFuncs[this.mode]?this.assignClickFuncs():this.assignDragFuncs();!1!==a&&(this==this.tree.clickedButton||this==this.tree.editingButton?(this.tree.editingButton=this,this.pointArrows("left"),this.tree.editingButton=
this,this.flyToPos(this.tree.buttonPosObjectModeSelected,200)):this.flyToPos(P(-this.tree.buttonDims.dx-50,this.pos.y),150))},hide:function(){this.rect.hide();this.innerRect.hide();this.label&&this.label.hide();for(var a=0;a<this.arrows.length;a++)this.arrows[a].hide()},setUse:function(a){this.inUse=a},show:function(){this.rect.show().toFront();this.innerRect.show().toFront();this.label&&this.label.show().toFront();for(var a=0;a<this.arrows.length;a++)this.arrows[a].show().toFront()},assignClickFuncs:function(){if(this.clickFuncs){this.rect.unclick(this.getClickFunc(this.rect));
this.rect.click(this.clickFuncs[this.mode].rect);this.innerRect.unclick(this.getClickFunc(this.innerRect));this.innerRect.click(this.clickFuncs[this.mode].arrows);this.label&&(this.label.unclick(this.getClickFunc(this.label)),this.label.click(this.clickFuncs[this.mode].rect));for(var a=0;a<this.arrows.length;a++)this.arrows[a].unclick(this.getClickFunc(this.label)),this.arrows[a].click(this.clickFuncs[this.mode].arrows)}},getClickFunc:function(a){for(var b=0;b<a.events.length;b++)if("click"==a.events[b].name)return a.events[b].f},
assignDragFuncs:function(){if(this.dragFuncs){this.rect.undrag();this.rect.drag(this.dragFuncs[this.mode].onMove,this.dragFuncs[this.mode].onStart,this.dragFuncs[this.mode].onEnd);this.innerRect.undrag();this.innerRect.drag(this.dragFuncs[this.mode].onMove,this.dragFuncs[this.mode].onStart,this.dragFuncs[this.mode].onEnd);this.label&&(this.label.undrag(),this.label.drag(this.dragFuncs[this.mode].onMove,this.dragFuncs[this.mode].onStart,this.dragFuncs[this.mode].onEnd));for(var a=0;a<this.arrows.length;a++)this.arrows[a].undrag(),
this.arrows[a].drag(this.dragFuncs[this.mode].onMove,this.dragFuncs[this.mode].onStart,this.dragFuncs[this.mode].onEnd)}},displace:function(a){var b;"up"==a?b=-this.tree.displaceDist:"down"==a&&(b=this.tree.displaceDist);this.move(V(0,b),"fly",300)},toPos:function(){var a=this.tree.getButtonPos(this);this.move(a,"fly",300)},makeRect:function(){var a=this.tree.paper.rect(0,0,this.tree.buttonDims.dx,this.tree.buttonDims.dy,this.tree.rectRounding);a.attr({fill:this.tree.rectCol.hex,"stroke-width":0});
this.assignHover(a,"rect",this.tree.rectColHover,this.tree.rectCol);var b=this.rectPos();translateObj(a,b);a.parent=this;a.type="rect";return a},makeInnerRect:function(){var a=this.tree.paper.rect(0,0,this.tree.innerRectDims.dx,this.tree.innerRectDims.dy,this.tree.rectRounding);a.attr({fill:this.tree.rectCol.hex,"stroke-width":0});this.assignHover(a,"innerRect",this.tree.rectColHover,this.tree.rectCol);var b=this.innerRectPos();translateObj(a,b);a.parent=this;a.type="arrows";return a},makeArrows:function(){for(var a=
this.makeArrowPath(),b=[],c=0;c<this.tree.numArrows;c++){var d=this.arrowPos(c),e=this.tree.paper.path(a);translateObj(e,d);e.attr({fill:this.tree.arrowCol.hex,"stroke-width":0});this.assignHover(e,"innerRect",this.tree.rectColHover,this.tree.rectCol);e.parent=this;e.type="arrows";b.push(e)}return b},updateLabel:function(a,b,c){if(!b||!this.haveUpdatedLabel)if(!c&&(a!=this.labelText&&!b||!b&&!this.haveUpdateLabel)?(data.change(this.parent.id+"LabelText",a),this.haveUpdatedLabel=!0):b||(this.haveUpdateLabel=
!0),a!=this.labelText){this.labelText=a;b=this.labelPos();this.label&&this.label.remove();c=this.tree.buttonDims.dx-this.tree.labelIndent-this.tree.innerRectDims.dx-5;for(var d="",e=this.tree.paper.text(0,0,d).attr({"text-anchor":"start","font-size":this.tree.labelTextSize,fill:config.textCol.hex}),f=!1,g=a.length;0<=g;g--)if(d=a.slice(0,g),e.attr({text:d}),e.getBBox().width>c)f=!0;else break;f&&e.attr({text:d+"..."});translateObj(e,b);this.assignHover(e,"rect",this.tree.rectColHover,this.tree.rectCol);
this.dragFuncs&&this.dragFuncs[this.mode]&&e.drag(this.dragFuncs[this.mode].onMove,this.dragFuncs[this.mode].onStart,this.dragFuncs[this.mode].onEnd);e.parent=this;e.type="label";this.label=e}},hoverOnChangeAll:function(){this.parent.innerRect.attr({fill:this.parent.tree.rectColHover.hex});this.parent.rect.attr({fill:this.parent.tree.rectColHover.hex})},hoverOffChangeAll:function(){this.parent.innerRect.attr({fill:this.parent.tree.rectCol.hex});this.parent.rect.attr({fill:this.parent.tree.rectCol.hex})},
pointArrows:function(a){"left"==a?this.arrowAngle=Math.PI:"right"==a?this.arrowAngle=0:"down"==a&&(this.arrowAngle=Math.PI/2);a=this.innerRectPos().movePt(this.tree.innerRectDims.copy().mult(0.5));for(var b=0;b<this.arrows.length;b++){var c=this.arrows[b],d=this.arrowPos(b).rotate(a,this.arrowAngle);c.transform("r"+this.arrowAngle*this.tree.degToRad+",0,0T"+d.x+","+d.y)}},setParent:function(a){this.parent=a},move:function(a,b,c){if(this.inUse)return!1;a=a instanceof Vector?P(this.pos.x+a.dx,this.pos.y+
a.dy):a;"fly"==b?this.flyToPos(a,c):this.snapToPos(a);return!0},groupToFront:function(){this.parent.toFront()},toFront:function(){this.rect.toFront();this.innerRect.toFront();this.label.toFront();for(var a=0;a<this.arrows.length;a++)this.arrows[a].toFront()},snapToPos:function(a){if(!a.sameAs(this.pos)){this.pos.set(a);a=this.rectPos();var b=this.innerRectPos(),c=this.labelPos();this.rect.transform("t"+a.x+","+a.y).toFront();this.innerRect.transform("t"+b.x+","+b.y).toFront();this.label.transform("t"+
c.x+","+c.y).toFront();a=this.innerRectPos().movePt(this.tree.innerRectDims.copy().mult(0.5));for(b=0;b<this.arrows.length;b++)c=this.arrowPos(b).rotate(a,this.arrowAngle),this.arrows[b].transform("r"+this.arrowAngle*this.tree.degToRad+",0,0T"+c.x+","+c.y).toFront()}},flyToPos:function(a,b){b=defaultTo(b,250);if(!a.sameAs(this.pos)){this.pos.set(a);var c=this.rectPos(),d=this.innerRectPos(),e=this.labelPos();this.rect.animate({transform:"t"+c.x+","+c.y},b,"ease-in-out").toFront();this.innerRect.animate({transform:"t"+
d.x+","+d.y},b,"ease-in-out").toFront();this.label.animate({transform:"t"+e.x+","+e.y},b,"ease-in-out").toFront();c=this.innerRectPos().movePt(this.tree.innerRectDims.copy().mult(0.5));for(d=0;d<this.arrows.length;d++)e=this.arrowPos(d).rotate(c,this.arrowAngle),this.arrows[d].animate({transform:"r"+this.arrowAngle*this.tree.degToRad+",0,0T"+e.x+","+e.y},b,"ease-in-out").toFront()}},rectPos:function(){return this.pos.copy()},innerRectPos:function(){return P(this.pos.x+this.tree.buttonDims.dx-this.tree.innerRectDims.dx,
this.pos.y)},arrowPos:function(a){return P(this.pos.x+this.tree.buttonDims.dx-this.tree.innerRectDims.dx+this.tree.arrowOffset+a*(this.tree.arrowSpacing+this.tree.arrowThickness),this.pos.y+(this.tree.buttonDims.dy-this.tree.arrowDims.dy)/2)},labelPos:function(){return this.pos.copy().movePt(V(this.tree.labelIndent,this.tree.buttonDims.dy/2))},makeArrowPath:function(){var a=[],b=this.tree.arrowDims.dx,c=this.tree.arrowDims.dy,d=this.tree.arrowThickness;a.push(P(0,0));a.push(P(d,0));a.push(P(b,c/2));
a.push(P(d,c));a.push(P(0,c));a.push(P(b-d,c/2));return makePath(a,!0)},fadeOut:function(){this.tree.addTopButton(this);this.setUse(!1);this.fadeObj(this.rect);this.fadeObj(this.innerRect);this.fadeObj(this.label);for(var a=0;a<this.arrows.length;a++)this.fadeObj(this.arrows[a])},fadeObj:function(a,b){b=defaultTo(b,250);a.drag(void 0,void 0,void 0);a.hover(void 0,void 0);a.animate({opacity:0},b,void 0,function(){this.parent.tree.removeTopButton(this.parent);this.remove()})},remove:function(){this.rect.remove();
this.innerRect.remove();this.label&&this.label.remove();for(var a=0;a<this.arrows.length;a++)this.arrows[a].remove();for(a=0;a<this.memberOf;a++){var b=this.memberOf[a],c=b.indexOf(this);-1!=c&&b.splice(c,1)}}});function TreePrompt(a,b,c,d,e,f,g){this.tree=a;this.section=b;this.sceneData=new SceneData;this.dragFuncs=d;this.clickFuncs=e;this.labelText=f;this.button=new ArrowButton(this.tree,this,c,this.dragFuncs,this.clickFuncs);void 0===g?(this.id=data.getPromptId(),this.register()):this.id=g}
TreePrompt.prototype={getSection:function(){return this.section},getId:function(){return this.id},register:function(){this.button.haveUpdatedLabel?data.add(this.id+"LabelText",this.labelText):data.add(this.id+"LabelText",void 0)},fadeOut:function(){this.button.fadeOut()},setSection:function(a){this.section=a},updateLabel:function(a,b,c){this.button.updateLabel(a,b,c)},totalHeight:function(){return this.tree.totalButtonHeight},totalWidth:function(){return this.tree.buttonDims.dx},hide:function(){this.button.hide()},
show:function(){this.button.show()},toFront:function(){this.button.toFront()},remove:function(){this.button.remove()},move:function(a,b,c){this.button.move(a,b,c)}};function TreeSection(a,b,c,d,e,f,g,h){this.tree=a;this.prompts=[];this.pos=b.copy();this.sceneData=new SceneData;this.initSectionIdx=void 0;this.mousePosInit=P(0,0);this.sectionYs=[];this.sectionDragFuncs=c;this.promptDragFuncs=d;this.clickFuncs=e;this.labelText=f;this.isPlacer=g;this.button=new ArrowButton(this.tree,this,this.pos,this.sectionDragFuncs,this.clickFuncs,this.labelText,g);void 0===h?(this.id=data.getSectionId(),this.register()):this.id=h}
TreeSection.prototype={addPrompt:function(a,b){var c=this.getNewPromptIdx(a);b||(b=new TreePrompt(this.tree,this,a,this.promptDragFuncs,this.clickFuncs,""));this.prompts.splice(c,0,b);c=this.getPromptIds();data.change(this.id+"Prompts",c)},loadPrompts:function(a,b,c,d,e){for(var f=this.prompts,g=[],h=this.getPromptIds(),l=0;l<b.length;l++){var j=b[l],k=h.indexOf(j),m=d.copy().movePt(V(this.tree.promptIndent,0));j==c&&(m=this.buttonPosObjectModeSelected);var n=a.get(j+"LabelText");j==c&&(m=this.tree.buttonPosObjectModeSelected);
-1!=k?(e[j].remove=!1,k=f[k],k.move(m,"snap")):k=new TreePrompt(this.tree,this,m,this.promptDragFuncs,this.clickFuncs,"",j);j==c&&(this.tree.editingButton=k.button);n&&k.updateLabel(n,!1,!0);d.y+=this.tree.totalButtonHeight;g.push(k)}this.prompts=g},register:function(){data.add(this.id+"Prompts",[]);data.add(this.id+"SectionDragFuncs",this.sectionDragFuncs);data.add(this.id+"PromptDragFuncs",this.promptDragFuncs);data.add(this.id+"ClickFuncs",this.clickFuncs);this.button.haveUpdatedLabel?data.add(this.id+
"LabelText",this.labelText):data.add(this.id+"LabelText",void 0)},getPromptIds:function(){for(var a=[],b=0;b<this.prompts.length;b++)a.push(this.prompts[b].getId());return a},getId:function(){return this.id},hide:function(){this.button.hide();for(var a=0;a<this.prompts.length;a++)this.prompts[a].hide()},show:function(){this.button.show();for(var a=0;a<this.prompts.length;a++)this.prompts[a].show()},updateLabel:function(a,b,c){this.labelText=a;this.button.updateLabel(a,b,c)},toFront:function(){this.button.toFront();
for(var a=0;a<this.prompts.length;a++)this.prompts[a].toFront()},move:function(a,b,c){this.button.move(a,b,c)&&(a instanceof Vector?this.pos.movePt(a):this.pos.set(a));for(var d=0;d<this.prompts.length;d++)this.prompts[d].move(a,b,c)},getNewPromptIdx:function(a){for(var b=this.pos.y+this.tree.totalButtonHeight,c=0;c<this.prompts.length;c++){if(b>a.y)return c;b+=this.tree.totalButtonHeight}return this.prompts.length},fadeOut:function(){this.button.fadeOut();for(var a=0;a<this.prompts.length;a++)this.prompts[a].fadeOut()},
fadeOutPrompt:function(a){this.prompts[a].fadeOut();this.prompts.splice(a,1)},getPromptIdx:function(a){return this.prompts.indexOf(a)},remove:function(){this.button.remove();for(var a=0;a<this.prompts.length;a++)this.prompts[a].remove();this.prompts=[]},removePrompt:function(a){this.prompts[a]?this.prompts[a].remove():(console.log("tried to remove prompt idx "+a+" from some section, which is not helpful at all.  It does not exist."),console.trace())},totalHeight:function(){return this.tree.totalButtonHeight*
(1+this.prompts.length)},totalWidth:function(){return this.tree.buttonDims.dx}};function Receptacle(a,b,c,d,e,f,g){this.tree=a;this.pos=b;this.labelText=d;this.dims=c;this.rect=this.makeRect();this.label=this.makeLabel();this.onHoverIn=e;this.onHoverOut=f;this.onDropInto=g}
Receptacle.prototype={makeRect:function(){var a=this.tree.paper.rect(0,0,this.dims.dx,this.dims.dy,this.tree.rectRounding);translateObj(a,this.pos);a.attr({fill:this.tree.panelCol.hex,stroke:this.tree.rectCol.hex});return a},toFront:function(){this.rect.toFront();this.label.toFront()},show:function(){this.rect.show();this.label.show()},hide:function(){this.rect.hide();this.label.hide()},makeLabel:function(){var a=P(this.pos.x+this.tree.buttonDims.dx/2,this.pos.y+this.tree.buttonDims.dy/2),b=this.tree.paper.text(0,
0,this.labelText).attr({"font-size":this.tree.labelTextSize});translateObj(b,a);return b}};function Tree(a){this.paper=a;this.someImage=new Image;this.someImage.src="undo.GIF";this.buttonDims=config.buttonDimsLarge;this.toPosTime=250;this.innerRectDims=V(30,this.buttonDims.dy);this.buttonSpacing=7;this.displaceDist=9;this.transitionTime=400;this.degToRad=360/(2*Math.PI);this.panelDimsTop=V(this.paper.width,2*this.buttonDims.dy+3*this.buttonSpacing);this.panelDimsBottom=V(this.paper.width,50);this.pos=P(15,10+this.panelDimsTop.dy);this.posO=this.pos.copy();this.totalButtonHeight=this.buttonDims.dy+
this.buttonSpacing;this.buttonPosObjectModeSelected=P(this.buttonSpacing,this.panelDimsTop.dy-this.totalButtonHeight);this.elementAdderPos=P(this.panelDimsTop.dx-this.buttonSpacing-this.buttonDims.dx,this.panelDimsTop.dy-this.totalButtonHeight);this.labelIndent=config.labelIndent;this.labelTextSize=config.textSizeMed;this.promptIndent=30;this.rectRounding=config.buttonRounding;this.innerRectWidth=25;this.arrowDims=V(17,26);this.arrowThickness=4;this.arrowSpacing=3;this.arrowOffset=5;this.numArrows=
2;this.snapDist=5;this.placerBlockTolerance=this.edgePadding=10;this.bgCol=Col(255,255,255);this.panelCol=Col(230,230,230);this.arrowCol=Col(255,255,255);this.rectCol=config.buttonFillCol;this.rectColHover=config.buttonFillColHover;this.populateelementAdder();this.mode="tree";this.placerButtonPos=P(this.paper.width-this.buttonDims.dx-this.edgePadding,this.paper.height-this.buttonDims.dy-this.edgePadding);this.trashPos=this.placerButtonPos.copy().movePt(V(-160,0));this.defineSectionDragFuncs();this.definePromptDragFuncs();
this.defineClickFuncs();this.defineBGRectDragFuncs();this.definePlacerRectFuncs();this.panels=this.makePanels();this.placerButtonBG=this.makePlacerButton(!1);this.placerButton=this.makePlacerButton(!0);this.elementAdder=new ElementAdder(this.paper,this,this.elementAdderPos,this.buttonDims,"New Element",this.rectCol,this.rectColHover);this.elementAdder.hide();this.bgRect=this.makeBGRect();this.clickedButton=this.editingButton=void 0;this.receptacles=[this.makeTrash(this.trashPos)];this.dirButtonDims=
config.buttonDimsSmall;this.dirButtons=this.makeDirButtons();this.sections=[];this.topButtons=[];data.add("tSections",[]);data.add("tMode","tree")}
_.extend(Tree.prototype,SectionFuncs,PromptFuncs,BGRectFuncs,PlacerRectFuncs,TrashFuncs,ReceptacleFuncs,{addSection:function(a,b){var c=posOnPaper(a,this.paper),d=this.getNewSectionIdx(c);b=new TreeSection(this,c,this.sectionDragFuncs,this.promptDragFuncs,this.clickFuncs,"");this.sections.splice(d,0,b);this.setDefaultLabels();c=this.getSectionIds();data.change("tSections",c);this.moveAllToPositions("fly")},getSectionIds:function(){for(var a=[],b=0;b<this.sections.length;b++)a.push(this.sections[b].getId());
return a},addPrompt:function(a,b){var c=posOnPaper(a,this.paper),d=this.getNewPromptSectionIdx(c);this.sections[d].addPrompt(c,b);this.setDefaultLabels();this.moveAllToPositions("fly")},toTreeMode:function(){var a=V($("#treeWrapper").width(),$("#treeWrapper").height());this.paper.setSize(a.dx,a.dy);$("#treeDiv").animate({height:a.dy+"px"},this.transitionTime);$("#objDiv").animate({height:"0px"},this.transitionTime,function(){$("#objDiv").hide()});this.bgRect.show();this.elementAdder.hide();this.mode=
"tree";this.showBottomPanel();this.editingButton=void 0;this.clickedButton&&this.addTopButton(this.clickedButton);this.unclickButton();for(a=0;a<this.sections.length;a++){var b=this.sections[a];b.button.toTreeMode();for(var b=b.prompts,c=0;c<b.length;c++)b[c].button.toTreeMode()}this.moveAllToPositions("fly");window.setTimeout(function(){tree.topButtons=[]},this.toPosTime)},toObjectMode:function(){var a=this;this.bgRect.hide();var b=$("#treeWrapper").height(),c=this.panelDimsTop.dy;$("#objDiv").show();
b-=c;$("#treeDiv").animate({height:this.panelDimsTop.dy+"px"},this.transitionTime,function(){a.paper.setSize(a.paper.width,c)});$("#objDiv").animate({height:b+"px"},this.transitionTime);this.mode="object";this.hideBottomPanel();this.elementAdder.show();for(b=0;b<this.sections.length;b++){var d=this.sections[b];d.button.toObjectMode();for(var d=d.prompts,e=0;e<d.length;e++)d[e].button.toObjectMode()}},staticsToFront:function(){this.panels.bottom.toFront();this.panels.top.toFront();this.placerButtonBG.toFront();
this.placerButton.toFront();for(var a=0;a<this.receptacles.length;a++)this.receptacles[a].toFront();this.dirButtons.redo.toFront();this.dirButtons.undo.toFront();this.elementAdder.toFront();for(a=0;a<this.topButtons.length;a++)this.topButtons[a].toFront()},addTopButton:function(a){this.topButtons.push(a);a.memberOf.push(this.topButtons)},removeTopButton:function(a){var b=this.topButtons.indexOf(a);-1!=b&&this.topButtons.splice(b,1);a=a.memberOf.indexOf(this.topButtons);-1!=a&&this.topButtons.splice(a,
1)},hideBottomPanel:function(){this.panels.bottom.hide();this.placerButtonBG.hide();this.placerButton.hide();this.hideReceptacles()},showBottomPanel:function(){this.panels.bottom.show();this.placerButtonBG.show();this.placerButton.show();this.showReceptacles()},load:function(a){var b,c;c=this.pos.y;"tree"==this.mode?b=this.pos.x:"object"==this.mode&&(b=-this.buttonDims.dx-50);b=P(b,c);c=a.get("tSections");if(this.editingButton)var d=this.editingButton.parent.getId();this.editingButton=void 0;var e=
this.getSectionIds(),f=this.makeToRemove(e);this.loadSections(a,c,d,b,e,f);this.removeUnused(f);this.setDefaultLabels();"object"==this.mode&&void 0==this.editingButton&&this.toTreeMode();this.staticsToFront();this.editingButton&&(this.editingButton.toObjectMode(),this.editingButton.toFront())},loadSections:function(a,b,c,d,e,f){for(var g=this.sections,h=[],l=0;l<b.length;l++){var j=b[l],k=e.indexOf(j),m=d;j==c&&(m=this.buttonPosObjectModeSelected);var n=a.get(j+"LabelText");j==c&&(m=this.buttonPosObjectModeSelected);
if(-1!=k)f[j].remove=!1,k=g[k],k.move(m,"snap");else var k=a.get(j+"SectionDragFuncs"),p=a.get(j+"PromptDragFuncs"),q=a.get(j+"ClickFuncs"),k=new TreeSection(this,m,k,p,q,"",!1,j);n&&k.updateLabel(n,!1,!0);j==c&&(this.editingButton=k.button);j=a.get(j+"Prompts");d.y+=this.totalButtonHeight;k.loadPrompts(a,j,c,d,f);h.push(k)}this.sections=h},makeToRemove:function(){for(var a={},b=0;b<this.sections.length;b++){a[this.sections[b].getId()]={remove:!0,obj:this.sections[b]};for(var c=this.sections[b].prompts,
d=0;d<c.length;d++)a[c[d].getId()]={remove:!0,obj:c[d]}}return a},populateelementAdder:function(){},removeUnused:function(a){for(var b in a)a[b].remove&&a[b].obj.button.remove()},removeSections:function(){for(var a=0;a<this.sections.length;a++)this.sections[a].remove();this.sections=[]},setDefaultLabels:function(){for(var a,b,c=0;c<this.sections.length;c++){a="Section "+(c+1);this.sections[c].updateLabel(a,!0);for(var d=this.sections[c].prompts,e=0;e<d.length;e++)b=a+" prompt "+(e+1),d[e].updateLabel(b,
!0)}},makeDirButtons:function(){var a=P(this.buttonSpacing,this.buttonSpacing),b=new Button(this.paper,a,this.dirButtonDims,void 0,function(){data.undo()},"imgUndo");a.movePt(V(this.dirButtonDims.dx+this.buttonSpacing,0));a=new Button(this.paper,a,this.dirButtonDims,void 0,function(){data.redo()},"imgRedo");return{undo:b,redo:a}},showReceptacles:function(){for(var a=0;a<this.receptacles.length;a++)this.receptacles[a].show()},hideReceptacles:function(){for(var a=0;a<this.receptacles.length;a++)this.receptacles[a].hide()},
makePanels:function(){var a=this.paper.rect(0,this.paper.height-this.panelDimsBottom.dy,this.panelDimsBottom.dx,this.panelDimsBottom.dy).attr({fill:this.panelCol.hex,"stroke-width":0}),b=this.paper.rect(0,0,this.panelDimsTop.dx,this.panelDimsTop.dy).attr({fill:this.panelCol.hex,"stroke-width":0});return{bottom:a,top:b}},removeSection:function(a){a instanceof TreeSection&&(a=this.sections.indexOf(a));this.sections[a]?(this.sections[a].remove(),this.sections.splice(a,1),this.moveAllToPositions("fly")):
(console.log("tried to remove section idx "+a+".  Does not exist."),console.trace())},removePrompt:function(a,b){if(a instanceof TreePrompt){var c=a;for(a=0;a<this.section.length&&!(b=this.sections[a].prompts.indexOf(c),-1!=b);a++);}this.sections[a].removePrompt(b);this.moveAllToPositions("fly")},removeUnknown:function(a){a instanceof TreeSection?this.removeSection(a):a instanceof TreePrompt?this.removePrompt(a):(console.log("Tried to remove a MYSTERIOUS OBJECT!"),console.trace())},fadeOutSection:function(a){a instanceof
TreeSection&&(a=this.sections.indexOf(a));this.sections[a]?(this.sections[a].fadeOut(),this.sections.splice(a,1),this.moveAllToPositions("fly")):(console.log("tried to remove section idx "+a+".  Does not exist."),console.trace())},fadeOutPrompt:function(a,b){if(a instanceof TreePrompt){var c=a;for(a=0;a<this.sections.length&&!(b=this.sections[a].prompts.indexOf(c),-1!=b);a++);}this.sections[a].fadeOutPrompt(b);this.moveAllToPositions("fly")},fadeOutUnknown:function(a){a instanceof TreeSection?this.fadeOutSection(a):
a instanceof TreePrompt?this.fadeOutPrompt(a):(console.log("Tried to fade out a MYSTERIOUS OBJECT!"),console.trace())},unclickButton:function(){this.clickedButton=void 0},getNewSectionIdx:function(a){for(var b=this.pos.y,c=0;c<this.sections.length;c++){var d=this.sections[c].totalHeight();if(b>a.y)return c;b+=d}return this.sections.length},getNewPromptSectionIdx:function(a){for(var b=this.pos.y,c=0;c<this.sections.length;c++){var d=this.sections[c].totalHeight();if(b+d>a.y)return c;b+=d}return this.sections.length-
1},getButtonPos:function(a){for(var b=this.pos.y,c=this.pos.x,d=0;d<this.sections.length;d++){if(this.sections[d].button==a)return P(c,b);for(var b=b+this.totalButtonHeight,e=0;e<this.sections[d].prompts.length;e++){if(this.sections[d].prompts[e].button==a)return P(c+this.promptIndent,b);b+=this.totalButtonHeight}}},getButtonPosFromIdxs:function(a){return this.getButtonPos(-1==a.promptIdx?this.sections[a.sectionIdx].button:this.sections[a.sectionIdx].prompts[a.promptIdx].button)},getSectionIdx:function(a){return this.sections.indexOf(a)},
totalHeight:function(){for(var a=0,b=0;b<this.sections.length;b++)a+=this.sections[b].totalHeight();return a},fadeOut:function(a,b){b=defaultTo(b,250);a.animate({opacity:0},b,void 0,function(){this.remove()})},inButtonColumn:function(a){var b=this.pos.x+this.buttonDims.dx+this.promptIndent+this.placerBlockTolerance;return a.x+this.buttonDims.dx>this.pos.x-this.placerBlockTolerance&&a.x<b},inSectionColumn:function(a){return a.x<this.pos.x+this.promptIndent},defineClickFuncs:function(){this.clickFuncs=
{tree:{rect:this.onClickRectTreeMode,arrows:this.onClickArrowsTreeMode},object:{rect:this.onClickRectObjectMode,arrows:this.onClickArrowsObjectMode}}},onClickRectTreeMode:function(){console.log("I'm a rectangle!")},onClickRectObjectMode:function(){console.log("I'm a rectangle!")},onClickArrowsObjectMode:function(){this.parent.tree.toTreeMode()},onClickArrowsTreeMode:function(){this.parent.tree.toObjectMode()},getSectionYs:function(){for(var a=this.pos.y,b=[],c=0;c<this.sections.length;c++)b.push(a),
a+=this.totalButtonHeight*(1+this.sections[c].prompts.length);return b},makeTrash:function(){return new Receptacle(this,this.trashPos,this.buttonDims,"Trash",this.trashOnHoverIn,this.trashOnHoverOut,this.trashOnDropInto)},moveAllToPositions:function(a){for(var b=this.pos.x,c=this.pos.y,d=0;d<this.sections.length;d++){var e=this.sections[d];if(e.button!=this.clickedButton&&!e.button.inUse){e.button.move(P(b,c),a,this.toPosTime);e.pos.set(P(b,c));for(var c=c+this.totalButtonHeight,f=0;f<e.prompts.length;f++){var g=
e.prompts[f];g.button!=this.clickedButton&&!g.button.inUse&&g.button.move(P(b+this.promptIndent,c),a,this.toPosTime);c+=this.totalButtonHeight}}else c+=this.sections[d].totalHeight()}this.clickedButton&&this.clickedButton.groupToFront();this.staticsToFront()}});function translateObj(a,b){return a.transform("t"+b.x+","+b.y)}function makePath(a,b){for(var c="M"+a[0].x+","+a[0].y,d=1;d<a.length;d++)c+="L"+a[d].x+","+a[d].y;if(b||void 0===b)c+="Z";return c}
function defaultTo(a,b){return void 0===a?b:a}function objectsEqual(a,b){return Math.min(objectsEqualInDirection(a,b),objectsEqualInDirection(b,a))}function rectsOverlap(a,b){return(a.pos.x<=b.pos.x&&a.pos.x+a.dims.dx>=b.pos.x||b.pos.x<=a.pos.x&&b.pos.x+b.dims.dx>=a.pos.x)&&(a.pos.y<=b.pos.y&&a.pos.y+a.dims.dy>=b.pos.y||b.pos.y<=a.pos.y&&b.pos.y+b.dims.dy>=a.pos.y)}function scaleDims(a,b,c){c=defaultTo(c,0);a=a.copy();b=Math.min(b.dx/a.dx,b.dy/a.dy)*(1-c);return a.mult(b)}
function objectsEqualInDirection(a,b){for(var c in a)if(b&&b.hasOwnProperty(c))if("object"==typeof a[c]){if(!objectsEqual(a[c],b[c]))return!1}else{if(a[c]!=b[c])return!1}else return!1;return!0}function arrayDifference(a,b){for(var c=[],d=[],e=0;e<a.length;e++)-1==b.indexOf(a[e])&&c.push(a[e]);for(e=0;e<b.length;e++)-1==a.indexOf(b[e])&&d.push(b[e]);return{asNotInB:c,bsNotInA:d}}function posOnPaper(a,b){return P(a.x-b._left,a.y-b._top)}
function posGlobal(a,b){try{var c=$(b).offset();return P(a.x+c.left,a.y+c.top)}catch(d){console.trace()}};function Button(a,b,c,d,e,f,g,h,l){this.paper=a;this.pos=b.copy();"large"==c?this.dims=config.buttonDimsLarge:"medium"==c?this.dims=config.buttonDimsMedium:"small"==c?this.dims=config.buttonDimsSmall:c instanceof Vector?this.dims=c.copy():(console.log("Bad button dims sent to "+d),console.trace());this.fillCol=defaultTo(g,config.buttonFillCol);this.fillColHover=defaultTo(h,config.buttonFillColHover);this.rounding=defaultTo(l,config.buttonRounding);this.onClick=e;this.rect=this.makeRect();d&&(this.labelText=
d,this.label=this.makeLabel());f&&(this.imagePadding=config.imagePadding,this.imgId=f,this.image=this.makeImage())}
_.extend(Button.prototype,assignHover,{makeRect:function(){var a=this.paper.rect(0,0,this.dims.dx,this.dims.dy,this.rounding).attr({"stroke-width":0,fill:this.fillCol.hex});translateObj(a,this.pos);a.parent=this;this.assignHover(a,"rect",this.fillColHover,this.fillCol);a.click(this.onClick);return a},makeLabel:function(){var a=this.pos.copy().movePt(this.dims.copy().mult(0.5)),b=this.paper.text(0,0,this.labelText).attr({"font-size":config.textSizeMed});translateObj(b,a);b.parent=this;this.assignHover(b,
"rect",this.fillColHover,this.fillCol);b.click(this.onClick);return b},makeImage:function(){var a=$("#"+this.imgId)[0],b=V(a.width,a.height),b=scaleDims(b,this.dims,this.imagePadding),c=this.pos.copy().movePt(this.dims.copy().mult(0.5)).movePt(b.copy().mult(-0.5)),a=this.paper.image(a.src,c.x,c.y,b.dx,b.dy);a.parent=this;this.assignHover(a,"rect",this.fillColHover,this.fillCol);a.click(this.onClick);return a},remove:function(){this.action("remove")},move:function(a){a instanceof Vector?this.pos.movePt(a):
a instanceof Point?this.pos.set(a):console.log("Bad move orders sent to "+this.labelText);translateObj(this.rect,this.pos);a=this.pos.copy().movePt(this.dims.copy().mult(0.5));this.label&&translateObj(this.label,a);this.image&&translateObj(this.image,a)},hide:function(){this.action("hide")},show:function(){this.action("show")},toFront:function(){this.action("toFront")},action:function(a){this.rect[a]();if(this.label)this.label[a]();if(this.image)this.image[a]()}});
